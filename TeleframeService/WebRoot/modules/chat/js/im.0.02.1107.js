function meval(s){try{return eval("("+s+")")}catch(e){return null}}function obj_merge(g,e){var b,f,l;if(!e){return g}for(l in e){if(((b=e[l])!=undefined)&&(null!=b)){if(b.constructor===Array){g[l]=f=[];for(var c=0,a=b.length;c<a;c++){f[c]=b[c]}}else{if(typeof(b)!="object"){g[l]=b}else{if(((f=g[l])==undefined)||(null==f)){g[l]=(f={})}obj_merge(f,b)}}}}return g}String.prototype.cmp=function(d){var b,c,a=Math.min(this.length,d.length);for(b=0;b<a;b++){if(c=this.charCodeAt(b)-d.charCodeAt(b)){return c}}return this.length-d.length};String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")};Date.prototype.toString1=function(){var e=this.getMonth()+1;var b=this.getDate();var a=this.getHours();var c=this.getMinutes();var d=this.getSeconds();return this.getFullYear()+"年"+((e<10)?"0":"")+e+"月"+((b<10)?"0":"")+b+"日"+((a<10)?"0":"")+a+":"+((c<10)?"0":"")+c+":"+((d<10)?"0":"")+d};if(!Array.prototype.filter){Array.prototype.filter=function(b){var a=this.length;if(typeof b!="function"){throw new TypeError()}var e=new Array();var d=arguments[1];for(var c=0;c<a;c++){if(c in this){var f=this[c];if(b.call(d,f,c,this)){e.push(f)}}}return e}}if(!Array.prototype.some){Array.prototype.some=function(b){var a=this.length;if(typeof b!="function"){throw new TypeError()}var d=arguments[1];for(var c=0;c<a;c++){if(c in this&&b.call(d,this[c],c,this)){return true}}return false}}if(!Array.prototype.forEach){Array.prototype.forEach=function(b){var a=this.length;if(typeof b!="function"){throw new TypeError()}var d=arguments[1];for(var c=0;c<a;c++){if(c in this){b.call(d,this[c],c,this)}}}}function publisher(){this.subscribers=[]}publisher.prototype.deliver=function(){var c,d,a;d=this.subscribers.length;for(var b=0;b<d;){c=this.subscribers[b];if(this.filter&&!this.filter(c,arguments)){b++;continue}c.fn.apply(c.fn,arguments);a=this.subscribers.length;if(d>a){d=a}else{b++}}return this};Function.prototype.subscribe=function(d){var c=this;var f=d.subscribers.some(function(g){return g.fn===c});if(!f){var e={};for(var b=1,a=arguments.length;b<a;b++){e["arg"+(b-1)]=arguments[b]}e.fn=this;d.subscribers.push(e)}return this};Function.prototype.unsubscribe=function(b){var a=this;b.subscribers=b.subscribers.filter(function(c){return c.fn!==a});return this};(function(){var m=String.fromCharCode,e={"\0":1,"\t":1,"\n":1,"\r":1," ":1,'"':1,"#":1,"%":1,"&":1,"+":1,"-":1,".":1,"/":1,":":1,";":1,"=":1,"?":1,"@":1,"\\":1},n=[0,192,224,240,248,252],g="0123456789abcdef",f=function(o){return"%"+g.charAt(o>>4)+g.charAt(o&15)},b=[],d=[["&","&amp;"],["\\n","&#10;"],["\\r","&#13;"],["\\t","&#9;"],["`","&#96;"],["'","&#39;"],['"',"&quot;"],[" ","&nbsp;"],["<","&lt;"],[">","&gt;"]],a=[{s:/\[img\]([^\]]*)\[\/img\]/gi,d:'<img src="$1" border="0"/>'},{s:/\[flash\]([^\]]*)\[\/flash\]/gi,d:'<embed type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash" quality="heigh" src="$1"/></embed>'},{s:/\[url=([^\]]*)\]([^\]]*)\[\/url\]/gi,d:'<a href="$1" target="_blank">$2</a>'},{s:/\[url\]([^\]]*)\[\/url\]/gi,d:'<a href="$1" target="_blank">$1</a>'},{s:/\[email=([^\]]*)\]([^\]]*)\[\/email\]/gi,d:'<a href="mailto:$1">$2</a>'},{s:/\[email\]([^\]]*)\[\/email\]/gi,d:'<a href="mailto:$1">$1</a>'},{s:/\[color=([^\]]*)\]([^\]]*)\[\/color\]/gi,d:'<font color="$1">$2</font>'},{s:/\[face=([^\]]*)\]([^\]]*)\[\/face\]/gi,d:'<font face="$1">$2</font>'},{s:/\[size=1\]([^\]]*)\[\/size\]/gi,d:'<font size="1">$1</font>'},{s:/\[size=2\]([^\]]*)\[\/size\]/gi,d:'<font size="2">$1</font>'},{s:/\[size=3\]([^\]]*)\[\/size\]/gi,d:'<font size="3">$1</font>'},{s:/\[size=4\]([^\]]*)\[\/size\]/gi,d:'<font size="4">$1</font>'},{s:/\[align=([^\]]*)\]([^]]*)\[\/face\]/gi,d:'<align="$1">$2</align>'},{s:/\[fly\]([^\]]*)\[\/fly\]/gi,d:"<marquee>$1</marquee>"},{s:/\[b\]([^\]]*)\[\/b\]/gi,d:"<b>$1</b>"},{s:/\[i\]([^\]]*)\[\/i\]/gi,d:"<i>$1</i>"},{s:/\[u\]([^\]]*)\[\/u\]/gi,d:"<u>$1</u>"},{s:/\[code\]([^\]]*)\[\/code\]/gi,d:'<pre><font size="2" face="Verdana,Arial">$1</font></pre>'},{s:/\[list\]([^\]]*)\[\/list\]/gi,d:"<ul>$1</ul>"},{s:/\[list=1\]([^\]]*)\[\/list\]/gi,d:'<ol type="1">$1</ol>'},{s:/\[list=a\]([^\]]*)\[\/list\]/gi,d:'<ol type="a">$1</ol>'},{s:/\[\*\]([^\]]*)\[\/\*\]/gi,d:"<li>$1</li>"},{s:/\[quote\]([^\]]*)\[\/quote\]/gi,d:"<blockquote>$1</blockquote>"}],l={magic:"codec",str_2_uri_param:function(A){var y,z,t,q,p,x,u,o="";for(t=0,x=A.length;t<x;++t){if(127>=(z=A.charCodeAt(t))){o+=e[y=A.charAt(t)]?f(z):y}else{u="";p=(z<128)?0:((z<2048)?1:((z<65536)?2:((z<4194304)?3:((z<134217728)?4:5))));for(q=p;q>0;--q,z=z>>6){u=f(128|(z&63))+u}z|=n[p];o+=f(z)+u}}return o},uri_param_2_str:function(B){var x=b,y,A,u,z=B.length,t,q,p,o="";for(u=0;u<z;){if(("%"!=B.charAt(u))||((u+3)>z)){o+=B.charAt(u);++u}else{y=(x[B.charCodeAt(u+1)&255]<<4)+x[B.charCodeAt(u+2)&255];for(t=n.length,A=0;t>1;--t){if(y>=n[t-1]){if((p=(u+(3*t)))<=z){A=y-n[t-1];for(q=u+3;q<p;q+=3){if("%"!=B.charAt(q)){break}A=((A<<6)+(((x[B.charCodeAt(q+1)&255]<<4)+x[B.charCodeAt(q+2)&255])&127))}if(q==p){o+=m(A);u+=(t*3)}}break}}if(0==A){o+=m(y);u+=3}}}return o},uri_2_obj:function(A){var t={},x,o,p,z,y,r,v=A.length,q=((0<v)&&("-"==A.charAt(0)))?"-":"=",u=("-"==q)?"-":"&";for(r=1;r<v;++r){for(o=r;((r<v)&&(q!=(x=A.charAt(r)))&&(x!=u));++r){}z=r-o;r+=(((r<v)&&(q==x))?1:0);for(p=r;((r<v)&&(u!=A.charAt(r)));++r){}y=r-p;if((0<z)&&(0<y)){t[A.substr(o,z)]=l.uri_param_2_str(A.substr(p,y))}}return t},obj_2_url:function(r,p){var s=("-"==p)?"-":"=",o=("="==s)?"&":"-";function q(C,B){var D,u,t,A,z=(C.constructor==Array),y=z?(B+"__x_countz_"+s+C.length):"";for(D in C){if((undefined!=(u=C[D]))&&(null!=u)){if(t=("%"==(""+D).charAt(0))){D=D.substr(1)}A=B+((0!=D)?(((""==B)?"d":"_")+D):"");if(typeof(u)=="function"){continue}if(typeof(u)=="object"){y+=((""==y)?"":o)+((u.constructor==Array)?"":(A+s+"1"+o))+q(u,A)}else{y+=((""==y)?"":o)+A+s+(t?u:l.str_2_uri_param(("string"==typeof(u))?u:u.toString()))}}}return y}return q(r,"",p)},json_txt_2_url:function(q,p){var o=q.indexOf("("),r=q.lastIndexOf(")");if((0<o)&&(r>o)){q=q.substring(o+1,r)}return l.obj_2_url(meval(q),p)},obj_2_form:function(q,p){function o(x,C,u){var t,A,y,r,z=(x.constructor==Array),B=z?('<input type="hidden" name="'+C+'__x_countz_" value="'+x.length+'"/>\r\n'):"";for(t in x){if((undefined!=(A=x[t]))&&(null!=A)){y=C+((0!=t)?(((""==C)?"d":"_")+t):"");r=""+u+(z?("["+t+"]"):(((""==u)?"":".")+t));if(typeof(A)=="object"){B+='<div style="border:1px solid #00ffff;padding:2px;"><br/>\r\n'+((0==t)?"":('<input type="hidden" name="'+y+'" value="1"/>\r\n'))+o(A,y,r)+"</div>\r\n"}else{B+="<label>"+r+':</label><input type="text" name="'+y+'" value="'+A+'"/><br/>'}}}return B}return'<form action="'+p+'" method="get" style="border:2px solid blue;padding:1px;"><button id="submit" type="submit">提交</button><br/>'+o(q,"","")+"</form>"},obj_2_str:function(q){if(q){var o,y,r,x,p=0,u,t=(q.constructor==Array),z=t?"[":"{";for(o in q){y=q[o];z+=((0==(p++))?"":",")+(t?"":(o+":"));switch(typeof(y)){case"number":z+=y;break;case"object":z+=l.obj_2_str(y);break;case"string":z+='"';for(r=0,u=y.length;r<u;++r){x=y.charAt(r);z+=((x!='"')&&(x!="\\"))?(("\n"==x)?"\\n":((x=="\r")?"\\r":x)):("\\"+x)}z+='"';break}}return z+(t?"]":"}")}return""},json_txt_2_form:function(p,q){var o=p.indexOf("("),r=p.lastIndexOf(")");if((0<o)&&(r>o)){p=p.substring(o+1,r)}return l.obj_2_form(meval(p),q)},str_2_html:function(p){for(var o=0;o<d.length;++o){p=p.replace(new RegExp(d[o][0],"g"),d[o][1])}return p},html_2_str:function(p){for(var o=d.length-1;o>=0;--o){p=p.replace(new RegExp(d[o][1],"g"),d[o][0])}return p},ubb_2_html:function(p){for(var q,o=a.length;o>=0;--o){q=a[o];p=p.replace(q.s,q.d)}return p},hex_2_uri_param:function(p){var o,q="";for(o=0;o<p.length;++o){q+=((0==(1&o))?"%":"")+p.charAt(o)}return q}};for(var c=0;c<=255;++c){if((c>=48)&&(c<=57)){b[c]=c-48}else{if((c>=65)&&(c<=71)){b[c]=c-55}else{if((c>=97)&&(c<=102)){b[c]=c-87}else{b[c]=0}}}}window.codec=l})();(function(){var b=codec.uri_2_obj(location.search||location.hash||""),a=(b?b.lang:null)||"cn";window.lang_get=function(c){return c[a]||c.cn||c.en}})();var evt={bind:function(a,c,b){if(a.attachEvent){a.attachEvent("on"+c,b)}else{if(a.addEventListener){a.addEventListener(c,b,false)}else{a["on"+c]=b}}},unbind:function(a,c,b){if(a.detachEvent){a.detachEvent("on"+c,b)}else{if(a.removeEventListener){a.removeEventListener(c,b,false)}else{a["on"+c]=null}}},mude:function(a){if(a.preventDefault){a.preventDefault()}else{a.returnValue=false}},stop:function(a){if(a.stopPropagation){a.stopPropagation()}else{a.cancelBubble=true}},props:"altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode layerX layerY metaKey newValue offsetX offsetY originalTarget pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" "),fix:function(g){var b,l,f=g,c=this.props;g={};for(b=c.length,l;b;){l=c[--b];g[l]=f[l]}if(!g.target){g.target=g.srcElement||document}if(g.target.nodeType===3){g.target=g.target.parentNode}if(!g.relatedTarget&&g.fromElement){g.relatedTarget=g.fromElement===g.target?g.toElement:g.fromElement}if(g.pageX==null&&g.clientX!=null){var d=document.documentElement,a=document.body;g.pageX=g.clientX+(d&&d.scrollLeft||a&&a.scrollLeft||0)-(d&&d.clientLeft||a&&a.clientLeft||0);g.pageY=g.clientY+(d&&d.scrollTop||a&&a.scrollTop||0)-(d&&d.clientTop||a&&a.clientTop||0)}if(!g.which&&((g.charCode||g.charCode===0)?g.charCode:g.keyCode)){g.which=g.charCode||g.keyCode}if(!g.metaKey&&g.ctrlKey){g.metaKey=g.ctrlKey}if(!g.which&&g.button!==undefined){g.which=(g.button&1?1:(g.button&2?3:(g.button&4?2:0)))}return g}};function is_ancestor(a,c){if(a==document.body){return true}for(var b=c.parentNode;b&&b!=document.body;b=b.parentNode){if(a===b){return true}}return false}function getElementsByClass(g,e,a){var d=[];if(e==null){e=document}if(a==null){a="*"}var c=e.getElementsByTagName(a);var b=c.length;var f=new RegExp("(^|\\s)"+g+"(\\s|$)");for(i=0,j=0;i<b;i++){if(f.test(c[i].className)){d[j]=c[i];j++}}return d}(function(c,d){var b=/^(div|span|button|input|table|row|col|td|tr|option|select|img)/;function a(e,l){var g,m=l||document;switch(typeof(e)){case"string":var f=e.substring(1);switch(e.charAt(0)){case"#":return m.getElementById(f);case".":return(m.getElementsByClassName?m.getElementsByClassName(f):getElementsByClass(f,m));case"/":return m.getElementsByTagName(f);default:return m.getElementsByName(e)}case"object":return e;case"function":a.funcs.push(e)}}a.funcs=[];a.loaded=false;a.run=function(){if(a.loaded){return}for(var e=0;e<a.funcs.length;e++){a.funcs[e]()}a.loaded=true;delete a.funcs;delete a.run};if(c.addEventListener){c.addEventListener("load",a.run,false)}else{if(c.attachEvent){c.attachEvent("onload",a.run)}else{c.onload=a.run}}a.service_gid=1052078;a.ie6=(navigator.userAgent.indexOf("MSIE 6.")>=0);a.ie=(navigator.userAgent.indexOf("MSIE")>=0);c.hehe=c.$=a})(window);(function(){var f,m,x,t,u,b=navigator.userAgent,v=document,l,s=0<=b.indexOf("Opera"),n,c,p=(!s)&&(0<=b.indexOf("compatible"))&&(0<=b.indexOf("MSIE")),d=(0<=b.indexOf("Firefox")),e=(0<=b.indexOf("Safari"))&&(0>b.indexOf("Chrome")),o=0<=b.indexOf("Chrome"),a=0<=b.indexOf("Webkit"),g=0<=b.indexOf("Gecko"),r=false;if(p){if(!(c=v.documentMode)){c=("CSS1Compat"==v.compatMode)?7:5}u=new RegExp("MSIE (\\d+\\.\\d+);");u.test(b);n=parseFloat(RegExp["$1"])}function q(){if(l){return}l=v.body;u=v.createElement("div");l.appendChild(u);u.style.cssText="width:3px;margin:0px;padding:0px;border:1px solid white;";f=((u.offsetWidth-3)/2);u.style.cssText="width:3px;border:none;margin:0px;padding:1px;";m=((u.offsetWidth-3)/2);u.innerHTML='<table style="border-collapse:separate;border-spacing:0;"><tr><td style="height:3px; border:0px"></td></tr></table>';t=(((u.getElementsByTagName("td")[0]).offsetHeight-3)/2);l.removeChild(u);u=v.createElement("textarea");l.appendChild(u);u.style.cssText="width:10px;border:1px solid white;margin:0px;padding:0px";x=((u.offsetWidth-10)/2);u.style.cssText="width:10px;border:0px solid white;margin:0px;padding:1px";text_padding_space=((u.offsetWidth-10)/2);l.removeChild(u)}window.hack={magic:"hack",ie_mode:c,ie:p,ie_ver:n,chrome:o,opera:s,get_border_space:function(){q();return f},get_padding_space:function(){q();return m},get_text_border_space:function(){q();return x},get_text_padding_space:function(){q();return text_padding_space},get_td_border_space_v:function(){q();return t},css_alpha:function(y){return(p&&(c<9))?("filter:alpha(opacity="+(100*y)+");"):("opacity:"+y+";")},get_body_height:function(){q();return Math.max(l.clientHeight,((("CSS1Compat"==v.compatMode)&&v.documentElement)||l).clientHeight)},css_box_shadow:function(z,y){u="2px 2px "+z+"px "+y+";";return(p&&(c<9))?("filter:progid:DXImageTransform.Microsoft.Shadow(color="+y+", Direction=135, Strength="+Math.round(z/2)+");"):("-moz-box-shadow:"+u+"-webkit-box-shadow:"+u+"box-shadow:"+u)}}})();function sound_play(c,b){var a=window.snd_player;if(!!a){if(!hack.ie){a.innerHTML=""}a.parentNode.removeChild(a)}window.snd_player=(a=document.createElement(hack.ie?"embed":"bgsound"));a.style.cssText="width:1px;height:1px;left:0px;top:0px;";a.src=(hack.ie?c:b);if(hack.ie){a.src=c}else{a.innerHTML="<embed width='0' height='0' src='"+b+"'></embed>"}document.body.appendChild(a)}function dom_get_item_by_name(a,c,b){if(nodes=a.getElementsByTagName(c)){for(node_index=0;node_index<nodes.length;++node_index){node=nodes[node_index];if(b==node.getAttribute("name")){return node}}}return null}var alert_ex=(function(){var g="alert_ex",d="message_box",a="提醒",c,f,e,b;return function(l,m,n){if(!c){c=document.createElement("div");c.id="alert_ex";c.className="message_box";c.innerHTML='<div class="head"><div class="title"></div></div><div class="body"><div class="content"></div><div class="submit"><button class="close smallBtn">确定</button></div></div>';document.body.appendChild(c);e=$(".title",c)[0];b=$(".content",c)[0];f=$(".close",c)[0];f.onclick=function(){if(n){n()}c.style.display="none"}}e.innerHTML=m||a;b.innerHTML=l;c.style.display="";c.style.left=(viewport_width()-c.clientWidth)/2+"px"}})();var tip_ex=(function(){var a="tip_ex",l="提醒",c=1500,f=125,d,m,b,g,e;return function(n,q,p,o){if(!b){b=document.createElement("div");b.id=a;b.className="message_box";b.innerHTML='<div class="head"><div class="title"></div></div><div class="body"><div class="content"></div></div>';document.body.appendChild(b);g=$(".title",b)[0];e=$(".content",b)[0]}g.innerHTML=q||l;e.innerHTML=n;b.style.cssText="";b.style.left=(viewport_width()-b.clientWidth)/2+"px";if(d){clearTimeout(d);d=null}if(m){clearInterval(m);m=null}d=setTimeout(function(){var s=1,r=b.style.cssText;d=null;m=setInterval(function(){b.style.cssText=hack.css_alpha(s-=1/4)+r;if(s==0){b.style.cssText="";b.style.display="none"}},o||f)},p||c)}})();var prompt_ex=(function(){var g="prompt_ex",e="message_box",c,a,d,f,b;return function(n){var m=this,l;if(!l){l=document.createElement("div");l.id=g;l.className=e;l.innerHTML='<div class="body"><div class="content"><label class="question"></label><input class="answer"></input></div><div class="submit"><button class="ok smallBtn">确定</button>&nbsp;&nbsp;&nbsp;<button class="cancel smallBtn">取消</button></div></div>';document.body.appendChild(l);a=$(".question",l)[0];d=$(".answer",l)[0];f=$(".ok",l)[0];b=$(".cancel",l)[0];d.onkeypress=function(p){var o=p||window.event;if((o.which|o.keyCode)==13){f.click();o.returnValue=false}}}a.innerHTML=n.question;d.value=n.answer||"";d.select();l.style.display="";f.onclick=function(){if(n.ok_callback){n.ok_callback(d.value)}l.style.display="none"};b.onclick=function(){if(n.cancel_callback){n.cancel_callback()}l.style.display="none"};l.style.left=(viewport_width()-l.clientWidth)/2+"px"}})();(function(){var e,b,a,f,d=document,c="title";window.title_twinkle=function(g){if(a){clearInterval(a);a=null;if(e){d[c]=e}}if(g){e=d[c];d[c]=(b=g);a=setInterval(function(){d[c]=(f=!f)?e:b},1000)}}})();function insert_after(a,b){if(b.nextSibling){b.parentNode.insertBefore(a,b.nextSibling)}else{b.parentNode.appendChild(a)}}function remove_self(a){if(a&&a.parentNode){a.parentNode.removeChild(a)}return a}(function(){var a;window.log=function(b){if(null==a){document.body.appendChild(a=document.createElement("div"));a.style.cssText="position:absolute;top:40px;right:0px;display:none;"}a.innerHTML+="<br/>"+b}})();function get_x(b){var a=0;while(b){a+=b.offsetLeft;b=b.offsetParent}return a}function get_y(a){var c=0;for(var b=a;b;b=b.offsetParent){c+=b.offsetTop}for(b=a.parentNode;b&&b!=document.body;b=b.parentNode){if(b.scrollTop){c-=b.scrollTop}}return c}function viewport_width(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth}function viewport_height(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}function cookie_ex(a){this.name=a;this.value="";var d=document.cookie;if(d==""){return}var e=d.split(";");var c=null;for(var b=0;b<e.length;b++){e[b]=e[b].replace(/(^\s*)/g,"");if(e[b].substring(0,a.length+1)==(a+"=")){c=e[b];break}}if(c==null){return}this.value=decodeURIComponent(c.substring(a.length+1))}cookie_ex.prototype={store:function(a,f,c,e){var b=this.name+"="+encodeURIComponent(this.value);if(a&&a!=0){var d=new Date();d.setDate(d.getDate()+a);b+="; expires="+d.toGMTString()}if(f){b+="; path="+f}if(c){b+="; domain="+c}if(e){b+="; secure"}document.cookie=b},remove:function(c,a,b){this.value="";this.store(-1,c,a,b)},enabled:function(){if(navigator.cookieEnabled!=undefined){return navigator.cookieEnabled}if(Cookie.enabled.cache!=undefined){return Cookie.enabled.cache}document.cookie="testcookie=test; max-age=10000";var a=document.cookie;if(a.indexOf("testcookie=test")==-1){return Cookie.enabled.cache=false}else{document.cookie="testcookie=test; max-age=0";return Cookie.enabled.cache=true}}};(function(){var b=0,e="local_storage",f=window.localStorage||null,d=document.documentElement||null;function g(l,n){try{if(f){if((""==n)||(null==n)){f.removeItem(l)}else{f.setItem(l,n)}}else{if(d){if(0==b){d.addBehavior("#default#userdata");b=1}d.load(e);d.setAttribute(l,n);d.save(e)}else{return 1}}return 0}catch(m){return 1}}function c(m){try{if(f){return f.getItem(m)}else{if(d){if(0==b){d.addBehavior("#default#userdata");b=1}d.load(e);return d.getAttribute(m)}}}catch(l){}return null}function a(){try{if(f){localStorage.clear()}else{if(d){d.load(e);d.expires=new Date(315532799000).toUTCString();d.save(e)}}return 0}catch(l){return 1}}window.local_storage={magic:e,init_flag:0,set:g,get:c,clear:a}})();(function(){var g=300000,s={},b={},p=Math.floor((Math.random()*1000000)),e=function(){},l,a;function o(){for(var t in s){if(s[t]){r(s[t],"cancel")}}}function n(){a=setInterval(m,5000);evt.bind(window,"unload",function(){clearInterval(a);window.message=null;o();for(var t in b){if(b[t]){delete b[t]}}});window.message=function(t){var u=s[t.to_handle];if(u){r(u,t)}}}function m(){var v,u,t=(new Date()).getTime();for(v in s){if((u=s[v])&&(u.timeout<t)){r(u,"timeout")}}}function r(z,y){var v=z.js,u=z.seq,t=z.x;delete s[u];if(v){delete z.js;if(v.parentNode){l.removeChild(v)}}if(t){delete z.x;t.abort()}z.on_ack(y,z.ref);if(t){t.onreadystatechange=e;b[u]=t}}function d(v){var t=document,u=(v.js=t.createElement("script"));u.type="text/javascript";u.language="javascript";u.async=true;u.src=v.url;(l||(l=(t.getElementsByTagName("head")[0]||t.documentElement))).insertBefore(u,l.firstChild)}function f(B,u){if((B.x==u)&&(u.readyState==4)){var A,v=B.seq;if(0==u.status){if(s[v]){r(B,"abort")}return}if((200==u.status)||(304==u.status)){var B,y=u.responseText,t=y.indexOf("("),z=y.lastIndexOf(")");if(((z>(t+2))&&("{"==y.charAt(t+1))&&("}"==y.charAt(z-1)))){A=meval(y.substring(t+1,z))}}B.x=null;r(B,A||"error");u.onreadystatechange=e;b[v]=u}}function c(v){var u,t;for(u in b){if(t=b[u]){delete b[u];t.abort();break}}t=t||(window.XMLHttpRequest?new XMLHttpRequest():new ActiveXObject("Microsoft.XMLHTTP"));t.open(v.param?"post":"get",v.url,true);t.onreadystatechange=function(){f(v,t)};if(v.param){t.setRequestHeader("content-type","application/x-www-form-urlencoded;charset=utf-8")}(v.x=t).send(v.param)}function q(u){if(u&&u.on_ack&&u.type){var C=u["static"],D=(("json"!=u.way)&&("get"!=u.method)),z=u.from_handle,B=(C||D)?"&":"-",y=("-"==B)?"-":"=",v=(u.srv?u.srv:"/")+(u.to?u.to:"")+"/"+u.type,x="hfrom_handle"+y+((null==z)?(++p):z)+B+codec.obj_2_url(u.data,B),A={seq:p,on_ack:u.on_ack,time:((new Date()).getTime()+(u.timeout?u.timeout:g)),url:(D?(v+".js"):(C?(v+".js?"+x):(v+"/-"+x+".js"))),param:(D?x:""),ref:u.ref};s[p]=A;try{("json"==u.way)?d(A):c(A)}catch(E){r(A,"error")}}}n();window.rpc={magic:"rpc",call:q,cancel:o}})();function drag(b,d,a,q){var p=b.style,f=p.cursor,e=b.offsetLeft,c=b.offsetTop,n=d.clientX,m=d.clientY,o=document,l=(o.compatMode=="CSS1Compat")?o.documentElement:null;p.cursor="move";evt.bind(o,"mousemove",g);evt.bind(o,"mouseup",g);evt.bind(o,"blur",g);if(b.setCapture){b.setCapture();evt.bind(b,"losecapture",g)}evt.stop(d);evt.mude(d);function g(u){switch((u=u||window.event).type){case"blur":case"losecapture":case"mouseup":p.cursor=f;evt.unbind(o,"mousemove",g);evt.unbind(o,"mouseup",g);evt.unbind(o,"blur",g);if(b.releaseCapture){evt.unbind(b,"losecapture",g);b.releaseCapture()}break;case"mousemove":var r=(e+u.clientX-n),z=(c+u.clientY-m),t=b.offsetParent,s=Math.max(t.scrollWidth,t.clientWidth),v=Math.max(t.scrollHeight,t.clientHeight,(l&&(t==o.body))?l.clientHeight:0);if((r+b.offsetWidth)>s){r=s-b.offsetWidth}if((z+b.offsetHeight)>v){z=v-b.offsetHeight}if(r<0){r=0}if(z<0){z=0}p.left=r+"px";p.top=z+"px";if(a){a(q)}break}evt.stop(u)}}function media_plug(a){this.create(a)}media_plug.prototype={magic:"media_plug",langs:{en:{plz_select:"please select ",mic:"microphone",cam:"camera",and:"and ",set_done:"OK",installing:"Installing...",rebot_hint:"After Install, Restart Browser",install_media_plug:"Install Video Pluggin",try_flash:"Try Video with Flash",download:"Download and Install",l1:"More clear / high resolution video screen, a better full-screen display",l2:"Network intelligence to adapt, video connected to faster, more fluid video and audio effects",l3:"Safe and viruses, ease of use, reliable and professional organizations certified signatures",l4:"Permanent free",l5:"System Requirements: Windows XP or later; browser: IE, Chrome, Firefox, Safari, Opera ..."},cn:{plz_select:"选择",mic:"麦克风",cam:"摄像头",and:"和",set_done:"确定",installing:"正在安装...",rebot_hint:"安装完毕后重启浏览器",install_media_plug:"安装视频加速器",try_flash:"我先试试普通视频",download:"立即安装视频加速器",l1:"更清晰/高分辨率的视频画面，更好的全屏显示效果",l2:"网络智能适应，视频接通更快，影音效果更流畅",l3:"安全无病毒，放心使用，专业机构认证的可靠签名",l4:"永久免费",l5:"系统要求：Windows XP 或更高版本；浏览器：IE,Chrome,Firefox,Safari,Opera..."}},types:{install:{codebase:"/plugin/hehehi.0.02.0823.exe"},activex:{name:"activex",xname:"HEHEHI.HehehiieCtrl.1",clsid:"F3711E49-C6C3-4598-9816-8FD986250C98",codebase:"plugin/hehehi_ie.cab",install_url:"",install_img:"",install_hint:""},xpcom:{name:"xpcom",mime:"application/hehehi-media-engine",codebase:"plugin/nphehehi.xpi",install_url:"",install_img:"",install_hint:""},flash:{name:"flash",xname:"ShockwaveFlash.ShockwaveFlash",mime:"application/x-shockwave-flash",clsid:"D27CDB6E-AE6D-11cf-96B8-444553540000",codebase:"",install_img:"",install_url:"http://www.adobe.com/go/getflashplayer",src:"plugin/hehehi.0.02.0823.swf",install_hint:""}},debug:false,windowless:(0>(""+navigator.platform).indexOf("Linux")),id_allocer:{value:0},ver_min:0.020516,chl_status:{closed:0,initting:1,initting_device:2,running:3},plug_status:{closed:0,initting:1,installing:2,running:3},get_default_skin:function(){return{dev_panel:{width:360,height:180}}},create_plug:function(n,o,d){var l,f,b=null,c=this.id?this.id:(++this.id_allocer.value),m=null,a=(0<=navigator.appName.indexOf("Microsoft"));if((navigator.platform=="Win32")&&((null==this.ver_cur)||(this.ver_cur>=this.ver_min))){if(a){try{l=new ActiveXObject(this.types.activex.xname);m=this.types.activex}catch(g){}}else{if((null!=navigator.mimeTypes)&&(0<navigator.mimeTypes.length)&&(null!=navigator.mimeTypes[this.types.xpcom.mime])&&navigator.mimeTypes[this.types.xpcom.mime].enabledPlugin){m=this.types.xpcom}}}if(!m&&o){if(a){try{l=new ActiveXObject(this.types.flash.xname);m=this.types.flash}catch(g){}}else{if((null!=navigator.mimeTypes)&&(0<navigator.mimeTypes.length)&&(null!=navigator.mimeTypes[this.types.flash.mime])&&navigator.mimeTypes[this.types.flash.mime].enabledPlugin){m=this.types.flash}}}if(m){if(this.type!=media_plug.prototype){this.type=m}d=codec.str_2_uri_param(d);n.innerHTML="<object id='plug_"+c+"' width='100%' height='100%'"+(a?(" classid='clsid:"+m.clsid+"'"):(" type='"+m.mime+"'"))+" codebase='"+m.codebase+"'"+((m==this.types.flash)?(" data='"+m.src+"'"+(this.windowless?(" wmode='transparent'"):"")):"")+">"+((m==this.types.flash)?(" <param name='movie' value='"+m.src+"'/> <param name='allowScriptAccess' value='always'/> <param name='flashVars' value='debug="+this.debug+"&plug_id="+c+"&plug_params="+d+"'/> <param name='allowFullScreen' value='true'/>"+(this.windowless?(" <param name='wmode' value='transparent'/>"):"")+"   <a href='"+m.install_url+"'>        <img border='none' src='"+m.install_img+"' alt='"+m.install_hint+"'/>   </a>"):(" <param name='plug_id' value='"+c+"'/>"+(this.windowless?(" <param name='windowless' value='"+this.windowless+"'/>"):"")+"<param name='plug_params' value='"+d+"'/>"))+"</object>";b=a?window["plug_"+c]:document.getElementById("plug_"+c);if(b){if((m.name!="flash")&&(f=meval(b.get_info(65535)))){media_plug.prototype.ver_cur=f.ver;if(f.ver<this.ver_min){n.innerHTML="";return null}}}else{n.innerHTML=""}return b}return null},check_plug_install:function(d,f){var b,e,l,g=20,a=document.createElement("div"),c=false;a.style.cssText="position:absolute;width:1px;height:1px;left:-1px;top:-1px;";document.body.appendChild(a);if(b=this.create_plug(a,false,"")){l=setInterval(function(){if(((b&&("undefined"!=typeof(b.get_info)))||(0>=(--g)))){if(b&&("undefined"!=typeof(b.get_info))){if(e=meval(b.get_info(65535))){c=(e.ver>=media_plug.prototype.ver_min);media_plug.prototype.plug_valid=c}}clearInterval(l);a.innerHTML="";a.parentNode.removeChild(a);f(d,e?e.ver:null)}},50)}else{a.innerHTML="";a.parentNode.removeChild(a);f(d,null)}},clipboard_get_img:function(a){if(null==this.clipboard_plug){document.body.appendChild(media_plug.prototype.clipboard_cont=document.createElement("div"));media_plug.prototype.clipboard_cont.style.cssText="position:absolute;top:-1px;left:-1px;width:1px;height:1px;";media_plug.prototype.clipboard_plug=media_plug.prototype.create_plug(media_plug.prototype.clipboard_cont,false,"");if((null==media_plug.prototype.clipboard_plug)||("undefined"==typeof(media_plug.prototype.clipboard_plug.clipboard_get_img))){media_plug.prototype.clipboard_plug=null;media_plug.prototype.clipboard_cont.innerHTML="";media_plug.prototype.clipboard_cont.parentNode.removeChild(media_plug.prototype.clipboard_cont);media_plug.prototype.clipboard_cont=undefined}}return this.clipboard_plug?this.clipboard_plug.clipboard_get_img(a):null},clear_install:function(){if(this.install_timer){clearInterval(this.install_timer);delete this.install_timer}if(this.install_panel){if(this.install_panel){this.install_panel.innerHTML="";this.install_panel.parentNode.removeChild(this.install_panel)}delete this.install_panel}if(this.install_test_panel){if(this.install_test_panel.parentNode){this.install_test_panel.innerHTML="";this.install_test_panel.parentNode.removeChild(this.install_test_panel)}delete this.install_test_panel}},install:function(){var b,c,f,e,d=this,g=media_plug.prototype.types.install.codebase;this.clear_install();this.parent.appendChild(this.install_panel=document.createElement("div"));this.install_panel.style.cssText="position:absolute;left:0px;top:0px;width:100%;height:100%;color:#fff;line-height:2em;font-size:14px;visibility:hidden;";this.install_panel.innerHTML="<div style='position:absolute;left:4%;width:92%;overflow:none;'><br/><center><span style='font-size:18px;'><b>"+this.lang.install_media_plug+"</b></span></center><br/><li>"+this.lang.l1+"</li><li>"+this.lang.l2+"</li><li>"+this.lang.l3+"</li><li>"+this.lang.l4+"</li><li>"+this.lang.l5+"</li><br/><br/><a name='flash' href='#' style='float:left;background:#333;font-size:18px;color:#fff;text-decoration:none;text-align:center;display:inline-block;width:210px;height:32px;line-height:32px;-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5Px;"+hack.css_box_shadow(1,"#666666")+"' onmouseover='this.style.background=\"#666\";' onmouseout='this.style.background=\"#333\";' >"+this.lang.try_flash+"</a><a name='plug' href='"+g+"' target='_blank' style='float:right;background:#333;font-size:18px;color:#fff;text-decoration:none;text-align:center;display:inline-block;width:210px;height:32px;line-height:32px;-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5Px;"+hack.css_box_shadow(1,"#666666")+"' onmouseover='this.style.background=\"#666\";' onmouseout='this.style.background=\"#333\";'>"+this.lang.download+"</a><span name='plug_installing' style='display:none'></span></div><div style='float:clear;'></div>";document.body.appendChild(this.install_test_panel=document.createElement("div"));if(this.on_event){this.on_event({type:"install_ui",panel:this.install_panel,download:g,ver_cur:this.ver_cur})}this.install_panel.style.visibility="";this.install_test_panel.style.cssText="position:absolute;left:-1px;top:-1px;width:1px;height:1px;";if(b=dom_get_item_by_name(this.install_panel,"*","flash")){evt.bind(b,"click",function(a){d.clear_install();d.status=d.plug_status.initting;if(null==(d.plug_obj=d.create_plug(d.parent,true,d.create_params))){d.status=d.plug_status.closed;if(d.on_event){d.on_event({type:"missing"})}}else{if(d.on_event){d.on_event({type:"create"})}}return false})}if(b=dom_get_item_by_name(this.install_panel,"*","plug")){evt.bind(b,"click",function(a){b=dom_get_item_by_name(d.install_panel,"*","plug_installing");if(b){b.style.display="";b.innerHTML=d.lang.installing;if(b=dom_get_item_by_name(d.install_panel,"*","plug")){b.style.display="none"}}else{if(b=dom_get_item_by_name(d.install_panel,"*","plug")){b.innerHTML="<b>"+((hack.ie||hack.chrome)?d.lang.installing:d.lang.rebot_hint)+"</b>"}}if(hack.ie||hack.chrome){d.install_timer=setInterval(function(){if(media_plug.prototype.create_plug(d.install_test_panel,false,"")){d.clear_install();d.status=d.plug_status.initting;if(null==(d.plug_obj=d.create_plug(d.parent,true,d.create_params))){d.status=d.plug_status.closed;if(d.on_event){d.on_event({type:"missing"})}}else{if(d.on_event){d.on_event({type:"create"})}}}},1000)}})}},on_plug_event:function(a){var b=meval(a);if(b.target&&b.target.type&&b.target.url){b.chl=this.chl_get(b.target.type,b.target.url)}switch(b.type){case"is_ready":return(null!=this.plug_obj);break;case"ready":this.status=this.plug_status.running;break;case"close":if(b.chl){b.chl.status=this.chl_status.closed;b.chl.id=0}break;case"active":break}if(this.is_created&&this.on_event){this.on_event(b)}return 0},create:function(c){var a=c.parent,b=this;this.skin=this.get_default_skin();if("object"==typeof(c.skin)){obj_merge(this.skin,c.skin)}this.parent=a;if(undefined!=c.debug){this.debug=c.debug}if(undefined!=c.windowless){this.windowless=c.windowless}this.on_event=c.on_event;this.cam_index=-1;this.mic_index=-1;this.chls=[];this.create_params=c.params||"";this.ref_obj=c.ref_obj;this.is_created=false;if(c.on_event){this.on_event_callback=c.on_event;this.on_event=function(d){d.plug=b;d.ref_obj=b.ref_obj;b.on_event_callback(d);d.plug=(d.ref_obj=null)}}this.id=(++this.id_allocer.value);window["plug_"+this.id+"_on_event"]=function(d){return b.on_plug_event(d)};this.status=this.plug_status.initting;if(null==(this.plug_obj=this.create_plug(a,(!!c.plug_install_mute)||(navigator.platform!="Win32"),this.create_params))){if(navigator.platform=="Win32"){if(this.ver_cur){b.status=b.plug_status.initting;if(null==(b.plug_obj=b.create_plug(a,true,b.create_params))){b.status=b.plug_status.closed;if(b.on_event){b.on_event({type:"missing"})}}else{if(b.on_event){b.on_event({type:"create"})}}}else{this.status=this.plug_status.installing;this.install(function(){b.status=b.plug_status.initting;if(null==(b.plug_obj=b.create_plug(a,true,b.create_params))){b.status=b.plug_status.closed;if(b.on_event){b.on_event({type:"missing"})}}else{if(b.on_event){b.on_event({type:"create"})}}})}}else{b.status=b.plug_status.closed;if(b.on_event){b.on_event({type:"missing"})}}}else{if((this.status==this.plug_status.running)&&b.on_event){setTimeout(function(){if(b.on_event){b.on_event({type:"ready"})}},0)}}this.is_created=true},destroy:function(){this.clear_install();window["plug_"+this.id+"_on_event"]=null;for(var a,b=this.chls.length-1;0<=b;--b){if(a=this.chls[b]){this.chl_destroy(a)}}if(this.dev_form){this.dev_form.onsubmit=null;this.dev_form.innerHTML="";this.dev_form.parentNode.removeChild(this.dev_form);delete this.dev_form}if(this.plug_obj){delete this.plug_obj}if(this.parent){this.parent.innerTHML="";delete this.parent}if(this.id){delete this.id}if(this.status){delete this.status}if(this.on_event){delete this.on_event}},update:function(){},is_ready:function(a){return(this.plug_obj&&(this.status==this.plug_status.running)&&(null==a||(("undefined"!=typeof(this.plug_obj[a])))))},get_info:function(a){return this.is_ready("get_info")?this.plug_obj.get_info(a):"{}"},text_out:function(a){return this.is_ready("text_out")?this.plug_obj.text_out(a):""},select_device:function(c,n,a){var f,d,b,g,l=this,m=this.dev_form,e="";if(null==m){this.parent.appendChild(this.dev_from=(m=document.createElement("form")));m.style.cssText="position:absolute;left:0px;top:0px;width:100%;height:100%;overflow-y:auto;overflow-x:none;padding:0px;margin:0px;background:transparent;background:#000;color:#fff;line-height:1.5em;font-size:12px;"}m.style.visibility="hidden";m.innerHTML="";e+="<div style='position:absolute;left:5%;width:90%'><br/><center><span style='font-size:18x;'><b>"+this.lang.plz_select+this.lang.cam+this.lang.and+this.lang.mic+"</span></center>";if(c&&(0<c.length)){e+="<br/><span>"+this.lang.cam+"</span><br/>";for(d=0;d<c.length;d++){f=c[d];e+="<input type='radio' name='cam' id='cam_"+f.index+"' value='"+f.index+"' "+((0==d)?"checked":"")+"/><label for='cam_"+f.index+"'>"+f.name+"</label><br/>"}}if(n&&(0<n.length)){e+="<br/><span>"+this.lang.mic+"</span><br/>";for(d=0;d<n.length;d++){f=n[d];e+="<input type='radio' name='mic' id='mic_"+f.index+"' value='"+f.index+"' "+((0==d)?"checked":"")+"/><label for='mic_"+f.index+"'>"+f.name+"</label><br/>"}}e+="<br/><center><input type='submit' value='"+this.lang.set_done+"' onmouseover='this.style.background=\"#666\";' onmouseout='this.style.background=\"#333\";' style='cursor:pointer;border:none;padding:0px;margin:0px;font-size:14px;color:#fff;width:120px;height:24px;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3Px;"+hack.css_box_shadow(1,"#666666")+"line-height:32px;background:#333;'/></center></div>";m.innerHTML=e;if(this.on_event){this.on_event({type:"select_device_ui",form:m,mics:n,cams:c})}m.style.visibility="";m.onsubmit=function(){for(d=0,g=m.getElementsByTagName("input");d<g.length;++d){if(((b=g[d]).type=="radio")&&b.checked){if(b.name=="cam"){l.cam_index=b.value}else{if(b.name=="mic"){l.mic_index=b.value}}}}m.style.display="none";a();return false}},init_device:function(f){var d=this;function g(){if(f.on_done){f.on_done()}}if(null==this.plug_info){this.plug_info=meval(this.plug_obj.get_info(65535));if(this.plug_info&&this.plug_info.camera){var c=[],b,e,a=this.plug_info.camera;for(b=0;b<a.length;++b){if((e=a[b])&&(e.name.indexOf("Google Camera Adapter")<0)){c.push(e)}}this.plug_info.camera=c}}if((0>this.cam_index)&&(this.plug_info.camera.length==1)){this.cam_index=this.plug_info.camera[0].index}if((0>this.mic_index)&&(this.plug_info.microphone.length>=1)){this.mic_index=this.plug_info.microphone[0].index}if(((0>this.cam_index)&&(1<this.plug_info.camera.length))){this.select_device(this.plug_info.camera,this.plug_info.microphone,g)}else{g()}},chl_get:function(d,b){for(var a=this.chls,c=a.length-1;c>=0;--c){if((chl=a[c])&&(chl.type==d)&&(b==chl.url)){return chl}}return null},chl_destroy:function(a){for(var b=this.chls,c=b.length-1;c>=0;--c){if(a==b[c]){if(a.timer){clearTimeout(a.timer);a.timer=null}if(this.chl_status.initting_device==a.status){this.dev_from.style.display="none"}a.status=this.chl_status.stopped;if(0<a.id){if(this.is_ready("chl_destroy")){this.plug_obj.chl_destroy(a.id)}a.id=0}a.refer=null;b.splice(c,1);break}}},chl_dev_index_param:function(a,b){return"\ncam.index="+a+"\nmic.index="+b},chl_create:function(d){if(!this.is_ready("chl_create")){return null}else{var c=this,b,a={type:d.type,id:0,url:d.url,status:this.chl_status.initting,refer:d.refer,params:(d.params||"")};this.chls[this.chls.length]=a;a.timer=setTimeout(function(){a.timer=null;if("publish"==d.type){a.status=c.chl_status.initting_device;c.init_device({on_done:function(){if((0<=c.cam_index)||(0<=c.mic_index)){a.params+=c.chl_dev_index_param(c.cam_index,c.mic_index);if(0>=(a.id=c.plug_obj.chl_create(a.type,a.url,a.params))){a.id=0;a.status=c.chl_status.closed;if(c.on_event){c.on_event({type:"close",chl:a,info:"chl_create failed."})}}else{a.status=c.chl_status.running;if(c.on_event){c.on_event({type:"running",chl:a})}}}else{a.status=c.chl_status.closed;if(c.on_event){c.on_event({type:"close",chl:a,info:"have not device."})}}}})}else{if(0>=(a.id=c.plug_obj.chl_create(a.type,a.url,a.params))){a.status=c.chl_status.closed;if(c.on_event){c.on_event({type:"close",chl:a,info:"chl_create failed."})}}else{a.status=c.chl_status.running;if(c.on_event){c.on_event({type:"running",chl:a})}}}},1);return a}},chl_query:function(b,a){return(!this.is_ready("chl_query"))?-1:this.plug_obj.chl_query(b,a)},chl_ctrl:function(b,c,a){return(!this.is_ready("chl_ctrl"))?-1:this.plug_obj.chl_ctrl(b,c,a)}};media_plug.prototype.lang=lang_get(media_plug.prototype.langs);var _gaq=_gaq||[];_gaq.push(["_setAccount","UA-922747-2"]);_gaq.push(["_setDomainName",".hehehi.com"]);_gaq.push(["_trackPageview"]);function google_analytics_init(){var b=document.createElement("script");b.type="text/javascript";b.async=true;b.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a)}if(0>(location.hash||location.search||"").indexOf("debug=1")){$(google_analytics_init)}function shadow_lines(a){this.create(a)}shadow_lines.prototype={magic:"shadow_lines",is_focus:false,get_default_skin:function(){return{from:"top",head_line:{size:1,bg:"#ddd",focus_bg:"#fff",alpha:0.9},lines:{size:1,bg:"#666",focus_bg:"#333",alpha:{start:0.9,end:0.01,mod:0.5,sub:0}}}},create:function(l){var c,q,f,b,g,m,d,e,a,o,r,n=0,p=l.parent;this.parent=l.parent;this.skin=(q=this.get_default_skin());if("object"==typeof(l.skin)){obj_merge(this.skin,l.skin)}this.on_event=l.on_event;this.lines=[];if(0<q.head_line.size){d=(("left"==q.from)||("right"==q.from));(this.head_line=(r=document.createElement("div"))).style.cssText="display:none";if(!d){r.innerHTML="&nbsp;"}p.appendChild(r);n+=q.head_line.size}c=d?p.clientWidth:p.clientHeight;line_sz=q.lines.size;a=q.lines.alpha.sub;o=q.lines.alpha.mod;f=q.lines.alpha.start;b=q.lines.alpha.end;g=(f>b)?b:f;m=(f>b)?f:b;for(i=0;((n+line_sz)<=c)&&(f>=g)&&(f<=m);++i,n+=line_sz){(this.lines[this.lines.length]=(r=document.createElement("div"))).style.cssText="display:none";if(!d){r.innerHTML="&nbsp;"}p.appendChild(r);f=(f-a)*o}if(n!=c){(this.end_line=(r=document.createElement("div"))).style.cssText="display:none";if(!d){r.innerHTML="&nbsp;"}p.appendChild(r)}this.update()},destroy:function(){if(this.head_line){this.head_line.parentNode.removeChild(this.head_line);delete this.head_line}for(var a=this.lines.length-1;a>=0;--a){this.lines[a].parentNode.removeChild(this.lines[a]);this.lines[a]=null}delete this.lines;if(this.end_line){this.end_line.parentNode.removeChild(this.end_line);delete this.end_line}delete this.skin;delete this.parent},update:function(){var e,d,b,s,t=this.skin,f,a=t.lines.alpha.sub,o=t.lines.alpha.mod,q=this.parent,p=this.skin.from,r=q.clientWidth,g=q.clientHeight,c=(("left"==p)||("right"==p)),m=(("right"==p)||("bottom"==p)),n=0,l=c?"top":"left",u=this.lines;if(this.head_line){f=this.is_focus?t.head_line.focus_bg:t.head_line.bg;d=t.head_line.size;alpha=t.head_line.alpha;w=c?d:r;h=c?g:d;this.head_line.style.cssText="display:block;overflow:hidden;position:absolute;width:"+w+"px;height:"+h+"px;"+(c?"":"line-height:1px;")+p+":"+n+"px;"+l+":0px;background:"+f+";"+hack.css_alpha(alpha);n+=d}f=this.is_focus?t.lines.focus_bg:t.lines.bg;d=t.lines.size;w=c?d:r;h=c?g:d;for(e=0,alpha=t.lines.alpha.start,len=u.length;e<len;++e,n+=d,alpha=(alpha-a)*o){u[e].style.cssText="display:block;overflow:hidden;position:absolute;width:"+w+"px;height:"+h+"px;"+(c?"":"line-height:1px;")+p+":"+n+"px;"+l+":0px;background:"+f+";"+hack.css_alpha(alpha)}if(this.end_line){w=c?(r-n):r;h=c?g:(g-n);alpha=t.lines.alpha.end;this.end_line.style.cssText="display:block;overflow:hidden;position:absolute;width:"+w+"px;height:"+h+"px;"+(c?"":"line-height:1px;")+p+":"+n+"px;"+l+":0px;background:"+f+";"+hack.css_alpha(alpha)}},set_focus:function(d){if(this.is_focus!=d){var c,b=this.lines,e=this.skin,a;this.is_focus=d;if(this.head_line){this.head_line.style.background=d?e.head_line.focus_bg:e.head_line.bg}e=this.skin;bg=d?e.lines.focus_bg:e.lines.bg;for(c=0,a=b.length;c<a;++c){b[c].style.background=bg}if(this.end_line){this.end_line.style.background=bg}}}};function edit_input(a){this.create(a)}edit_input.prototype.get_default_skin=function(){return{hover:{pad:1},border:{size:1},width:200,height:18,font:{size:12},top:0,left:0}};edit_input.prototype.create=function(b){var a=this;this.parent=b.parent||document.body;this.skin=obj_merge(this.get_default_skin(),b.skin||{});this.onblur1=b.onblur;this.hint=b.hint||"";this.text=b.text||"";this.is_ie6=navigator.userAgent.indexOf("MSIE 6.")>=0;this.parent.appendChild(this.input_wrapper=document.createElement("div"));this.input_wrapper.appendChild(this.a_hint=document.createElement("a"));this.a_hint.onclick=function(){return a.a_onclick()};this.input_wrapper.appendChild(this.label=document.createElement("label"));this.label.appendChild(this.input=document.createElement("input"));this.input.type="text";this.input.value=b.text;this.input.onblur=function(){a.input_onblur()};if($.ie6){this.input.onkeypress=function(c){a.input_onkeydown(c)}}else{this.input.onkeydown=function(c){a.input_onkeydown(c)}}this.input_wrapper.onmousedown=function(c){evt.stop(c||window.event)};this.label.appendChild(this.input);if($.ie6){this.input_wrapper.onmouseenter=function(){a.is_enter=true;a.input_wrapper.style.padding="1px";a.input_wrapper.style.border="1px solid blue";a.input_wrapper.style.backgroundImage="url(/images/hint-bg-2.gif)";a.input_wrapper.style.backgroundPosition="0 0"};this.input_wrapper.onmouseleave=function(){if(!a.is_focus){a.input_wrapper.style.border="0";a.input_wrapper.style.padding="2px";a.input_wrapper.style.backgroundImage=""}a.is_enter=false}}this.update()};edit_input.prototype.destroy=function(a){remove_self(this.input);remove_self(this.input_wrapper);delete this.input;delete this.input_wrapper};edit_input.prototype.update=function(){var a=this.skin;this.input_wrapper.style.cssText="position:absolute;overflow:hidden;width:"+(a.width-4)+"px;height:"+(a.height-4)+"px;font-size:"+this.skin.font.size+"px;top:0px;left:0px;";this.input_wrapper.className="edit_input";this.a_hint.style.cssText="position:absolute;white-space:nowrap;width:"+(a.width-4)+"px;height:"+(a.height-4)+"px;"+(this.skin.bold?"font-weight:bold;":"")+($.ie6?"padding-top:2px;padding-bottom:2px;padding-left:2px;":"padding:1px;");this.input.style.cssText="position:absolute;left:0px;top:0px;display:none;border:0;font-size:12px;margin:0px;line-height:"+(a.height-4)+"px;height:"+(a.height-4)+"px;width:"+(a.width-4)+"px;"+($.ie6?"padding-top:2px;padding-bottom:2px;padding-left:3px;":"padding:1px;");this.input.style.padding=this.a_hint.style.padding;this.a_hint.title=this.text||this.hint;this.a_hint.innerHTML=this.a_hint.title};edit_input.prototype.input_onblur=function(){if(this.onblur1){this.text=this.input.value=this.onblur1(this.input.value)}else{this.text=this.input.value}this.is_focus=false;this.input_wrapper.style.padding="";this.input_wrapper.style.border="";this.a_hint.style.display="";if($.ie6&&!this.is_enter){this.input_wrapper.style.border="0";this.input_wrapper.style.padding="2px";this.input_wrapper.style.backgroundImage=""}this.update()};edit_input.prototype.input_onkeydown=function(c){var b=c||window.event;var a=b.charCode||b.keyCode;if(13==a){this.input_onblur()}};edit_input.prototype.a_onclick=function(){this.a_hint.style.display="none";this.input.style.display="";this.input_wrapper.style.padding="1px";this.input_wrapper.style.border="1px solid blue";this.is_focus=true;this.input.focus();return false};edit_input.prototype.set_text=function(a){this.input.value=a;this.text=a;this.update()};edit_input.prototype.set_hint=function(a){this.hint=a;this.update()};var shadow_ex={magic:"shadow_ex",skin:{color1:"#ddd",color2:"#bbb",color3:"#999",opacity:0.5},get_border_space:function(){hack.get_border_space()},_create:function(d){var g,b,a,e=this,f=e.skin,c=e.get_border_space();bb=";border-bottom:1px solid ",bl=";border-left:1px solid ",br=";border-right:1px solid ",bt=";border-top:1px solid ",bc=";background-color:",commcss="position:absolute;display:block;overflow:hidden;"+hack.css_alpha(f.opacity),a,panel=document.createElement("div");d.shadow_ex={magic:"shadow_ex",panel:panel,lines:[]};panel.style.cssText="display:none;position:absolute;"+(d.style.zIndex?("z-index"+d.style.zIndex):"");a=d.shadow_ex.lines;for(i=0;i<7;++i){panel.appendChild(a[i]=document.createElement("span"))}a[0].innerHTML="&nbsp;";a[0].style.cssText=commcss+bb+f.color1+bc+f.color2+bt+f.color3+";left:2px;bottom:0px;line-height:1px;height:"+(3-(c*2))+"px;";a[1].style.cssText=commcss+bl+f.color1+bc+f.color2+br+f.color3+";left:2px;top:1px;width:"+(3-(c*2))+"px;";a[2].style.cssText=commcss+bl+f.color1+bc+f.color2+br+f.color2+";left:1px;top:2px;line-height:1px;height:1px;width:"+(3-(c*2))+"px;";a[3].style.cssText=commcss+bl+f.color1+bc+f.color1+br+f.color1+";left:0px;top:3px;line-height:1px;height:1px;width:"+(3-(c*2))+"px;";a[4].style.cssText=commcss+br+f.color1+bc+f.color2+bl+f.color3+";right:2px;top:1px;width:"+(3-(c*2))+"px;";a[5].style.cssText=commcss+br+f.color1+bc+f.color2+bl+f.color2+";right:1px;top:2px;line-height:1px;height:1px;width:"+(3-(c*2))+"px;";a[6].style.cssText=commcss+br+f.color1+bc+f.color1+bl+f.color1+";right:0px;top:3px;line-height:1px;height:1px;width:"+(3-(c*2))+"px;"},show:function(d){var f=this,c=f.get_border_space();var e=("object"==typeof(d))?d:document.getElementById(d);if(null==e){return"invalid element"}else{var b,a;if((null==e.shadow_ex)||(e.shadow_ex.magic!="shadow_ex")){f._create(e)}b=e.shadow_ex.panel;if(b.parentNode!=e.parentNode){if(b.parentNode){b.parentNode.removeChild(b)}e.parentNode.insertBefore(b,e)}b.style.zIndex=e.style.zIndex;b.style.display="block";b.style.left=(e.offsetLeft-3)+"px";b.style.top=e.offsetTop+"px";b.style.width=(e.offsetWidth+6)+"px";b.style.height=(e.offsetHeight+3)+"px";a=e.shadow_ex.lines;a[0].style.width=(e.offsetWidth+2)+"px";a[1].style.height=(e.offsetHeight-1)+"px";a[2].style.height=(e.offsetHeight-2)+"px";a[3].style.height=(e.offsetHeight)+"px";a[4].style.height=(e.offsetHeight-1)+"px";a[5].style.height=(e.offsetHeight-2)+"px";a[6].style.height=(e.offsetHeight)+"px";return""}},hide:function(b){var a,c=("object"==typeof(b))?b:document.getElementById(b);if((null==c)||(null==c.shadow_ex)||(c.shadow_ex.magic!="shadow_ex")){return"invalid element"}if(c.shadow_ex.panel){if(c.shadow_ex.panel.parentNode){c.shadow_ex.panel.parentNode.removeChild(c.shadow_ex.panel)}delete c.shadow_ex.panel}c.shadow_ex=null}};function shadow_background(a){this.create(a)}shadow_background.prototype={magic:"shadow_background",get_default_skin:function(){return{vertical:true,bg:"#fff",alpha:0.9,start:{size:16,alpha:0.01,mod:0.98,sub:0.03},end:{size:0,alpha:0.15,mod:0.93,sub:0.04}}},create:function(a){this.parent=a.parent;this.skin=this.get_default_skin();if("object"==typeof(a.skin)){obj_merge(this.skin,a.skin)}if(0<this.skin.start.size){this.parent.insertBefore(this.start=document.createElement("div"),this.parent.firstChild)}this.parent.insertBefore(this.main=document.createElement("div"),this.parent.firstChild);if(0<this.skin.end.size){this.parent.insertBefore(this.end=document.createElement("div"),this.parent.firstChild)}this.update()},destroy:function(){if(this.start_lines){this.start_lines.destroy();delete this.start_lines}if(this.start){this.start.parentNode.removeChild(this.start);delete this.start}if(this.main){this.main.parentNode.removeChild(this.main);delete this.main}if(this.end_lines){this.end_lines.destroy();delete this.end_lines}if(this.end){this.end.parentNode.removeChild(this.end);delete this.end}},update:function(){var f,c=this.skin,a=c.vertical,e=0,b=this.parent.clientWidth,d=this.parent.clientHeight;if(this.start){f=c.start;this.start.style.cssText="position:absolute;left:0px;top:0px;width:"+(a?b:f.size)+"px;height:"+(a?f.size:b)+"px;";e+=f.size;if(null==this.start_lines){this.start_lines=new shadow_lines({parent:this.start,skin:{from:(a?"bottom":"right"),head_line:{size:0},lines:{bg:c.bg,alpha:{start:c.alpha,end:f.alpha,mod:f.mod,sub:f.sub}}}})}else{this.start_lines.update()}}this.main.style.cssText="position:absolute;left:"+(a?0:e)+"px;top:"+(a?e:0)+"px;width:"+(a?b:(b-e-c.end.size))+"px;height:"+(a?(d-e-c.end.size):d)+"px;background:"+c.bg+";"+hack.css_alpha(c.alpha);if(this.end){f=c.end;this.end.style.cssText="position:absolute;bottom:0px;"+(a?"left:0px;":"right:0px;")+"width:"+(a?b:f.size)+"px;height:"+(a?f.size:d)+"px;";if(null==this.end_shadow_lines){this.end_shadow_lines=new shadow_lines({parent:this.end,skin:{from:(a?"top":"left"),head_line:{size:0},lines:{bg:c.bg,alpha:{start:c.alpha,end:f.alpha,mod:f.mod,sub:f.sub}}}})}else{this.end_shadow_lines.update()}}}};var global_z_index=0;function window_box(a){this.create(a)}window_box.prototype={magic:"window_box",z_index:0,langs:{cn:{close:"关闭"},en:{close:"close"}},get_default_skin:function(){return{drag:true,close:true,shadow:true,modal:false,width:640,height:480,bg:{alpha:1,color:"",shadow_color:"#6699cc",matrix_3x3:{stretch:{left:6,top:26,bottom:6,right:6},srcs:["images/window-box-bg-0-0.gif","images/window-box-bg-0-1.gif","images/window-box-bg-0-2.gif","images/window-box-bg-1-0.gif","images/window-box-bg-1-1.gif","images/window-box-bg-1-2.gif","images/window-box-bg-2-0.gif","images/window-box-bg-2-1.gif","images/window-box-bg-2-2.gif"]},mask:{alpha:0.32,color:"#999"}},font:"12px 宋体",head:{height:24,pad:0,split_line_size:0,icon:{size:24,src:"images/sphere.gif"},loading:{size:24,src:"images/loading.gif"},close:{width:40,height:16,right:6,bg:"",focus_bg:"#e66 url(images/close-red-bg.gif)",color:"#eee",focus_color:"#fff",font:"12px biondi,Arial Black,Bodoni MT Black"}},body:{pad:4,shadow:true}}},create:function(f){var b,e,g,a,d=this;this.parent=f.parent;this.skin=obj_merge(this.get_default_skin(),f.skin||{});this.bs=hack.get_border_space();this.on_status=f.on_status;if(this.skin.modal){document.body.appendChild(this.mask=document.createElement("div"))}this.panel=document.createElement("div");this.panel.style.cssText="display:none";if(this.skin.bg.matrix_3x3){this.panel.appendChild(this.bg_matrix_3x3=document.createElement("div"));this.bg_matrix_3x3_imgs=[];for(b=0;b<(3*3);++b){this.bg_matrix_3x3.appendChild(this.bg_matrix_3x3_imgs[this.bg_matrix_3x3_imgs.length]=document.createElement("img"))}}this.panel.appendChild(this.head=document.createElement("div"));this.panel.appendChild(this.body=document.createElement("div"));this.head.appendChild(this.head_bg=document.createElement("div"));this.head.appendChild(this.icon=document.createElement("img"));this.icon.src=this.skin.head.icon.src;if(this.skin.close){var c=function(l){d.on_close_event(l||window.event)};this.head.appendChild(this.close=document.createElement("div"));this.close.onmouseover=c;this.close.onmouseout=c;this.close.onclick=c;this.close.title=this.lang.close}this.head.appendChild(this.caption=document.createElement("span"));if(undefined!=global_z_index){d.z_index=global_z_index}if(this.skin.drag){this.panel.onmousedown=function(l){d.on_event(l||window.event)}}(this.parent||document.body).appendChild(this.panel);if(this.mask){(this.parent||document.body).insertBefore(this.mask,this.panel)}this.update();if(f.is_hide){this.hide()}if(f.caption){this.set_caption(f.caption)}},destroy:function(){if(this.head_shadow_lines){this.head_shadow_lines.destroy();delete this.head_shadow_lines}if(this.bg_matrix_3x3_imgs){for(var a=0;a<(3*3);++a){this.bg_matrix_3x3_imgs[a].parentNode.removeChild(this.bg_matrix_3x3_imgs[a]);this.bg_matrix_3x3_imgs[a]=null}delete this.bg_matrix_3x3_imgs}if(this.bg_matrix_3x3){this.bg_matrix_3x3.parentNode.removeChild(this.bg_matrix_3x3);delete this.bg_matrix_3x3}this.panel.innerHTML="";this.panel.parentNode.removeChild(this.panel);if(this.mask){this.mask.parentNode.removeChild(this.mask);delete this.mask}},update:function(){var m,p=this.skin,c=null,n=null,l,b=(this.parent?this.parent.clientWidth:p.width);height=(this.parent?this.parent.clientHeight:p.height);body_top=p.head.height+p.body.pad,body_width=b-(2*p.body.pad),body_height=height-body_top-p.body.pad;if(this.mask){this.mask.style.cssText="position:fixed;display:block;left:0px;top:0px;padding:0px;margin:0px;display:block;width:100%;height:100%;background:"+p.bg.mask.color+";"+hack.css_alpha(p.bg.mask.alpha)}if(p.right){n=p.right}else{c=this.parent?0:(((undefined!=p.left)&&(null!=p.left))?p.left:((this.panel.parentNode.clientWidth-b)/2));if(c<0){c=0}}l=this.parent?0:(((undefined!=p.top)&&(null!=p.top))?p.top:((this.panel.parentNode.clientHeight-height)/2));if(l<0){l=0}this.panel.style.cssText="position:absolute;"+(n?("right:"+n):("left:"+c))+"px;top:"+l+"px;width:"+b+"px;height:"+height+"px;z-index:"+this.z_index+";"+((p.font&&(""!=p.font))?("font:"+p.font+";"):"");alpha=p.bg.alpha;if(this.bg_matrix_3x3){var f,a=[0,p.bg.matrix_3x3.stretch.left,b-p.bg.matrix_3x3.stretch.right],d=[a[1],a[2]-a[1],p.bg.matrix_3x3.stretch.right],o=[0,p.bg.matrix_3x3.stretch.top,height-p.bg.matrix_3x3.stretch.bottom],g=[o[1],o[2]-o[1],p.bg.matrix_3x3.stretch.bottom];this.bg_matrix_3x3.style.cssText="position:absolute;left:0px;top:0px;width:"+b+"px;height:"+height+"px;background-color:"+p.bg.color+";"+hack.css_alpha(alpha)+"-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5px;"+hack.css_box_shadow(8,p.bg.shadow_color);for(f=0;f<(3*3);++f){this.bg_matrix_3x3_imgs[f].src=p.bg.matrix_3x3.srcs[f];this.bg_matrix_3x3_imgs[f].style.cssText="position:absolute;left:"+a[f%3]+"px;top:"+o[Math.floor(f/3)]+"px;width:"+d[f%3]+"px;height:"+g[Math.floor(f/3)]+"px;"}}this.head.style.cssText="position:absolute;left:0px;top:0px;width:"+b+"px;height:"+p.head.height+"px;";alpha=0.01;this.head_bg.style.cssText="position:absolute;background:#fff;left:0px;top:0px;width:"+b+"px;height:"+p.head.height+"px;"+hack.css_alpha(alpha);this.body.style.cssText="position:absolute;outline:none;left:"+p.body.pad+"px;top:"+body_top+"px;width:"+body_width+"px;height:"+body_height+"px;";this.icon.style.cssText="position:absolute;display:none;left:"+p.head.pad+"px;top:"+p.head.pad+"px;width:"+p.head.icon.size+"px;height:"+p.head.icon.size+"px;";this.caption.style.cssText="position:absolute;display:inline-block;left:"+((p.head.pad*2)+((p.head.loading.size>p.head.icon.size)?p.head.loading.size:p.head.icon.size))+"px;top:"+p.head.pad+"px;height:"+p.head.icon.size+"px;line-height:"+p.head.icon.size+"px;";if(this.close){var e=p.head.close;alpha=1;this.close.style.cssText="text-align:center;float:right;position:relative;cursor:pointer;background:"+e.bg+";top:0px;right:"+e.right+"px;color:"+e.color+";font:"+e.font+";height:"+e.height+"px;line-height:"+e.height+"px;width:"+e.width+"px;"+hack.css_alpha(alpha);this.close.innerHTML="<span style='display:block;'>X</span>"}},on_event:function(b){switch(b.type){case"mousedown":var a=b.target?b.target:b.srcElement;for(;a&&(a!=this.close);a=a.parentNode){if(a===this.head){drag(this.panel,b,null,null);break}}this.show();if(this.on_status){this.on_status("mousedown")}break}},on_close_event:function(d){var a=false;switch(d.type){case"click":if(this.on_status){this.on_status("close")}break;case"mouseover":a=true;case"mouseout":var b=this.close.style,c=this.skin.head.close;b.background=a?c.focus_bg:c.bg;b.color=a?c.focus_color:c.color;break}},get_body:function(){return this.body},get_head:function(){return this.head},get_caption:function(){return this.caption},set_caption:function(a){this.caption.innerHTML=a},set_icon:function(a){this.icon.src=a},show:function(){if(undefined!=global_z_index){this.z_index=++global_z_index;this.panel.style.zIndex=this.z_index;if(this.mask){this.mask.style.zIndex=this.z_index}}if(this.panel.style.visibility=="hidden"){this.panel.style.visibility="";if(this.mask){this.mask.style.visibility=""}}},hide:function(){this.panel.style.visibility="hidden";if(this.mask){this.mask.style.visibility="hidden"}},get_z_index:function(){return this.z_index},set_pos:function(a){this.skin.left=a.left;this.skin.top=a.top;this.panel.style.left=a.left+"px";this.panel.style.top=a.top+"px"}};window_box.prototype.lang=lang_get(window_box.prototype.langs);var tooltip_ex={magic:"tooltip_ex",arrow_size:12,arrow_left:10,skin:{bd_cl:"#699",bg_cl:"#cff",cl1:"#ddd",cl2:"#bbb",cl3:"#999",opacity:0.5},get_border_space:function(){if((undefined==window.hack)||(undefined==window.hack.border_space)){var a=document.createElement("div");a.style.cssText="width:3px;border:1px solid white;";document.body.appendChild(a);window.hack.border_space=((a.offsetWidth-3)/2);document.body.removeChild(a)}return window.hack.border_space},create:function(c){var x=this,l,p,m,e=x.arrow_left,r=x.skin;var t=x.get_border_space();var f=";background-color:",b=";border-left:1px solid ",s=";border-top:1px solid ",v=";border-right:1px solid ",g=";border-bottom:1px solid ";var d=document.createElement("div");var u=document.createElement("div");var a=hack.css_alpha(r.alpha);var n="position:relative;overflow:hidden;";var o=n+a;var q="position:absolute;overflow:hidden;"+a;d.style.cssText="position:absolute;width:320px;left:0px;top:0px;";u.style.cssText="position:relative;display:inline-block !important;zoom:1;display:inline;border:1px solid "+r.bd_cl+f+r.bg_cl+";font-size:12px;padding:4px;";c.tooltip_ex={magic:"tooltip_ex",free:false,el:c,html:"",tip_div:d,hint_div:u,hint_shadow_divs:[],arrow_divs:[]};d.appendChild(u);if(d.attachEvent){d.attachEvent("onmouseover",function(y){c.tooltip_ex.free=false});d.attachEvent("onmouseout",function(y){c.tooltip_ex.free=true;x.destroy(c)})}else{d.addEventListener("mouseover",function(y){c.tooltip_ex.free=false},false);d.addEventListener("mouseout",function(y){c.tooltip_ex.free=true;x.destroy(c)},false)}document.body.appendChild(d);p=c.tooltip_ex.hint_shadow_divs;for(i=0;i<7;++i){d.appendChild(p[i]=document.createElement("div"))}p[0].style.cssText=q+g+r.cl1+f+r.cl2+s+r.cl3+";height:"+(3-(t*2))+"px;line-height:1px;";p[1].style.cssText=q+b+r.cl1+f+r.cl2+v+r.cl3+";width:"+(3-(t*2))+"px;";p[2].style.cssText=q+b+r.cl1+f+r.cl2+v+r.cl2+";line-height:1px;height:1px;width:"+(3-(t*2))+"px;";p[3].style.cssText=q+b+r.cl1+f+r.cl1+v+r.cl1+";line-height:1px;height:1px;width:"+(3-(t*2))+"px;";p[4].style.cssText=q+v+r.cl1+f+r.cl2+b+r.cl3+";width:"+(3-(t*2))+"px;";p[5].style.cssText=q+v+r.cl1+f+r.cl2+b+r.cl2+";line-height:1px;height:1px;width:"+(3-(t*2))+"px;";p[6].style.cssText=q+v+r.cl1+f+r.cl1+b+r.cl1+";line-height:1px;height:1px;width:"+(3-(t*2))+"px;";p=c.tooltip_ex.arrow_divs;for(i=0;i<x.arrow_size;++i){d.appendChild(p[i*2]=(l=document.createElement("div")));l.style.cssText=n+"left:"+x.arrow_left+"px;top:"+(-i-1)+"px;"+b+r.bd_cl+f+r.bg_cl+v+r.bd_cl+";line-height:1px;height:1px;width:"+((x.arrow_size-i+1)-(t*2))+"px;";d.appendChild(p[(i*2)+1]=(l=document.createElement("div")));l.style.cssText=o+"left:"+(x.arrow_left+x.arrow_size-i)+"px;top:"+(-i-1)+"px;"+b+r.cl3+f+r.cl2+v+r.cl1+";line-height:1px;height:1px;width:"+(3-(t*2))+"px;"}},destroy:function(a){function c(f){var d,e,l=f.tooltip_ex,g=f.tooltip_ex.tip_div;l.free=false;l.magic="";g.style.display="none";e=l.arrow_divs;for(d=(e.length-1);0<=d;--d){g.removeChild(e[d]);e[d]=null}l.arrow_divs=null;e=l.hint_shadow_divs;for(d=(e.length-1);0<=d;--d){g.removeChild(e[d]);e[d]=null}l.hint_shadow_divs=null;l.hint_div.innerHTML="";g.removeChild(l.hint_div);l.hint_div=null;l.tip_div=null;l.el=null;g.tooltip_ex=null;g.parentNode.removeChild(g);f.tooltip_ex=null}var b=a.tooltip_ex;setTimeout(function(){if((null!=b)&&("tooltip_ex"==b.magic)&&(null!=b.tip_div)&&(null!=b.tip_div.parentNode)&&b.free){c(a)}},1000)},update:function(tip){var el=tip.el,divs=tip.hint_shadow_divs,hint_div=tip.hint_div;var el_l=0,el_t=0,l=0,t=0,h=hint_div.offsetHeight,w=hint_div.offsetWidth;t=el.offsetTop+el.offsetHeight;while(el=el.offsetParent){t+=el.offsetTop}l=(el=tip.el).offsetLeft;while(el=el.offsetParent){l+=el.offsetLeft}with(tip.tip_div.style){left=(l)+"px";top=(t-hint_div.offsetHeight)+"px"}l=0;t=0;with(divs[0].style){left=(l)+"px";top=(t+h)+"px";width=(w)+"px"}with(divs[1].style){left=(l-3)+"px";top=(t+3)+"px";height=(h-2)+"px"}with(divs[2].style){left=(l-3)+"px";top=(t+h+1)+"px"}with(divs[3].style){left=(l-3)+"px";top=(t+h+2)+"px"}with(divs[4].style){left=(l+w)+"px";top=(t+3)+"px";height=(h-2)+"px"}with(divs[5].style){left=(l+w)+"px";top=(t+h+1)+"px"}with(divs[6].style){left=(l+w)+"px";top=(t+h+2)+"px"}},set_hint:function(e,c){if(e.html!=c){var d=this,b,f,a;e.hint_div.innerHTML=c;f=e.hint_div.getElementsByTagName("img");for(i=0,a=f.length;i<a;++i){b=f[i];if(b.attachEvent){b.attachEvent("onload",function(g){d.update(e)})}else{b.addEventListener("load",function(g){d.update(e)},false)}}e.html=c;d.update(e)}},show:function(b,a){var d=this;var c=("object"==typeof(b))?b:document.getElementById(b);if((null==a)||(""==a)){if(c.tooltip_ex&&("tooltip_ex"==c.tooltip_ex.magic)){c.tooltip_ex.free=true;d.destroy(c)}}else{if(c&&((null==c.tooltip_ex)||("tooltip_ex"!=c.tooltip_ex.magic))){d.create(c)}if(c&&c.tooltip_ex&&("tooltip_ex"==c.tooltip_ex.magic)){d.set_hint(c.tooltip_ex,a)}}}};function menu_ex(a){this.create(a)}menu_ex.prototype={magic:"menu_ex",get_default_skin:function(){return{icon:{close:"images/right-empty.gif",open:"images/right-down.gif"},border:{size:1,color:"#369"},bg:"#9cf url(images/menu-bg.gif)",font:"12px 宋体",item:{height:26,pad:1,border:{size:0,color:"#e8e8f8",focus_color:"#88d"},bg:"",focus_bg:"#69c url(images/menu-item-bg.gif)"},split:{top:{size:1,color:"#69c"},bottom:{size:1,color:"#9cf"}}}},create:function(c){var b=this,a=function(d){b.on_kinput_event(d||window.event)};this.skin=this.get_default_skin();if("object"==typeof(c.skin)){obj_merge(this.skin,c.skin)}this.bs=hack.get_border_space();b.is_mouse_over_item=false;b.root=b.create_menu(null,c.items);b.kinput=document.createElement("input");b.kinput.type="text";b.kinput.style.cssText="display:block;border:none;background:transparent;padding:0px;margin:0px;position:absolute;left:0px;top:0px;height:1px;width:1px;";b.kinput.onkeydown=a;b.kinput.onblur=a;b.root.appendChild(b.kinput)},destroy:function(){this.kinput.onkeydown=null;this.kinput.onblur=null;this.kinput.parentNode.removeChild(this.kinput);delete this.kinput},create_menu:function(e,a){var b,d,c=this.skin;document.body.appendChild(d=document.createElement("ul"));d.menu_ex={parent_item:e,max_item_text_len:0};d.style.cssText="display:none;position:absolute;width:100px;list-style:none;margin:0px;padding:0px;background:"+c.bg+";border:"+c.border.size+"px solid "+c.border.color+";"+((c.font&&(""!=c.font))?("font:"+c.font+";"):"")+"-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5Px;"+hack.css_box_shadow(8,"#6699cc");if(a){for(b=0;b<a.length;++b){this.add_item(d,a[b])}}return d},add_item:function(b,o){var f,c,p,n,e,l,m,a,g=this,d={data:o,menu:b};if(null==b){b=this.root}b.appendChild(e=document.createElement("li"));e.menu_ex=d;if("-"==o.caption){n=this.skin.split;e.style.cssText="line-height:0px;height:0px;border-top:"+n.top.size+"px solid "+n.top.color+";border-bottom:"+n.bottom.size+"px solid "+n.bottom.color+";";e.innerHTML="&nbsp;";d.is_split=true}else{for(p=0,f=0;f<o.caption.length;++f){p+=1+((127<o.caption.charCodeAt(f))?1:0)}if(b.menu_ex.max_item_text_len<p){b.menu_ex.max_item_text_len=p}n=this.skin.item;c=n.pad;p=n.height-(2*n.border.size*this.bs)-(2*c);e.style.cssText="position:relative;padding-left:2px;cursor:pointer;border:"+n.border.size+"px solid "+n.border.color+";height:"+(n.height-(this.bs*2*n.border.size))+"px;";if(o.icon){d.icon=(l=document.createElement("img"));l.src=o.icon;l.style.cssText="position:absolute;left:"+c+"px;top:"+c+"px;height:"+p+"px;width:"+p+"px;";e.appendChild(l)}d.cap=(m=document.createElement("span"));m.style.cssText="position:absolute;left:"+(p+(c*2))+"px;top:"+c+"px;height:"+p+"px;line-height:"+p+"px;";m.innerHTML=o.caption;e.appendChild(m);if(o.items&&(0<o.items.length)){d.sub=(a=document.createElement("img"));a.src=this.skin.icon.close;a.style.cssText="position:absolute;bottom:"+(c+4)+"px;right:"+c+"px;";e.appendChild(a);e.menu_ex.sub_menu=this.create_menu(e,o.items)}e.onmouseover=function(q){g.on_item_event(q||window.event)};e.onmouseout=function(q){g.on_item_event(q||window.event)};e.onclick=function(q){g.on_item_event(q||window.event)}}return e},on_kinput_event:function(g){var c=this;switch(g.type){case"blur":if(!c.is_mouse_over_item){c.hide(null)}break;case"keydown":if(c.cur_menu){var a;switch(g.keyCode?g.keyCode:g.which){case 37:if(c.cur_menu&&c.cur_menu.menu_ex.selected_item){c.unselect_item(c.cur_menu.menu_ex.selected_item);c.hide(c.cur_menu)}break;case 39:if(c.cur_menu&&c.cur_menu.menu_ex.selected_item&&c.cur_menu.menu_ex.selected_item.menu_ex.sub_menu){var b,f,d;f=(b=c.cur_menu.menu_ex.selected_item).offsetTop;while(b=b.offsetParent){f+=b.offsetTop}d=(b=c.cur_menu.menu_ex.selected_item).offsetLeft+c.cur_menu.menu_ex.selected_item.offsetWidth-10;while(b=b.offsetParent){d+=b.offsetLeft}c.show(c.cur_menu.menu_ex.selected_item.menu_ex.sub_menu,d,f);if(a=c.get_next_item(c.cur_menu,c.cur_menu.menu_ex.selected_item)){c.select_item(a)}}break;case 40:if(a=c.get_next_item(c.cur_menu,c.cur_menu.menu_ex.selected_item)){c.select_item(a)}break;case 38:if(a=c.get_prev_item(c.cur_menu,c.cur_menu.menu_ex.selected_item)){c.select_item(a)}break;case 13:if(c.cur_menu&&c.cur_menu.menu_ex.selected_item){c.on_item_do(c.cur_menu.menu_ex.selected_item)}break}}break}},on_item_do:function(a){var b=a.menu_ex.data?a.menu_ex.data.callback:null;this.hide(null);if(b){b()}},on_item_event:function(g){var c=this,b=g.srcElement?g.srcElement:g.target;while(b&&(b.tagName.toLowerCase()!="li")){b=b.parentNode}if(b&&b.menu_ex){switch(g.type){case"click":c.on_item_do(b);break;case"mouseout":c.is_mouse_over_item=false;break;case"mouseover":c.is_mouse_over_item=true;if(b!=b.parentNode.menu_ex.selected_item){c.select_item(b);if(b.menu_ex.sub_menu){var a,f,d;f=(a=b).offsetTop;while(a=a.offsetParent){f+=a.offsetTop}d=(a=b).offsetLeft+b.offsetWidth;while(a=a.offsetParent){d+=a.offsetLeft}c.show(b.menu_ex.sub_menu,d,f)}}break}}},get_next_item:function(d,c){var a,b=(d.menu_ex.selected_item&&d.menu_ex.selected_item.nextSibling)?d.menu_ex.selected_item.nextSibling:d.firstChild;a=b;while(a&&a.menu_ex.is_split){a=a.nextSibling}if(null==a){a=d.firstChild;while(a&&(a!=b)&&a.menu_ex.is_split){a=a.nextSibling}}return a},get_prev_item:function(d,c){var a,b=(d.menu_ex.selected_item&&d.menu_ex.selected_item.previousSibling)?d.menu_ex.selected_item.previousSibling:d.lastChild;a=b;while(a&&a.menu_ex.is_split){a=a.previousSibling}if(null==a){a=d.lastChild;while(a&&(a!=b)&&a.menu_ex.is_split){a=a.previousSibling}}return a},select_item:function(a){var b=this;if(a.parentNode.menu_ex&&a.parentNode.menu_ex.selected_item){if(a.parentNode.menu_ex.selected_item.menu_ex.sub_menu){b.hide(a.parentNode.menu_ex.selected_item.menu_ex.sub_menu)}b.unselect_item(a.parentNode.menu_ex.selected_item)}a.style.border.color=b.skin.item.border.focus_color;a.style.background=b.skin.item.focus_bg;a.parentNode.menu_ex.selected_item=a},unselect_item:function(a){var b=this;a.style.border.color=b.skin.item.border.focus_color;a.style.background=b.skin.item.bg;a.parentNode.menu_ex.selected_item=null},show:function(d,c,b){var a=this;if(null==d){d=this.root}if(d.style.display.toLowerCase()!="none"){a.hide(d)}d.style.left=c+"px";d.style.top=b+"px";d.style.display="";d.style.width=(this.skin.item.height*2)+(d.menu_ex.max_item_text_len*6)+"px";if(global_z_index){d.style.zIndex=global_z_index}if(d.menu_ex.parent_item){d.menu_ex.parent_item.menu_ex.sub.src=this.skin.icon.open}a.cur_menu=d;if(d==a.root){a.kinput.style.display="";a.kinput.focus()}},hide:function(c){var b=this;if((c=((null==c)?b.root:c))&&(c.style.display.toLowerCase()!="none")){}if(c.childNodes){var a,d;for(a=0;a<c.childNodes.length;++a){if((d=c.childNodes[a]).menu_ex&&d.menu_ex.sub_menu){b.hide(d.menu_ex.sub_menu)}}}if(c.menu_ex.selected_item){b.unselect_item(c.menu_ex.selected_item)}c.style.display="none";if((b.cur_menu==c)&&c.menu_ex.parent_item&&c.menu_ex.parent_item.parentNode&&c.menu_ex.parent_item.parentNode.menu_ex){b.cur_menu=c.menu_ex.parent_item.parentNode;c.menu_ex.parent_item.menu_ex.sub.src=this.skin.icon.close}if(c==b.root){b.kinput.style.display="none"}}};function tabs(a){this.create(a)}tabs.prototype={magic:"tabs",langs:{cn:{hide:"隐藏",show:"显示"},en:{hide:"hide",show:"show"}},get_default_skin:function(){return{pad:4,vertical:false,head_visible:true,head_hidden_enable:false,caption:{height:26,width:100,pad:2,bg:"",focus_bg:"#69c url(images/menu-item-bg.gif)",border:{size:0,color:"#9cc"},line:{size:1,color:"#9cc"}},head_shadow:{size:6,arrow:{pad:0,vertical:{show:"images/right.gif",show_empty:"images/right-empty.gif",hide:"images/left.gif",hide_empty:"images/left-empty.gif"},horizontal:{show:"images/down.gif",show_empty:"images/down-empty.gif",hide:"images/up.gif",hide_empty:"images/up-empty.gif"}}},content:{pad:6,bg:"#cee",border:{size:0,color:"#9cc"}}}},create:function(d){var b=d.parent,c=this;this.parent=b;this.bs=hack.get_border_space();this.skin=this.get_default_skin();if("object"==typeof(d.skin)){obj_merge(this.skin,d.skin)}if(d&&d.items&&d.items.length){for(var a=0;a<d.items.length;++a){this.create_tab(d.items[a])}}b.appendChild(this.head=document.createElement("div"));b.appendChild(this.body=document.createElement("div"));if(this.skin.head_shadow.size>0){b.appendChild(this.head_shadow=document.createElement("div"));if(this.skin.head_hidden_enable){this.on_head_shadow_event=function(f){c.on_shadow_event(f||window.event)};this.head_shadow.onclick=this.on_head_shadow_event;this.head_shadow.onmouseover=this.on_head_shadow_event;this.head_shadow.onmouseout=this.on_head_shadow_event;this.head_shadow.appendChild(this.head_shadow_arrow=document.createElement("img"));this.head_shadow_arrow.style.cssText="display:none;"}}this.counts=0;this.items={};this.update()},destroy:function(){var b,a=this.items;for(b in a){if(a[b]){this.destroy_tab(a[b])}}if(this.head_shadow_arrow){this.head_shadow_arrow.parentNode.removeChild(this.head_shadow_arrow);delete this.head_shadow_arrow}if(this.head_shadow_lines){this.head_shadow_lines.destroy();delete this.head_shadow_lines}if(this.head_shadow){this.head_shadow.parentNode.removeChild(this.head_shadow);delete this.head_shadow}if(this.on_head_shadow_event){delete this.on_head_shadow_event}if(this.on_head_shadow_arrow_event){delete this.on_head_shadow_arrow_event}if(this.head){this.head.parentNode.removeChild(this.head);delete this.head}if(this.body){this.body.parentNode.removeChild(this.body);delete this.body}delete this.parent;delete this.items},update:function(){var u,f,t,c=this.skin.pad,d,m,g,l,a,s,r=this.bs,x=this.skin.head_visible,e=this.skin.vertical,p=this.parent;u=this.skin.caption;f=u.border;t=((c+(r*f.size))*2);g=(e?(x?u.width:0):(p.clientWidth-t))-(r*f.size*2);l=(e?(p.clientHeight-t):(x?u.height:0))-(r*f.size*2);this.head.style.cssText="border:"+((0==f.size)?"none":(f.size+"px solid "+f.color))+";background:"+u.bg+";position:absolute;"+(e?"overflow-x:hidden;overflow-y:auto;":"overflow:hidden;")+"left:"+c+"px;top:"+c+"px;width:"+g+"px;height:"+l+"px;"+(("undefined"==typeof(u.font))?"":+(("undefined"==typeof(u.font.family)?"":("font-family:"+u.font.family+";")))+(("undefined"==typeof(u.font.size)?"":("font-size:"+u.font.size+";")))+(("undefined"==typeof(u.font.color)?"":("color:"+u.font.color+";"))));if(this.head_shadow){u=this.skin.head_shadow;a=e?u.size:(p.clientWidth-(2*c));s=e?(p.clientHeight-(2*c)):u.size;this.head_shadow.style.cssText="border:"+((0==f.size)?"none":(f.size+"px solid "+f.color))+";position:absolute;left:"+(c+(e?g:0))+"px;top:"+(c+(e?0:l))+"px;width:"+a+"px;height:"+s+"px;"+(("undefined"==typeof(u.font))?"":+(("undefined"==typeof(u.font.family)?"":("font-family:"+u.font.family+";")))+(("undefined"==typeof(u.font.size)?"":("font-size:"+u.font.size+";")))+(("undefined"==typeof(u.font.color)?"":("color:"+u.font.color+";"))));if(null==this.head_shadow_lines){this.head_shadow_lines=new shadow_lines({parent:this.head_shadow,skin:{from:(e?"left":"top"),head_line:{size:0}}})}else{this.head_shadow_lines.update()}if(this.head_shadow_arrow){var o=e?this.skin.head_shadow.arrow.vertical:this.skin.head_shadow.arrow.horizontal;this.head_shadow_arrow.src=x?o.hide_empty:o.show_empty;this.head_shadow_arrow.style.cssText="position:absolute;z-index:1;"+((e?"top":"left")+":50%;")+((x?(e?"left":"top"):(e?"right":"bottom"))+":0px;");this.head_shadow.style.cursor="pointer";this.head_shadow.title=x?this.lang.hide:this.lang.show}}u=this.skin.content;f=u.border;t=((c+(this.bs*f.size))*2);d=(e?(g+this.skin.head_shadow.size):0)+c;m=(e?0:(l+this.skin.head_shadow.size))+c;a=p.clientWidth-d-c;s=p.clientHeight-m-c;this.body.style.cssText="border:"+((0==f.size)?"none":(f.size+"px solid "+f.color))+";background:"+u.bg+";position:absolute;left:"+d+"px;top:"+m+"px;width:"+a+"px;height:"+s+"px;"+(("undefined"==typeof(u.font))?"":+(("undefined"==typeof(u.font.family)?"":("font-family:"+u.font.family+";")))+(("undefined"==typeof(u.font.size)?"":("font-size:"+u.font.size+";")))+(("undefined"==typeof(u.font.color)?"":("color:"+u.font.color+";"))));for(var b in this.items){var q=this.items[b];if((undefined!=q)&&(null!=q)){this.update_tab(q)}}},get_tab:function(a){return this.items[a]},create_tab:function(f){var b,a,e=this,c={name:f.name,twinkle_timer:null},d=function(g){e.on_tab_event(g||window.event,c)};c.caption=(b=document.createElement("span"));b.onclick=d;b.onmouseover=d;b.onmouseout=d;this.head.appendChild(b);c.content=(a=document.createElement("div"));this.body.appendChild(a);this.items[f.name]=c;++this.counts;this.set_caption(c,f.caption,f.icon);c.on_cmd=f.on_cmd;this.update_tab(c);if(1==this.counts){e.set_active_tab(c)}return c},destroy_tab:function(b){var a=b.name;if(this.active_tab==b){this.active_tab=null}if(b.twinkle_timer){clearInterval(b.twinkle_timer);b.twinkle_timer=null}if(b.caption){b.caption.innerHTML="";b.caption.parentNode.removeChild(b.caption);b.caption=null}if(b.content){b.content.parentNode.removeChild(b.content);b.content=null}delete this.items[a];--this.counts},set_caption:function(f,c,e){var d=("string"==typeof(f))?this.items.list[f]:f;if(d){var l=this.skin.caption;var b=(l.height-(l.pad*2));var a=((null==e)||(0==e.length))?"":("<img style='border:none;width:"+b+"px;height:"+b+"px;' src='"+e+"'/>")+"&nbsp;";var g="<span style='display:inline-block;position:absolute;left:"+l.height+"px;top:0px;height:"+b+"px;line-height:"+b+"px;vertical-align:top;'>"+c+"</span>";d.caption.innerHTML=a+g;d.caption.title=c}},update_tab:function(b){var q,g,r,f,d,m,a,p,c,o,n=this.bs,e=this.skin.vertical,l=(b==this.active_tab);q=this.skin.caption;r=q.line;c=q.pad;o=c*n*2;g=(((1<this.items.counts)&&(0<r.size))?r.size:0);a=(e?q.width:(q.width-(n*g)))-o;p=(e?(q.height-(n*g)):q.height)-o;b.caption.style.cssText="display:inline-block;white-space:nowrap;cursor:pointer;position:relative;padding:"+c+"px;"+(g?("border-"+(e?"top":"left")+":"+g+"px solid "+r.color+";"):"")+"width:"+a+"px;height:"+p+"px;"+(l?("background:"+this.skin.content.bg+";"):"")+(l?("fontWeight:bold;"):"")+"line-height:"+q.height+"px;";q=this.skin.content;f=q.border;c=q.pad;o=(c+(f.size*n))*2;b.content.style.cssText="border:"+((0==f.size)?"none":(f.size+"px solid "+f.color))+";background:"+q.bg+";display:block;position:absolute;"+(l?"z-index:1;":"z-index:0;visibility:hidden;")+"left:"+c+"px;top:"+c+"px;width:"+(this.body.clientWidth-o)+"px;height:"+(this.body.clientHeight-o)+"px;";if(b.on_cmd){b.on_cmd(b,"update")}},on_shadow_event:function(g){var f=false;switch(g.type){case"click":this.skin.head_visible=!this.skin.head_visible;this.update();break;case"mouseover":f=true;case"mouseout":var d=this.skin.head_shadow,a=this.skin.head_visible,b=this.skin.vertical,c=b?d.arrow.vertical:d.arrow.horizontal;this.head_shadow_arrow.src=a?c.show_empty:c.hide_empty;this.head_shadow_arrow.src=a?(f?c.hide:c.hide_empty):(f?c.show:c.show_empty);this.head_shadow_arrow.style[(a?(b?"left":"top"):(b?"right":"bottom"))]=(a?"":"-")+(f?(d.arrow.pad+d.size):0)+"px";this.head_shadow_lines.set_focus(f);break}},on_tab_event:function(e,tab){switch(e.type){case"mouseover":if(this.active_tab!=tab){with(tab.caption.style){background=this.skin.caption.focus_bg}}break;case"mouseout":if(this.active_tab!=tab){with(tab.caption.style){background=""}}break;case"click":this.set_active_tab(tab);break}},set_active_tab:function(b){var a=("string"==typeof(b))?this.items[b]:b;if(a&&(this.active_tab!=a)){if(this.active_tab){this.active_tab.content.style.zIndex=0;this.active_tab.content.style.visibility="hidden";this.active_tab.caption.style.background="";this.active_tab.caption.style.fontWeight="";if(this.active_tab.on_cmd){this.active_tab.on_cmd(b,"deactive")}}if(a.twinkle_timer){clearInterval(a.twinkle_timer);a.twinkle_timer=null}a.content.style.zIndex=1;a.content.style.visibility="";a.caption.style.background=this.skin.content.bg;a.caption.style.fontWeight="bold";this.active_tab=a;if(b.on_cmd){b.on_cmd(b,"active")}}},set_twinkle_tab:function(b){var a=("string"==typeof(b))?this.items[b]:b;if(a&&(this.active_tab!=a)&&(null==a.twinkle_timer)){a.twinkle_timer=setInterval(function(){a.caption.style.fontWeight=(""==a.caption.style.fontWeight)?"bold":""},500)}}};tabs.prototype.lang=lang_get(tabs.prototype.langs);function tag_tree(a){this.create(a)}tag_tree.prototype={magic:"tree_view",langs:{cn:{no_tag:"其他"},en:{no_tag:"other"}},get_default_skin:function(){return{pad:4,expand:true,focus_bg:"#69c",selected_bg:"#CBE7FC",selected_cap_height_multiple:1.5,line:{size:0,color:"#9cc"},caption:{height:32,pad:2},tag:{height:20},font:{height:16},item_visible:true,icon:{status_size:12,close:"images/right-empty.gif",open:"images/right-down.gif",tag:"",item:"images/item.png"}}},create:function(c){var b;this.parent=c.parent;this.bs=hack.get_border_space();this.skin=obj_merge(this.get_default_skin(),c.skin||{});this.on_update_label=c.on_update_label;this.parent.appendChild(b=document.createElement("ul"));b.style.cssText="list-style:none;margin:0px;padding:0px;";this.root={view:{ul:b},counts:0,items:{},hide_counts:0,twinkle_counts:0};if(c.on_event){this.on_event=c.on_event}this.show_prior=!c.hide_prior?true:false;if(c&&c.items&&c.items.length){for(var a=0;a<c.items.length;++a){this.add(c.items[a])}}},destroy:function(){if(this.root){this.destroy_item(this.root)}this.parent=null;this.on_event=null;this.root=null;this.no_tag=null},clear_all:function(){var a;this.destroy_item(this.root);this.parent.appendChild(a=document.createElement("ul"));a.style.cssText="list-style:none;margin:0px;padding:0px;";this.root={view:{ul:a},counts:0,items:{},hide_counts:0}},destroy_item:function(o){var a,g;if(o==this.selected_item){this.selected_item=null}for(a in o.items){g=o.items[a];if((undefined!=g)&&(null!=g)){this.destroy_item(g)}}if(o.parent&&o.parent.items){var b=o.id?o.id:(""+o.text);delete o.parent.items[b];--o.parent.counts}if(o.timer){clearInterval(o.timer);o.timer=null}if(o.view){var d=o.view,l=d.li,c=d.ul,m=d.caption,e=d.label,f=d.arrow;if(f){f.parentNode.removeChild(f);d.arrow=null}if(e){e.parentNode.removeChild(e);d.caption=null}if(m){m.parentNode.removeChild(m);d.caption=null}if(c){c.parentNode.removeChild(c);d.ul=null}if(l){l.parentNode.removeChild(l);d.li=null}o.view=null}o.items=null},load_img:function(a){var c,d,b;for(d in a.items){c=a.items[d];if(c.id){b=c.view.label.getElementsByTagName("img")[0];if(!b.src){b.src=c.icon||this.skin.icon.item}}}},open_tag:function(b,a){if(a===false){b.view.expand=false;b.view.ul.style.display="none";if(b.view.arrow){b.view.arrow.src=this.skin.icon.close}}else{b.view.expand=true;b.view.ul.style.display="";if(b.view.arrow){b.view.arrow.src=this.skin.icon.open}this.load_img(b);this.sort_label(b)}},create_tag:function(o,l,f){var m=this.root;if(0<o.length){var a,b,d=o.length,e=0,g,n=null;do{b=e;for(g=o.charAt(e);("/"!=g)&&("\\"!=g);g=o.charAt(e)){if((++e)>=d){break}}if(e>b){a=o.substring(b,e)+" ";n=m.items[a];if(null==n){n={text:a,counts:0,items:{},parent:m,hide_counts:0,twinkle_counts:0,prior:l||0};m.items[a]=n;++m.counts;this.on_add(n);this.open_tag(n,!!f)}m=n}}while((++e)<d)}return m},del_tag:function(a){var f=this.root;if(0<a.length){var d,m,b=a.length,e=0,l,g=null;do{m=e;for(l=a.charAt(e);("/"!=l)&&("\\"!=l);l=a.charAt(e)){if((++e)>=b){break}}if(e>m){d=a.substring(m,e)+" ";if(g=f.items[d]){this.destroy_item(g)}}}while((++e)<b)}},add_item:function(a,c){var b=a.items[c.id];if(b){b.text=c.text||b.text;b.data=c.data||b.data;b.icon=c.icon||b.icon;this.update_label(b)}else{b={text:c.text,id:c.id,data:c.data,icon:c.icon,parent:a,prior:0};a.items[c.id]=b;++a.counts;this.on_add(b)}return b},del_item:function(a,c){var e,b,d=a.counts;if(null==a||null==a.items||null==c){return}for(e in a.items){b=a.items[e];if((undefined!=b)&&(null!=b)){if(undefined==b.id){this.del_item(b,c)}else{if(b.id==c){this.destroy_item(b)}}}}if((a==this.root)){return}if(a.counts==0){this.destroy_item(a)}else{if(d!=a.counts){this.update_label(a)}}},oper_item:function(a,c,e){var f,b,d=a.counts;if(null==a||null==a.items||null==c){return}for(f in a.items){if(b=a.items[f]){if(undefined==b.id){this.oper_item(b,c,e)}else{if(b.id===c){e(b)}}}}if(a==this.root){return}if(a.counts==0){this.destroy_item(a)}else{this.update_label(a)}},find_item:function(a,b){var c=false;function d(e){c=true}this.oper_item(a,b,d);return c},add:function(l){var o=l.tags,n=null,e=((null!=l.id)&&(null!=l.text));var b;if(0<o.length){var p,d,f=o.length,g=0,m,a=null;do{d=g;for(m=o.charAt(g);(","!=m)&&(" "!=m)&&("\t"!=m)&&("\r"!=m)&&("\n"!=m);m=o.charAt(g)){if((++g)>=f){break}}if(g>d){p=o.substring(d,g);if(e){n=this.add_item((b=this.create_tag(p,l.tag_prior||0,l.tag_open)),l)}}}while((++g)<f)}if(e&&(null==n)){if(null==this.no_tag){this.no_tag=this.create_tag(this.lang.no_tag)}else{if(this.no_tag.items==null){this.del_tag(this.lang.no_tag);this.no_tag=this.create_tag(this.lang.no_tag)}}n=this.add_item(this.no_tag,l)}},add_prior:function(a,c,b){var e=this;var f=b||1;function d(g){g.prior+=f;e.update_label(g)}this.oper_item(a,c,d)},del_prior:function(a,c){var d=this;function b(e){e.prior--;if(e.prior<0){e.prior=0}d.update_label(e)}this.oper_item(a,c,b)},clear_prior:function(a,b){var d=this;function c(e){e.prior=0;d.update_label(e)}this.oper_item(a,b,c)},set_twinkle:function(a,b){function c(d){if(null==d){return}if(d.timer){clearInterval(d.timer)}else{d.parent.twinkle_counts++}d.timer=setInterval(function(){var e=d.view.label.getElementsByTagName("img")[0];if(e.style.left=="3px"){e.style.left="0px";e.style.top="0px"}else{e.style.left="3px";e.style.top="1px"}},250)}this.oper_item(a,b,c)},clear_twinkle:function(b){function a(c){if(c.timer){clearInterval(c.timer);img=c.view.label.getElementsByTagName("img")[0];img.style.left="0px";img.style.top="0px";c.timer=null;c.parent.twinkle_counts--}}this.oper_item(this.root,b,a)},clear_tags:function(d){if(0<d.length){var a,l,b=d.length,e=0,g,f=null;do{l=e;for(g=d.charAt(e);(","!=g)&&(" "!=g)&&("\t"!=g)&&("\r"!=g)&&("\n"!=g);g=d.charAt(e)){if((++e)>=b){break}}if(e>l){a=d.substring(l,e);this.del_tag(a)}}while((++e)<b)}},update_label:function(c,l){var b,e,d=this.skin;if(this.on_update_label&&c.id){this.on_update_label(c)}else{var g,a="",f=parseInt(c.view.caption.style.height);if(c.id){a="&nbsp;<img style='position:relative;cursor:pointer;border:none;width:"+f+"px;height:"+f+"px;'/>"}g=c.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>&nbsp;")+((null==c.id)?("("+(c.counts-c.hide_counts)+")"):"");if(this.show_prior&&c.prior&&c.id){g+="("+c.prior+")"}e=(c.id?f:this.skin.icon.status_size)+this.skin.font.height/2;c.view.label.innerHTML=a+"&nbsp;<span style='position:absolute;left:"+(e+this.skin.font.height/2)+"px;top:"+((f-this.skin.font.height)/2+d.caption.pad)+"px;cursor:pointer;vertical-align:middle;height:"+this.skin.font.height+"px;line-height:"+this.skin.font.height+"px;'>"+g+"</span>";c.view.caption.title=g;if(!c.id){if(c.twinkle_counts&&!c.view.expand){if(!c.timer){c.timer=setInterval(function(){var m=c.view.label;if(m.style.visibility=="hidden"){m.style.visibility=""}else{m.style.visibility="hidden"}},250)}}else{if(c.view.expand&&c.timer){clearInterval(c.timer);c.view.label.style.visibility="";c.timer=null}}}}if(c.id&&c.parent.view.expand&&(b=c.view.label.getElementsByTagName("img")[0])&&!b.src){b.src=c.icon||this.skin.icon.item}if(c.view.expand&&(l=="click")){this.sort_label(c)}else{if(c.parent&&(c.parent.view.expand||(c.parent==this.root))){this.sort_label(c.parent)}}},sort_label:function(d){function b(m,l){if(m==l){return 0}if(m.status===l.status){if(m.prior===l.prior){return m.text.cmp(l.text)}else{return l.prior-m.prior}}else{return(l.status||0)-(m.status||0)}}var c,g,a=d.items,f=[];if(d.counts<=1){return}for(c in a){if(a[c]){f.push(a[c]);if(!g){g=a[c].view.li.parentNode}}}f.sort(b);for(c=f.length-1;c>=0;c--){var e=g.childNodes[c];if(e!=f[c].view.li){if(c==f.length-1){g.appendChild(f[c].view.li)}else{g.insertBefore(f[c].view.li,f[c+1].view.li)}}}},on_add:function(r){var q=this.skin,m=r.parent;if((null==r.id)||(q.item_visible)){var f,n,d,p,l,g,c,b=q.icon,e=this,s=(null==r.id),a=function(t){e.on_item_event(t||window.event,r)},o;if(null==(f=r.view)){r.view=(f={})}if(null==(n=f.li)){r.parent.view.ul.appendChild(f.li=(n=document.createElement("li")));n.item=r}c=((r.parent.parent)||(n!=r.parent.view.ul.firstChild))?q.line.size:0;this.cap_height=q.caption.height-(c*this.bs);if(0<c){n.style.borderTop=""+q.line.size+"px solid "+q.line.color}if(null==(p=f.caption)){n.appendChild(f.caption=(p=document.createElement("div")));p.onmouseover=a;p.onmouseout=a;p.onclick=a}o=r.id?this.cap_height:q.tag.height;p.style.cssText="list-style:none;margin:0px;position:relative;left:0px;top:0px;overflow:hidden;white-space:nowrap;display:block;vertical-align:middle;height:"+o+"px;line-height:"+o+"px;padding:"+q.caption.pad+"px;";if(s){if(b.close&&(""!=b.close)){p.appendChild(r.view.arrow=(l=document.createElement("img")))}l.src=r.view.expand?q.icon.close:q.icon.open;l.style.cssText="position:absolute;border:none;top:"+((o-this.skin.icon.status_size)/2+q.caption.pad)+"px;width:"+b.status_size+"px;height:"+b.status_size+"px;"}if(null==(g=f.label)){p.appendChild(f.label=(g=document.createElement("span")));g.onclick=a}if(s){if(null==(d=f.ul)){n.appendChild(f.ul=(d=document.createElement("ul")))}r.view.expand=q.expand;d.style.cssText="list-style:none;margin:0px;padding:0px;margin-left:1em;display:"+(r.view.expand?"":"none")+";"}if(r.parent.parent){this.update_label(r.parent)}this.update_label(r)}},on_item_event:function(g,f){var c,d,b;switch(g.type){case"click":var a;if(this.selected_item&&this.selected_item!==f){a=this.selected_item.view;a.caption.style.background="";if(this.selected_item.id){a.caption.style.cssText="list-style:none;margin:0px;position:relative;left:0px;top:0;overflow:hidden;white-space:nowrap;display:block;vertical-align:text-bottom;height:"+this.cap_height+"px;line-height:"+this.cap_height+"px;padding:"+this.skin.caption.pad+"px;"}}c=this.selected_item;this.selected_item=f;if(c){this.update_label(c,"click")}a=f.view;a.caption.style.background=this.skin.selected_bg;if(null==f.id){if(f.counts>f.hide_counts){this.open_tag(f,!f.view.expand)}}else{a.caption.style.cssText="list-style:none;margin:0px;position:relative;left:0px;top:0;overflow:hidden;white-space:nowrap;display:block;vertical-align:text-bottom;height:"+(this.cap_height*this.skin.selected_cap_height_multiple)+"px;line-height:"+(this.cap_height*this.skin.selected_cap_height_multiple)+"px;padding:"+this.skin.caption.pad+"px;"}this.update_label(f,"click");evt.stop(g);break;case"mouseover":f.view.caption.style.background=this.skin.focus_bg;break;case"mouseout":f.view.caption.style.background=(f==this.selected_item)?this.skin.selected_bg:"";break}if(f.id&&this.on_event){this.on_event(g,f)}},filter:function(c){var a=this;function b(d,l){var m,e,f=d.hide_counts,g;if(null==d||null==d.items){return}for(m in d.items){if(e=d.items[m]){if(undefined==e.id){b(e,l)}else{if((l=="")||(e.text.indexOf(l)>=0)){if(e.view.li.style.display=="none"){d.hide_counts--;e.view.li.style.display=""}}else{if(e.view.li.style.display==""){d.hide_counts++;e.view.li.style.display="none"}}}}}if(!a.str){d.view.orig_expand=d.view.expand}if(l){if(d.hide_counts==d.counts){if(d.view.ul.style.display==""){if(d!=a.root){d.parent.hide_counts++}d.view.expand=false;d.view.ul.style.display="none";if(d.view.arrow){d.view.arrow.src=a.skin.icon.close}}}else{if(d.view.ul.style.display=="none"){if(d!=a.root){d.parent.hide_counts--}d.view.expand=true;d.view.ul.style.display="";if(d.view.arrow){d.view.arrow.src=a.skin.icon.open}}}}else{d.view.expand=g=d.view.orig_expand||(d.view.orig_expand===undefined);d.view.ul.style.display=g?"":"none";if(d.view.arrow){d.view.arrow.src=g?a.skin.icon.open:a.skin.icon.close}d.hide_counts=0;delete d.view.orig_expand}if((d!=a.root)&&(f!=d.hide_counts)){a.update_label(d)}}b(this.root,c);this.str=c},get_item_data:function(e){var b=[];var a=[];var d;if(!e){return null}if(e.id){a[a.length]=e.data;return a}b[0]=e;for(var c=0;c<b.length;c++){e=b[c];for(var f in e.items){if((d=e.items[f])){if(d.id){a.push(d.data)}else{b.push(d)}}}}return a}};tag_tree.prototype.lang=lang_get(tag_tree.prototype.langs);function list_view(a){this.create(a||{})}list_view.prototype={get_default_skin:function(){return{font:{weight:"normal"},bd:{size:1,color:"#9cc"},header:{font:{weight:"bold"},bg:"#99BBE8",color:"#15428b",height:22,padding:2,icon:"/images/search.gif"},body:{view:"list",bg:{oddrow:"#F8F8FF",evenrow:"#FFF",select:"#DFE8F6",over:"#eee"},list:{header:{font:{weight:"normal"},bg:"#F9F9F9",height:28,bd:{size:1,color:"#DDD"}},item:{height:28}},grid:{}}}},create:function(b){this.parent=b.parent||document.body;this.columns=b.columns;this.header=b.header;this.on_event=b.on_event;this.skin=obj_merge(this.get_default_skin(),b.skin||{});this.items=[];if(b.items&&b.items.length){for(var a=0;a<b.items.length;++a){this.add_item(b.items[a])}}this.draw_view()},update:function(){if(this.view){this.view.parentNode.removeChild(this.view);this.view=null}this.draw_view()},destroy:function(){if(this.view){this.view.parentNode.removeChild(this.view)}},set_header:function(a){this.header=a},suspend_item:function(a){this.add_item(a);this.draw_view_body()},clear_all_item:function(a){this.items=[];this.draw_view_body()},add_item:function(a){this.items[this.items.length]={data:a}},draw_view:function(){if(this.view==null){this.bs=hack.get_border_space();this.td_bdv=hack.get_td_border_space_v();this.view=document.createElement("div");this.parent.appendChild(this.view);this.view._width=this.parent.clientWidth-this.skin.bd.size*2;this.view._height=this.parent.clientHeight-this.skin.bd.size*2;this.view.style.cssText="width:"+this.view._width+"px;height:"+this.view._height+"px;overflow:hidden;border:"+this.skin.bd.size+"px solid "+this.skin.bd.color+(this.skin.font.size?(";font-size:"+this.skin.font.size):"")+(this.skin.font.weight?("; font-weight:"+this.skin.font.weight):"")}this.draw_view_header();this.draw_view_body()},draw_view_header:function(){if(this.header!=null&&this.header.length>0){this.view.header=document.createElement("div");this.view.appendChild(this.view.header);this.view.header._height=this.skin.header.height-(this.skin.header.padding*2+this.skin.bd.size)*this.bs;this.view.header.style.cssText="height:"+this.view.header._height+"px; border-bottom:"+this.skin.bd.size+"px solid "+this.skin.bd.color+"; line-height:"+this.view.header._height+"px; padding:"+this.skin.header.padding+"px;width:100%;background:"+this.skin.header.bg+"; color:"+this.skin.header.color+(this.skin.header.font.size?("; font-size:"+this.skin.header.font.size):"")+(this.skin.header.font.weight?("; font-weight:"+this.skin.header.font.weight):"");this.view.header.innerHTML="<div>"+(this.skin.header.icon?('<img src="'+this.skin.header.icon+'" style="width:'+this.view.header._height+'px; vertical-align:middle; margin-right:1px;">'):"")+this.header+"</div>"}},draw_view_body:function(){if(this.view.body==null){this.view.body=document.createElement("div");this.view.appendChild(this.view.body);this.view.body._height=this.view._height-(this.view.header?this.view.header.offsetHeight:0);this.view.body.style.cssText="width:100%;"}if(this.skin.body.view=="list"){this.draw_list()}else{this.draw_grid()}},draw_list:function(){this.draw_list_header();this.draw_list_items();this.list_align()},draw_list_header:function(){if(this.view.body.header==null){this.view.body.header=document.createElement("div");this.view.body.appendChild(this.view.body.header);this.view.body.header._height=this.skin.body.list.header.height;this.view.body.header._td_height=this.skin.body.list.header.height-(this.skin.body.list.header.bd.size*2+2)*this.td_bdv;this.view.body.header.style.cssText="width:100%;"}var e=document.createElement("table"),d,b;e.style.cssText="border-collapse:collapse;border-spacing:0;";d=e.insertRow(-1);d.style.cssText="background:"+this.skin.body.list.header.bg+(this.skin.body.list.header.font.size?("; font-size:"+this.skin.body.list.header.font.size):"")+(this.skin.body.list.header.font.weight?("; font-weight:"+this.skin.body.list.header.font.weight):"")+";";b=d.insertCell(-1);b.style.cssText="height:"+this.view.body.header._td_height+"px; border-width:"+this.skin.body.list.header.bd.size+"px 0px;border-style:solid; border-color:"+this.skin.body.list.header.bd.color+";";for(var c in this.columns){b=d.insertCell(-1);b.style.cssText="border-width:"+this.skin.body.list.header.bd.size+"px 0px "+this.skin.body.list.header.bd.size+"px "+this.skin.body.list.header.bd.size+"px ;border-style:solid; border-color:"+this.skin.body.list.header.bd.color+";";b.innerHTML=this.columns[c]}this.view.body.header.innerHTML="";this.view.body.header.appendChild(e);var a=(this.view.body.header.getElementsByTagName("table"))[0];if(a.clientWidth<this.view.body.header.clientWidth){a.style.width=this.view.body.header.clientWidth+"px"}},draw_list_items:function(){if(this.view.body.items==null){this.view.body.items=document.createElement("div");this.view.body.appendChild(this.view.body.items);this.view.body.items._height=this.view.body._height-this.view.body.header.offsetHeight;this.view.body.items._td_height=this.skin.body.list.item.height-2*this.td_bdv;this.view.body.items.style.cssText="width:100%; height:"+this.view.body.items._height+"px; overflow-x:hidden; overflow-y:auto;"}var l=document.createElement("table"),g,b;l.style.cssText="border-collapse:collapse;border-spacing:0;";for(var c=0;c<this.items.length;c++){g=l.insertRow(-1);g.style.height=this.view.body.items._td_height+"px";b=g.insertCell(-1);b.style.width=this.view.body.items._td_height+"px";if(this.items[c].data.icon!=undefined){b.innerHTML+='<img src="'+this.items[c].data.icon+'" style="width:'+this.view.body.items._td_height+'px;"></img>'}for(var d in this.columns){var e=this.items[c].data[d];b=g.insertCell(-1);b.innerHTML=e||""}}this.view.body.items.innerHTML="";this.view.body.items.appendChild(l);var a=(this.view.body.items.getElementsByTagName("table"))[0];if(a.clientWidth<this.view.body.items.clientWidth){a.style.width=this.view.body.items.clientWidth+"px"}var f=(this.view.body.getElementsByTagName("tr"));for(var c=1;c<f.length;c++){this.items[c-1].obj=f[c]}for(var c=0;c<this.items.length;c++){this.regist_event_handler(c);this.update_item_bg_color(c,"normal")}},list_align:function(){var c=(this.view.body.header.getElementsByTagName("td"));var a=(this.view.body.items.getElementsByTagName("td"));if(c.length>0&&a.length>0){for(var b=0;b<c.length-1;b++){c[b].style.width=(a[b].clientWidth-3)+"px"}}this.view.body.items._height=this.view.body._height-this.view.body.header.offsetHeight;this.view.body.items.style.cssText="width:100%; height:"+this.view.body.items._height+"px; overflow-x:hidden; overflow-y:auto;"},draw_grid:function(){},update_item_bg_color:function(a,b){var c=this.items[a].obj;if(b=="normal"){if((a%2)==1){c.style.backgroundColor=this.skin.body.bg.oddrow}else{c.style.backgroundColor=this.skin.body.bg.evenrow}}else{if(b=="select"){c.style.backgroundColor=this.skin.body.bg.select}else{if(b=="over"){c.style.backgroundColor=this.skin.body.bg.over}}}},regist_event_handler:function(a){var c=this;var b=this.items[a].obj;b.onmouseover=function(d){if(c.selected_item_id!=a){c.update_item_bg_color(a,"over")}if(c.on_event){c.on_event(d?d:window.event,c.items[a].data)}};b.onmouseout=function(d){if(c.selected_item_id!=a){c.update_item_bg_color(a,"normal")}if(c.on_event){c.on_event(d?d:window.event,c.items[a].data)}};b.onclick=function(d){if(c.selected_item_id!=undefined){c.update_item_bg_color(c.selected_item_id,"normal")}c.selected_item_id=a;c.update_item_bg_color(a,"select");if(c.on_event){c.on_event(d?d:window.event,c.items[a].data)}}}};function user_file_pub(a){this.create(a)}user_file_pub.prototype={magic:"user_file_pub",langs:{cn:{caption:"上传文件",upload_failed:"文件上传失败",select_nothing:"未选择文件"},en:{caption:"upload file",upload_failed:"upload file failed",select_nothing:"please select file"}},get_default_skin:function(){return{img:{loading:"/images/loading.gif"}}},create:function(c){var a=this;this.parent=c.parent;this.type=c.req_command;this.img_src=c.img_src;this.out_width=c.width;this.out_height=c.height;this.pad=c.pad;this.extra_parms=obj_merge({MAX_FILE_SIZE:600},c.extra_parms);if(c.onsubmit){this.onsubmit=c.onsubmit}if(c.mouse_event_handle){this.mouse_event_handle=c.mouse_event_handle}if(c.success_handle){this.success_handle=c.success_handle}if(c.failed_handle){this.failed_handle=c.failed_handle}if(c.caption&&(""!=c.caption)){this.caption=c.caption}this.skin=this.get_default_skin();this.flash_flag=0;try{if(1==this.flash_flag&&typeof(preLoad)=="function"){this.flash_flag=1}else{this.flash_flag=0}}catch(b){this.flash_flag=0}if(null!=c.img_src){this.parent.appendChild(this.upload_icon=document.createElement("img"))}this.parent.appendChild(this.div_for_flash=document.createElement("div"));this.div_for_flash.style.cssText="";evt.bind(this.div_for_flash,"mouseover",function(d){if(a.mouse_event_handle){a.mouse_event_handle(a.upload_icon,true)}});evt.bind(this.div_for_flash,"mouseout",function(d){if(a.mouse_event_handle){a.mouse_event_handle(a.upload_icon,false)}});if(0==this.flash_flag){this.div_for_flash.appendChild(this.upload_iframe=document.createElement("iframe"));evt.bind(this.upload_iframe,"load",function(){a.file_iframe_onload()})}if(1==this.flash_flag){this.div_for_flash.appendChild(this.tmp_span=document.createElement("span"));this.flash_pub_create()}},destroy:function(){if(0==this.flash_flag){if(this.upload_iframe.parentNode){this.upload_iframe.parentNode.removeChild(this.upload_iframe)}this.upload_iframe=null}else{if(this.div_for_flash&&this.div_for_flash.parentNode){this.div_for_flash.parentNode.removeChild(this.div_for_flash)}this.div_for_flash=null;this.swfu=null;this.tmp_span=null}},check_flash_support:function(){if((navigator.appName=="Microsoft Internet Explorer"&&navigator.appVersion.indexOf("Mac")==-1&&navigator.appVersion.indexOf("3.1")==-1)||(navigator.plugins&&navigator.plugins["Shockwave Flash"])||navigator.plugins["Shockwave Flash 2.0"]){return 1}else{return 0}},update:function(){var a=this;if(null!=this.upload_icon){this.upload_icon.style.cssText="border:none;padding:0px;margin:0px;position:absolute;top:0px;left:"+this.pad+"px;top:"+this.pad+"px;width:"+(this.out_width-2*this.pad)+"px;height:"+(this.out_height-2*this.pad)+"px;";this.upload_icon.src=this.img_src}this.div_for_flash.style.cssText="padding:0px;margin:0px;position:absolute;left:0px;top:0px;width:"+(this.out_width-2*this.pad)+"px;height:"+(this.out_height-2*this.pad)+"px;"+hack.css_alpha(0.01);this.div_for_flash.title=this.caption||this.lang.caption;if(null!=this.upload_iframe){this.upload_iframe.style.cssText="border:none;padding:0px;margin:0px;position:absolute;left:0px;top:0px;width:"+(this.out_width-2*this.pad)+"px;height:"+(this.out_height-2*this.pad)+"px;"+hack.css_alpha(0.01);this.upload_iframe.title=this.caption||this.lang.caption;this.upload_iframe.src="";this.file_iframe_update()}if(1==this.flash_flag){}},file_iframe_onload:function(){var a=this;var b=this.upload_iframe;var c=b.contentDocument||b.contentWindow.document;if(c&&((undefined==c.readyState)||(c.readyState=="complete"))){if(1==a.file_flag){var d=c.body.innerHTML;a.file_flag=0;a.on_file_pub_ack(d)}}},on_file_pub_ack:function(msg){var me=this;var param=null;var s=msg,start=s.indexOf("("),end=s.lastIndexOf(")");if((end>(start+2))&&("{"==s.charAt(start+1))&&("}"==s.charAt(end-1))){try{param=eval(s.substring(start,end+1))}catch(err){param="error"}}if(("error"==param)||(null==param)||(null==param.data)||(0!=param.data.result)){alert(me.lang.upload_failed);if(me.failed_handle){me.failed_handle()}}else{if(undefined!=me.success_handle){me.success_handle("load",param.data.content_ex)}}me.update()},file_iframe_update:function(){var d=this,g=this.skin,l,f=0.01;var e=(this.upload_iframe.contentDocument||this.upload_iframe.contentWindow.document);var b="",a;for(a in d.extra_parms){if(undefined==a||null==a){continue}b+="<input type='hidden' name='"+a+"' value='"+d.extra_parms[a]+"'/>"}try{e.open();e.close()}catch(c){}e.body.style.cssText="padding:0px;margin:0px;border:none;overflow:hidden;";html_text="<form id='upload_form' method='post' action='"+this.type+"/-.txt' enctype='multipart/form-data' style='padding:0px;margin:0px;border:none;overflow:hidden;'><input type='file' id='dcontent' hidefocus='true' title='"+this.caption+"' style='padding:0px;margin:0px;position:absolute;left:-5px;top:0px;verflow:hidden;cursor:pointer;width:"+(this.out_width+5)+"px;height:"+(this.out_height-2*this.pad)+"px;line-height:"+(this.out_height-2*this.pad)+"px;"+hack.css_alpha(f)+"' name='dcontent' />"+b+"</form>";e.body.innerHTML=html_text;if(d.upload_iframe.style.visibility=="hidden"){d.upload_iframe.style.visibility=""}l=e.getElementById("dcontent");l.onchange=function(){var n=e.getElementById("upload_form"),o;var m=0;o=e.getElementById("dcontent");if(""==o.value){alert(d.lang.select_nothing);m=1}if(m){return}d.upload_iframe.style.visibility="hidden";n.submit();if(d.onsubmit){d.onsubmit()}else{d.upload_icon.src=d.skin.img.loading}d.file_flag=1}},flash_pub_create:function(){var b=this;var c=b.type+"/-.js";var a={flash_url:"scripts/swfupload/swfupload.swf",flash9_url:"scripts/swfupload/swfupload_fp9.swf",upload_url:c,file_post_name:"dcontent",post_params:b.extra_parms,file_size_limit:"10 MB",file_types:"*.*",file_types_description:"All Files",file_upload_limit:10,file_queue_limit:1,debug:false,custom_settings:{file_pub_ack_handle:function(d){b.on_file_pub_ack(d)}},button_width:(b.out_width-2*b.pad),button_height:(b.out_height-2*b.pad),button_window_mode:"transparent",button_placeholder:b.tmp_span,swfupload_preload_handler:preLoad,swfupload_load_failed_handler:loadFailed,file_queued_handler:fileQueued,file_dialog_complete_handler:fileDialogComplete,upload_start_handler:uploadStart,upload_progress_handler:uploadProgress,upload_success_handler:uploadSuccess,upload_complete_handler:uploadComplete};this.swfu=new SWFUpload(a)}};user_file_pub.prototype.lang=lang_get(user_file_pub.prototype.langs);md5_ex={hexcase:0,b64pad:"",chrsz:8,binl2hex:function(d){var c=this.hexcase?"0123456789ABCDEF":"0123456789abcdef";var e="";for(var b=0,a=d.length*4;b<a;b++){e+=c.charAt((d[b>>2]>>((b%4)*8+4))&15)+c.charAt((d[b>>2]>>((b%4)*8))&15)}return e},hex:function(a){return this.binl2hex(this.core(this.str2binl(a),a.length*this.chrsz))},b64:function(a){return this.binl2b64(this.core(this.str2binl(a),a.length*this.chrsz))},str:function(a){return this.binl2str(this.core(this.str2binl(a),a.length*this.chrsz))},hex_hmac:function(a,b){return this.binl2hex(this.core_hmac(a,b))},b64_hmac:function(a,b){return this.binl2b64(this.core_hmac(a,b))},str_hmac:function(a,b){return this.binl2str(this.core_hmac(a,b))},core:function(s,n){s[n>>5]|=128<<((n)%32);s[(((n+64)>>>9)<<4)+14]=n;var r=1732584193;var q=-271733879;var p=-1732584194;var o=271733878;for(var g=0,n=s.length;g<n;g+=16){var m=r;var l=q;var f=p;var e=o;r=this.ff(r,q,p,o,s[g+0],7,-680876936);o=this.ff(o,r,q,p,s[g+1],12,-389564586);p=this.ff(p,o,r,q,s[g+2],17,606105819);q=this.ff(q,p,o,r,s[g+3],22,-1044525330);r=this.ff(r,q,p,o,s[g+4],7,-176418897);o=this.ff(o,r,q,p,s[g+5],12,1200080426);p=this.ff(p,o,r,q,s[g+6],17,-1473231341);q=this.ff(q,p,o,r,s[g+7],22,-45705983);r=this.ff(r,q,p,o,s[g+8],7,1770035416);o=this.ff(o,r,q,p,s[g+9],12,-1958414417);p=this.ff(p,o,r,q,s[g+10],17,-42063);q=this.ff(q,p,o,r,s[g+11],22,-1990404162);r=this.ff(r,q,p,o,s[g+12],7,1804603682);o=this.ff(o,r,q,p,s[g+13],12,-40341101);p=this.ff(p,o,r,q,s[g+14],17,-1502002290);q=this.ff(q,p,o,r,s[g+15],22,1236535329);r=this.gg(r,q,p,o,s[g+1],5,-165796510);o=this.gg(o,r,q,p,s[g+6],9,-1069501632);p=this.gg(p,o,r,q,s[g+11],14,643717713);q=this.gg(q,p,o,r,s[g+0],20,-373897302);r=this.gg(r,q,p,o,s[g+5],5,-701558691);o=this.gg(o,r,q,p,s[g+10],9,38016083);p=this.gg(p,o,r,q,s[g+15],14,-660478335);q=this.gg(q,p,o,r,s[g+4],20,-405537848);r=this.gg(r,q,p,o,s[g+9],5,568446438);o=this.gg(o,r,q,p,s[g+14],9,-1019803690);p=this.gg(p,o,r,q,s[g+3],14,-187363961);q=this.gg(q,p,o,r,s[g+8],20,1163531501);r=this.gg(r,q,p,o,s[g+13],5,-1444681467);o=this.gg(o,r,q,p,s[g+2],9,-51403784);p=this.gg(p,o,r,q,s[g+7],14,1735328473);q=this.gg(q,p,o,r,s[g+12],20,-1926607734);r=this.hh(r,q,p,o,s[g+5],4,-378558);o=this.hh(o,r,q,p,s[g+8],11,-2022574463);p=this.hh(p,o,r,q,s[g+11],16,1839030562);q=this.hh(q,p,o,r,s[g+14],23,-35309556);r=this.hh(r,q,p,o,s[g+1],4,-1530992060);o=this.hh(o,r,q,p,s[g+4],11,1272893353);p=this.hh(p,o,r,q,s[g+7],16,-155497632);q=this.hh(q,p,o,r,s[g+10],23,-1094730640);r=this.hh(r,q,p,o,s[g+13],4,681279174);o=this.hh(o,r,q,p,s[g+0],11,-358537222);p=this.hh(p,o,r,q,s[g+3],16,-722521979);q=this.hh(q,p,o,r,s[g+6],23,76029189);r=this.hh(r,q,p,o,s[g+9],4,-640364487);o=this.hh(o,r,q,p,s[g+12],11,-421815835);p=this.hh(p,o,r,q,s[g+15],16,530742520);q=this.hh(q,p,o,r,s[g+2],23,-995338651);r=this.ii(r,q,p,o,s[g+0],6,-198630844);o=this.ii(o,r,q,p,s[g+7],10,1126891415);p=this.ii(p,o,r,q,s[g+14],15,-1416354905);q=this.ii(q,p,o,r,s[g+5],21,-57434055);r=this.ii(r,q,p,o,s[g+12],6,1700485571);o=this.ii(o,r,q,p,s[g+3],10,-1894986606);p=this.ii(p,o,r,q,s[g+10],15,-1051523);q=this.ii(q,p,o,r,s[g+1],21,-2054922799);r=this.ii(r,q,p,o,s[g+8],6,1873313359);o=this.ii(o,r,q,p,s[g+15],10,-30611744);p=this.ii(p,o,r,q,s[g+6],15,-1560198380);q=this.ii(q,p,o,r,s[g+13],21,1309151649);r=this.ii(r,q,p,o,s[g+4],6,-145523070);o=this.ii(o,r,q,p,s[g+11],10,-1120210379);p=this.ii(p,o,r,q,s[g+2],15,718787259);q=this.ii(q,p,o,r,s[g+9],21,-343485551);r=this.safe_add(r,m);q=this.safe_add(q,l);p=this.safe_add(p,f);o=this.safe_add(o,e)}return[r,q,p,o]},cmn:function(l,e,d,c,g,f){return this.safe_add(this.bit_rol(this.safe_add(this.safe_add(e,l),this.safe_add(c,f)),g),d)},ff:function(g,f,o,n,e,m,l){return this.cmn((f&o)|((~f)&n),g,f,e,m,l)},gg:function(g,f,o,n,e,m,l){return this.cmn((f&n)|(o&(~n)),g,f,e,m,l)},hh:function(g,f,o,n,e,m,l){return this.cmn(f^o^n,g,f,e,m,l)},ii:function(g,f,o,n,e,m,l){return this.cmn(o^(f|(~n)),g,f,e,m,l)},core_hmac:function(c,f){var e=this.str2binl(c);if(e.length>16){e=this.core(e,c.length*this.chrsz)}var a=new Array(16),d=new Array(16);for(var b=0;b<16;b++){a[b]=e[b]^909522486;d[b]=e[b]^1549556828}var g=this.core(a.concat(this.str2binl(f)),512+f.length*this.chrsz);return this.core(d.concat(g),512+128)},safe_add:function(a,d){var c=(a&65535)+(d&65535);var b=(a>>16)+(d>>16)+(c>>16);return(b<<16)|(c&65535)},bit_rol:function(a,b){return(a<<b)|(a>>>(32-b))},str2binl:function(d){var c=[];var a=(1<<this.chrsz)-1;for(var b=0;b<d.length*this.chrsz;b+=this.chrsz){c[b>>5]|=(d.charCodeAt(b/this.chrsz)&a)<<(b%32)}return c},binl2str:function(c){var d="";var a=(1<<this.chrsz)-1;for(var b=0;b<c.length*32;b+=this.chrsz){d+=String.fromCharCode((c[b>>5]>>>(b%32))&a)}return d},binl2b64:function(d){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var f="";for(var b=0;b<d.length*4;b+=3){var e=(((d[b>>2]>>8*(b%4))&255)<<16)|(((d[b+1>>2]>>8*((b+1)%4))&255)<<8)|((d[b+2>>2]>>8*((b+2)%4))&255);for(var a=0;a<4;a++){if(b*8+a*6>d.length*32){f+=sb.md5.b64pad}else{f+=c.charAt((e>>6*(3-a))&63)}}return f}}};(function(){var B=0,aA=0,J=aA+1,be="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_=!@#$%^&*()[]{}|;:,.<>/?`~ \\'\"+-";for(B=0;(1<<(B+1))>(1<<B);B++){}B>>=1;aA=(1<<B)-1;J=aA+1;var s=a1(1,1,1);var ad=[],aV=ad,r=ad,o=ad,n=ad,m=ad,l=ad,g=ad,f=ad,e=ad,aw=ad,a3=ad,aT=ad,K=ad,Y=ad,Z=ad,ab=ad,aJ=ad,aI=ad,aG=ad,aE=ad,ao=ad,an=ad,am=ad,aN=ad,W=ad,V=ad,aK=ad,U=ad,aq=ad,ah=ad,aS=ad,at=ad,bh=ad,aa=ad,a8=ad,al=ad,N=ad,ae=ad,ak=ad,ai=ad,S=ad,R=ad,aX=ad,a7=ad;function ba(bn){var T,bk,bm,t;bk=new Array(bn);for(T=0;T<bn;T++){bk[T]=0}bk[0]=2;bm=0;for(;bk[bm]<bn;){for(T=bk[bm]*bk[bm];T<bn;T+=bk[bm]){bk[T]=1}bm++;bk[bm]=bk[bm-1]+1;for(;bk[bm]<bn&&bk[bk[bm]];bk[bm]++){}}t=new Array(bm);for(T=0;T<bm;T++){t[T]=bk[T]}return t}function p(T,t){if(aT.length!=T.length){aT=P(T);K=P(T);Y=P(T)}C(Y,t);return aP(T,Y)}function aP(T,t){var bn,bm,bk,bo;if(aT.length!=T.length){aT=P(T);K=P(T);Y=P(T)}aB(Y,t);aB(K,T);aB(aT,T);ax(K,-1);ax(aT,-1);bk=0;for(bn=0;bn<K.length;bn++){for(bm=1;bm<aA;bm<<=1){if(T[bn]&bm){bo=(bk<K.length+B?bk:0);bn=K.length;bm=aA}else{bk++}}}if(bo){M(K,bo)}aU(Y,K,T);if(!D(Y,1)&&!X(Y,aT)){bm=1;while(bm<=bo-1&&!X(Y,aT)){aM(Y,T);if(D(Y,1)){return 0}bm++}if(!X(Y,aT)){return 0}}return 1}function aC(t){var bk,bm,T;for(bk=t.length-1;(t[bk]==0)&&(bk>0);bk--){}for(bm=0,T=t[bk];T;(T>>=1),bm++){}bm+=B*bk;return bm}function aH(t,bk){var T=a1(0,(t.length>bk?t.length:bk)*B,0);aB(T,t);return T}function ap(T){var t=a1(0,T,0);av(t,T);return a4(t,1)}function I(t){if(t>=600){return v(t,2)}if(t>=550){return v(t,4)}if(t>=500){return v(t,5)}if(t>=400){return v(t,6)}if(t>=350){return v(t,7)}if(t>=300){return v(t,9)}if(t>=250){return v(t,12)}if(t>=200){return v(t,15)}if(t>=150){return v(t,18)}if(t>=100){return v(t,27)}return v(t,40)}function v(bk,bo){var T,bm,t,bn;bn=30000;T=a1(0,bk,0);if(U.length==0){U=ba(30000)}if(a7.length!=T.length){a7=P(T)}for(;;){a2(T,bk,0);T[0]|=1;t=0;for(bm=0;(bm<U.length)&&(U[bm]<=bn);bm++){if(bf(T,U[bm])==0&&!D(T,U[bm])){t=1;break}}for(bm=0;bm<bo&&!t;bm++){a2(a7,bk,0);while(!F(T,a7)){a2(a7,bk,0)}if(!aP(T,a7)){t=1}}if(!t){return T}}}function b(t,bk){var T=P(t);aF(T,bk);return a4(T,1)}function u(t,bk){var T=aH(t,t.length+1);ax(T,bk);return a4(T,1)}function d(t,bk){var T=aH(t,t.length+bk.length);aZ(T,bk);return a4(T,1)}function aR(t,bm,bk){var T=aH(t,bk.length);aU(T,a4(bm,2),a4(bk,2),0);return a4(T,1)}function a5(t,bk){var T=aH(t,(t.length>bk.length?t.length+1:bk.length+1));bd(T,bk);return a4(T,1)}function A(t,bk){var T=aH(t,(t.length>bk.length?t.length+1:bk.length+1));aL(T,bk);return a4(T,1)}function bi(t,bm){var T=aH(t,bm.length);var bk;bk=ag(T,bm);return bk?a4(T,1):null}function ar(t,bm,bk){var T=aH(t,bk.length);aW(T,bm,bk);return a4(T,1)}function av(bw,bo){var bv,bm,bn,bx,bp,t,T,bs,bu,bk,bq;if(U.length==0){U=ba(30000)}if(aq.length==0){aq=new Array(512);for(bp=0;bp<512;bp++){aq[bp]=Math.pow(2,bp/511-1)}}bv=0.1;bm=20;recLimit=20;if(aS.length!=bw.length){aS=P(bw);at=P(bw);a8=P(bw);N=P(bw);ai=P(bw);S=P(bw);R=P(bw);ak=P(bw);ae=P(bw);ah=P(bw);bh=P(bw);aa=P(bw);al=P(bw);aX=P(bw)}if(bo<=recLimit){bn=(1<<((bo+2)>>1))-1;C(bw,0);for(bx=1;bx;){bx=0;bw[0]=1|(1<<(bo-1))|Math.floor(Math.random()*(1<<bo));for(bp=1;(bp<U.length)&&((U[bp]&bn)==U[bp]);bp++){if(0==(bw[0]%U[bp])){bx=1;break}}}af(bw);return}T=bv*bo*bo;if(bo>2*bm){for(t=1;bo-bo*t<=bm;){t=aq[Math.floor(Math.random()*512)]}}else{t=0.5}bq=Math.floor(t*bo)+1;av(aa,bq);C(aS,0);aS[Math.floor((bo-2)/B)]|=(1<<((bo-2)%B));c(aS,aa,ah,bh);bu=aC(ah);for(;;){for(;;){a2(at,bu,0);if(F(ah,at)){break}}ax(at,1);aL(at,ah);aB(ae,aa);aZ(ae,at);q(ae,2);ax(ae,1);aB(N,at);q(N,2);for(bs=0,bp=0;(bp<U.length)&&(U[bp]<T);bp++){if(bf(ae,U[bp])==0&&!D(ae,U[bp])){bs=1;break}}if(!bs){if(!p(ae,2)){bs=1}}if(!bs){ax(ae,-3);for(bp=ae.length-1;(ae[bp]==0)&&(bp>0);bp--){}for(bk=0,w=ae[bp];w;(w>>=1),bk++){}bk+=B*bp;for(;;){a2(al,bk,0);if(F(ae,al)){break}}ax(ae,3);ax(al,2);aB(ak,al);aB(a8,ae);ax(a8,-1);aU(ak,a8,ae);ax(ak,-1);if(a0(ak)){aB(ak,al);aU(ak,N,ae);ax(ak,-1);aB(aX,ae);aB(ai,ak);E(ai,ae);if(D(ai,1)){aB(bw,aX);return}}}}}function aQ(bm,bk){var T,t;T=Math.floor((bm-1)/B)+2;t=a1(0,0,T);a2(t,bm,bk);return t}function a2(t,bn,bm){var bk,T;for(bk=0;bk<t.length;bk++){t[bk]=0}T=Math.floor((bn-1)/B)+1;for(bk=0;bk<T;bk++){t[bk]=Math.floor(Math.random()*(1<<(B-1)))}t[T-1]&=(2<<((bn-1)%B))-1;if(bm==1){t[T-1]|=(1<<((bn-1)%B))}}function au(t,bm){var T,bk;T=P(t);bk=P(bm);E(T,bk);return T}function E(bv,bu){var bs,bq,T,bp,bo,bn,t,bm,bk;if(aw.length!=bv.length){aw=P(bv)}bk=1;while(bk){bk=0;for(bs=1;bs<bu.length;bs++){if(bu[bs]){bk=1;break}}if(!bk){break}for(bs=bv.length;!bv[bs]&&bs>=0;bs--){}bq=bv[bs];T=bu[bs];bp=1;bo=0;bn=0;t=1;while((T+bn)&&(T+t)){bm=Math.floor((bq+bp)/(T+bn));qp=Math.floor((bq+bo)/(T+t));if(bm!=qp){break}ad=bp-bm*bn;bp=bn;bn=ad;ad=bo-bm*t;bo=t;t=ad;ad=bq-bm*T;bq=T;T=ad}if(bo){aB(aw,bv);O(bv,bu,bp,bo);O(bu,aw,t,bn)}else{aF(bv,bu);aB(aw,bv);aB(bv,bu);aB(bu,aw)}}if(bu[0]==0){return}ad=bf(bv,bu[0]);C(bv,bu[0]);bu[0]=ad;while(bu[0]){bv[0]%=bu[0];ad=bv[0];bv[0]=bu[0];bu[0]=ad}}function ag(t,bk){var T=1+2*Math.max(t.length,bk.length);if(!(t[0]&1)&&!(bk[0]&1)){C(t,0);return 0}if(ab.length!=T){ab=new Array(T);Z=new Array(T);aJ=new Array(T);aI=new Array(T);aG=new Array(T);aE=new Array(T)}aB(ab,t);aB(Z,bk);C(aJ,1);C(aI,0);C(aG,0);C(aE,1);for(;;){while(!(ab[0]&1)){y(ab);if(!(aJ[0]&1)&&!(aI[0]&1)){y(aJ);y(aI)}else{aL(aJ,bk);y(aJ);bd(aI,t);y(aI)}}while(!(Z[0]&1)){y(Z);if(!(aG[0]&1)&&!(aE[0]&1)){y(aG);y(aE)}else{aL(aG,bk);y(aG);bd(aE,t);y(aE)}}if(!F(Z,ab)){bd(ab,Z);bd(aJ,aG);bd(aI,aE)}else{bd(Z,ab);bd(aG,aJ);bd(aE,aI)}if(D(ab,0)){if(x(aG)){aL(aG,bk)}aB(t,aG);if(!D(Z,1)){C(t,0);return 0}return 1}}}function aY(bk,bo){var bm=1,T=0,bn;for(;;){if(bk==1){return bm}if(bk==0){return 0}T-=bm*Math.floor(bo/bk);bo%=bk;if(bo==1){return T}if(bo==0){return 0}bm-=T*Math.floor(bk/bo);bk%=bo}}function H(t,T){return aY(t,T)}function z(T,bp,bn,bk,t){var bo=0;var bm=Math.max(T.length,bp.length);if(ab.length!=bm){ab=new Array(bm);aJ=new Array(bm);aI=new Array(bm);aG=new Array(bm);aE=new Array(bm)}while(!(T[0]&1)&&!(bp[0]&1)){y(T);y(bp);bo++}aB(ab,T);aB(bn,bp);C(aJ,1);C(aI,0);C(aG,0);C(aE,1);for(;;){while(!(ab[0]&1)){y(ab);if(!(aJ[0]&1)&&!(aI[0]&1)){y(aJ);y(aI)}else{aL(aJ,bp);y(aJ);bd(aI,T);y(aI)}}while(!(bn[0]&1)){y(bn);if(!(aG[0]&1)&&!(aE[0]&1)){y(aG);y(aE)}else{aL(aG,bp);y(aG);bd(aE,T);y(aE)}}if(!F(bn,ab)){bd(ab,bn);bd(aJ,aG);bd(aI,aE)}else{bd(bn,ab);bd(aG,aJ);bd(aE,aI)}if(D(ab,0)){if(x(aG)){aL(aG,bp);bd(aE,T)}q(aE,-1);aB(bk,aG);aB(t,aE);bj(bn,bo);return}}}function x(t){return((t[t.length-1]>>(B-1))&1)}function a(t,bo,T){var bm,bn=t.length,bk=bo.length;k=((bn+T)<bk)?(bn+T):bk;for(bm=bk-1-T;bm<bn&&bm>=0;bm++){if(t[bm]>0){return 1}}for(bm=bn-1+T;bm<bk;bm++){if(bo[bm]>0){return 0}}for(bm=k-1;bm>=T;bm--){if(t[bm-T]>bo[bm]){return 1}else{if(t[bm-T]<bo[bm]){return 0}}}return 0}function F(t,bm){var bk;var T=(t.length<bm.length)?t.length:bm.length;for(bk=t.length;bk<bm.length;bk++){if(bm[bk]){return 0}}for(bk=bm.length;bk<t.length;bk++){if(t[bk]){return 1}}for(bk=T-1;bk>=0;bk--){if(t[bk]>bm[bk]){return 1}else{if(t[bk]<bm[bk]){return 0}}}return 0}function c(bx,bu,T,t){var bo,bn;var bm,bk,bw,bs,bp,bv,bq;aB(t,bx);for(bn=bu.length;bu[bn-1]==0;bn--){}bq=bu[bn-1];for(bv=0;bq;bv++){bq>>=1}bv=B-bv;bj(bu,bv);bj(t,bv);for(bo=t.length;t[bo-1]==0&&bo>bn;bo--){}C(T,0);while(!a(bu,t,bo-bn)){aD(t,bu,bo-bn);T[bo-bn]++}for(bm=bo-1;bm>=bn;bm--){if(t[bm]==bu[bn-1]){T[bm-bn]=aA}else{T[bm-bn]=Math.floor((t[bm]*J+t[bm-1])/bu[bn-1])}for(;;){bs=(bn>1?bu[bn-2]:0)*T[bm-bn];bp=bs>>B;bs=bs&aA;bw=bp+T[bm-bn]*bu[bn-1];bp=bw>>B;bw=bw&aA;if(bp==t[bm]?bw==t[bm-1]?bs>(bm>1?t[bm-2]:0):bw>t[bm-1]:bp>t[bm]){T[bm-bn]--}else{break}}az(t,bu,-T[bm-bn],bm-bn);if(x(t)){a9(t,bu,bm-bn);T[bm-bn]--}}M(bu,bv);M(t,bv)}function af(T){var bm,bk,bn,t;bk=T.length;bn=0;for(bm=0;bm<bk;bm++){bn+=T[bm];t=0;if(bn<0){t=-(bn>>B);bn+=t*J}T[bm]=bn&aA;bn=(bn>>B)-t}}function bf(t,bm){var T,bk=0;for(T=t.length-1;T>=0;T--){bk=(bk*J+t[T])%bm}return bk}function a1(bm,bn,bo){var bk,T;T=Math.ceil(bn/B)+1;T=bo>T?bo:T;buff=new Array(T);C(buff,bm);return buff}function a6(bu,bk,T){var bp,bo,bn,bs,bq,t;var bm=bu.length;if(bk==-1){bs=new Array(0);for(;;){bq=new Array(bs.length+1);for(bo=0;bo<bs.length;bo++){bq[bo+1]=bs[bo]}bq[0]=parseInt(bu,10);bs=bq;bp=bu.indexOf(",",0);if(bp<1){break}bu=bu.substring(bp+1);if(bu.length==0){break}}if(bs.length<T){bq=new Array(T);aB(bq,bs);return bq}return bs}bs=a1(0,bk*bm,0);for(bo=0;bo<bm;bo++){bp=be.indexOf(bu.substring(bo,bo+1),0);if(bk<=36&&bp>=36){bp-=26}if(bp>=bk||bp<0){break}q(bs,bk);ax(bs,bp)}for(bm=bs.length;bm>0&&!bs[bm-1];bm--){}bm=T>bm+1?T:bm+1;bq=new Array(bm);t=bm<bs.length?bm:bs.length;for(bo=0;bo<t;bo++){bq[bo]=bs[bo]}for(;bo<bm;bo++){bq[bo]=0}return bq}function D(t,bk){var T;if(t[0]!=bk){return 0}for(T=1;T<t.length;T++){if(t[T]){return 0}}return 1}function X(t,bm){var bk;var T=t.length<bm.length?t.length:bm.length;for(bk=0;bk<T;bk++){if(t[bk]!=bm[bk]){return 0}}if(t.length>bm.length){for(;bk<t.length;bk++){if(t[bk]){return 0}}}else{for(;bk<bm.length;bk++){if(bm[bk]){return 0}}}return 1}function a0(t){var T;for(T=0;T<t.length;T++){if(t[T]){return 0}}return 1}function aO(T,bo){var bm,bk,bn="";if(f.length!=T.length){f=P(T)}else{aB(f,T)}if(bo==-1){for(bm=T.length-1;bm>0;bm--){bn+=T[bm]+","}bn+=T[0]}else{while(!a0(f)){bk=aj(f,bo);bn=be.substring(bk,bk+1)+bn}}if(bn.length==0){bn="0"}return bn}function P(t){var T;buff=new Array(t.length);aB(buff,t);return buff}function aB(t,bm){var bk;var T=t.length<bm.length?t.length:bm.length;for(bk=0;bk<T;bk++){t[bk]=bm[bk]}for(bk=T;bk<t.length;bk++){t[bk]=0}}function C(t,bm){var T,bk;for(bk=bm,T=0;T<t.length;T++){t[T]=bk&aA;bk>>=B}}function ax(T,bo){var bm,bk,bn,t;T[0]+=bo;bk=T.length;bn=0;for(bm=0;bm<bk;bm++){bn+=T[bm];t=0;if(bn<0){t=-(bn>>B);bn+=t*J}T[bm]=bn&aA;bn=(bn>>B)-t;if(!bn){return}}}function M(t,bm){var bk;var T=Math.floor(bm/B);if(T){for(bk=0;bk<t.length-T;bk++){t[bk]=t[bk+T]}for(;bk<t.length;bk++){t[bk]=0}bm%=B}for(bk=0;bk<t.length-1;bk++){t[bk]=aA&((t[bk+1]<<(B-bm))|(t[bk]>>bm))}t[bk]>>=bm}function y(t){var T;for(T=0;T<t.length-1;T++){t[T]=aA&((t[T+1]<<(B-1))|(t[T]>>1))}t[T]=(t[T]>>1)|(t[T]&(J>>1))}function bj(t,bm){var bk;var T=Math.floor(bm/B);if(T){for(bk=t.length;bk>=T;bk--){t[bk]=t[bk-T]}for(;bk>=0;bk--){t[bk]=0}bm%=B}if(!bm){return}for(bk=t.length-1;bk>0;bk--){t[bk]=aA&((t[bk]<<bm)|(t[bk-1]>>(B-bm)))}t[bk]=aA&(t[bk]<<bm)}function q(T,bo){var bm,bk,bn,t;if(!bo){return}bk=T.length;bn=0;for(bm=0;bm<bk;bm++){bn+=T[bm]*bo;t=0;if(bn<0){t=-(bn>>B);bn+=t*J}T[bm]=bn&aA;bn=(bn>>B)-t}}function aj(t,bn){var T,bm=0,bk;for(T=t.length-1;T>=0;T--){bk=bm*J+t[T];t[T]=Math.floor(bk/bn);bm=bk%bn}return bm}function O(T,bq,bk,t){var bn,bp,bm,bo;bm=T.length<bq.length?T.length:bq.length;bo=T.length;for(bp=0,bn=0;bn<bm;bn++){bp+=bk*T[bn]+t*bq[bn];T[bn]=bp&aA;bp>>=B}for(bn=bm;bn<bo;bn++){bp+=bk*T[bn];T[bn]=bp&aA;bp>>=B}}function az(T,bq,t,bn){var bm,bp,bk,bo;bk=T.length<bn+bq.length?T.length:bn+bq.length;bo=T.length;for(bp=0,bm=bn;bm<bk;bm++){bp+=T[bm]+t*bq[bm-bn];T[bm]=bp&aA;bp>>=B}for(bm=bk;bp&&bm<bo;bm++){bp+=T[bm];T[bm]=bp&aA;bp>>=B}}function a9(t,bp,bm){var bk,bo,T,bn;T=t.length<bm+bp.length?t.length:bm+bp.length;bn=t.length;for(bo=0,bk=bm;bk<T;bk++){bo+=t[bk]+bp[bk-bm];t[bk]=bo&aA;bo>>=B}for(bk=T;bo&&bk<bn;bk++){bo+=t[bk];t[bk]=bo&aA;bo>>=B}}function aD(t,bp,bm){var bk,bo,T,bn;T=t.length<bm+bp.length?t.length:bm+bp.length;bn=t.length;for(bo=0,bk=bm;bk<T;bk++){bo+=t[bk]-bp[bk-bm];t[bk]=bo&aA;bo>>=B}for(bk=T;bo&&bk<bn;bk++){bo+=t[bk];t[bk]=bo&aA;bo>>=B}}function bd(t,bo){var bk,bn,T,bm;T=t.length<bo.length?t.length:bo.length;for(bn=0,bk=0;bk<T;bk++){bn+=t[bk]-bo[bk];t[bk]=bn&aA;bn>>=B}for(bk=T;bn&&bk<t.length;bk++){bn+=t[bk];t[bk]=bn&aA;bn>>=B}}function aL(t,bo){var bk,bn,T,bm;T=t.length<bo.length?t.length:bo.length;for(bn=0,bk=0;bk<T;bk++){bn+=t[bk]+bo[bk];t[bk]=bn&aA;bn>>=B}for(bk=T;bn&&bk<t.length;bk++){bn+=t[bk];t[bk]=bn&aA;bn>>=B}}function aZ(t,bk){var T;if(aV.length!=2*t.length){aV=new Array(2*t.length)}C(aV,0);for(T=0;T<bk.length;T++){if(bk[T]){az(aV,t,bk[T],T)}}aB(t,aV)}function aF(t,T){if(l.length!=t.length){l=P(t)}else{aB(l,t)}if(g.length!=t.length){g=P(t)}c(l,T,g,t)}function aW(t,bm,bk){var T;if(r.length!=2*t.length){r=new Array(2*t.length)}C(r,0);for(T=0;T<bm.length;T++){if(bm[T]){az(r,t,bm[T],T)}}aF(r,bk);aB(t,r)}function aM(bq,t){var bm,bk,bo,bp,bn,bs,T;for(bn=bq.length;bn>0&&!bq[bn-1];bn--){}T=bn>t.length?2*bn:2*t.length;if(r.length!=T){r=new Array(T)}C(r,0);for(bm=0;bm<bn;bm++){bp=r[2*bm]+bq[bm]*bq[bm];r[2*bm]=bp&aA;bp>>=B;for(bk=bm+1;bk<bn;bk++){bp=r[bm+bk]+2*bq[bm]*bq[bk]+bp;r[bm+bk]=(bp&aA);bp>>=B}r[bm+bn]=bp}aF(r,t);aB(bq,r)}function a4(t,T){var bk,bm;for(bk=t.length;bk>0&&!t[bk-1];bk--){}bm=new Array(bk+T);aB(bm,t);return bm}function aU(t,bp,bo){var bn,bm,T,bk;if(e.length!=bo.length){e=P(bo)}if((bo[0]&1)==0){aB(e,t);C(t,1);while(!D(bp,0)){if(bp[0]&1){aW(t,e,bo)}aj(bp,2);aM(e,bo)}return}C(e,0);for(T=bo.length;T>0&&!bo[T-1];T--){}bk=J-aY(bf(bo,J),J);e[T]=1;aW(t,e,bo);if(m.length!=t.length){m=P(t)}else{aB(m,t)}for(bn=bp.length-1;bn>0&!bp[bn];bn--){}if(bp[bn]==0){C(t,1);return}for(bm=1<<(B-1);bm&&!(bp[bn]&bm);bm>>=1){}for(;;){if(!(bm>>=1)){bn--;if(bn<0){ay(t,s,bo,bk);return}bm=1<<(B-1)}ay(t,t,bo,bk);if(bm&bp[bn]){ay(t,m,bo,bk)}}}function ay(bu,bp,T,bv){var bm,bk,bo,bq,bw,bs;var bx=T.length;var bn=bp.length;if(a3.length!=bx){a3=new Array(bx)}C(a3,0);for(;bx>0&&T[bx-1]==0;bx--){}for(;bn>0&&bp[bn-1]==0;bn--){}bs=a3.length-1;for(bm=0;bm<bx;bm++){bw=a3[0]+bu[bm]*bp[0];bq=((bw&aA)*bv)&aA;bo=(bw+bq*T[0])>>B;bw=bu[bm];bk=1;for(;bk<bn-4;){bo+=a3[bk]+bq*T[bk]+bw*bp[bk];a3[bk-1]=bo&aA;bo>>=B;bk++;bo+=a3[bk]+bq*T[bk]+bw*bp[bk];a3[bk-1]=bo&aA;bo>>=B;bk++;bo+=a3[bk]+bq*T[bk]+bw*bp[bk];a3[bk-1]=bo&aA;bo>>=B;bk++;bo+=a3[bk]+bq*T[bk]+bw*bp[bk];a3[bk-1]=bo&aA;bo>>=B;bk++;bo+=a3[bk]+bq*T[bk]+bw*bp[bk];a3[bk-1]=bo&aA;bo>>=B;bk++}for(;bk<bn;){bo+=a3[bk]+bq*T[bk]+bw*bp[bk];a3[bk-1]=bo&aA;bo>>=B;bk++}for(;bk<bx-4;){bo+=a3[bk]+bq*T[bk];a3[bk-1]=bo&aA;bo>>=B;bk++;bo+=a3[bk]+bq*T[bk];a3[bk-1]=bo&aA;bo>>=B;bk++;bo+=a3[bk]+bq*T[bk];a3[bk-1]=bo&aA;bo>>=B;bk++;bo+=a3[bk]+bq*T[bk];a3[bk-1]=bo&aA;bo>>=B;bk++;bo+=a3[bk]+bq*T[bk];a3[bk-1]=bo&aA;bo>>=B;bk++}for(;bk<bx;){bo+=a3[bk]+bq*T[bk];a3[bk-1]=bo&aA;bo>>=B;bk++}for(;bk<bs;){bo+=a3[bk];a3[bk-1]=bo&aA;bo>>=B;bk++}a3[bk-1]=bo&aA}if(!F(T,a3)){bd(a3,T)}aB(bu,a3)}var L={};L.Leemon={Base:10,PowMod:function(bk,T,bm){bk=a6(bk,this.Base);T=a6(T,this.Base);bm=a6(bm,this.Base);var t=aR(bk,T,bm);t=aO(t,this.Base);return t},RandomInt:function(T){var t=aQ(T);return aO(t,this.Base)}};var G=L.Leemon,Q="791658605174853458830696113306796803",ac="5";window.dh={prime:Q,g:ac,gen_private:function(){return G.RandomInt(64)},gen_public:function(t){return G.PowMod(ac,t,Q)},gen_shared_secret:function(T,t){return G.PowMod(t,T,Q)}}})();function service(){if(im.account.uid==$.service_gid){return}if(im.account.uid&&global_sid){try{im.groups[im.account.uid].topics_ptr.open_friend_topic($.service_gid)}catch(a){}}else{if(im.session){return 1}}}function im_init_service(){$("#service").onclick=function(){if(1===service()){var a=function(){service();a.unsubscribe(im.login_publisher)};a.subscribe(im.login_publisher);im.session.anony_sign_in()}return false}}var im={};im.init=function(){var a=location.href,b=a.indexOf("?");im.args=codec.uri_2_obj(location.search);im.href=(b>=0)?a.substring(0,b):a};im.init();function im_body_uninit(){if(im.session){if(im.account.uid&&global_sid){json("group_status_notify_ex",{nid:global_sid,status:im.status.TS_OFFLINE},function(){})}if(im.invite.panel){im.invite.panel.destroy()}if(im.set_tag.panel){im.set_tag.panel.destroy()}im.session.destroy();delete im.session;im={};global_z_index=1;if(undefined==global_sid||""==global_sid||0==global_sid.length){return}global_sid=""}}function json(b,c,a){rpc.call({srv:"/",to:"im",type:b,data:c,way:"json",on_ack:function(d){if("object"==typeof(d)){a(d.type,d.data)}}})}function ajax(b,c,a){rpc.call({srv:"/",to:"im",type:b,data:c,on_ack:function(d){if("object"==typeof(d)){a(d.type,d.data)}}})}function im_body_init(){var a=im_body_init.prototype.lang;$("#feature").innerHTML="<li>"+a.video_hint+"<ul><li>"+a.video_hint_l1+"</li><li>"+a.video_hint_l2+"</li></ul></li><li>"+a.content_hint+"<ul><li>"+a.content_hint_l1+"</li><li>"+a.content_hint_l2+"</li></ul></li>";if($.ie6){$("#site_title").className="site_title_ie6"}im.session=new account();im.session.start_login();$("#bg_img").src=im_body_init.prototype.bg_img;$("#bg_img").onload=function(){$("#bg_img").style.display=""};$("#about").innerHTML=a.about;$("#service").innerHTML=a.service;$("#desktop_link").innerHTML=a.desktop_link}im_body_init.prototype={langs:{cn:{update_plugin_hint:"更新视频引擎",install_plugin_hint:"安装视频引擎，获得更优画质",video_hint:"高清视频",video_hint_l1:"更清晰的视频",video_hint_l2:"多人视频群聊",content_hint:"聊天内容在线保存",content_hint_l1:"随时查阅全部聊天记录",content_hint_l2:"上传的图片/文件永久保存",about:"关于",service:"在线客服",desktop_link:"设置桌面快捷"},en:{update_plugin_hint:"Update HD video chat plugin",install_plugin_hint:"Install HD video chat plugin for HD video chatting",video_hint:"HD video chat",video_hint_l1:"More clear HD video chat(same bandwith and same vcam)",video_hint_l2:"Video chat with multi friends in a group",content_hint:"Message storaged online",content_hint_l1:"Access message anywhere",content_hint_l2:"Uploaded file/picture storaged forever",about:"About",service:"Help At Once",desktop_link:"Save as Desktop Link"}},bg_img:"images/bg.jpg"};im_body_init.prototype.lang=lang_get(im_body_init.prototype.langs);$(im_body_init);$(im_init_service);im.account={};im.global_used_by_cs=false;im.pattern={sex:/^[男女]$/,zodiac:/^白羊座|金牛座|双子座|巨蟹座|狮子座|处女座|天秤座|天蝎座|人马座|山羊座|水瓶座|双鱼座|白羊|金牛|双子|巨蟹|狮子|处女|天秤|天蝎|人马|山羊|水瓶|双鱼$/,age_test:/^([<>]=?)?([0-9]{1,4})\.([1][0-2]|0?[1-9])$/,country:/^中国|美国|加拿大|澳大利亚|韩国|日本|新西兰|英国|法国|德国|俄罗斯|葡萄牙|西班牙$/,city:/^$/};im.GROUP_TOPIC=101;im.langs={cn:{account:"帐号",anony_sign:"匿名登录",anonymous:"匿名",edit_nick:"编辑昵称",edit_caption:"编辑标题",edit_bulletin:"编辑公告",edit_tag:"编辑标签",tag_hint:"设置分组/TAG  例如: 同学/高中 同事 ",ok:"确定",cancel:"取消",add:"添加",del:"删除",invite:"邀请",manage:"管理",sex:"性别",setting:"设置",system_topic:"系统会话",owner:"所有者",admin:"管理员",user:"用户",friend:"好友",guest:"客人",stranger:"陌生人",black:"黑名单",online_friend:"在线好友",logo_hint:"点击更新头像",group:"群",member:"成员",temp_session:"讨论组",temp_session1:"创建的讨论组",discus:"讨论组",system_session:"系统会话",recent_msg:"最近消息",search_result:"搜索结果",search:"搜索",accept:"接受",denial:"拒绝",delete_member:"删除成员",new_topic:"新建讨论组",offline:"离线",online:"在线",plz_call_me:"Q我吧",dont_call_me:"请勿打扰",leave:"离开",busy:"忙碌",hide:"隐身",status:"状态",writting:" 正在输入……",send_btn:"&nbsp;发&nbsp;送",plz_install_plugin:"安装视频加速器",update_plugin_hint:"更新视频加速器",install_plugin_hint:"安装视频加速器，获得更优画质",US_CONFIRM:"需要对方确认，已向对方发送请求",US_REFUSE:"添加失败，对方拒绝所有好友邀请"},en:{account:"account",anony_sign:"anony sign",anonymous:"anonymous",edit_nick:"edit nickname",edit_caption:"edit caption",edit_bulletin:"edit bulletin",edit_tag:"edit tag",tag_hint:"set tags/class Eg. Classmates/Middle-School co-worker ",ok:"OK",cancel:"Cancel",add:"Add",del:"Delete",invite:"Invite",manage:"manage",sex:"sex",setting:"setting",system_topic:"system topic",owner:"owner",admin:"administrator",user:"user",friend:"friend",guest:"guest",stranger:"stranger",black:"black list",online_friend:"online-friend",logo_hint:"click to change head",group:"group",member:"members",temp_session:"group",temp_session1:"new group",discus:"group",system_session:"system-session",recent_msg:"recent-message",search_result:"search-result",search:"search",accept:"accept",denial:"deny",delete_member:"deleted member",new_topic:"new topic",offline:"offline",online:"online",plz_call_me:"plz call me",dont_call_me:"no disturb",leave:"leave",busy:"busy",hide:"hide",status:"status",writting:" is writing……",send_btn:"send",plz_install_plugin:"install HD video engine",update_plugin_hint:"update HD video engine",install_plugin_hint:"install HD video engine, to get more clearly video",US_CONFIRM:"sent message out,waiting for confirmation ",US_REFUSE:"add failed, denied by your friend "}};im.lang=lang_get(im.langs);im.dir={LEFT:1,MIDDLE:2,RIGHT:3};im.prior={owner:20,manager:18,recent_msg:12,online_friend:11,friend:10,discus:8,search_result:6};im.role={OWNER:0,MANAGER:1,MEMBER:2,FRIEND:3,GUEST:4,STRANGER:5,BLACK:6};im.role_text=function(a){switch(a){case im.role.OWNER:return im.lang.owner;case im.role.MANAGER:return im.lang.manager;case im.role.MEMBER:return im.lang.member;case im.role.FRIEND:return im.lang.friend;case im.role.GUSET:return im.lang.guest;case im.role.STRANGER:return im.lang.stranger;case im.role.BLACK:return im.lang.black;default:return im.lang.stranger}};im.status={TS_OFFLINE:1,TS_ONLINE:2,TS_PLZ_CALL_ME:3,TS_DONT_CALL_ME:4,TS_LEAVE:5,TS_BUSY:6,TS_HIDE:7,TS_WRITTING:8,US_SUCCEED:1,US_ANSWER_QUESTIONN:2,US_CONFIRM:3,US_REFUSE:4};im.status_text=function(a){switch(a){case im.status.TS_OFFLINE:return im.lang.offline;case im.status.TS_ONLINE:return im.lang.online;case im.status.TS_LEAVE:return im.lang.leave;case im.status.TS_BUSY:return im.lang.busy;case im.status.TS_HIDE:return im.lang.hide}return""};im.status_icon=function(a){switch(a){case im.status.TS_ONLINE:return"images/status-online.gif";case im.status.TS_LEAVE:return"images/status-leave.gif";case im.status.TS_BUSY:return"images/status-busy.gif"}return"images/status-hide.gif"};im.tag_gid=function(a){return"0_"+a};im.tag_tid=function(a){return"1_"+a};im.clear=function(){im.groups={};im.args={}};im.group_mask={MASK_TAG:1,MASK_CONTACT_LOGO:2,MASK_CONTACT_ROLE:4,MASK_PERMISSION:8,MASK_DETAIL:16,MASK_STATUS:32,MASK_STATE:64,MASK_USER:256,MASK_EX_GID:1,MASK_EX_CONTACTS:2,MASK_EX_GROUPS:4};im.group_mask.MASK_BASIC=im.group_mask.MASK_CONTACT_LOGO|im.group_mask.MASK_DETAIL|im.group_mask.MASK_STATUS;im.group_mask.MASK_CONTACT=im.group_mask.MASK_TAG|im.group_mask.MASK_CONTACT_LOGO|im.group_mask.MASK_CONTACT_ROLE|im.group_mask.MASK_DETAIL;im.group_mask.MASK_ALL=im.group_mask.MASK_TAG|im.group_mask.MASK_CONTACT_LOGO|im.group_mask.MASK_CONTACT_ROLE|im.group_mask.MASK_PERMISSION|im.group_mask.MASK_DETAIL|im.group_mask.MASK_STATUS|im.group_mask.MASK_STATE|im.group_mask.MASK_USER;im.group_mask.MASK_EX_ALL=im.group_mask.MASK_EX_GID|im.group_mask.MASK_EX_CONTACTS|im.group_mask.MASK_EX_GROUPS;im.group_mask.MASK_EX_BASIC=im.group_mask.MASK_EX_CONTACTS|im.group_mask.MASK_EX_GROUPS;im.lookup={"男":1,"女":2,"白羊座":1,"金牛座":2,"双子座":3,"巨蟹座":4,"狮子座":5,"处女座":6,"天秤座":7,"天蝎座":8,"人马座":9,"山羊座":10,"水瓶座":11,"双鱼座":12,"白羊":1,"金牛":2,"双子":3,"巨蟹":4,"狮子":5,"处女":6,"天秤":7,"天蝎":8,"人马":9,"山羊":10,"水瓶":11,"双鱼":12,"中国":1,"美国":2,"加拿大":2,"澳大利亚":2,"韩国":2,"日本":2,"新西兰":2,"英国":2,"法国":2,"德国":2,"俄罗斯":2,"葡萄牙":2,"西班牙":2,"内蒙古":1,"新":2,"藏":3,"宁":4,"桂":5,"黑":6,"吉":7,"辽":8,"冀":9,"晋":10,"青":11,"鲁":12,"豫":13,"苏":14,"皖":15,"浙":16,"闽":17,"赣":18,"湘":19,"鄂":20,"粤":21,"台":22,"琼":23,"甘":24,"陇":24,"陕":25,"秦":25,"川":26,"蜀":26,"贵":27,"黔":27,"云":28,"滇":28,"京":29,"津":30,"沪":31,"渝":32,"港":34,"香港":34,"澳":35,"澳门":35,"黑龙江":6,"吉林":7,"辽宁":8,"河北":9,"山西":10,"青海":11,"山东":12,"河南":13,"江苏":14,"安徽":15,"浙江":16,"福建":17,"江西":18,"湖南":19,"湖北":20,"广东":21,"台湾":22,"海南":23,"甘肃":24,"陕西":25,"四川":26,"贵州":27,"云南":28,"内蒙古自治区":1,"维吾尔自治区":2,"西藏自治区":3,"宁夏回族自治区":4,"广西壮族自治区":5,"黑龙江省":6,"吉林省":7,"辽宁省":8,"河北省":9,"山西省":10,"青海省":11,"山东省":12,"河南省":13,"江苏省":14,"安徽省":15,"浙江省":16,"福建省":17,"江西省":18,"湖南省":19,"湖北省":20,"广东省":21,"台湾省":22,"海南省":23,"甘肃省":24,"陕西省":25,"四川省":26,"贵州省":27,"云南省":28,"北京":29,"天津":30,"上海":31,"重庆":32,"香港特别行政区":33,"澳门特别行政区":35};im.groups={};im.group_add_publisher=new publisher();im.group_update_publisher=new publisher();im.guser_add_publisher=new publisher();im.guser_del_publisher=new publisher();im.topic_add_publisher=new publisher();im.change_status_publisher=new publisher();im.login_publisher=new publisher();im.change_status=function(a){im.account.status=a;im.change_status_publisher.deliver()};im.group_add_publisher.filter=function(c,a){var b=a[0];if(c.arg0==undefined){return true}return(c.arg0==b)?true:false};im.guser_add_publisher.filter=function(d,a){var c=a[0];var b=a[1];if(d.arg0==undefined){return true}if(d.arg0!=c){return false}return d.arg1?((d.arg1==b)?true:false):true};im.topic_add_publisher.filter=im.guser_add_publisher.filter;im.save_msg=function(l,b){var m=b.head,g=b.content,f=m.gid,n,e,a,d={},c=m.tid||1;if(f<0){c=im.GROUP_TOPIC}if(undefined==(n=im.groups[f])){n=im.groups[f]={}}if(undefined==(e=n.msg_set)){e=n.msg_set={}}if(undefined==(a=e[c])){a=e[c]=[]}d.type=l;d.msg=obj_merge({},b);a.push(d)};im.group_add=function(a){var b;if((undefined==a.gid)||(0==a.gid)){alert("group_add() failed with [grp_profile.gid == undefined]");return}b=a.gid;if(a!==im.groups[b]){im.groups[b]=obj_merge(im.groups[b]||{},a);if(im.groups[b].contacts==undefined){im.groups[b].contacts={}}if(im.groups[b].topics==undefined){im.groups[b].topics={}}}if(undefined==im.groups[b].logo){im.groups[b].logo={}}if(undefined==im.groups[b].logo.nick){if(b>0){im.groups[b].logo.nick=im.lang.user+b}else{im.groups[b].logo.nick=im.lang.group+b}}im.group_add_publisher.deliver(a.gid)};im.group_get=function(d){var b=[];if(this.be_get==undefined){this.be_get={}}if(this.getting==undefined){this.getting={}}for(var c=0,a=d.length;c<a;c++){if(this.getting[d[c]]){continue}if(!this.be_get[d[c]]){this.be_get[d[c]]=d[c]}}};im.on_group_get_ack=function(d,g){var c,b,f,e,a;if(("group_get_ack"!=d)||g.result){return 1}if((a=g.groups)){for(c=0,b=a.length;c<b;c++){f=a[c];if(f.gid==0){alert("im.on_group_get_ack meet group.gid == 0");continue}if(!f.logo){f.logo={}}if(!f.logo.nick){f.logo.nick=((f.gid>0)?im.lang.user:im.lang.group)+f.gid}im.group_add(a[c])}}if((e=g.contacts)){for(c=0,b=e.length;c<b;c++){f=e[c];im.guser_add(f.owner_gid,f)}}if(g.group){f=g.group;if(!f.logo){f.logo={}}if(!f.logo.nick){f.logo.nick=im.lang.user+f.gid}im.group_add(f)}return 0};im.group_merge=function(b,a){if(!a){return b}if(a.user){b.user=a.user}if(a.logo){if(undefined==b.logo){b.logo={}}if(a.logo.nick){b.logo.nick=a.logo.nick}if(a.logo.icon){b.logo.icon=a.logo.icon}if(a.logo.bulletin){b.logo.bulletin=a.logo.bulletin}}if(a.status){b.status=a.status}return b};im.topic_add=function(c,b){var a,d;if(b.tid==undefined){alert("topic_add() failed with [invalid param:{topic.tid == undefined}]");return}if(im.groups[c]==undefined){alert("topic_add() failed with im.groups[gid] == undefined");return}if(im.groups[c].topics==undefined){im.groups[c].topics={}}a=im.groups[c].topics[b.tid];a=im.groups[c].topics[b.tid]=obj_merge(im.groups[c].topics[b.tid]||{},b);if(!a.orig_tmid&&a.tmid){a.orig_tmid=a.tmid}if(a.link_info&&!a.link_info.ex_key&&!a.refer_gid){d=a.link_info;if(d.tids&&d.tids.length==2){a.refer_gid=d.tids[(d.tids[0].gid==c)?1:0].gid;im.group_add({gid:a.refer_gid,owner_gid:a.refer_gid,refer_tid:b.tid})}}im.topic_add_publisher.deliver(c,b.tid)};im.on_topic_get_ack=function(c,e){var d;if(("object"!=typeof(e))||e.result||("topic_get_ack"!=c)){if("cancel"==c){return}return}for(var b=0,a=e.info.length;b<a;++b){if(d=e.info[b]){im.topic_add(d.gid,d)}}};im.topic_get_caption=function(l,d){var g=im.groups[l].topics[d],m;var c,o="",b,n,f,e;if((undefined==g)||(undefined==(c=g.link_info))){return" "}if(c.ex_key=="temp"){return g.caption}if(d<=1){o=im.lang.system_session}else{var a=(l>0)?g.refer_gid:l;if(a&&im.groups[a]&&im.groups[a].logo&&im.groups[a].logo.nick){o=im.groups[a].logo.nick}else{o=im.lang.user+a}}return o};im.topic_get_bulletin=function(d,f){var b=im.groups[d].topics[f],e,a="";if((undefined==b)||(undefined==(e=b.link_info))){return" "}if(e.ex_key=="temp"){return b.bulletin||""}if(b.refer_gid){var c=b.refer_gid;if(c&&im.groups[c]&&im.groups[c].logo&&im.groups[c].logo.bulletin){a=im.groups[c].logo.bulletin}}return a};im.guser_add=function(c,a){var b=a.gid;if(b==undefined){alert("guser_add() failed with [invalid param:{guser_profile.gid:undefined}]");return}if(im.groups[c]==undefined){im.group_add({gid:c})}if(im.groups[c].contacts==undefined){im.groups[c].contacts={}}im.groups[c].contacts[b]=obj_merge(im.groups[c].contacts[b]||{},a);im.guser_add_publisher.deliver(c,b)};im.guser_del=function(b,a){};im.guser_get_profile=function(b,d){var c,a;if(undefined==im.groups[b]){return null}if(undefined==(a=im.groups[b].contacts[d])){return im.groups[d]}c=im.groups[d];if(c.logo){a.logo=c.logo}if(c.detail){a.detail=c.detail}if(c.tag){a.tag=c.tag}if(c.permission){a.permission=c.permission}a.status=c.status;return a};im.guser_set_tag=function(b,c,a){if(undefined==im.groups[b]){im.groups[b]={}}if(undefined==im.groups[b].contacts[c]){im.groups[b].contacts[c]={}}if(undefined==im.groups[b].contacts[c].tag){im.groups[b].contacts[c].tag={}}im.groups[b].contacts[c].tag.data=a};im.empty_group={logo:{icon:0},status:im.status.TS_OFFLINE};im.icon_src=function(d,e,c){var a=im.groups[e]||im.empty_group;var b=(e<0)?im.status.TS_ONLINE:(c||a.status);if(a.logo&&a.logo.icon){return"/im/group_get_logo/logo.png?dnid="+global_sid+"&dgid="+d+"&dcontact_gid="+e+"&dlogo_id="+a.logo.icon+"&duser_state="+b}else{if((d<0)||(e<0)){return"/images/topics.gif"}else{return"/images/contacts2"+((b==im.status.TS_OFFLINE)?"-offline":"")+".jpg"}}};function obj2csstxt(b){var c,a="";for(c in b){a+=c+":"+b[c]+";"}return a}function remove_self(a){if(a.parentNode){a.parentNode.removeChild(a)}return a}function group_search_parser(d,n){var m=n.replace(/([<>]=?)\s*([0-9]*\.?[0-9]*)/g,"$1$2");var l=m.split(" ");var a=0,f;function b(q,o,p){q[o]=p;a++}for(var e=0,g=l.length;(e<g)&&(a<8);e++){if(d.nick==undefined){b(d,"nick",l[e])}}if(d.age_min&&d.age_max&&d.age_max<d.age_min){var c=d.age_max;d.age_max=d.age_min;d.age_min=c}return d}function invite_panel(a){this.create(a||{})}invite_panel.prototype={langs:{cn:{new_topic:"新建讨论组",new_group:"新建群",edit_topic:"编辑讨论组",edit_group:"编辑群",topic_add:"（二）编辑讨论组人员",new_topic1:"（一）讨论组标题"},en:{new_group:"Create group",new_topic:"Create discussion group",edit_topic:"Edit group",edit_group:"Edit group",topic_add:"(2) Edit discus group members",new_topic1:"(1) Discus caption:"}},get_default_skin:function(){return{width:536,height:496,label:{height:16,pad:4},main_wrapper:{width:530,height:402,pad:5},contacts:{bottom:0,left:0,height:316,width:206,border:{size:1}},invite_list:{bottom:0,right:0,height:316,width:206,border:{size:1}},del_btn:{bottom:126},add_btn:{bottom:190},btn:{space:170}}},create:function(b){var a=this;this.left=b.left||0;this.top=b.top||0;this.skin=obj_merge(this.get_default_skin(),b.skin||{});this.skin.left=(document.body.clientWidth-this.skin.width)/2;this.skin.top=(600-this.skin.height)/2;this.winbox=new window_box({on_status:function(c){a.on_winbox_event(c)},skin:{drag:true,close:true,width:this.skin.width,height:this.skin.height,left:this.skin.left,top:this.skin.top}});this.caption=this.winbox.get_caption();this.caption.innerHTML=this.lang.new_topic;this.body=this.winbox.get_body();this.body.appendChild(this.main_wrapper=document.createElement("div"));this.body.appendChild(this.invite_btn=document.createElement("button"));this.body.appendChild(this.cancel_btn=document.createElement("button"));this.invite_btn.className="sign_btn";this.cancel_btn.className="sign_btn";this.main_wrapper.appendChild(this.new_topic_label=document.createElement("label"));this.main_wrapper.appendChild(this.new_topic_input=document.createElement("input"));this.new_topic_input.type="text";this.new_topic_input.className="sign_input";this.new_topic_label.innerHTML=this.lang.new_topic1;this.main_wrapper.appendChild(this.topic_add_label=document.createElement("label"));this.main_wrapper.appendChild(this.contacts_panel=document.createElement("div"));this.main_wrapper.appendChild(this.invite_list_panel=document.createElement("div"));this.main_wrapper.appendChild(this.add_btn=document.createElement("button"));this.main_wrapper.appendChild(this.del_btn=document.createElement("button"));this.topic_add_label.innerHTML=this.lang.topic_add;this.add_btn.className="sign_btn";this.del_btn.className="sign_btn";this.contacts_tree=new tag_tree({parent:this.contacts_panel});this.invite_tree=new tag_tree({parent:this.invite_list_panel});this.tree_subscriber=function(d){if(d==im.account.uid){return}if(d<0){return}var c=im.groups[d];icon=im.icon_src(c.gid,c.gid,im.status.TS_ONLINE);a.contacts_tree.add({id:c.gid,text:c.logo.nick,tags:a.get_contact_tag(c.contacts[d]),icon:icon,data:c})};this.tree_subscriber.subscribe(im.group_add_publisher);this.add_btn.innerHTML=im.lang.add+"==>";this.del_btn.innerHTML="<=="+im.lang.del;this.invite_btn.innerHTML=im.lang.ok;this.cancel_btn.innerHTML=im.lang.cancel;this.add_btn.onclick=function(){a.on_add_btn()};this.del_btn.onclick=function(){a.on_del_btn()};this.invite_btn.onclick=function(){a.on_invite_btn()};this.cancel_btn.onclick=function(){a.on_cancel_btn()};this.update();this.init_contacts_tree()},destroy:function(){this.tree_subscriber.unsubscribe(im.group_add_publisher);this.contacts_tree.destroy();this.window_box.destroy()},update:function(){var c=this.skin,a,b;a=c.label;this.new_topic_label.style.cssText=this.topic_add_label.style.cssText="display:block;font-weight:bold;padding:"+a.pad+"px;height:"+a.height+"px;";a=c.main_wrapper;this.main_wrapper.style.cssText="position:absolute;background:white;padding:"+a.pad+"px;width:"+(a.width-a.pad*2)+"px;height:"+(a.height-a.pad*2)+"px;";this.new_topic_input.style.cssText="width:"+(a.width-a.pad*2*2)+"px;";a=c.contacts;this.contacts_panel.style.cssText="position:absolute;overflow-y:auto;border:"+a.border.size+"px solid black;bottom:"+(a.bottom+c.main_wrapper.pad)+"px;left:"+(a.left+c.main_wrapper.pad)+"px;width:"+(a.width-a.border.size*2)+"px;height:"+(a.height-a.border.size*2)+"px;";a=c.invite_list;this.invite_list_panel.style.cssText="position:absolute;overflow-y:auto;border:"+a.border.size+"px solid black;bottom:"+(a.bottom+c.main_wrapper.pad)+"px;right:"+(a.right+c.main_wrapper.pad)+"px;width:"+(a.width-a.border.size*2)+"px;height:"+(a.height-a.border.size*2)+"px;";b=(c.main_wrapper.width-this.add_btn.clientWidth)/2;this.add_btn.style.cssText="position:absolute;left:"+b+"px;bottom:"+c.add_btn.bottom+"px;";this.del_btn.style.cssText="position:absolute;left:"+b+"px;bottom:"+c.del_btn.bottom+"px;";a=this.skin.btn;this.invite_btn.style.cssText="position:absolute;bottom:16px;left:"+a.space+"px;";this.cancel_btn.style.cssText="position:absolute;bottom:16px;right:"+a.space+"px;"},init_contacts_tree:function(){var c=im.groups[im.account.uid],b,a;for(var d in im.groups){b=im.groups[d];if(b.gid===im.account.uid){continue}if(b.gid<0){continue}nick=(b.logo&&b.logo.nick)?b.logo.nick:this.lang.user+b.gid;icon=im.icon_src(b.gid,b.gid);this.contacts_tree.add({id:b.gid,text:nick,tags:this.get_contact_tag(c.contacts[b.gid]),icon:im.icon_src(b.gid,b.gid),data:b})}},get_contact_tag:function(b){var a="";if(undefined==b){return""}try{if((b.role.type==im.role.FRIEND)&&b.tag){a=b.tag.data}if(!a){a=im.role_text(b.role.type)}}catch(c){a=im.role_text(im.role.STRANGER)}return a},on_add_btn:function(){var l=im.groups[im.account.uid],e,g,d,c;var b=this.contacts_tree.get_item_data(this.contacts_tree.selected_item);if(!b){return}for(var f=0,a=b.length;f<a;f++){d=b[f];e=l.contacts[d.gid];c=(d.logo&&d.logo.nick)?d.logo.nick:this.lang.user+d.gid;g=im.icon_src(d.gid,d.gid);this.invite_tree.add({id:d.gid,text:c,tags:e?(e.tag||im.lang.stranger):"",icon:g,data:d})}},on_del_btn:function(){var b=this.invite_tree.get_item_data(this.invite_tree.selected_item);if(!b){return}for(var c=0,a=b.length;c<a;c++){this.invite_tree.del_item(this.invite_tree.root,b[c].gid)}},on_invite_btn:function(){var l=this;var e=this.invite_tree.get_item_data(this.invite_tree.root),f;var c={},m,a=[],o=this.new_topic_input.value;for(var d=0,g=e.length;d<g;d++){m=e[d];if(m.gid<0){continue}if(m.gid==this.gid){continue}c[m.gid]=m.gid}for(var b in c){f=c[b];if(this.group&&this.group.contacts[f]&&(this.group.contacts[f].role.type==im.role.FRIEND)){continue}a.push(f)}if(this.gid){this.self.send_msg("group_add",{gid:this.gid,gid_add:a},function(n,p){if(p.result===0){l.group.state.pid+=p.pass_list.length;l.self.on_ext_scroll()}})}else{this.self.send_msg("group_set",{info:{logo:{nick:o}}},function(n,p){if(p.result===0){if(a.length){l.self.send_msg("group_add",{gid:p.gid,gid_add:a},function(q,r){if(r.result===0){l.self.send_msg("group_get",{gid:im.account.uid,gids:[p.gid],flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(s,t){im.on_group_get_ack(s,t);im.topic_add(p.gid,{tid:im.GROUP_TOPIC,tmid:0,cur_tmid:0});l.topics_ptr.set_active_topic(p.gid,im.GROUP_TOPIC);l.self.send_msg("group_status_notify_ex",{flag:1,status:im.status.TS_WRITTING,gt_pair:[{gid:im.account.uid,tid:1}]},function(){})})}})}else{l.self.send_msg("group_get",{gid:im.account.uid,gids:[p.gid],flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(q,r){im.on_group_get_ack(q,r);im.topic_add(p.gid,{tid:im.GROUP_TOPIC,tmid:0,cur_tmid:0});l.topics_ptr.set_active_topic(p.gid,im.GROUP_TOPIC);l.self.send_msg("group_status_notify_ex",{flag:1,status:im.status.TS_WRITTING,gt_pair:[{gid:im.account.uid,tid:1}]},function(){})})}}})}this.on_cancel_btn()},on_cancel_btn:function(){this.invite_tree.clear_all();this.winbox.hide()},on_winbox_event:function(a){if(a=="close"){this.on_cancel_btn()}},invite:function(c,g){var e=im.groups[im.account.uid],a,b,d,f;if(c){this.group=im.groups[c];this.caption.innerHTML=this.lang.edit_group;this.new_topic_input.value=this.group.logo.nick}else{this.group=null;this.caption.innerHTML=this.lang.new_topic;this.new_topic_input.value=im.lang.temp_session}this.topics_ptr=e.topics_ptr;this.winbox.show();this.self=g;this.gid=c}};invite_panel.prototype.lang=lang_get(invite_panel.prototype.langs);im.invite=function(a,b){if(undefined==im.invite_panel){im.invite_panel=new invite_panel({left:120,top:120})}im.invite_panel.invite(a,b)};function find_panel(a){this.create(a||{})}find_panel.prototype={langs:{cn:{find_user:"查找用户",search:"查找",search_online:"查找在线用户",nick:"昵称",username:"用户名",location:"地区",relation:"关系",search_contact_failed:"搜索联系人失败",search_result:"搜索结果",search_result_empty:"搜索结果为空",bulletin:"签名",default_bulletin:"此人很懒，什么都不写",sex:"性别",male:"男",female:"女",age:"年龄",mars:"火星",security:"保密",already_friend:"已是好友",add_friend:"加为好友",start_chat:"开始聊天"},en:{find_user:"find user",search:"search",search_online:"search online",nick:"nickname",username:"username",location:"location",relation:"relation",search_contact_failed:"search contact failed",search_result:"search result",search_result_empty:"search result empty",bulletin:"bulletin",default_bulletin:"man so lazy, nothing leave",sex:"sex",male:"male",female:"female",age:"age",mars:"Mars",security:"security",already_friend:"already friend",add_friend:"add friend",start_chat:"chat"}},get_default_skin:function(){return{width:640,height:400,pad:5,top:90,search_bar:{height:20},wrapper:{height:330}}},create:function(f){var e,c=this,g,b,a,d;this.living=true;this.parent=f.parent||document.body;this.skin=d=obj_merge(this.get_default_skin(),f.skin||{});this.send_msg=f.send_msg;this.topics_ptr=f.topics_ptr;this.contacts_ptr=f.contacts_ptr;e=(document.body.clientWidth-this.skin.width)/2;this.winbox=new window_box({on_status:function(l){c.on_status(l)},caption:this.lang.find_user,skin:{drag:true,close:true,width:this.skin.width,height:this.skin.height,left:e,top:this.skin.top}});this.body=this.winbox.get_body();this.body.appendChild(this.panel=document.createElement("div"));b=parseInt(this.body.style.width);a=parseInt(this.body.style.height);this.panel.style.cssText="position:absolute;left:0px;top:0px;width:"+(b-d.pad*2)+"px;height:"+(a-d.pad*2)+"px;padding:"+d.pad+"px;background:white;";this.panel.appendChild(this.search_bar=document.createElement("div"));this.search_bar.innerHTML='<input id="find_panel_input" type="text" class="sign_input"/>&nbsp;&nbsp;<input id="find_panel_online_checkbox" type="checkbox" ></input><label for="find_panel_online_checkbox">'+im.lang.online+"</label>";this.input=$("#find_panel_input");this.checkbox=$("#find_panel_online_checkbox");this.panel.appendChild(this.result_wrapper=document.createElement("div"));this.result_wrapper.style.cssText="position:absolute;bottom:"+d.pad+"px;width:"+(b-d.pad*2)+"px;height:"+d.wrapper.height+"px;overflow-y:auto;";this.checkbox.onclick=function(){c.on_search()};this.list_view=new list_view({parent:this.result_wrapper,header:this.lang.search_result,columns:{name1:this.lang.nick+"("+this.lang.username+")",name2:this.lang.sex,name3:this.lang.age,name4:this.lang.location,name5:this.lang.bulletin,name6:"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;",name7:"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"},on_event:function(l,m){var n=l.srcElement||l.target;if((l.type=="click")&&(n.tagName.toLowerCase()!="a")){c.on_event(3,m.gid)}}});this.send_msg("group_search",{online:1},function(l,m){if(c.living){c.on_search_ack(l,m)}});if($.ie){this.input.attachEvent("onpropertychange",function(){c.on_search()})}else{this.input.addEventListener("input",function(){c.on_search()},false)}},destroy:function(){this.living=false;this.winbox.destroy()},on_status:function(a){if(a=="close"){this.winbox.hide()}},show:function(){this.winbox.show()},hide:function(){this.winbox.hide()},on_event:function(b,a){switch(b){case 1:this.topics_ptr.open_friend_topic(a);break;case 2:this.contacts_ptr.group_add(a);break;case 3:this.contacts_ptr.group_view_detail(a);break}},on_search:function(){var b=this,a=this.input.value.trim();if(a||this.checkbox.checked){if(this.timeout){clearTimeout(this.timeout)}this.timeout=setTimeout(function(){var c=group_search_parser({},a);c.online=b.checkbox.checked?1:0;b.send_msg("group_search",c,function(d,e){if(b.living){b.on_search_ack(d,e)}});b.timeout=null},300)}},on_search_ack:function(f,l){if(l.result){alert(this.lang.search_contact_failed);return}this.list_view.clear_all_item();var y,x,d,g,B,D,C=l.groups||[],u=im.groups[im.account.uid],p={},E,t,n,q,b,a=(new Date()).getYear();for(y=0,x=0;y<C.length;y++){im.group_add(d=C[y]);b=this.lang.mars;E=d.detail;n=this.lang.security;q=this.lang.security;if(d.gid==0){continue}if(p[d.gid]){continue}try{if((d.gid==im.account.uid)||(u.contacts[d.gid].role.type==im.role.FRIEND)){t=0}else{need_chat=1}}catch(A){t=1}var m;if(E&&E.section&&(m=E.section[0])){var c,r=m.fields,o;for(var v=0,z=r.length;v<z;v++){switch(r[v].name){case"birthday":var s=r[v].value.split("/");q=2011-s[0];break;case"sex":if(r[v].value=="male"){n=this.lang.male}else{n=this.lang.female}break;case"province":b=r[v].value;break}}}p[d.gid]=d;x++;try{this.list_view.add_item({gid:d.gid,icon:im.icon_src(d.gid,d.gid),name1:d.logo.nick+(d.user?("("+d.user+")"):""),name2:n+"&nbsp;&nbsp;",name3:q+"&nbsp;",name4:b,name5:d.logo.bulletin||this.lang.default_bulletin,name6:(im.account.uid!=d.gid)?('<a href="" onclick="im.find_panel.on_event(1, '+d.gid+'); return false;">'+this.lang.start_chat+"</a>"):("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"),name7:t?('<a href="" onclick="im.find_panel.on_event(2, '+d.gid+'); return false;">'+this.lang.add_friend+"</a>"):((im.account.uid==d.gid)?"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;":this.lang.already_friend)})}catch(A){}}if(x==0){this.list_view.set_header(this.lang.search_result_empty)}else{this.list_view.set_header(this.lang.search_result)}this.list_view.update()}};find_panel.prototype.lang=lang_get(find_panel.prototype.langs);function hot_panel(a){this.create(a||{})}hot_panel.prototype={langs:{cn:{new_groups:"最新小组",hot_groups:"热门小组",hot_groups_in_day:"本日最热",hot_groups_in_week:"本周最热",hot_groups_in_month:"本月最热",search_hot_groups_failed:"搜索热门小组失败",search_result_empty:"搜索结果为空",search_result:"搜索结果",default_bulletin:"这个小组很懒，都不写签名",name:"名称",bulletin:"公告",members:"成员数",messages:"消息数",join:"加入该组",already_member:"已是成员"},en:{new_groups:"new groups",hot_groups:"hot groups",hot_groups_in_day:"hottest group in day",hot_groups_in_week:"hottest group in week",hot_groups_in_month:"hottest group in month",search_hot_groups_failed:"search hot group failed",search_result_empty:"search result is empty",search_result:"search result",default_bulletin:"lazy group owner",name:"name",bulletin:"bulletin",members:"members",messages:"messages",join:"join",already_member:"already member"}},get_default_skin:function(){return{width:640,height:400,pad:5,top:90,search_bar:{height:20},wrapper:{height:320}}},create:function(f){var e,c=this,g,b,a,d;this.living=true;this.parent=f.parent||document.body;this.skin=d=obj_merge(this.get_default_skin(),f.skin||{});this.send_msg=f.send_msg;this.topics_ptr=f.topics_ptr;this.contacts_ptr=f.contacts_ptr;e=(document.body.clientWidth-this.skin.width)/2;this.winbox=new window_box({on_status:function(l){c.on_status(l)},is_hide:true,caption:this.lang.hot_groups,skin:{drag:true,close:true,width:this.skin.width,height:this.skin.height,left:e,top:this.skin.top}});this.body=this.winbox.get_body();this.prefix="";this.body.appendChild(this.panel=document.createElement("div"));b=parseInt(this.body.style.width);a=parseInt(this.body.style.height);this.panel.style.cssText="position:absolute;left:0px;top:0px;width:"+(b-d.pad*2)+"px;height:"+(a-d.pad*2)+"px;padding:"+d.pad+"px;background:white;";this.panel.appendChild(this.search_bar=document.createElement("div"));this.search_bar.innerHTML='<button id="recent_groups_btn" class="sign_btn">'+this.lang.new_groups+'</button>&nbsp;&nbsp;<button id="hot_btn" class="sign_btn">'+this.lang.hot_groups+"</button>&nbsp;&nbsp;";this.recent_btn=$("#recent_groups_btn");this.hot_btn=$("#hot_btn");this.panel.appendChild(this.result_wrapper=document.createElement("div"));this.result_wrapper.style.cssText="position:absolute;bottom:"+d.pad+"px;width:"+(b-d.pad*2)+"px;height:"+d.wrapper.height+"px;overflow-y:auto;";this.list_view=new list_view({parent:this.result_wrapper,header:this.lang.search_result,columns:{name1:this.lang.name,name2:this.lang.bulletin,name3:this.lang.members,name4:this.lang.messages,name5:"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"},on_event:function(l,m){var n=l.srcElement||l.target;if((l.type=="click")&&(n.tagName.toLowerCase()!="a")){c.on_event(2,m.gid)}}});this.send_msg("server_get_statistics",{flag:2},function(l,m){if(c.living){c.prefix="("+c.lang.hot_groups+")";if(c.on_search_ack(l,m)){c.show()}}});this.recent_btn.onclick=function(){c.send_msg("server_get_statistics",{flag:4},function(l,m){if(c.living){c.prefix="("+c.lang.hot_groups+")";c.on_search_ack(l,m)}})};this.hot_btn.onclick=function(){c.send_msg("server_get_statistics",{flag:2},function(l,m){if(c.living){c.prefix="("+c.lang.hot_groups+")";c.on_search_ack(l,m)}})}},destroy:function(){this.living=false;this.winbox.destroy()},on_status:function(a){if(a=="close"){this.winbox.hide()}},show:function(){this.winbox.show()},hide:function(){this.winbox.hide()},on_event:function(b,a){var c=this;switch(b){case 1:this.contacts_ptr.group_add(a,"","",function(){c.topics_ptr.open_friend_topic(a)});break;case 2:this.contacts_ptr.group_view_detail(a);break}},on_search:function(){var b=this,a=this.input.value.trim();if(a||this.checkbox.checked){if(this.timeout){clearTimeout(this.timeout)}this.timeout=setTimeout(function(){var c=group_search_parser({},a);c.online=b.checkbox.checked?1:0;b.send_msg("group_search",c,function(d,e){if(b.living){b.on_search_ack(d,e)}});b.timeout=null},300)}},on_search_ack:function(o,b){this.list_view.clear_all_item();var g,f,c,d,q,a,p=im.groups[im.account.uid],l,s,r,m=b.hot_groups||[];for(g=0,f=0;g<m.length;g++){s=m[g];r={gid:s.gid,owner_gid:s.gid,logo:s.logo};im.group_add(r);try{l=(p.contacts[r.gid].role.type>im.role.FRIEND)}catch(n){l=1}f++;try{this.list_view.add_item({gid:r.gid,icon:im.icon_src(r.gid,r.gid),name1:r.logo.nick,name2:r.logo.bulletin||this.lang.default_bulletin,name3:s.pid+"&nbsp;&nbsp;",name4:s.tmid+"&nbsp;&nbsp;&nbsp;",name5:l?('<a href="" onclick="im.hot_panel.on_event(1, '+r.gid+'); return false;">'+this.lang.join+"</a>"):this.lang.already_member})}catch(n){}}if(f==0){this.list_view.set_header(this.prefix+this.lang.search_result_empty)}else{this.list_view.set_header(this.prefix+this.lang.search_result)}this.list_view.update();return f}};hot_panel.prototype.lang=lang_get(hot_panel.prototype.langs);function face_panel(a){this.create(a||{})}face_panel.prototype={get_default_skin:function(){return{bg:"blue",left:90,top:110,width:350,height:250,pad:5,border:{size:1,color:"#999"},head:{height:20},page_item:80,face:{width:28,height:28}}},lang:{onion:"洋葱头"},create:function(c){var a=this,b;this.skin=b=obj_merge(this.get_default_skin(),c.skin||{});this.parent=c.parent||document.body;this.faces=this.get_faces();this.parent.appendChild(this.panel=document.createElement("div"));this.tablist=new tabs({parent:this.panel,skin:{vertical:false,pad:0,xcaption:{bg:"#cef"},head_shadow:{size:0},content:{bg:"#fff"},height:this.skin.head.height}});this.onion_face=this.tablist.create_tab({name:"onion",caption:this.lang.onion,on_cmd:function(d,e){if(e=="active"){a.create_face_tab(d,e,"onion")}}});this.hide_handle=function(){a.hide()};this.panel.onmouseup=function(d){evt.stop(d||window.event)};this.panel.onkeydown=function(d){evt.stop(d||window.event)};this.update()},destroy:function(){remove_self(this.head);remove_self(this.body);remove_self(this.panel)},update:function(){var a=this.skin;this.panel.style.cssText="position:absolute;left:"+a.left+"px;top:"+a.top+"px;width:"+(a.width-a.border.size*2-a.pad*2)+"px;height:"+(a.height-a.border.size*2-a.pad*2)+"px;border:"+a.border.size+"px solid "+a.border.color+";padding:"+a.pad+"px;background:white;";this.tablist.update()},show:function(a,b){if(this.parent!=a){this.parent=a;a.appendChild(this.panel)}this.callback=b;this.panel.style.display="";evt.bind(document,"mouseup",this.hide_handle);evt.bind(document,"keydown",this.hide_handle)},hide:function(){this.panel.style.display="none";evt.unbind(document,"mouseup",this.hide_handle);evt.unbind(document,"keydown",this.hide_handle)},get_faces:function(){var b={onion:[]};for(var a=0;a<=71;a++){b.onion[a]="on12_"+a+".gif"}return b},create_face_tab:function(a,d,q){var b,m,o,l,g,f,c,n,e;var p=this;if(a.content.innerHTML){return}b=this.faces[q];c=b.length;n=Math.round((c+this.skin.page_item-1)/this.skin.page_item);for(l=0,g=0;l<n;l++){o=document.createElement("div");o.style.display="none";for(f=0;(f<this.skin.page_item-1)&&(g<c);f++){m=document.createElement("img");m.src="/images/face/"+b[g];m.face_name=b[g++];m.className="small_face";m.onclick=function(){if(p.callback){p.callback(this.face_name)}p.hide()};if($.ie6){m.onmouseenter=function(){this.style.border="1px solid blue";this.style.cursor="pointer"};m.onmouseleave=function(){this.style.border="";this.style.cursor=""}}o.appendChild(m)}a.content.appendChild(o)}this.active_page=a.content.childNodes[0];this.active_page.style.display="block"}};im.show_face_panel=function(a,b){if(undefined==im.face_panel){im.face_panel=new face_panel({parent:a})}im.face_panel.show(a,b)};function app_btn(a){this.create(a||{})}app_btn.prototype={get_default_skin:function(){return{left:0,top:0,width:96,height:96,icon:{width:48,height:48},img:"/images/share.gif"}},create:function(a){this.parent=a.parent||document.body;this.skin=obj_merge(this.get_default_skin(),a.skin||{});this.parent.appendChild(this.app_btn_wrapper=document.createElement("div"));if($.ie6){this.app_btn_wrapper.className="app_btn_wrapper_ie6"}else{this.app_btn_wrapper.className="app_btn_wrapper"}this.app_btn_wrapper.appendChild(this.app_btn=document.createElement("div"));this.app_btn.className="app_btn";this.app_btn.style.backgroundImage="url("+this.skin.img+")";this.app_btn_wrapper.appendChild(this.app_text=document.createElement("div"));this.app_text.className="app_text";this.app_text.innerHTML=a.text;if($.ie6){this.app_btn_wrapper.onmouseenter=function(){this.style.filter='filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=scale, src="/images/appbar_mouseover_bg.png")'};this.app_btn_wrapper.onmouseleave=function(){this.style.filter='filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=scale, src="/images/appbar_bg.png")'}}if(a.callback){this.app_btn_wrapper.onclick=a.callback}this.update()},destroy:function(){remove_self(this.app_btn);remove_self(this.app_text);remove_self(this.app_btn_wrapper)},update:function(){var a=this.skin;this.app_btn_wrapper.style.cssText="position:absolute;left:"+this.skin.left+"px;top:"+this.skin.top+"px;"}};function tag_panel(a){this.create(a||{})}tag_panel.prototype={get_default_skin:function(){return{width:352,height:184,head:{height:26},wrapper:{width:250,top:30,height:90},label:{height:16,pad:4,font:{size:14}},btn:{bottom:5,ok:{left:10},cancel:{right:10}},input:{width:220}}},create:function(b){var a=this;this.skin=obj_merge(this.get_default_skin(),b.skin||{});this.skin.left=(document.body.scrollWidth-this.skin.width)/2;this.skin.top=(500-this.skin.height)/2;this.winbox=new window_box({on_status:function(c){a.on_status(c)},skin:{drag:true,close:true,width:this.skin.width,height:this.skin.height,left:this.skin.left,top:this.skin.top,head:{height:this.skin.head.height}}});this.caption=this.winbox.get_caption();this.body=this.winbox.get_body();this.caption.innerHTML=im.lang.edit_tag;this.body.appendChild(this.wrapper=document.createElement("div"));this.wrapper.appendChild(this.label=document.createElement("label"));this.wrapper.appendChild(this.input=document.createElement("input"));this.wrapper.appendChild(this.btn_wrapper=document.createElement("div"));this.input.type="text";this.label.innerHTML=im.lang.tag_hint;this.input.className="sign_input";this.btn_wrapper.appendChild(this.ok_btn=document.createElement("button"));this.btn_wrapper.appendChild(this.cancel_btn=document.createElement("button"));this.ok_btn.innerHTML=im.lang.ok;this.cancel_btn.innerHTML=im.lang.cancel;this.ok_btn.className="sign_btn";this.cancel_btn.className="sign_btn";this.cancel_btn.onclick=function(){a.winbox.hide()};this.ok_btn.onclick=function(){if(a.callback){a.callback(a.input.value)}a.winbox.hide()};this.input.onkeypress=function(f){var d=f||window.event;var c=d.charCode||d.keyCode;if(c==13){a.ok_btn.click()}};this.update()},destroy:function(a){this.winbox.destroy()},on_status:function(a){if(a=="close"){this.winbox.hide()}},update:function(){var a=this.skin;this.wrapper.style.cssText="position:absolute;padding:0;text-align:center;left:"+((a.width-a.wrapper.width)/2)+"px;top:"+a.wrapper.top+"px;width:"+a.wrapper.width+"px;height:"+a.wrapper.height+"px;";this.label.style.cssText="font-size:"+a.label.font.size+"px;height:"+a.label.height+"px;line-height:"+a.label.height+"px;";this.input.style.cssText="position:relative;top:5px;width:"+a.input.width+"px;";this.ok_btn.style.cssText="position:absolute;bottom:"+a.btn.bottom+"px;left:"+a.btn.ok.left+"px;";this.cancel_btn.style.cssText="position:absolute;bottom:"+a.btn.bottom+"px;right:"+a.btn.cancel.right+"px;"},show:function(){this.winbox.show()},hide:function(){this.winbox.hide()},set:function(a,b){this.input.value=a;this.callback=b;this.winbox.show()}};im.set_tag=function(a,b){if(undefined==this.panel){this.panel=new tag_panel()}this.panel.set(a,b)};function topic_view(a){this.create(a)}topic_view.prototype={magic:"topic_view",langs:{cn:{ext_display:"显示侧边栏",ext_hide:"隐藏侧边栏",send_hint:"◆发送：ENTER或CTRL+ENTER\r\n◆换行：SHIFT+ENTER",stop:"停止",play:"播放",play_stop:"停止播放",play_you_video:"正在观看你的视频",play_:"正在观看",_video:"的视频",play_you_video_stop:"关闭了你的视频",publish:"发布",publish_stop:"关闭",video:"视频",upload:"上传文件",group_add_0:"对方同意你的邀请，和您成为了好友！",group_add_1:"已经加您为好友！",group_add_2:"想加你为好友！",accept:"接受",denial:"拒绝",user_add_the_topic:"参与者",user:"用户",share:"分享",topic_share:"分享此会话",video_share:"分享此视频",file_dialog_cap:"文件上传",cancel:"取消",confirm:"确认",err_camera_not_install:"对不起，你还没有安装摄像头",err_camera_busy:"摄像头正被别的程序使用",err_camera:"对不起，你的摄像头可能没有安装或被别的程序占用",err_video_start:"视频启动失败，请稍候再试",cam_select:"摄像头选择",mic_select:"麦克风选择",cam:"摄像头",mic:"麦克风",io_error:"网络出现故障",me:"我",drm_error:"数字视频授权无法通过",unknown_msg_type:"unknown message type",newest_msg:"(最新消息)",media_msg:"视频消息",sys_msg:"系统消息",msg:"消息",th_prevfix:"第",th_postfix:"条",share_hint:"点此按钮，邀请用户加入讨论组",need_pull:"未拉取",pulling:"拉取中...",peer_refuse_hint:"添加失败，对方拒绝所有好友邀请",need_peer_confirm_hint:"需要对方确认，已向对方发送请求",need_answer_question_hint:"用户需要回答问题，问题为空, 返回",already_friend_hint:"你们已经是好友",group_add_ack_failed_hint:"添加好友失败",become_friend:"成为好友",add_:"想加",_friend:"为好友",topic_invite:"邀请你进入讨论组",file_uploaded:"已上传文件",size:"大小",input_hint:"在此输入消息，按【回车】键发送",sent_at:"发表于",joined_group:"进入了群",and:"和",become_friend:"成为好友",quit_group:"退出了群",delete_from_group:"删除了"},en:{ext_display:"display extension ",ext_hide:"hide extension",send_hint:"◆send：ENTER或CTRL+ENTER\r\n◆line wrap：SHIFT+ENTER",stop:"stop",play:" play",play_stop:"shut down",play_you_video:" is watching your video",play_:"play ",_video:"'s video",play_you_video_stop:" shut down your video",publish:" publish",publish_stop:"stop publishing",video:"video",upload:"upload",group_add_0:"agree to add you as friend",group_add_1:"already in buddy list",group_add_2:"invite you to be a friend",accept:"accept",denial:"deny",user_add_the_topic:"participator",user:"user",share:"share",topic_share:"share topic",video_share:"share video",file_dialog_cap:"file upload",cancel:"cancel",confirm:"confirm",err_camera_not_install:"I'm sorry, your webcam can't be finded",err_camera_busy:"your webcam is now occupied",err_camera:"I'm sorry that your webcam can't be installed or occupied",err_video_start:"failed to open your video, please try it later",cam_select:"webcam option",mic_select:"mic option",cam:"webcam",mic:"mic",io_error:"networking issue",me:"I",drm_error:"failed to pass through with authorized digital video",unknown_msg_type:"unknown message type",newest_msg:"the latest message",media_msg:"video message",sys_msg:"system message",msg:"message",th_prevfix:"",th_postfix:"th ",share_hint:"click this button, invite user join this group",need_pull:"waiting for extracting",pulling:"extracting...",peer_refuse_hint:"add failed,denied by your friend",need_peer_confirm_hint:"sent message out, waiting for confirmation",need_answer_question_hint:"feedback is needed,when result is null then return",already_friend_hint:"already in buddy list",group_add_ack_failed_hint:"failure of adding friends",become_friend:"adding friend success",add_:"want to add ",_friend:"as friend",topic_invite:"invite you join topic",file_uploaded:"finished upload",size:"size",input_hint:"input message here, press [ENTER] key to send",sent_at:" sent at ",joined_group:" join the group ",and:" and ",become_friend:" become friend ",quit_group:" quit qroup ",delete_from_group:" delete "}},send:{enter:true,ctrl_enter:true,shift_enter:false,ctrl_shift_enter:false},media_srv:{proto:{plug:[{name:"",port:""},{name:"rtmp://",port:":8080"}],flash:[{name:"",port:":8080"}]},host:((window.location.protocol=="http:")?window.location.hostname:"127.0.0.1"),app:"/live/"},get_counts:64,try_times:1200,msg_height:16,try_timeout:1200,msg_status_line_timer_ms_min:3000,msg_status_line_timer_ms_max:10000,android_cam_param:"cam.width=240\ncam.height=320\ncam.fps=8",get_default_skin:function(){return{share_span_width:100,share_input_width:400,msg:{width:640,height:360,pad:8},tool_bar:{height:45},line:{size:1,color:"#669"},focus_bg:"#69c",attachment:"../images/attachment.gif",ext:{visible:false,width:160},ext_shadow:{width:6,arrow:{pad:0,show:"images/right.gif",show_empty:"images/right-empty.gif",hide:"images/left.gif",hide_empty:"images/left-empty.gif"}},bar:{height:77,icon:{pad:2,margin_right:8,size:36,width:32,height:32},cam:{img:"images/cam.gif",active_img:"images/cam-active.gif"},play:{start:"images/play.gif",stop:"images/stop.gif"},txt:{left:8,border:{color:"#999",size:1},pad:4,height:36,width:632,max_height:100,bg:"#fff url(images/input-bg.gif)",font:"12px 宋体"},upload:{img:"images/file_upload.gif"},face:{img:"/images/face.gif"},send:{right:35},share:{img:"/images/share.gif"}},button:{border:"none",width:"300px","vertical-align":"middle","font-size":"16px","line-height":"26px",cursor:"pointer",background:"url(images/menu-item-bg.gif)"},media:{width:300,height:100}}},create:function(g){var e=this,f,d;this.parent=g.parent;this.skin=this.get_default_skin();if("object"==typeof(g.skin)){obj_merge(this.skin,g.skin)}this.bs=hack.get_border_space();this.ps=hack.get_padding_space();this.txt_bs=hack.get_text_border_space();this.txt_ps=hack.get_text_padding_space();this.uid=g.uid;this.gid=g.gid;this.tid=g.tid;this.account=g.account;this.send_msg=g.send_msg;this.cam_active=false;this.media_visible=false;this.video_active_counts=0;this.videos={};this.last_write_time=0;this.pub_try_times=0;this.pub_url_try_index=0;this.cam_index=-2;this.mic_index=-2;this.plug_info=null;this.cam_panel=null;this.mic_panel=null;this.min_date=0;this.max_date=0;this.topic=im.groups[this.gid].topics[this.tid];this.loading=false;this.prev_value=0;this.group=im.groups[this.gid];this.ext=document.createElement("div");this.status_div=null;this.ext_shadow=document.createElement("div");this.ext_hide=(this.tid==1);this.unloaded_doms=[];if(!g.ext_hide){this.on_ext_shadow_event=function(l){e.on_shadow_event(l||window.event)};this.ext_shadow.onclick=this.on_ext_shadow_event;this.ext_shadow.onmouseover=this.on_ext_shadow_event;this.ext_shadow.onmouseout=this.on_ext_shadow_event;this.ext_shadow.appendChild(this.ext_shadow_arrow=document.createElement("img"));this.ext_shadow_arrow.style.cssText="display:none;";this.on_ext_shadow_arrow_event=function(l){l=l||window.event;if(l.stopPropagation){l.stopPropagation()}else{l.cancelBubble=true}};this.ext_shadow_arrow.onmouseover=this.on_ext_shadow_arrow_event;this.ext_shadow_arrow.onmouseout=this.on_ext_shadow_arrow_event}this.parent.appendChild(this.msg=document.createElement("div"));this.parent.appendChild(this.media=document.createElement("div"));this.parent.appendChild(this.bar=document.createElement("div"));this.bar.appendChild(this.tool_bar=document.createElement("div"));this.msg.appendChild(this.msg_cont=document.createElement("div"));this.ext.appendChild(this.tree_panel=document.createElement("div"));this.msg_cont.onscroll=function(){var l=this;if(this.timer){clearTimeout(this.timer)}this.timer=setTimeout(function(){e.onscroll();l.timer=null},200)};if(this.topic.tmid){var a=document.createElement("div");this.unloaded_doms.push(a);this.msg_cont.appendChild(a);a.tmid_min=1;a.tmid_max=this.topic.tmid;this.update_doms()}this.user_pop_menu=new user_pop_menu({parent:this,gid:this.gid,on_cmd:function(m,l){e.on_usermenu_cmd(m,l)}});this.tree=new tag_tree({parent:this.tree_panel,on_event:function(m,l){if(l&&l.id&&l.data){e.user_pop_menu.on_event(m,l.data)}}});if(this.gid>0){this.on__topic_add=function(l,m){e.on_topic_add(l,m)};this.on__topic_add.subscribe(im.topic_add_publisher,this.gid,this.tid);this.on_topic_add(this.gid,this.tid);this.topic__sidebar_add_user=function(l){e.topic_sidebar_add_user(l)};this.topic__sidebar_add_user.subscribe(im.group_add_publisher)}else{if(this.gid<0){this.on__client_group_add=function(l){e.on_client_group_add(l)};this.on__client_group_add.subscribe(im.group_add_publisher,this.gid);this.on_client_group_add(this.gid);this.pid_start=0;this.pid_loading=false;this.ext.onscroll=function(){var l=this;if(this.timer){clearTimeout(this.timer)}this.timer=setTimeout(function(){e.on_ext_scroll();l.timer=null},200)}}}this.tool_bar.appendChild(this.cam=document.createElement("span"));this.cam.appendChild(this.cam_icon=document.createElement("img"));this.cam.style.cssText="visibility:hidden;";this.cam_icon.onmouseover=function(l){e.on_img_focus(e.cam_icon,true)};this.cam_icon.onmouseout=function(l){e.on_img_focus(e.cam_icon,false)};this.cam_onclick=function(l){e.cam_on_click()};this.cam_icon.onclick=this.cam_onclick;this.tool_bar.appendChild(this.upload=document.createElement("span"));this.upload.style.cssText="visibility:hidden;";if(this.tid!=1){this.tool_icon=this.add_tool_icon(this.skin.bar.face.img,function(l){im.show_face_panel(e.parent,function(m){b();e.txt.value+="[face:"+m+"]";e.txt.focus()})})}if(this.gid<0){this.parent.appendChild(this.share_bar=document.createElement("div"));this.tool_bar.appendChild(this.share_span=document.createElement("span"));this.share_span.appendChild(this.share_btn=document.createElement("img"));this.share_btn.onclick=function(){e.share_bar.style.display=e.share_bar.style.display?"":"none";if(e.share_bar.style.display==""){e.share_bar.style.height=e.share_bar.scrollHeight-2+"px"}};this.share_btn.title=this.lang.share_hint;this.share_btn.onmouseover=function(l){e.on_img_focus(e.share_btn,true)};this.share_btn.onmouseout=function(l){e.on_img_focus(e.share_btn,false)};this.share_bar.appendChild(this.topic_share=document.createElement("div"));this.topic_share.appendChild(this.topic_label=document.createElement("span"));this.topic_share.appendChild(this.topic_input=document.createElement("input"));this.topic_label.style.width=this.skin.share_span_width+"px";this.topic_label.innerHTML="&nbsp;"+this.lang.topic_share+"&nbsp;:";this.topic_input.type="text";this.topic_input.value=im.href+"?ga="+this.gid;this.topic_input.style.width=this.skin.share_input_width+"px"}this.upload_frm=new user_file_pub({parent:this.upload,req_command:"/im/file_pub",extra_parms:{dnid:global_sid,dgid:this.gid,dtid:this.tid},caption:this.lang.file_dialog_cap,mouse_event_handle:function(m,l){e.on_img_focus(m,l)},img_src:this.skin.bar.upload.img,width:this.skin.bar.icon.size,height:this.skin.bar.icon.size,pad:this.skin.bar.icon.pad});this.bar.appendChild(this.txt=document.createElement("textarea"));this.txt.style.cssText="visibility:hidden;";function b(){if(!e.hint_showed){e.hint_showed=true;e.txt.value="";e.txt.style.color=""}}if((navigator.userAgent.indexOf("MSIE 5.")>=0)||(navigator.userAgent.indexOf("MSIE 6.")>=0)||(navigator.userAgent.indexOf("MSIE 7.")>=0)){this.txt.onkeypress=function(l){b();e.txt_on_keydown(l||window.event)};this.txt.onkeyup=function(l){b();e.txt_on_keydown(l||window.event)}}else{if(navigator.userAgent.indexOf("Opera")>=0){this.txt.onkeypress=function(l){b();e.txt_on_keydown(l||window.event)}}else{this.txt.onkeydown=function(l){b();e.txt_on_keydown(l||window.event)}}}this.txt.onfocus=function(l){if(e.hint_showed&&(e.txt.value==e.lang.input_hint)){e.txt.value="";e.txt.style.color=""}};this.txt.onblur=function(){if(e.txt.value==""){e.hint_showed=false;e.txt.value=e.lang.input_hint;e.txt.style.color="gray"}};this.txt.onmousedown=function(){b();e.txt.focus()};this.txt.title=this.lang.send_hint;this.txt.value=this.lang.input_hint;this.hint_showed=false;this.save_txt="";this.webkit=navigator.userAgent.indexOf("WebKit")>=0;f=function(l){if(e.ie){if(!e.old_txt&&(e.txt.value=="")){return}if(e.old_txt&&(e.old_txt==e.txt.value)){return}e.old_txt=e.txt.value}e.txt_on_change(l||window.event)};if($.ie){this.txt.attachEvent("onpropertychange",f)}else{this.txt.addEventListener("input",f,false)}this.parent.appendChild(this.ext);this.parent.appendChild(this.ext_shadow);this.update();if(this.group.msg_set&&this.group.msg_set[this.tid]){var c=this.group.msg_set[this.tid];for(var d=0;d<c.length;d++){var g=c[d];this.on_imsg(g.type,g.msg)}delete this.group.msg_set[this.tid]}},destroy:function(){this.publish_stop();this.pub_url_try_index=0;this.video_del_all();if(this.on__topic_add){this.on__topic_add.unsubscribe(im.topic_add_publisher)}if(this.on__client_group_add){this.on__client_group_add.unsubscribe(im.group_add_publisher,this.gid)}if(this.topic__sidebar_add_user){this.topic__sidebar_add_user.unsubscribe(im.group_add_publisher)}if(this.user_setting){this.user_setting.destroy();this.user_setting=null}if(this.ext_shadow_arrow_lines){this.ext_shadow_arrow_lines.destroy();delete this.ext_shadow_arrow_lines}if(this.client_shadow_background){this.client_shadow_background.destroy();delete this.client_shadow_background}if(this.on_ext_shadow_event){delete this.on_ext_shadow_event}if(this.on_ext_shadow_arrow_event){delete this.on_ext_shadow_arrow_event}this.ext_shadow.parentNode.removeChild(this.ext_shadow);delete this.ext_shadow;this.ext.parentNode.removeChild(this.ext);delete this.ext;if(this.plug){this.plug.destroy();delete this.plug}delete this.parent;this.cam_icon.parentNode.removeChild(this.cam_icon);this.cam.parentNode.removeChild(this.cam);this.cam_icon=null;this.cam=null;this.user_pop_menu.destroy();this.user_pop_menu=null;this.upload_frm.destroy();this.upload_frm=null;this.upload.parentNode.removeChild(this.upload);this.upload=null;if(this.status_div){this.status_div.parentNode.removeChild(this.status_div);this.status_div=null}},update:function(){var f=this.skin,g=f.bar.icon.size,l=this.parent.clientHeight,c=(f.ext.visible?f.ext.width:0)+f.ext_shadow.width,b=this.parent.clientWidth-c,e=this,d,a;this.txt_pad=(2*f.bar.txt.pad*this.txt_ps)+(2*f.bar.txt.border.size*this.txt_bs);this._padding=($.ie||this.webkit)?this.txt_pad:0;this.ext.style.cssText="position:absolute;left:0px;top:0px;overflow-x:hidden;overflow-y:auto;background:white;"+(f.ext.visible?"":"display:none;")+"width:"+f.ext.width+"px;height:"+f.msg.height+"px;";this.ext_shadow.style.cssText="position:absolute;"+(!this.ext_hide?"cursor:pointer;":"")+"left:"+(f.ext.visible?f.ext.width:0)+"px;width:"+f.ext_shadow.width+"px;height:"+f.msg.height+"px;";this.tree_panel.style.display=f.ext.visible?"":"none";if(null==this.ext_shadow_lines){this.ext_shadow_lines=new shadow_lines({parent:this.ext_shadow,skin:{from:"left",head_line:{size:0}}})}else{this.ext_shadow_lines.update()}if(this.ext_shadow_arrow){this.ext_shadow_arrow.style.cssText="position:absolute;top:50%;"+(f.ext.visible?"left:0px;":"right:0px");this.ext_shadow_arrow.src=f.ext.visible?f.ext_shadow.arrow.hide_empty:f.ext_shadow.arrow.show_empty;this.ext_shadow.title=(f.ext.visible?this.lang.ext_hide:this.lang.ext_display)}this.msg.style.cssText="position:absolute;right:0px;top:0px;width:"+f.msg.width+"px;height:"+f.msg.height+"px;";this.msg_cont.style.cssText="position:absolute;right:0px;top:0px;line-height:1.5em;overflow-x:hidden;overflow-y:auto;word-wrap:break-word;background:white;padding:"+f.msg.pad+"px;width:"+(f.msg.width-f.msg.pad*2-(f.ext.visible?f.ext.width:0))+"px;height:"+(f.msg.height-f.msg.pad*2)+"px;";this.msg_cont_height=parseInt(this.msg_cont.style.height)+f.msg.pad*2;this.media.style.cssText="position:absolute;right:0px;top:0px;background:#000;width:"+(f.msg.width-(f.ext.visible?f.ext.width:0))+"px;height:"+f.msg.height+"px;visibility:"+(this.media_visible?"":"hidden")+";";d=f.msg.width+f.msg.pad*2;this.bar.style.cssText="position:absolute;bottom:0px;left:0px;display:"+((this.tid>1)?"":"none")+";width:"+d+"px;height:"+f.bar.height+"px;";this.tool_bar.style.cssText="position:absolute;left:0px;top:0px;width:"+d+"px;height:"+f.tool_bar.height+"px;";if(this.share_bar){this.share_bar.style.cssText="position:absolute;bottom:"+f.bar.height+"px;display:none;background:white;right:0px;width:"+(b-2)+"px;overflow-y:auto;border:1px solid black;"}if(this.plug){this.plug.update()}this.cam.style.cssText="display:inline-block;position:relative;left:0px;top:0px;margin: 0 auto;width:"+(g+f.bar.icon.margin_right)+"px;height:"+g+"px;";this.cam_icon.style.cssText="cursor:pointer;position:absolute;left:"+f.bar.icon.pad+"px;top:"+f.bar.icon.pad+"px;width:"+f.bar.icon.width+"px;height:"+f.bar.icon.height+"px;";this.cam_icon.src=this.cam_active?f.bar.cam.active_img:f.bar.cam.img;this.cam_icon.title=(this.cam_active?this.lang.stop:"")+this.lang.publish+" "+this.lang.video;this.upload.style.cssText="position:relative;display:inline-block;left:0px;top:0px;width:"+(g+f.bar.icon.margin_right)+"px;height:"+g+"px;";this.upload_frm.update();if(this.share_span){d=g+f.bar.icon.margin_right;this.share_span.style.cssText="position:relative;display:inline-block;left:0px;top:0px;width:"+d+"px;height:"+g+"px;";this.share_btn.src=f.bar.share.img;this.share_btn.style.cssText=this.cam_icon.style.cssText}this.txt_default_height=(f.bar.txt.height-this.txt_pad);this.txt.style.cssText="position:absolute;bottom:0px;display:inline;margin:0px;overflow:hidden;resize:none;-moz-resize:none;left:"+f.bar.txt.left+"px;background:"+f.bar.txt.bg+";padding:"+f.bar.txt.pad+"px;border:"+f.bar.txt.border.size+"px solid "+f.bar.txt.border.color+";width:"+(f.bar.txt.width-this.txt_pad)+"px;height:"+this.txt_default_height+"px;"+((f.bar.txt.font&&(""!=f.bar.txt.font))?("font:"+f.bar.txt.font+";"):"")+((this.txt.value==this.lang.input_hint)?"color:gray;":"")},on_topic_add:function(m,e){var l=im.groups[m].topics[e],q=this;if(this.gid<0){return}if((undefined==l)||(undefined==l.link_info)){this.send_msg("topic_get",{gid:this.gid,tid:[this.tid]},function(n,t){im.on_topic_get_ack(n,t)});return}var r=l.link_info.tids,c=(new Date()).getTime();var m,s,d,a=[],p=l.link_info.ex_key,g={};if(r){if(!l.members){l.members={}}for(var f=0,o=r.length;f<o;f++){m=r[f].gid;l.members[m]=c;this.topic_sidebar_add_user(m);if(!im.groups[m]){a.push(r[f].gid)}}for(var b in l.members){m=b-0;if(l.members[b]<c){delete l.members[b];this.tree.del_item(this.tree.root,m)}}}if(a.length){this.send_msg("group_get",{gids:a,flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_GROUPS},function(n,t){im.on_group_get_ack(n,t);a.forEach(function(u){q.topic_sidebar_add_user(u)})})}},topic_sidebar_add_user:function(g){var b=im.groups[this.gid];var a=im.groups[g];var f=im.icon_src(this.gid,g);var c=b.topics?b.topics[this.tid]:undefined;try{if(!c.members[g]){return}}catch(l){return}var m=c.link_info.ex_key;var d=m&&this.have_invite_permission(g);if(a&&a.logo&&a.logo.nick){this.tree.add({id:g,text:a.logo.nick,tags:d?im.lang.admin:im.lang.member,icon:f,data:a})}else{this.tree.add({id:g,text:this.lang.user+g,tags:d?im.lang.admin:im.lang.member,icon:f,data:a})}},on_client_group_add:function(f){var m,d=im.groups[f].permission,b=[],l=this,a,g,c;if(f!=this.gid){return}if((m=im.groups[d.owner_gid])){this.is_owner=(d.owner_gid==this.uid);if(d.owner_gid==im.account.uid){this.add_invite_btn();this.add_setting_btn()}if(m.logo&&m.logo.nick){a=m.logo.nick}else{a=im.lang.user+m.gid;b.push(m.gid)}c=im.guser_get_profile(this.gid,m.gid);this.tree.add({id:m.gid,text:a,tags:im.role_text(im.role.OWNER),icon:im.icon_src(m.uid,m.gid),data:c,tag_prior:im.prior.owner})}else{b.push(d.owner_gid)}if(d.manager){for(var e=0;e<d.manager.length;e++){if(m=im.groups[d.manager[e]]){if(m.gid==im.account.uid){this.add_invite_btn();this.add_setting_btn()}this.tree.add({id:m.gid,text:m.logo.nick,tags:im.role_text(im.role.MANAGER),icon:im.icon_src(im.account.uid,m.gid),data:im.guser_get_profile(this.gid,m.gid),tag_prior:im.prior.manager})}else{b.push(d.manager[e])}}}if(b.length){this.send_msg("group_get",{gid:this.gid,gids:b,flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(n,o){im.on_group_get_ack(n,o);l.on_ext_group_get_ack(n,o)})}},add_media_pub:function(c){if(undefined==c){return}var a={};a.is_new=true;a.head={};a.content={};a.head.from={};for(var b=0;b<c.length;b++){if(this.videos[c[b].stream_id]){continue}a.head.from.gid=c[b].gid;if(im.groups[a.head.from.gid]&&im.groups[a.head.from.gid].logo){a.head.from.nick=im.groups[a.head.from.gid].logo.nick}a.content.flag=1;a.content.stream_id=c[b].stream_id;a.content.type="rtmp";a.head.date=c[b].date;this.on_imsg("im_media",a)}},have_invite_permission:function(e){var c=this.topic,b;if((undefined==c)||(undefined==c.link_info)){return false}if(c.link_info.ex_key==""){return false}if(c.link_info.creater==e){return true}if(b=c.link_info.auth_list){for(var d=0,a=b.length;d<a;d++){if(b[d]==e){return true}}}return false},add_invite_btn:function(){var a=this;if(this.invite_btn){return}this.invite_btn=document.createElement("button");this.invite_btn.innerHTML=im.lang.manage;this.invite_btn.className="sign_btn";this.ext.insertBefore(this.invite_btn,this.ext.firstChild);this.invite_btn.onclick=function(){im.invite(a.gid,a)}},add_setting_btn:function(){var a=this;if(this.setting_btn){return}this.setting_btn=document.createElement("button");this.setting_btn.innerHTML=im.lang.setting;this.setting_btn.className="sign_btn";this.ext.insertBefore(this.setting_btn,this.ext.firstChild);this.setting_btn.onclick=function(){if(a.user_setting){a.user_setting.show()}else{a.user_setting=new user_setting({parent:a,gid:a.uid,profile:a.group,sid:a.account.sid,update_group_icon:function(b){},send_msg:function(c,d,b){a.send_msg(c,d,b)}})}}},del_invite_btn:function(){if(!this.invite_btn){return}this.invite_btn.parentNode.removeChild(this.invite_btn);delete this.invite_btn},add_tool_icon:function(b,g){var a,d=this,e=this.skin,f=e.bar.icon.size,c;this.tool_bar.appendChild(a=document.createElement("span"));a.appendChild(c=document.createElement("img"));a.style.cssText="visibility:hidden;";c.onmouseover=function(l){d.on_img_focus(c,true)};c.onmouseout=function(l){d.on_img_focus(c,false)};c.onclick=g;c.src=b;a.style.cssText="display:inline-block;position:relative;left:0px;top:0px;margin: 0 auto;width:"+(f+e.bar.icon.margin_right)+"px;height:"+f+"px;";c.style.cssText="cursor:pointer;position:absolute;left:"+e.bar.icon.pad+"px;top:"+e.bar.icon.pad+"px;width:"+e.bar.icon.width+"px;height:"+e.bar.icon.height+"px;";return a},del_tool_icon:function(a){},on_usermenu_cmd:function(c,a){var b=this;switch(c){case"chat":im.groups[im.account.uid].topics_ptr.open_friend_topic(a.gid);break;case"del":if(this.gid>0){return}this.send_msg("group_del",{gid:this.gid,contact_gid:a.gid},function(d,e){if(e.result===0){im.guser_add(b.gid,{owner_gid:b.gid,gid:a.gid,role:{type:im.role.STRANGER}});b.tree.del_item(b.tree.root,a.gid)}});break;case"view_detail":im.groups[this.uid].contacts_ptr.group_view_detail(this.uid,a);break}},cam_on_click:function(a){this.cam_icon.onclick=null;this.on_publish();this.cam_icon.onclick=this.cam_onclick;this.cam_icon.title=(this.cam_active?this.lang.stop:"")+this.lang.publish+" "+this.lang.video},on_shadow_event:function(d){var c=false,b=this.skin,a=this;switch(d.type){case"click":b.ext.visible=!b.ext.visible;if((this.gid<0)&&!this.ext_onscroll){this.ext_onscroll=true;this.on_ext_scroll();this.ext.onscroll=function(){var e=this;if(this.timer){clearTimeout(this.timer)}this.timer=setTimeout(function(){a.on_ext_scroll();e.timer=null},200)}}this.update();break;case"mouseover":c=true;case"mouseout":this.ext_shadow_arrow.src=b.ext.visible?(c?b.ext_shadow.arrow.hide:b.ext_shadow.arrow.hide_empty):(c?b.ext_shadow.arrow.show:b.ext_shadow.arrow.show_empty);this.ext_shadow_arrow.style.left=b.ext.visible?((c?(b.ext_shadow.width+b.ext_shadow.arrow.pad):0)+"px"):"";this.ext_shadow_arrow.style.right=b.ext.visible?"":((c?(0-b.ext_shadow.width-b.ext_shadow.arrow.pad):0)+"px");this.ext_shadow_lines.set_focus(c);break}},on_ext_scroll:function(){var a=this;if((this.pid_start<this.group.state.pid)&&!this.pid_loading&&((this.ext.scrollTop+parseInt(this.ext.style.height))>=this.ext.scrollHeight)){this.send_msg("group_get",{gid:this.gid,start:1,counts:this.group.state.pid,flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(b,c){im.on_group_get_ack(b,c);a.on_ext_group_get_ack(b,c);a.pid_start=a.group.state.pid});return}},on_ext_group_get_ack:function(e,g){var f,b,d;if(g.result===0){for(var c=0,a=g.groups.length;c<a;c++){f=g.groups[c];if(!f.logo){f.logo={}}if(!f.logo.nick){f.logo.nick=im.lang.user+gid}if(!g.contacts[c].role){continue}d=im.guser_get_profile(this.gid,f.gid);d.is_owner=this.is_owner;switch(g.contacts[c].role.type){case im.role.OWNER:case im.role.MANAGER:case im.role.MEMBER:case im.role.FRIEND:this.tree.add({id:f.gid,text:f.logo.nick,tags:im.role_text(g.contacts[c].role.type),icon:im.icon_src(f.gid,f.gid),data:d});break;default:break}}}},on_img_focus:function(d,b){var c=this.bs,f=this.skin,a=f.line,e=f.bar.icon.width-(2*(b?1:0)*a.size);d.style.width=e+"px";d.style.height=e+"px";d.style.border=b?(""+a.size+"px solid "+a.color):"";d.style.backgroundColor=b?f.focus_bg:""},txt_on_keydown:function(l){var n=this;var o;var b=l.charCode||l.keyCode;if(13==b){if((this.send.enter&&!l.ctrlKey&&!l.shiftKey)||(this.send.ctrl_enter&&l.ctrlKey&&!l.shiftKey)||(this.send.shift_enter&&!l.ctrlKey&&l.shiftKey)||(this.send.ctrl_shift_enter&&l.ctrlKey&&l.shiftKey)){if(this.send_msg){var m,p=this.txt.value,a=0,d=p.length;for(;a<d;++a){m=p.charAt(a);if(("\r"!=m)&&("\n"!=m)&&(" "!=m)&&("\t"!=m)){break}}for(;a<d;--d){m=p.charAt(d-1);if(("\r"!=m)&&("\n"!=m)&&(" "!=m)&&("\t"!=m)){break}}if(d>a){this.save_txt=p;this.last_write_time=0;this.send_msg("text_pub",{gid:this.gid,tid:this.tid,content:{text:(p.substr(a,d-a))}},function(c,e){if(("object"!=typeof(e))||(0!=e.result)){alert("send text_pub failed.");n.txt.value=n.save_txt;n.save_txt=""}})}}this.txt.value="";this.txt.style.height=this.txt_default_height+"px";this.txt.style.overflowY="hidden";if(l.preventDefault){l.preventDefault()}else{l.returnValue=false}return false}}else{if((b==86)&&(l.ctrlKey)){var g=media_plug.prototype.clipboard_get_img("image/png"),f=(g&&(0<g.length))?codec.hex_2_uri_param(g):null;if(f&&(0<f.length)){this.send_msg("file_pub",{timeout:(g.length/2*3*10),gid:this.gid,tid:this.tid,content_mime:"image/png",content_filename:"untitled.png","%content":f},function(c,e){if(("object"!=typeof(e))||(0!=e.result)){alert("paste image failed.")}})}}}},txt_on_change:function(f){var d=this;var c,b=new Date();var a=b.getTime();if(!$.ie){this.txt.style.height="0px"}c=this.txt.scrollHeight-this._padding;if(c%2==1){c++}if(c<this.txt_default_height){c=this.txt_default_height}if(c>this.skin.bar.txt.max_height){this.txt.style.overflowY="auto";c=this.skin.bar.txt.max_height}else{this.txt.style.overflowY="hidden"}this.txt.style.height=c+"px";if(f.stopPropagation){f.stopPropagation()}else{f.cancelBubble=true}if((0==this.last_write_time)||(a-this.last_write_time)>3000){this.last_write_time=a;this.send_msg("group_status_notify_ex",{flag:1,status:im.status.TS_WRITTING,gt_pair:[{gid:d.gid,tid:d.tid}]},function(){})}},active:function(){if(this.tid!=1){this.txt.focus()}},on_keydown:function(b){var a=b.charCode||b.keyCode;return;if(a==33){this.msg_sb.page_up()}else{if(a==34){this.msg_sb.page_down()}else{if(a==35){this.msg_sb.scroll_to("bottom")}else{if(a==36){this.msg_sb.scroll_to("top")}else{if(a==38){this.msg_sb.scroll_by(-15)}else{if(a==40){this.msg_sb.scroll_by(15)}}}}}}},plug_on_event:function(c){switch(c.type){case"ready":case"is_ready":break;case"drm_error":alert(this.lang.drm_error);break;case"close":if(c.chl){var b,a=this.media_srv.proto[(this.plug.type.name=="flash")?"flash":"plug"],d=("network.connect.failed"==c.info);if(c.chl){if("publish"==c.chl.type){this.publish_stop();if(d&&(this.pub_url_try_index<a.length)){this.on_publish()}else{this.pub_url_try_index=0}}else{if(b=c.chl.refer){this.video_stop(b);if(d&&(b.url_try_index<a.length)){this.video_play(b)}else{b.url_try_index=0}}}}}break;default:break}},plug_show:function(b){if(b){if(!this.media_visible){this.media.style.visibility=""}if(null==this.plug){var a=this;setTimeout(function(){a.plug=new media_plug({parent:a.media,on_event:function(c){a.plug_on_event(c)}})},200)}}else{if(this.media_visible){this.media.style.visibility="hidden"}}this.media_visible=b},publish_start:function(){var c=this.media_srv.app+this.uid+"_"+this.gid+"_"+this.tid,d="?dtype=rtmp&dnid="+this.account.generate_nid()+"&dgid="+codec.str_2_uri_param(""+this.gid)+"&dtid="+codec.str_2_uri_param(""+this.tid),b=this.media_srv.proto[(this.plug.type.name=="flash")?"flash":"plug"][this.pub_url_try_index];this.publish_url=b.name+this.media_srv.host+b.port+c+d;if(this.topic.refer_gid){var a=im.groups[this.topic.refer_gid].agent||"";if(a.indexOf("Android")>=0){d=this.android_cam_param}}++this.pub_url_try_index;this.publish_chl=this.plug.chl_create({type:"publish",url:this.publish_url,refer:this,params:d})},publish_stop:function(){if(this.pub_timer){clearInterval(this.pub_timer);delete this.pub_timer}if(this.publish_chl){this.plug.chl_destroy(this.publish_chl);delete this.publish_chl}this.cam_active=false;this.cam_icon.src=this.skin.bar.cam.img;this.plug_show(0<this.video_active_counts)},publish_check_plug:function(){if(this.plug){var b,a=(this.plug.status==this.plug.plug_status.running);if(a||(this.plug.status==this.plug.plug_status.closed)||(this.pub_try_times>this.try_times)){this.pub_try_times=0;clearInterval(this.pub_timer);delete this.pub_timer;if(a){if((this.plug.type.name=="flash")&&(b=meval(this.plug.get_info(65535)))&&(b.av_hardware_disable=="true")){alert("系统检测到你的flash的视频设备被屏蔽。\n请打开[C:\\WINDOWS\\system32\\Macromed\\Flash\\mm.cfg]文件，把AVHardwareDisable设置成0");this.publish_stop();this.pub_url_try_index=0}this.video_play_all();this.publish_start()}else{this.publish_stop();this.pub_url_try_index=0}}this.pub_try_times+=(this.plug.status==this.plug.plug_status.initting)}},on_publish:function(){if(this.cam_active){this.publish_stop();this.pub_url_try_index=0}else{var a=this;this.plug_show(true);this.cam_active=true;this.cam_icon.src=this.skin.bar.cam.active_img;if(this.pub_timer){clearInterval(this.pub_timer)}this.pub_timer=setInterval(function(){a.publish_check_plug()},100)}},have_active_video:function(){return !!this.video_active_counts||this.media_visible},ldate_to_s:function(g){var f,b,a,d,e,c=new Date("2000/01/01");c.setTime(c.getTime()+(g*1000));f=(c.getMonth()+1);b=c.getDate();a=c.getHours();d=c.getMinutes();e=c.getSeconds();return""+c.getFullYear()+"-"+((10>f)?"0":"")+f+"-"+((10>b)?"0":"")+b+" "+((10>a)?"0":"")+a+":"+((10>d)?"0":"")+d+":"+((10>e)?"0":"")+e},label_append_span:function(a,b){var c=document.createElement("span");c.innerHTML=(b?b:"");a.appendChild(c)},label_append_im_text:function(l,m,b){var a,d,g=this;if(m.content.text&&(0<m.content.text.length)){var e=m.content.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>&nbsp;&nbsp;");e=e.replace(/(((https?:\/\/)|(www\.))[^\s\<\u00f0-\uffff]+)/g,"<a href=\"$1\" target=\"_blank\">$1 <img src='images/link.gif' style='border:none'/></a>");e=e.replace(/\[face:([^\]]*)\]/g,"<img src='/images/face/$1' style='border:none'></img>");this.label_append_span(l,e);d=l.getElementsByTagName("img");for(var c=0,f=d.length;c<f;c++){d[c].onload=function(){if(b){g.scroll_to_bottom()}this.onload=null}}if(this.media_visible&&this.plug){if(!(a=m.head.from.nick)){a=this.lang.user+m.head.from.gid}this.plug.text_out(a+" : "+m.content.text)}else{if(m.is_new&&!b&&(m.head.from.gid!=this.gid)){if(!(a=m.head.from.nick)){a=this.lang.user+m.head.from.gid}this.status_notify(a+" : "+m.content.text)}}}},get_file_size:function(b){var a;var e;var d=parseFloat(b);var c=parseFloat(1024);for(a=0;a<3&&d>c;a++){d=d/c}e=""+Math.round(d*100)/100;switch(a){case 0:e+=" Byte";break;case 1:e+=" K";break;case 2:e+=" M";break;case 3:e+=" G";break}return e},label_append_im_file:function(o,p,e){var n=this,g="",b=p.content.mime,c=p.content.name,l=p.content.file_size,m=p.content.thumb_size,d="/im/file_get/"+codec.str_2_uri_param(c)+"?dnid="+global_sid+"&dgid="+this.gid+"&dtid="+p.head.tid+"&dtmid="+p.head.tmid;org_file="/im/file_get/"+codec.str_2_uri_param(c)+"?dnid="+global_sid+"&dgid="+this.gid+"&dtid="+p.head.tid+"&dtmid="+p.head.tmid+"&dflag=1";is_img=(0==b.indexOf("image/"));var f;var q;q=this.get_file_size(l);g="";if(is_img&&m){g+="<br>&nbsp;&nbsp;<a href='"+org_file+"' target='_blank'><img src='"+d+"' style='border:none;position:relative;top:4px;"+hack.css_box_shadow(8,"#6699cc")+"' /></a>"}g+="<br>&nbsp;&nbsp;<a href='"+org_file+"' target='_blank'><img src='"+this.skin.attachment+"' style='border:none;width:18px;height:18px;position:relative;top:4px;'/>"+c+" ( "+q+" )</a>";this.label_append_span(o,g);if(this.media_visible&&this.plug){var a=p.head.from.nick;if((undefined==a)||(null==a)||(""==a)){a=this.lang.user+p.head.from.gid}this.plug.text_out(a+" : "+this.lang.file_uploaded+c+" ,"+this.lang.size+q)}if(is_img){f=o.getElementsByTagName("img")[0];f.onload=function(){if(e){n.scroll_to_bottom()}f.onload=null};if($.ie){setTimeout(function(){f.src=d},0)}}},video_add:function(c){var g=this,l=this.skin,b=c.head.from.nick,a=l.bar.icon.size,d=a-(2*l.bar.icon.pad),e=im.groups[c.head.from.gid],f={stream_id:c.content.stream_id,span:document.createElement("span"),logo:document.createElement("img"),player:document.createElement("img"),active:false,try_times:0,url_try_index:0,gid:c.head.from.gid};this.videos[f.stream_id]=f;if((undefined==b)||(null==b)||(""==b)){b=this.lang.user+c.head.from.gid}f.nick=b;f.logo.src=im.icon_src(c.head.from.gid,c.head.from.gid,im.status.TS_ONLINE);f.logo.style.cssText="position:absolute;left:"+l.bar.icon.pad+"px;top:"+l.bar.icon.pad+"px;width:"+d+"px;height:"+d+"px;";f.player.title=this.lang.play+"["+b+"]"+this.lang.video;f.player.src=l.bar.play.start;f.player.style.cssText="position:absolute;top:"+l.bar.icon.pad+"px;left:"+l.bar.icon.pad+"px;width:"+d+"px;height:"+d+"px;";f.span.style.cssText="cursor:pointer;display:inline-block;position:relative;left:0px;top:0px;width:"+(a+l.bar.icon.margin_right)+"px;height:"+a+"px;";f.span.appendChild(f.logo);f.span.appendChild(f.player);f.on_mouse_event=function(m){var m=m||window.event;g.on_img_focus(f.logo,"mouseover"==m.type)};f.player.onclick=function(m){if(f.active){g.video_stop(f);f.url_try_index=0}else{g.video_play(f)}};f.player.onmouseover=f.on_mouse_event;f.player.onmouseout=f.on_mouse_event;this.tool_bar.appendChild(f.span);if(this.cam_active){this.video_play(f)}},video_del:function(a){if(a.active){this.video_stop(a);a.url_try_index=0}delete this.videos[a.stream_id];a.logo.parentNode.removeChild(a.logo);a.logo=null;a.player.onclick=null;a.player.onmouseover=null;a.player.onmouseout=null;a.player.parentNode.removeChild(a.player);a.player=null;a.span.innerHTML="";a.span.parentNode.removeChild(a.span);a.span=null;a.on_mouse_event=null;for(var b in a){if(a[b]){delete a[b]}}},video_del_all:function(){for(var a in this.videos){if(this.videos[a]){this.video_del(this.videos[a])}}},video_play_start:function(c){if(this.plug){var a=(this.plug.status==this.plug.plug_status.running);if(a||(this.plug.status==this.plug.plug_status.closed)||(c.try_times>this.try_times)){c.try_times=0;clearInterval(c.play_timer);delete c.play_timer;if(a){var d=c.stream_id,e="?dtype=rtmp&dnid="+this.account.generate_nid()+"&dgid="+codec.str_2_uri_param(""+this.gid)+"&dtid="+codec.str_2_uri_param(""+this.tid),b=this.media_srv.proto[(this.plug.type.name=="flash")?"flash":"plug"][c.url_try_index];c.url=b.name+this.media_srv.host+b.port+d+e;++c.url_try_index;c.chl=this.plug.chl_create({type:"play",url:c.url,refer:c})}else{this.video_stop(c)}}c.try_times+=(this.plug.status==this.plug.plug_status.initting)}},video_play:function(b){var a=this;if((typeof(b)=="string")&&!(b=this.videos[b])){return}this.plug_show(true);b.player.src=this.skin.bar.play.stop;b.player.title=this.lang.stop+this.lang.play+"["+b.nick+"]"+this.lang.video;++this.video_active_counts;b.active=true;if(b.play_timer){clearInterval(b.play_timer)}b.play_timer=setInterval(function(){a.video_play_start(b)},100)},video_play_all:function(){var b,a;for(b in this.videos){if((a=this.videos[b])&&(!a.active)){this.video_play(a)}}},video_stop:function(a){if(a.play_timer){clearInterval(a.play_timer);delete a.play_timer}a.active=false;if(a.chl){this.plug.chl_destroy(a.chl);delete a.chl}a.player.src=this.skin.bar.play.start;a.player.title=this.lang.play+"["+a.nick+"]"+this.lang.video;--this.video_active_counts;this.plug_show(this.cam_active||(0<this.video_active_counts))},video_stop_all:function(){var a;for(var b in this.videos){a=this.videos[b];if(a.active){this.video_stop(a);a.url_try_index=0}}},status_notify:function(c){var b=this,a;if(undefined==this.status_div){this.status_div=document.createElement("div");this.status_div.style.cssText="position:absolute;left:0px;bottom:0px;background:#D2E1F6;color:#646464;line-height:16px;";this.msg.appendChild(this.status_div)}this.status_div.innerHTML=c;if(this.status_timer){clearTimeout(this.status_timer)}a=Math.round(c.length/5)*1000;a=(a<=this.msg_status_line_timer_ms_min)?this.msg_status_line_timer_ms_min:((a>=this.msg_status_line_timer_ms_max)?this.msg_status_line_timer_ms_max:a);if(this.plug&&this.media_visible){this.plug.text_out("<i>"+c)}this.status_timer=setTimeout(function(){if(b.plug&&b.media_visible){b.plug.text_out("<i>")}b.status_div.innerHTML=""},a)},on_im_status:function(b,a){switch(a.content.profile.status){case im.status.TS_WRITTING:this.status_notify(a.head.from.nick+im.lang.writting);break}},on_im_media:function(c,b){var g,a,e,f,d;if(b.content&&(f=b.content.stream_id)){d=this.videos[f];if(b.content.flag==1){this.label_append_span(c,((""==b.content.type)?this.lang.publish_stop:this.lang.publish)+" "+this.lang.video);if(""==b.content.type){if(d){this.video_del(d)}}else{if((null==d)&&(b.head.from.gid!=this.uid)){this.video_add(b)}}}else{e=b.content.sid_owner;a=(im.groups[e]&&im.groups[e].logo&&im.groups[e].logo.nick)?im.groups[e].logo.nick:(im.lang.user+e);g=(b.content.type?this.lang.play_:this.lang.play_stop)+a+this.lang._video;this.label_append_span(c,g);if(this.media_visible&&this.plug){this.plug.text_out(b.head.from.nick+" : "+g)}}}return 0},on_im_group_add:function(m,o){var e=o.content,l=o.head,a,d;var n=document.createElement("span"),b;var g=this,c,f=(e.gid==this.gid)?e.gid_add:e.gid;c=e.gid;a=im.groups[c]?im.groups[c].logo.nick:((c==l.from.gid)?l.from.nick:(im.lang.user+c));c=e.gid_add;d=im.groups[c]?im.groups[c].logo.nick:((c==l.from.gid)?l.from.nick:(im.lang.user+c));if(o.content.flag==1){if(e.gid_add<0){n.innerHTML=a+this.lang.joined_group+"("+d+")"}else{if(e.gid<0){n.innerHTML=d+this.lang.joined_group+"("+a+")"}else{n.innerHTML=a+this.lang.and+d+this.lang.become_friend}}if(o.is_new){this.send_msg("group_get",{gid:this.gid,gids:[f],flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(p,r){im.on_group_get_ack(p,r);if((g.gid<0)||(f<0)){var q=im.groups[f];g.tree.add({id:f,text:q.logo.nick,tags:im.role_text(im.groups[g.gid].contacts[f].role.type),icon:im.icon_src(f,f),data:q});g.send_msg("topic_get",{gid_list:[f]},function(s,t){im.on_topic_get_ack(s,t);g.send_msg("group_status_notify_ex",{flag:1,status:im.status.TS_WRITTING,gt_pair:[{gid:im.account.uid,tid:1}]},function(){})})}})}}else{if(e.gid_add==this.gid){n.innerHTML=this.lang.group_add_2;b=document.createElement("button");b.className="sign_btn";b.innerHTML=im.lang.accept;b.onclick=function(){g.group_add(e.gid,e.verify_id,null);b.parentNode.removeChild(b)}}else{n.innerHTML=this.lang.add_+d+this.lang._friend}}m.appendChild(n);if(b){m.appendChild(b)}},on_im_group_del:function(g,m){var e=this,f=m.head,a,b,l=document.createElement("span");var c=m.content,d=(this.gid==c.gid)?c.gid_del:c.gid;gid=c.gid;a=im.groups[gid]?im.groups[gid].logo.nick:((gid==f.from.gid)?f.from.nick:(im.lang.user+gid));gid=c.gid_del;b=im.groups[gid]?im.groups[gid].logo.nick:((gid==f.from.gid)?f.from.nick:(im.lang.user+gid));if(c.gid_del<0){l.innerHTML=a+this.lang.quit_group+"("+b+")"}else{if(c.gid<0){l.innerHTML=b+this.lang.quit_group+"("+a+")"}else{l.innerHTML=a+this.lang.delete_from_group+b}}g.appendChild(l);if(m.is_new){this.send_msg("group_get",{gid:this.gid,gids:[d],flag:im.group_mask.MASK_CONTACT,flag_ex:im.group_mask.MASK_EX_CONTACTS},function(n,o){im.on_group_get_ack(n,o,e.gid)})}},on_im_check_manual:function(c,b){var l=this,g=b.content,e=b.head,a;var f=document.createElement("span"),d;f.innerHTML=this.lang.topic_invite;c.appendChild(f);d=document.createElement("button");d.className="sign_btn";d.innerHTML=im.lang.accept;d.onclick=function(){l.send_msg("topic_open",{gid:l.gid,link_id:g.link_id},function(m,n){if(n.result===0){l.send_msg("topic_get",{gid:l.gid,tid:[n.tid]},function(o,p){im.on_topic_get_ack(o,p)})}});d.parentNode.removeChild(d)};c.appendChild(d)},group_add:function(b,a,d){var c=this;this.send_msg("group_add",{gid:this.gid,gid_add:b,vid:a||"",req_text:d||""},function(e,f){c.on_group_add_ack(b,e,f)})},on_group_add_ack:function(b,a,f){var c=this;if(("object"!=typeof(f))||f.result||("group_add_ack"!=a)){if(f.result==105){alert(this.lang.already_friend_hint)}else{alert(this.lang.group_add_ack_failed_hint)}return}var e,d;switch(f.state){case im.status.US_SUCCEED:this.send_msg("group_get",{gid:this.gid,gids:[b],flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(g,l){im.on_group_get_ack(g,l)});break;case im.status.US_ANSWER_QUESTIONN:if(null==f.question){alert(this.lang.need_answer_question_hint);return}d=prompt(f.ques_list[0].question);this.group_add(b,null,d);break;case im.status.US_CONFIRM:alert(this.lang.need_peer_confirm_hint);break;case im.status.US_REFUSE:alert(this.lang.peer_refuse_hint);break}},onscroll:function(){var l,b,d,r,s,t,v,f,c,u,a,o,e,m,p,q,g;m=this.msg_cont.scrollTop;if(!this.unloaded_doms.length||this.loading){this.prev_value=m;return}function n(A){var B="[";for(var y=0,x=A.length;y<x;y++){var z=A[y];B+="("+y+": "+z.tmid_min+"--"+z.tmid_max+")";if(y!=(x-1)){B+=", "}}B+="]";return B}p=m+parseInt(this.msg_cont.style.height)-1;for(r=0,s=this.unloaded_doms.length;r<s;r++){t=this.unloaded_doms[r];b=t.offsetTop;d=b+(f=t.offsetHeight)-1;if((m>b)&&(m<=d)){q=1}else{if((m<=b)&&(p>=d)){q=2}else{if((p>=b)&&(d>p)){q=3}else{continue}}}if((v=(t.tmid_max-t.tmid_min+1))<=this.get_counts){this.send_im_get(r,this.prev_value>m);break}if((q==2)||((Math.abs(m-this.prev_value)<=40))){if(t.tmid_min==1){c=t.tmid_min}else{c=(m>this.prev_value)?t.tmid_min:t.tmid_max}}else{if(q==1){c=Math.round((m-b)/f*v)+t.tmid_min}else{c=Math.round((p-b)/f*v)+t.tmid_min}}if((u=(c-this.get_counts/2+1))>t.tmid_min){a=document.createElement("div");a.tmid_min=u;a.tmid_max=t.tmid_max;t.tmid_max=u-1;if(t.nextSibling){this.msg_cont.insertBefore(a,t.nextSibling)}else{this.msg_cont.appendChild(a)}for(o=s;o>r+1;o--){this.unloaded_doms[o]=this.unloaded_doms[o-1]}this.unloaded_doms[++r]=a;t=a}if((tmid_max=(c+this.get_counts/2))<t.tmid_max){a=document.createElement("div");a.tmid_min=tmid_max;a.tmid_max=t.tmid_max;t.tmid_max=tmid_max-1;if(t.nextSibling){this.msg_cont.insertBefore(a,t.nextSibling)}else{this.msg_cont.appendChild(a)}for(o=this.unloaded_doms.length;o>r+1;o--){this.unloaded_doms[o]=this.unloaded_doms[o-1]}this.unloaded_doms[r+1]=a;t=a}this.send_im_get(r,this.prev_value>m);break}this.prev_value=m},scroll_to_bottom:function(){this.msg_cont.scrollTop=this.msg_cont.scrollHeight-this.msg_cont_height},send_im_get:function(a,b){var d=this,e=this.unloaded_doms[a],f,c;if(this.loading){return}this.loading=true;if(b&&(e.tmid_min!=1)){this.scrollBottom=this.msg_cont.scrollHeight-this.msg_cont.scrollTop}e.innerHTML=this.lang.th_prevfix+e.tmid_min+"--"+e.tmid_max+this.lang.th_postfix+this.lang.msg+this.lang.pulling;f=e.tmid_min;c=e.tmid_max-e.tmid_min+1;this.send_msg("im_get",{groups:[{gid:this.gid,tmids:{tid:this.tid,start:f,counts:c}}]},function(g,l){d.on_im_get(g,l,a);d.loading=false;if(d.scrollBottom){d.msg_cont.scrollTop=d.msg_cont.scrollHeight-d.scrollBottom;d.scrollBottom=0}})},on_im_get:function(g,c,m){var e,f,d=c.records,l,a,b;if("ds_records"!=g){return}if(c.result||(null==d)||(0==d.length)){return}for(e=d.length;e;){f=d[--e];if(f&&f.type&&(0==f.type.indexOf("im_"))&&(data=f.data)&&data.content){f.data.is_old=true;l=f.data.head.from;if(!l.nick){if(im.groups[l.gid]&&im.groups[l.gid].logo&&im.groups[l.gid].logo.nick){l.nick=im.groups[l.gid].logo.nick}else{l.nick=this.lang.user+head.from.gid}}this.on_imsg(f.type,f.data,m)}}this.update_doms()},get_title:function(a){return this.lang.th_prevfix+a.tmid_min+"--"+a.tmid_max+this.lang.th_postfix+this.lang.msg+this.lang.need_pull},update_doms:function(){var c,b,a,d,f=this.unloaded_doms,e=this;for(c=0,b=0,a=f.length;c<a;c++){d=f[c];if(d.tmid_min<=d.tmid_max){f[b++]=d}else{d.parentNode.removeChild(d)}}this.unloaded_doms.length=b;this.unloaded_doms.forEach(function(l){var g=l.tmid_max-l.tmid_min+1;if(g>128){g=128}if(g<32){g=32}l.style.cssText="height:"+g+"px;line-height:"+g+"px;vertical-align:middle;text-align:center;border:1px solid black;";l.innerHTML=e.get_title(l)})},label_create_nick:function(a,e,c){var d=document.createElement("span"),b=e.head,f=b.from;a.id="msg_"+this.gid+"_"+this.tid+"_"+b.tmid;if((c!="im_group_add")&&(c!="im_group_del")){a.innerHTML=":&nbsp;";d.title=(this.lang.th_prevfix+b.tmid+this.lang.th_postfix+this.lang.msg)+':"'+f.nick+'"'+(f.user?("<"+f.user+">"):"")+this.lang.sent_at+this.ldate_to_s(b.date);d.innerHTML=f.nick;d.style.color="green";a.insertBefore(d,a.firstChild)}return a},create_sep_line:function(l,e){var f=l.head,c=f.date,b,d,g,m,a,n;a=document.createElement("div");if(f.tmid!=1){b=document.createElement("div");b.innerHTML="&nbsp;";a.appendChild(b)}if(e=="im_media"){n=this.lang.media_msg}else{if(e=="im_group_add"){n=this.lang.sys_msg}}g=document.createElement("div");if(n){g.innerHTML=n+"&nbsp;&nbsp;"+this.ldate_to_s(c)}else{g.innerHTML=this.lang.th_prevfix+f.tmid+this.lang.th_postfix+this.lang.msg+"&nbsp;&nbsp;"+this.ldate_to_s(c)}if(l.is_new&&!this.latest_news_label){g.innerHTML+="&nbsp;"+this.lang.newest_msg;this.latest_news_label=g}g.style.cssText="color:gray;";a.appendChild(g);m=document.createElement("div");m.style.cssText="height:1px;line-height:1px;background:#999;";m.innerHTML="&nbsp;";a.appendChild(m);return a},insert_label:function(l,d,m){var f,e=l.head,g=e.from,o,c=this.msg_cont,p,n,a,b;if(d=="im_status"){return}f=document.createElement("div");f.id="msg_"+this.gid+"_"+this.tid+"_"+e.tmid;f.from_gid=g.gid;f.from_date=e.date;if(undefined!==m){p=this.unloaded_doms[m]}else{if(this.unloaded_doms.length){p=this.unloaded_doms[this.unloaded_doms.length-1]}}if(p&&e.tmid&&(p.tmid_max>=e.tmid)&&(e.tmid>=p.tmid_min)){p.tmid_max=e.tmid-1}f.id="msg_"+this.gid+"_"+this.tid+"_"+e.tmid;if(undefined!==m){this.label_create_nick(f,l,d);if((o=p.nextSibling)&&o.from_gid&&(o.from_gid==g.gid)){o.removeChild(o.firstChild);o.firstChild.nodeValue="";o.innerHTML="&nbsp;&nbsp;"+o.innerHTML}insert_after(f,p);b=(n&&n.from_date)?n.from_date:0;if((e.tmid==1)||((b-e.date)>1800)){a=this.create_sep_line(l,d);insert_after(a,p)}}else{b=(c.lastChild&&c.lastChild.from_date)?c.lastChild.from_date:0;if((e.tmid==1)||((e.date-b)>1800)||(l.is_new&&!this.latest_news_label)){a=this.create_sep_line(l,d);c.appendChild(a)}if(c.lastChild.from_gid==g.gid){f.innerHTML="&nbsp;&nbsp;"}else{this.label_create_nick(f,l,d)}c.appendChild(f)}return f},on_imsg:function(l,e,c){var g=e.head;var f,b,a;var d=((this.msg_cont.scrollTop+this.msg_cont_height)>=this.msg_cont.scrollHeight);if((l=="im_status")&&(e.content.profile.status==im.status.TS_WRITTING)&&(e.head.from.gid==this.uid)){return}if((l=="im_media")&&(e.head.from.gid==this.gid)){return}f=this.insert_label(e,l,c);switch(l){case"im_group_del":this.on_im_group_del(f,e);break;case"im_group_add":this.on_im_group_add(f,e);break;case"im_text":this.label_append_im_text(f,e,d);break;case"im_file":this.label_append_im_file(f,e,d);break;case"im_media":if(this.on_im_media(f,e)){return}break;case"im_status":this.on_im_status(f,e);return;case"im_check_manual":this.on_im_check_manual(f,e);break;default:this.label_append_span(f,this.lang.unknown_msg_type+"["+l+"]");break}f.tmid=g.tmid;if(d){this.msg_cont.scrollTop=this.msg_cont.scrollHeight-this.msg_cont_height;if(this.status_div){this.status_div.innerHTML=""}if(this.status_timer){clearTimeout(this.status_timer);this.status_timer=null}}}};topic_view.prototype.lang=lang_get(topic_view.prototype.langs);function topic_box(a){this.create(a)}topic_box.prototype={magic:"topic_box",zIndex:"",pos:{start_left:20,start_top:80,left:20,top:80,step:24},langs:{cn:{user:"用户",video_hint:"还有未关闭的视频，是否强制关闭？"},en:{user:"user",video_hint:"video is playing, are you sure to close it?"}},get_default_skin:function(){return{head:{height:53},space:5,wrapper:{height:42,left:5,top:5,width:450},nick_wrapper:{top:1,left:47,width:150,height:20},bulletin_wrapper:{bottom:1,left:47,width:400,height:20},width:656,height:498,img:{topic:"/images/topic.gif"}}},create:function(c){var a=this,b;this.first_show=true;this.skin=obj_merge(this.get_default_skin(),c.skin||{});this.account=c.account;this.on_close_topic=c.on_close_topic;this.on_mousedown=c.on_mousedown;this.uid=c.uid;this.gid=c.gid;this.tid=c.tid;this.send_msg=c.send_msg;this.group=im.groups[this.gid];this.window_box=new window_box({on_status:function(d){a.on_status(d)},skin:{drag:true,close:im.global_used_by_cs?false:true,width:this.skin.width,height:this.skin.height,left:0,top:0,head:{height:this.skin.head.height}},is_hide:c.is_hide||true});this.win_head=this.window_box.get_head();this.win_body=this.window_box.get_body();this.topic_view=new topic_view({parent:this.win_body,uid:c.uid,gid:c.gid,tid:c.tid,account:c.account,send_msg:c.send_msg,link_info:c.link_info});this.topic=im.groups[this.gid].topics[this.tid];this.win_head.appendChild(this.wrapper=document.createElement("div"));this.wrapper.appendChild(this.txt_caption=document.createElement("span"));this.wrapper.appendChild(this.nick_wrapper=document.createElement("div"));this.wrapper.appendChild(this.bulletin_wrapper=document.createElement("div"));this.wrapper.appendChild(this.icon=document.createElement("img"));this.icon.className="main_icon";this.update__self=function(){a.update_self()};if(this.gid>0){this.update__self.subscribe(im.topic_add_publisher,this.gid,this.tid);this.nick=im.topic_get_caption(this.gid,this.tid);this.bulletin=im.topic_get_bulletin(this.gid,this.tid);if(this.topic.refer_gid){this.update__self.subscribe(im.group_add_publisher,this.topic.refer_gid)}}else{this.nick=this.group.logo.nick;this.bulletin=this.group.logo.bulletin;this.update__self.subscribe(im.group_add_publisher,this.gid)}this.init();this.update_self()},destroy:function(){this.topic_view.destroy();this.topic_view=null;if(this.update__self){this.update__self.unsubscribe(im.topic_add_publisher);this.update__self.unsubscribe(im.group_add_publisher)}this.window_box.destroy();this.window_box=null},init:function(){var d=this.skin,c=this.topic.link_info||{},b=this,a=this.group.permission||{};this.wrapper.style.cssText="position:absolute;left:"+d.wrapper.left+"px;top:"+d.wrapper.top+"px;width:"+d.wrapper.width+"px;height:"+d.wrapper.height+"px;";this.nick_wrapper.style.cssText="position:absolute;left:"+d.nick_wrapper.left+"px;top:"+d.nick_wrapper.top+"px;width:"+d.nick_wrapper.width+"px;height:"+d.nick_wrapper.height+"px;";this.bulletin_wrapper.style.cssText="position:absolute;overflow:hidden;left:"+d.bulletin_wrapper.left+"px;bottom:"+d.bulletin_wrapper.bottom+"px;width:"+d.bulletin_wrapper.width+"px;height:"+d.bulletin_wrapper.height+"px;";if(this.topic.refer_gid||((this.gid>0)&&(c.creater!=this.gid))||((this.gid<0)&&(a.owner_gid!==this.uid))){this.nick_wrapper.innerHTML="<b>"+this.nick+"</b>";this.bulletin_wrapper.innerHTML=this.bulletin}else{this.edit_nick=new edit_input({parent:this.nick_wrapper,text:this.nick,skin:{width:this.skin.nick_wrapper.width,height:this.skin.nick_wrapper.height,bold:true},hint:im.lang.edit_caption,onblur:function(e){return b.nick_onblur(e)}});this.edit_bulletin=new edit_input({parent:this.bulletin_wrapper,text:this.bulletin,skin:{width:this.skin.bulletin_wrapper.width,height:this.skin.bulletin_wrapper.height},hint:im.lang.edit_bulletin,onblur:function(e){return b.bulletin_onblur(e)}})}this.icon.style.cssText="position:absolute;overflow:hidden;"},update_self:function(){this.icon.src=im.icon_src(this.gid,this.topic.refer_gid||this.gid);this.nick=(this.gid>0)?im.topic_get_caption(this.gid,this.tid):this.group.logo.nick;this.bulletin=(this.gid>0)?im.topic_get_bulletin(this.gid,this.tid):this.group.logo.bulletin;if(this.edit_nick){this.edit_nick.set_text(this.nick)}else{this.nick_wrapper.innerHTML="<b>"+this.nick+"</b>";this.nick_wrapper.title=this.nick}if(this.edit_bulletin){this.edit_bulletin.set_text(this.bulletin)}else{this.bulletin_wrapper.innerHTML=this.bulletin;this.bulletin_wrapper.title=this.bulletin}},nick_onblur:function(a){var b=this;if(a==""){a=im.lang.temp_session}if(a.length>20){a=a.substring(0,20)}if(a==this.nick){return a}if(this.gid>0){this.send_msg("topic_set",{gid:this.gid,info:[{tid:this.tid,caption:a}]},function(c,d){if(d&&(d.result===0)){b.nick=a;im.topic_add(b.gid,{tid:b.tid,caption:a})}})}else{this.group.logo.nick=a;this.send_msg("group_set",{gid:this.gid,info:{logo:this.group.logo}},function(c,d){if(d&&(d.result===0)){b.nick=a;im.group_add(b.group)}})}return a},bulletin_onblur:function(a){var b=this;if(a.length>100){a=a.substring(0,20)}if(a==this.bulletin){return a}if(this.gid>0){this.send_msg("topic_set",{gid:this.gid,info:[{tid:this.tid,bulletin:a}]},function(c,d){if(d&&(d.result===0)){b.bulletin=a;im.topic_add(b.gid,{tid:b.tid,bulletin:a})}})}else{this.group.logo.bulletin=a;this.send_msg("group_set",{gid:this.gid,info:{logo:this.group.logo}},function(c,d){if(d&&(d.result===0)){b.bulletin=a;im.group_add(b.group)}})}return a},on_status:function(a){var b=this;if(a=="close"){if(this.topic_view.have_active_video()){if(!confirm(this.lang.video_hint)){return}}this.topic_view.video_stop_all();this.topic_view.publish_stop();this.pub_url_try_index=0;this.window_box.hide();if(this.on_close_topic){this.on_close_topic()}}else{if(a=="mousedown"){if(this.on_mousedown){this.on_mousedown()}}}},on_imsg:function(b,a){if(("string"!=b)&&(typeof(a)=="object")){this.topic_view.on_imsg(b,a)}},on_keydown:function(a){if((document.activeElement==this.win_body)||(this.win_body.uniqueID&&(document.activeElement.uniqueID==this.win_body.uniqueID))){this.topic_view.on_keydown(a)}},active:function(){if(this.first_show&&!im.global_used_by_cs){var b=this,d=this.pos,a=d.left,c=d.top;if((a+this.skin.width)>document.body.clientWidth){a=d.start_left;c=d.start_top}if((c+this.skin.height+150)>window.screen.availHeight){d.top=d.start_top;c=d.start_top}d.left=(a+d.step);d.top=(c+d.step);this.window_box.set_pos({left:a,top:c});this.first_show=false}this.window_box.show();this.topic_view.active()},get_z_index:function(){return this.window_box.get_z_index()},pos_clean:function(){topic_box.prototype.pos={start_left:20,start_top:80,left:20,top:80,step:24}}};topic_box.prototype.lang=lang_get(topic_box.prototype.langs);function topics(a){this.create(a)}topics.prototype={magic:"topics",get_counts:32,langs:{cn:{user:"用户",user2:"用户",txt_hint:"输入文字后会自动显示搜索结果",txt_hint2:"搜索消息",online:"在线用户",online_search_result:"在线搜索结果",search:"搜索",system_msg:"系统消息",active_topic:"当前消息",all_topic:"所有消息",im_get_failed:"获取消息",temp_session:"讨论组",topic_invite_failed_hint:"邀请加入交流失败",topic_open_failed_hint:"开启消息失败",topic_link_open_failed_hint:"尝试开启消息失败",msg_coming:" 来消息了……",topic_get_failed_hint:"拉取交流信息失败"},en:{user:"user",user2:"user",txt_hint:"input text, then auto search contacts",txt_hint2:"searching message",online:"online users",online_search_result:"online search result",search:"search",system_msg:"system message",active_topic:"active message",all_topic:"all messages",im_get_failed:"get message",temp_session:"topic group",topic_invite_failed_hint:"join failed",topic_open_failed_hint:"failure of message enablement ",topic_link_open_failed_hint:"failed trying message enablement ",msg_coming:" message coming……",topic_get_failed_hint:"extract message failed"}},get_default_skin:function(){return{line:{size:1,color:"#9cc"},bar:{height:28,pad:2},txt:{border:{color:"#999",size:1},pad:4,bg:"#fff url(images/input-bg.gif)"},focus_bg:"#69c",icon:{search:"images/search.gif",topic:"images/topic.gif",topics:"images/topic.gif"}}},create:function(e){var c=this,f;this.living=true;this.skin=obj_merge(this.get_default_skin(),e.skin||{});this.send_msg=e.send_msg;this.self_profile=e.self_profile;this.uid=e.uid;this.account=e.account;this.im_get={req:0,ack:0};this.profile=e.profile;this.gid=this.profile.gid;var d=this.self_profile?this.self_profile.state:null;this.dyn_gmid=(d?d.cur_dyn_gmid:0);this.items={};this.contacts=e.contacts;this.tree=e.contacts.tree;this.active_topic=null;this.prev_type=null;this.im_get_counts=0;this.items[this.uid]={};if(undefined==im.groups[this.uid].topics){im.groups[this.uid].topics={}}this.topics=im.groups[this.uid].topics;im.groups[this.uid].topics_ptr=this;im.groups[this.uid].contacts_ptr=e.contacts;this.topic__on_keydown=function(g){g=g||window.event;if(false===c.topic_on_keydown(g)){evt.mude(g);evt.stop(g)}};this.topic__on_mousedown=function(){title_twinkle(null)};if($.ie){document.attachEvent("onkeydown",this.topic__on_keydown);document.attachEvent("onmousedown",this.topic__on_mousedown)}else{document.addEventListener("keydown",this.topic__on_keydown,false);document.addEventListener("mousedown",this.topic__on_mousedown,false)}this.on__topic_add=function(g,l){c.on_topic_add(g,l)};this.on__topic_add.subscribe(im.topic_add_publisher,this.gid);f={};f.gid=this.gid;f.tid=[1];for(var b=1000001,a=1;b<=this.profile.state.tid;b++){f.tid[a++]=b}this.send_msg("topic_get",f,function(g,l){if(c.living){c.on_topic_get_ack(g,l);c.send_im_get(500)}})},destroy:function(){var b;this.living=false;for(var c in this.items){for(var a in this.items[c]){if(b=this.items[c][a]){this.destroy_topic(b)}}}topic_box.prototype.pos_clean();this.items=null;this.on__topic_add.unsubscribe(im.topic_add_publisher);if($.ie){document.detachEvent("keydown",this.topic__on_keydown);document.detachEvent("mousedown",this.topic__on_mousedown)}else{document.removeEventListener("keydown",this.topic__on_keydown,false);document.removeEventListener("mousedown",this.topic__on_mousedown,false)}this.send_msg=null},create_topic:function(c,l){var e=this,g=im.groups[c],d,b=g.topics[l];var a=(c>0)?im.topic_get_caption(c,l):g.logo.nick,f;d={gid:c,tid:l,z_index:0,caption:a,icon:this.skin.icon.topics};d.box=new topic_box({uid:this.uid,gid:c,tid:l,account:this.account,send_msg:this.send_msg,is_hide:true,on_close_topic:function(){e.on_close_topic(c,l)},on_mousedown:function(){if((e.active_topic.gid!==c)&&(e.active_topic.tid!==l)){e.set_active_topic(c,l)}}});if(!this.items[c]){this.items[c]={}}this.items[c][l]=d;if(b.orig_tmid){f=b.orig_tmid-this.get_counts+1;f=(f>0)?f:1;this.send_msg("im_get",{groups:[{gid:c,tmids:[{tid:l,start:f}]}]},function(m,n){if(e.living){e.on_ds_records(m,n,false);d.box.topic_view.add_media_pub(b.videos);d.box.topic_view.update_doms();d.box.topic_view.scroll_to_bottom();if((e.args_tid===l)){d.box.topic_view.video_play_all()}}})}else{if(b.videos){d.box.topic_view.add_media_pub(b.videos);if(this.args_tid===l){d.box.topic_view.video_play_all()}}else{d.box.topic_view.update_doms()}}return d},destroy_topic:function(a){a.box.destroy();delete a.box;delete this.items[a.gid][a.tid]},on_close_topic:function(d,e){var c,b;for(var f in this.items){for(var a in this.items[f]){b=this.items[f][a];if((b.gid==d)&&(b.tid==e)){continue}if(undefined==b.z_index){b.z_index=b.box.get_z_index()}if(undefined==c){c=b;continue}if(c.z_index<b.z_index){c=b}}}this.items[d][e].z_index=0;if(undefined==c){return}if(0==c.z_index){return}this.set_active_topic(c.gid,c.tid)},set_active_topic:function(b,g){var f=im.groups[b],l,d,a=f.topics[g],e;var c=this;if(!this.items[b]||!(d=this.items[b][g])){d=this.create_topic(b,g)}else{this.topic_set(b,g)}d.box.active();this.active_topic=d;d.z_index=d.box.get_z_index();if(b<0){l=im.tag_gid(b)}else{if(f.topics[d.tid].refer_gid){l=im.tag_gid(f.topics[d.tid].refer_gid)}else{l=im.tag_tid(d.tid)}}this.tree.clear_twinkle(l);this.tree.clear_prior(this.tree.create_tag(im.lang.recent_msg,im.prior.recent_msg,true),l)},on_topic_event:function(c,d){switch(c.type){case"click":var a=(d<0)?d:this.gid;var b=(d<0)?101:d;this.set_active_topic(a,b);break}},topic_set:function(b,c){var a=im.groups[b].topics[c];if(a&&(a.tmid>a.cur_tmid)){a.cur_tmid=a.tmid;this.send_msg("topic_set",{gid:b,info:[{tid:c,pos:a.cur_tmid}]},function(d,e){})}},on_topic_add:function(c,d){var b=im.topic_get_caption(c,d);var a=im.groups[c].topics[d];if(!a.refer_gid){this.tree.add({id:im.tag_tid(d),text:b,tags:im.lang.discus,data:d,icon:this.skin.icon.topics,tag_prior:im.prior.discus})}},on_topic_get_ack:function(c,e,b){var v=this,a=[],l=[],g=false;var r,m;if(("object"!=typeof(e))||(0!=e.result)||("topic_get_ack"!=c)){if("cancel"==c){return}alert(this.lang.topic_get_failed_hint);return}if(undefined==e.info){return}var n,d;for(var p=0,q=e.info.length,g=false;p<q;++p,g=false){var s=e.info[p];group=im.groups[s.gid];if(!s||((s.tid!=1)&&!s.linkid)){continue}var f=s.link_info;if(f.tids){for(var u=f.tids,t=u.length,o=0;o<t;o++){if(im.groups[u[o].gid]){continue}g=true;a.push(u[o].gid)}}if(g){l.push(s.tid)}im.topic_add(s.gid,s);if((s.tid==1)&&(undefined==this.items[s.gid][s.tid])){this.create_topic(s.gid,s.tid)}r=im.topic_get_caption(s.gid,s.tid);if(!group.topics[s.tid].refer_gid&&(s.gid>0)){this.tree.add({id:im.tag_tid(s.tid),text:r,tags:im.lang.discus,data:s.tid,icon:this.skin.icon.topics,tag_prior:im.prior.discus});if(b||(s.videos&&s.videos.length)){this.tree.add({id:im.tag_tid(s.tid),text:r,tags:im.lang.recent_msg,data:s.tid,icon:this.skin.icon.topics,tag_prior:im.prior.recent_msg,tag_open:true})}}if((d=s.tmid-s.cur_tmid)<0){d=0}d+=(s.videos?s.videos.length:0);if(d>0){this.msg_notify(s.gid,s.tid,false,d)}}this.send_msg("group_get",{gids:a,flag:im.group_mask.MASK_BASIC,flag_ex:im.group_mask.MASK_EX_GROUPS},function(x,y){im.on_group_get_ack(x,y);l.forEach(function(z){v.on_topic_add(v.gid,z)})})},is_active_topic:function(a,b){if(this.active_topic&&(this.active_topic.gid==a)&&(this.active_topic.tid==b)&&this.active_topic.z_index){return true}return false},msg_notify:function(d,f,l,b){var e=im.groups[d],g,a;var c=e.topics[f]?e.topics[f].refer_gid:0;g=c||(d<0)?im.tag_gid(c||d):im.tag_tid(f);if(!this.tree.find_item(this.tree.create_tag(im.lang.recent_msg),g)){this.tree.add({id:g,icon:(c||(d<0))?im.icon_src(this.uid,c||d):this.skin.icon.topics,text:(d>0)?im.topic_get_caption(d,f):e.logo.nick,tags:im.lang.recent_msg,data:(c||(d<0))?im.guser_get_profile(this.uid,c||d):f,tag_prior:im.prior.recent_msg,tag_open:true})}if(l){return}if(!this.is_active_topic(d,f)){this.tree.set_twinkle(a=this.tree.create_tag(im.lang.recent_msg,im.prior.recent_msg,true),g);this.tree.add_prior(a,g,b)}},send_im_get:function(m){var a=im.groups[this.uid].topics,e,o,f,d;var g=this,c=[],p,l=im.groups[this.uid];p={};p.gid=this.gid;p.dyn_gmids={start:im.groups[this.uid].state.cur_dyn_gmid+1};c.push(p);for(var b in im.groups){e=b-0;if((im.groups[e].gid<0)&&l.contacts[e]&&l.contacts[e].role&&l.contacts[e].role.type<=im.role.FRIEND){p={};p.gid=im.groups[b].gid;p.dyn_gmids={start:im.groups[b].state.cur_dyn_gmid+1};c.push(p)}}setTimeout(function(){if(g.living&&!g.im_get_counts){g.im_get_counts++;g.send_msg("im_get",{groups:c},function(n,q){if(g.living){g.on_ds_records(n,q,true)}})}},m)},on_ds_records:function(e,g,b){var z=this,l=false,o=100;if(b){this.im_get_counts--}if(("object"!=typeof(g))||g.result||("ds_records"!=e)){if("cancel"==e){return}this.prev_type=e;o=3000}else{var p=this.items,u,f,r,c,A,q,v,x,y=[],a=[],t=g.records,m,n,s;if((this.prev_type=="timeout")||(this.prev_type=="error")||(this.prev_type=="abort")){this.send_msg("group_status_notify_ex",{status:im.account.status},function(B,C){});this.prev_type=null}for(u=0,is_dyn_msg=false;u<t.length;++u,is_dyn_msg=false){c=t[u];if(c&&c.type&&(0==c.type.indexOf("im_"))&&(A=c.data)){f=A.head;m=im.groups[f.gid];q=f.gid;v=f.tid||1;A.is_new=b;if(q<0){v=im.GROUP_TOPIC}if(undefined==(s=im.groups[q].topics)){s=im.groups[q].topics={}}if(undefined==this.items[q]){this.items[q]={}}if(f.tmid==0){is_dyn_msg=true;if(f.gmid>m.state.cur_dyn_gmid){m.state.cur_dyn_gmid=f.gmid}}else{if(f.gmid>m.state.gmid){m.state.gmid=f.gmid}}r=f.from;n=im.groups[r.gid];if(n&&n.user){r.user=n.user}if(!r.nick){if(n&&n.logo&&n.logo.nick){r.nick=n.logo.nick}else{r.nick=this.lang.user+f.from.gid}}if((undefined==(x=this.items[q][v]))&&(c.type!="im_blank")&&(c.type!="im_text")){im.save_msg(c.type,A)}if("im_blank"==c.type){continue}if("im_status"==c.type){if(!A.content.profile.gid){A.content.profile.gid=f.from.gid}if(!A.content.profile.owner_gid){A.content.profile.owner_gid=f.from.gid}if(A.content.profile.status!=im.status.TS_WRITTING){im.group_add(A.content.profile)}else{if(x){x.box.on_imsg(c.type,A)}}continue}if(!s[v]){if(q>0){y.push(v)}else{a.push(q)}continue}if(x){x.box.on_imsg(c.type,A)}if(A.is_new){if(!is_dyn_msg){s[v].tmid=f.tmid}if((f.from.gid!=this.uid)&&((c.type=="im_text")||(c.type=="im_media"))){sound_play("voice/msg.wav","voice/msg.swf");title_twinkle((A.head.from.nick||(A.head.from.gid+this.lang.user))+this.lang.msg_coming)}if(v!=1){this.msg_notify(q,v,f.from.gid==this.gid)}}}}if(a.length){var d=[];for(var u=0;u<a.length;u++){if(!im.groups[a[u]]){d.push(a[u])}}if(d.length){this.send_msg("group_get",{gids:d,flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(B,C){im.on_group_get_ack(B,C);z.send_msg("topic_get",{gid:z.gid,tid:y,gid_list:a},function(D,E){if(z.living){z.on_topic_get_ack(D,E,true)}})})}else{this.send_msg("topic_get",{gid:this.gid,tid:y},function(B,C){if(z.living){z.on_topic_get_ack(B,C,true)}})}}else{if(y.length){this.send_msg("topic_get",{gid:this.gid,tid:y},function(B,C){if(z.living){z.on_topic_get_ack(B,C,true)}})}}if(this.active_topic&&this.is_active_topic(this.active_topic.gid,this.active_topic.tid)){this.topic_set(this.active_topic.gid,this.active_topic.tid)}}if(b){this.send_im_get(o)}},open_friend_topic:function(b,d){var a=b<0?b:this.uid,f=im.groups[a],c=this;if(b!=this.uid){var e=(b<0)?im.GROUP_TOPIC:im.groups[b].refer_tid;if(e){if(f&&f.topics[e]){this.set_active_topic(a,e)}else{this.send_msg("topic_get",{gid:b,tid:[e]},function(g,l){if(c.living){im.on_topic_get_ack(g,l);c.set_active_topic(a,e)}})}}else{if(b>0){this.send_msg("topic_link_open",{gid:this.gid,gids:[b],answer:d||""},function(g,l){if(c.living){c.on_topic_link_open_ack(b,"",g,l)}})}}}},on_topic_link_open_ack:function(e,a,g,c){var f=this;if(("object"!=typeof(c))||c.result||("topic_link_open_ack"!=g)){if("cancel"==g){return}if(c.question){var m=prompt("请回答问题："+c.question);if(null!=m){this.open_friend_topic(e,m)}}else{alert(this.lang.topic_link_open_failed_hint)}}else{var d=c.tid,l=im.groups[this.gid];var b=c.link_id;if(0<c.tid){if(l.topics[d]){this.set_active_topic(this.uid,d)}else{this.send_msg("topic_get",{gid:this.gid,tid:[d]},function(n,o){im.on_topic_get_ack(n,o);f.set_active_topic(f.uid,d)})}}else{this.send_msg("topic_open",{gid:this.gid,caption:a,link_id:b},function(n,o){if(f.living){f.on_topic_open_ack(e,n,o,b)}})}}},on_topic_open_ack:function(e,m,b,c){var g=[],a=[];if(("object"!=typeof(b))||b.result||("topic_open_ack"!=m)){if("cancel"==m){return}alert(this.lang.topic_open_failed_hint)}else{var l=this;if(e.constructor===Array){for(var d=0,f=e.length;d<f;d++){g.push({gid:e[d]});if(undefined==im.groups[e[d]]){a.push(e[d])}}}else{g.push({gid:e});if(undefined==im.groups[e]){a.push(e)}}this.send_msg("group_get",{gids:a,flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(n,o){im.on_group_get_ack(n,o)});if(g.length==0){this.send_msg("topic_get",{gid:e,tid:[b.tid]},function(n,o){im.on_topic_get_ack(n,o);l.set_active_topic(l.uid,b.tid)})}else{this.send_msg("topic_invite",{gid:this.gid,link_id:c,caption:"",item:g},function(n,o){if(l.living){l.on_topic_invite_ack(l.gid,b.tid,n,o)}})}}},on_topic_invite_ack:function(b,d,a,e){var c=this;if(("object"!=typeof(e))||e.result||("topic_invite_ack"!=a)){if("cancel"==a){return}alert(this.lang.topic_invite_failed_hint)}this.send_msg("topic_get",{gid:b,tid:[d]},function(f,g){im.on_topic_get_ack(f,g);c.set_active_topic(im.account.uid,d)})},topic_on_keydown:function(d){var b=d.charCode||d.keyCode;var g=String.fromCharCode(b);title_twinkle(null);if(d.ctrlKey&&d.altKey&&g=="Z"){for(var f in this.topics){var a=this.topics[f];if(this.topics[a.tid].cur_tmid<this.topics[a.tid].tmid){this.set_active_topic(a.gid,a.tid);return true}}}if(this.active_topic&&this.active_topic.box&&this.active_topic.z_index){this.active_topic.box.on_keydown(d)}if(this.active_topic&&this.active_topic.box&&(b==27)){this.active_topic.box.on_status("close")}if(b==27){return false}return true}};topics.prototype.lang=lang_get(topics.prototype.langs);function contacts(a){this.create(a)}contacts.prototype={magic:"contacts",group_get_counts:256,langs:{cn:{txt_hint:"根据输入文字，自动显示搜索结果",txt_hint2:"输入昵称或用户名即可搜索",online_search_result:"搜索在线用户",search:"搜索",online:"在线用户",user:"用户",owner:"所有者",manager:"管理员",default_bulletin:"此人很懒，什么都没有写",member:"成员",friend:"好友",guest:"客人",stranger:"陌生人",block:"黑名单",search_result_is_empty:"搜索结果为空",nick:"昵称",sex:"性别",male:"男",female:"女",security:"保密",age:"年龄",bulletin:"心情",tags:"标签",view_detail:"联系人详细资料",ok:"确定",head_icon:"头像",nick:"昵称",tag_hint:"设置分组/TAG  例如: 同学/高中 同事 ",del_friend_failed:"删除好友失败",need_confirm_hint:"需要对方确认，已向对方发送请求",need_answer_question_hint:"用户需要回答问题，问题为空, 返回",add_friend_failed:"添加好友失败",peer_refuse_all_hint:"添加失败，对方拒绝所有好友邀请",search_contact_failed:"搜索联系人失败",birthday:"生日",home:"家乡",male:"男",female:"女",year:"年",month:"月",day:"日",answer_question:"请回答问题:"},en:{default_bulletin:"",txt_hint:"search result will auto display according to input text",txt_hint2:"input nick or accounts to search",online_search_result:"searching online user",search:"search",online:"online user",user:"user",owner:"owner",manager:"administrator",member:"member",friend:"friend",guest:"guest",stranger:"stranger",block:"block list",search_result_is_empty:"null of search result",nick:"nickname",sex:"sex",male:"male",female:"female",security:"security",age:"age",bulletin:"mood",tags:"tags",view_detail:"contact detail",ok:"confirm",head_icon:"image",nick:"nickname",tag_hint:"set tags/class Eg. Classmates/Middle-School co-worker ",del_friend_failed:"delete friends failed",need_confirm_hint:"sent message out,waiting for confirmation",need_answer_question_hint:"answer is needed, when it's null then return",add_friend_failed:"add friends failed",peer_refuse_all_hint:"add failed,denied by your friend",search_contact_failed:"search contact failed",birthday:"birthday",home:"home",male:"male",female:"female",year:"Y",month:"M",day:"D",answer_question:"please anser the question :"}},get_default_skin:function(){return{line:{size:1,color:"#9cc"},bar:{height:28,pad:2},online:{width:80},txt:{border:{color:"#999",size:1},pad:4,bg:"#fff url(images/input-bg.gif)",width:180},focus_bg:"#69c",icon:{search:"images/search.gif",discus:"/images/topics.gif"},profile:{width:200,height:160},box:{box_width:450,box_height:350,box_left:400,box_top:100},button:{width:"80px",height:"26px","vertical-align":"middle","font-size":"16px","line-height":"26px",cursor:"pointer",border:"0px solid #999",background_focus:"url(images/button-bg-focus.gif)",background:"url(images/button-bg.gif)"}}},create:function(e){var c=this,b=e.parent;this.living=true;this.parent=b;this.skin=obj_merge(this.get_default_skin(),e.skin||{});this.self_profile=e.self_profile;this.uid=e.uid;this.gid=e.gid;this.send_msg=e.send_msg;this.items={};this.on__view_contact=function(f,g){c.on_view_contact(g||f)};this.on__view_contact.subscribe(im.group_add_publisher).subscribe(im.guser_add_publisher,this.gid);if(e.on_cmd){this.on_cmd=e.on_cmd}b.appendChild(this.tree_panel=document.createElement("div"));b.appendChild(this.bar=document.createElement("div"));(this.txt=document.createElement("input")).type="text";this.bar.appendChild(this.txt);this.txt.title=this.lang.txt_hint;this.txt.value=this.lang.txt_hint2;this.txt_old_value="";this.timeout=null;if($.ie){this.txt.attachEvent("onpropertychange",function(){c.on_search()})}else{this.txt.addEventListener("input",function(){c.on_search()},false)}this.txt.onfocus=function(){if(c.txt.value==c.lang.txt_hint2){c.txt.value="";c.txt.style.color="black"}};this.txt.onblur=function(){if(c.txt.value==""){c.txt.value=c.lang.txt_hint2;c.txt.style.color="gray"}};this.txt.onblur();this.update_self();this.user_pop_menu=new user_pop_menu({parent:this,gid:this.gid,on_cmd:function(g,f){c.on_cmd(g,f)}});this.tree=new tag_tree({parent:this.tree_panel,on_event:function(g,f){if(f&&f.id&&f.data){c.user_pop_menu.on_event(g,f.data)}},on_update_label:function(f){c.tree_on_update_label(f)}});this.tree__on_update_label=function(f,g){c.tree.oper_item(c.tree.root,im.tag_tid(g),function(l){c.tree.update_label(l)})};this.tree__on_update_label.subscribe(im.topic_add_publisher,this.gid);var d=this.self_profile?this.self_profile.state:null,a=(d&&(d.pid<this.group_get_counts))?d.pid:this.group_get_counts;this.send_msg("group_get",{gid:this.gid,start:1,counts:a,flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(m,n){if(im.on_group_get_ack(m,n)){return}if(!n.groups||(n.groups.length<10)){c.send_msg("group_search",{online:1},function(o,p){if(c.living){c.on_search_ack(o,p)}})}var l=[];for(var g=0,f=n.groups?n.groups.length:0;g<f;g++){if(n.groups[g].gid<0){l.push(n.groups[g].gid)}}if(l.length){c.send_msg("topic_get",{gid_list:l},function(o,p){im.groups[c.uid].topics_ptr.on_topic_get_ack(o,p)})}})},destroy:function(){var a;this.living=false;this.on__view_contact.unsubscribe(im.group_add_publisher).unsubscribe(im.guser_add_publisher);this.tree__on_update_label.unsubscribe(im.topic_add_publisher);for(var b in this.items){if(a=this.items[b]){this.items[b]=null;a=null}}this.items=null;this.user_pop_menu.destroy();if(this.tree){this.tree.destroy();this.tree=null}if(this.tree_panel){this.tree_panel.parentNode.removeChild(this.tree_panel);this.tree_panel=null}if(this.button){this.button.onclick=null;this.button.onmouseover=null;this.button.onmouseout=null;this.button.parentNode.removeChild(this.button);this.button=null}if(this.txt){this.txt.parentNode.removeChild(this.txt);this.txt=null}if(this.online_cap){this.online_cap.parentNode.removeChild(this.online_cap);this.online_cap=null}if(this.online){this.online.parentNode.removeChild(this.online);this.online=null}if(this.label){this.label.onmouseover=null;this.label.onmouseout=null;this.label.parentNode.removeChild(this.label);this.label=null}if(this.bar){this.bar.parentNode.removeChild(this.bar);this.bar=null}if(this.timeout){clearTimeout(this.timeout)}this.send_msg=null;this.parent=null},update_self:function(){var b=this.parent,c=this.skin,a=c.line;this.tree_panel.style.cssText="position:absolute;left:0px;top:0px;overflow-x:hidden;overflow-y:auto;background:white;width:"+b.clientWidth+"px;height:"+(b.clientHeight-c.bar.height)+"px;";this.bar.style.cssText="position:absolute;bottom:0px;left:0px;width:"+b.clientWidth+"px;height:"+c.bar.height+"px;";this.txt.style.cssText="border:"+c.txt.border.size+"px solid "+c.txt.border.color+";background:"+c.txt.bg+";padding:"+c.txt.pad+"px;position:absolute;margin:0px;bottom:"+c.bar.pad+"px;left:"+c.bar.pad+"px;width:"+(b.clientWidth-(2*c.txt.border.size)-(c.txt.pad*2)-(2*c.bar.pad))+"px;height:"+(c.bar.height-(2*c.txt.border.size)-(c.txt.pad*2)-(2*c.bar.pad))+"px;";this.txt.style.color="gray"},update:function(){this.update_self();this.tree.update()},on_search:function(){var b=this;var a=this.txt.value.trim();if(this.tree&&(this.txt.value!=this.txt_old_value)&&(this.txt.style.color=="black")&&(this.txt.value!=this.lang.txt_hint2)){this.tree.del_tag(this.lang.online_search_result);this.tree.filter(a);this.txt_old_value=this.txt.value;if(a){if(this.timeout){clearTimeout(this.timeout)}this.timeout=setTimeout(function(){b.send_msg("group_search",group_search_parser({},a),function(c,d){if(b.living){b.on_search_ack(c,d)}});b.timeout=null},300)}}},on_search_ack:function(f,l){if(("group_search_ack"!=f)||l.result){if("cancel"==f){return}alert(this.lang.search_contact_failed);return}var c,e,g,d,b,a=l.groups||[];for(c=0;c<a.length;++c){im.group_add((e=a[c]));if(e.gid&&(e.gid!=this.gid)&&!this.tree.find_item(this.tree.root,im.tag_gid(e.gid))){g=e.logo;b=(g&&g.nick)?g.nick:(this.lang.user+e.gid);this.tree.add({id:im.tag_gid(e.gid),icon:im.icon_src(e.gid,e.gid),text:b,tags:im.lang.search_result,data:e,tag_prior:im.prior.search_result,tag_open:true})}}},on_view_contact:function(g){var c,e,a,m,f,b;var d=im.guser_get_profile(this.gid,g);var l;if(d.status==0){d.status=im.status.TS_OFFLINE}e=d.logo,l=im.icon_src(d.gid,d.gid);a=(e&&e.nick)?e.nick:(this.lang.user+d.gid);f=this.lang.stranger;if(d.role){switch(d.role.type){case 0:f=this.lang.owner;break;case 1:f=this.lang.manager;break;case 2:f=this.lang.member;break;case 3:f=this.lang.friend;break;case 4:f=this.lang.guest;break;case 5:f=this.lang.stranger;break;case 6:f=this.lang.black;break}}if(this.lang.stranger==f||this.lang.black==f){return}if((f==im.role.FRIEND)&&(g>0)){this.tree.create_tag(im.lang.friend,im.prior.friend)}this.items[d.gid]=obj_merge(this.items[d.id]||{},d);m=(d.tag&&d.tag.data)?d.tag.data:","+((g>0)?f:im.lang.discus);this.tree.add({id:b=im.tag_gid(d.gid),icon:l,text:a,tags:m,data:d,tag_prior:im.prior.friend-1});if(this.tree.find_item(this.tree.create_tag(im.lang.recent_msg),b)){this.tree.add({id:b,icon:l,text:a,tags:im.lang.recent_msg,data:d})}if(d.gid>0){if(d.status==im.status.TS_OFFLINE){this.tree.del_item(this.tree.create_tag(im.lang.online_friend),b)}else{this.tree.add({id:b,icon:l,text:a,tags:im.lang.online_friend,data:d,tag_prior:im.prior.online_friend})}}else{this.tree.add({id:b,icon:l,text:a,tags:im.lang.discus,data:d,tag_prior:im.prior.discus})}},on_contact:function(e,g){var f=this,d=[];if(("group_get_ack"!=e)||g.result){if("cancel"==e){return}alert("group_get_ack failed")}else{var b=g.groups;for(var c=0,a=b.length;c<a;c++){profile=b[c];if(undefined==im.groups[profile.gid]){d.push(profile.gid)}if(profile.gid!=this.gid){this.on_view_contact(profile.gid)}}}if(d.length){this.send_msg("group_get",{gids:d,flag:im.group_mask.MASK_BASIC,flag_ex:im.group_mask.MASK_EX_GROUPS},function(l,m){im.on_group_get_ack(l,m)})}},tree_on_update_label:function(o,e){var m=o.view.label,p=o.view.caption,c,f,b=parseInt(p.style.height),g=o.data,l=(typeof(g)=="object"),n=o.text,q,c,d,a=Math.round(b/2);icon_html="&nbsp;<img style='position:relative;cursor:pointer;border:none;width:"+b+"px;height:"+b+"px;'/>";n=o.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>&nbsp;");c=(l&&g.logo)?g.logo.bulletin:im.topic_get_bulletin(this.gid,o.data);if(o.prior){q=n+"("+o.prior+")";n="<b>"+q+"</b>"}if(l&&g.user&&(!g.logo||(g.user!==g.logo.nick))){n+='&nbsp;<font color="gray">'+g.user+"</font>"}if(l){o.status=(g.status!=im.status.TS_OFFLINE)?im.status.TS_ONLINE:im.status.TS_OFFLINE}d=b+12;if(c){m.innerHTML=icon_html+"&nbsp;<span style='position:absolute;left:"+d+"px;top:0px;cursor:pointer;vertical-align:middle;height:"+a+"px;line-height:"+a+"px;' title='"+(g.user||q)+"'>"+n+'</span><span style="position:absolute;height:'+a+"px;line-height:"+a+"px;left:"+d+"px;top:"+a+'px;color:gray;">'+c+"</span>"}else{m.innerHTML=icon_html+"&nbsp;<span style='position:absolute;left:"+d+"px;top:"+((b-a)/2)+"px;cursor:pointer;vertical-align:middle;height:"+a+"px;line-height:"+a+"px;' title='"+(g.user||q)+"'>"+n+"</span>"}},group_add:function(b,a,d,e){var c=this;this.send_msg("group_add",{gid:this.gid,gid_add:b,vid:a||"",req_text:d||""},function(f,g){if(c.living){c.group_add_ack(b,f,g,e)}})},group_add_ack:function(b,a,f,g){var c=this;if(("object"!=typeof(f))||f.result||("group_add_ack"!=a)){if("cancel"==a){return}if(f.result==105){if(g){g()}return}alert(this.lang.add_friend_failed)}else{var e;if(f.state==1){this.group_clear_contact(b);this.send_msg("group_get",{gid:this.gid,gids:[b],flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_BASIC},function(l,m){im.on_group_get_ack(l,m);if(g){g()}})}else{if(f.state==2){alert(this.lang.peer_refuse_all_hint)}else{if(f.state==3){alert(this.lang.need_confirm_hint)}else{if(f.state==4){var d=prompt(this.lang.answer_question+f.ques_list[0].question);if(null!=d){this.group_add(b,null,d,g)}}}}}}},group_del:function(a){var b=this;this.send_msg("group_del",{gid:this.gid,contact_gid:a},function(c,d){if(b.living){b.group_del_ack(a,c,d)}})},group_del_ack:function(b,a,e){var c=this;var d;if(("object"!=typeof(e))||(0!=e.result)||("group_del_ack"!=a)){if("cancel"==a){return}alert(this.lang.del_friend_failed);return 0}this.group_clear_contact(b);this.items[b]=null;this.send_msg("group_get",{gid:this.gid,gids:[b],flag:im.group_mask.MASK_CONTACT,flag_ex:im.group_mask.MASK_EX_CONTACTS},function(f,g){im.on_group_get_ack(f,g)})},group_clear_contact:function(a){this.tree.del_item(this.tree.root,im.tag_gid(a))},group_set_tags:function(b,e){var d,a,c=this;if(0==b){return}a=e.tag?e.tag.data||"":"";im.set_tag(a,function(f){if(f==a){return}c.send_msg("group_set",{gid:c.gid,info:{gid:b,tag:[{data:f}]}},function(g,l){if(c.living){c.group_set_tags_ack(b,g,l,f)}})})},group_set_tags_ack:function(c,b,e,a){var d=this;if(("object"!=typeof(e))||e.result){alert("group_set() failed");return 0}this.group_clear_contact(c);im.guser_set_tag(this.gid,c,a);this.on_view_contact(c)},group_view_detail:function(n,u){var z=this,d=u||im.groups[n];var q=this.skin,y=d.detail,m=1987,x=12,r=21,a,g;var v=im.icon_src(d.gid,d.gid,im.status.TS_ONLINE);var f="border: "+q.txt.border.size+"px solid "+q.txt.border.color+";background:"+q.txt.bg+";padding:"+q.txt.pad+"px;";if(!this.detail_box){this.detail_box=new window_box({on_status:function(A){if(A=="close"){z.detail_box.destroy();z.detail_box=null}},caption:this.lang.view_detail,skin:{width:this.skin.box.box_width,height:this.skin.box.box_height,left:this.skin.box.box_left,top:this.skin.box.box_top,body:{shadow:true}}})}var l=this.detail_box.get_body();l.style.backgroundColor="white";if(y&&y.section&&(section=y.section[0])){var b,o=section.fields,m,x,r;for(var s=0,t=o.length;s<t;s++){switch(o[s].name){case"province":a=o[s].value;break;case"birthday":var p=o[s].value.split("/");m=(p[0]-0)+this.lang.year;x=(p[1]-0)+this.lang.month;r=(p[2]-0)+this.lang.day;break;case"sex":g=(o[s].value=="male")?this.lang.male:this.lang.female;break}}}var c="<br><div style='position:relative;float:left;width:65%;height:px;'><div style='position:relative;margin-left:10px;float:left;line-height:32px'><table><tr><td>"+this.lang.nick+":&nbsp;&nbsp;&nbsp;</td><td>"+(d.logo?d.logo.nick:"")+"</td></tr><tr><td>"+this.lang.bulletin+":&nbsp;&nbsp;&nbsp;</td><td>"+(d.logo&&d.logo.bulletin?d.logo.bulletin:this.lang.default_bulletin)+"</td></tr>"+(g?("<tr><td>"+this.lang.sex+":</td><td>"+g+"</td></tr>"):"")+(a?("<tr><td>"+this.lang.home+":</td><td>"+a+"</td></tr>"):"")+(m?("<tr><td>"+this.lang.birthday+":</td><td>"+m+x+r+"</td></tr>"):"")+"</table><span id='base_set_res' style='color:red'></span></div></div><div style='position:relative;float:left;width:30%;'><div style='position:relative;float:left;right:10px;'><img style='width:120px;height:120px;' src='"+v+"'/><div align='center'><span id='change_avatar' align='center'>"+this.lang.head_icon+"</button></div></div></div><div style='float:right;position:relative;top:120px;right:20px;'><button id='detail_view_cancel' class='sign_btn'>"+this.lang.ok+"</button>&nbsp;</div>";l.innerHTML=c;this.detail_box.show();var e=$("#detail_view_cancel");e.onclick=function(){z.detail_box.hide()};if($.ie6){e.onmouseenter=function(){e.style.backgroundImage="/images/button-bg-focus.gif"};e.onmouseout=function(){e.style.backgroundImage=""}}}};contacts.prototype.lang=lang_get(contacts.prototype.langs);var global_sid;function im_box(a){this.create(a)}im_box.prototype={magic:"im_box",langs:{cn:{product:"HeHe,Hi!",topics:"消息",contacts:"联系人",user:"用户",menu_hint:"用户菜单",group:"组",login:"登录",logout:"退出",bulletin_hint:"此处编辑签名",sign_up:"注册",setting:"设置",change_user:"切换用户",invite_others:"邀请他人",new_group:"建讨论组",find_user:"查找用户",hot_groups:"热门小组",supporter:"呼叫客服",invite_others_hint:"发送此链接给你好友，对方点此链接即可加你为好友",session_invalid_hint:"会话不存在或已过期，请输入用户名密码登陆"},en:{product:"HeHe,Hi!",topics:"message",contacts:"contact",user:"user",menu_hint:"menu",group:"group",login:"sign in",logout:"sign out",bulletin_hint:"edit bulletin",sign_up:"registration",setting:"setting",change_user:"switch accounts",invite_others:"invite",new_group:"new group",find_user:"find user",hot_groups:"hot groups",supporter:"supporter",invite_others_hint:"send this link to your fiends, he/she will be your friend after he/she click.",session_invalid_hint:"expired session, please login again"}},get_default_skin:function(){return{icon:{contacts:"/images/contacts2.jpg",topics:"images/topic.gif",arrow_down:"images/down.gif",online:"images/status-online-24x24.gif",hide:"images/status-hide-24x24.gif",busy:"images/status-busy-24x24.gif",leave:"images/status-leave-24x24.gif",loading:"/images/loading.gif"},right:60,top:10,height:531,width:205,info:{pad:2,height:40,top:36},nick:{height:20,width:75},bulletin:{width:139,height:20},menu:{width:60,height:20,img:"url(/images/hint-bg-3.gif)",pad:2},install_bar:{width:193,height:26},share_box:{width:520,height:90,top:100,wrapper:{width:480,height:60,top:10}},head:{height:110,logo:{size:80,pad:8,bg:"#fff",mask:"images/logo-mask.gif",src:"images/contact-online.gif"}}}},create:function(c){var a=this,b=c||{};this.living=true;this.skin=obj_merge(this.get_default_skin(),b.skin||{});this.account=b.parent;this.group_counts=0;this.groups={};this.self__status_notify=function(){a.self_status_notify()};this.self__status_notify.subscribe(im.change_status_publisher);this.self__status_notify.subscribe(im.group_add_publisher,im.account.uid);if(b.used_by_cs){b.is_hide=true;im.global_used_by_cs=true}media_plug.prototype.check_plug_install(this.install_bar,function(e,d){a.already_install=((null!=d)&&(media_plug.prototype.ver_min<=d));a.init(b)})},init:function(d){var a,c=this,b=this.already_install?this.skin.install_bar.height:0;this.window_box=new window_box({is_hide:d.is_hide||false,skin:{close:false,width:this.skin.width,height:(this.skin.height-b),right:this.skin.right,top:this.skin.top,head:{height:this.skin.head.height-b}}});this.body=this.window_box.get_body();this.head=this.window_box.get_head();this.head.appendChild(this.logo_wrapper=document.createElement("div"));this.logo_wrapper.appendChild(this.logo=document.createElement("div"));this.logo_wrapper.appendChild(this.caption=document.createElement("div"));this.head.appendChild(this.info_wrapper=document.createElement("div"));this.info_wrapper.appendChild(this.icon=document.createElement("img"));this.info_wrapper.appendChild(this.icon_frame=document.createElement("div"));this.info_wrapper.appendChild(this.nick_wrapper=document.createElement("div"));this.info_wrapper.appendChild(this.menu=document.createElement("div"));this.info_wrapper.appendChild(this.bulletin_wrapper=document.createElement("div"));this.caption.innerHTML="<b>"+this.lang.product+"</b>";this.loading_counts=0;this.uid=d.uid;this.username=d.user;this.nick=d.user||(this.lang.user+this.uid);im.account.uid=this.uid;im.account.user=this.username;a=this.btn_left||220;if(!this.disable_set_btn){this.set_btn=new app_btn({skin:{left:a,top:10,img:"images/setting.gif"},text:this.lang.setting,callback:function(){c.on_contact_setting()}});a+=70}if(!this.disable_share_btn){this.share_btn=new app_btn({skin:{left:a,top:10},text:this.lang.invite_others,callback:function(){c.on_share_btn()}});a+=70}if(!this.disable_new_grp_btn){this.new_grp_btn=new app_btn({skin:{left:a,top:10,img:"images/new-topic.gif"},text:this.lang.new_group,callback:function(){im.invite(0,c)}});a+=70}if(!this.disable_find_btn){this.find_btn=new app_btn({skin:{left:a,top:10,img:"images/search.gif"},text:this.lang.find_user,callback:function(){c.on_find_btn()}});a+=70}if(!this.disable_hot_btn){this.hot_btn=new app_btn({skin:{left:a,top:10,img:"images/search.gif"},text:this.lang.hot_groups,callback:function(){c.on_hot_btn()}});a+=70}if(!this.disable_service_btn){if(im.account.uid!=$.service_gid){this.service_btn=new app_btn({skin:{left:a,top:10,img:"images/help.gif"},text:this.lang.supporter,callback:function(){service()}});a+=70}}this.update__self();this.group_menu=new menu_ex({});this.menu.title=this.lang.menu_hint;this.menu.onclick=function(f){c.on_menu(f||window.event)};if($.ie6){this.menu.onmouseenter=function(){c.menu.style.cursor="pointer";c.menu.style.backgroundImage=c.skin.menu.img;c.menu.style.padding="1px";c.menu.style.border="1px solid blue"};this.menu.onmouseleave=function(){c.menu.style.cursor="";c.menu.style.backgroundImage="";c.menu.style.padding="";c.menu.style.border=""}}if(""==d.user){this.caption.appendChild(this.sign_bar=document.createElement("span"));this.sign_bar.style.cssText="position:relative;left:20px;color:blue;cursor:pointer;";this.sign_bar.innerHTML=this.lang.sign_up;this.sign_bar.onclick=function(f){rpc.cancel();c.account.create_sign_up(true)}}if(d.init_nick_flag){this.send_msg("group_set",{gid:this.uid,info:{logo:{nick:this.nick,icon:0,bulletin:""}}},function(e,f){if(("group_set_ack"==e)&&(0===f.result)){c.get_self_profile()}else{alert(c.lang.session_invalid_hint);c.account.clear_storage();c.account.create_sign_in()}})}else{this.get_self_profile()}},on_contact_setting:function(){var a=this;if(this.user_setting){this.user_setting.show()}else{this.user_setting=new user_setting({parent:a,gid:this.uid,profile:this.self_profile,sid:this.account.sid,update_group_icon:function(b){a.update_group_icon(b)},send_msg:function(c,d,b){if(a&&a.send_msg&&a.living){a.send_msg(c,d,b)}}})}},on_share_btn:function(){var c=this,e=this.skin,d,a;if(this.share_box){this.share_box.show()}else{d=(document.body.clientWidth-e.share_box.width)/2;this.share_box=new window_box({on_status:function(l){if(l=="close"){c.share_box.hide()}},caption:this.lang.invite_others,skin:{width:e.share_box.width,height:e.share_box.height,left:d,top:e.share_box.top,body:{shadow:false}}});a=this.share_box.get_body();var g=document.createElement("div");g.style.cssText="position:absolute;left:"+((e.share_box.width-e.share_box.wrapper.width)/2)+"px;top:"+e.share_box.wrapper.top+"px;width:"+e.share_box.wrapper.width+"px;height:"+e.share_box.wrapper.height+"px;";a.appendChild(g);var f=document.createElement("div");f.innerHTML=this.lang.invite_others_hint;g.appendChild(f);var b=document.createElement("input");b.type="text";b.value=im.href+"?ga="+im.account.uid;b.style.cssText="width:"+(e.share_box.wrapper.width-20)+"px;padding:0px;";g.appendChild(b)}},on_find_btn:function(){var a=this;if(this.find_panel){this.find_panel.show()}else{im.find_panel=this.find_panel=new find_panel({send_msg:function(c,d,b){if(a.living){a.send_msg(c,d,b)}},topics_ptr:this.active_group.topics,contacts_ptr:this.active_group.contacts})}},on_hot_btn:function(){var a=this;if(this.hot_panel){this.hot_panel.show()}else{im.hot_panel=this.hot_panel=new hot_panel({send_msg:function(c,d,b){if(a.living){a.send_msg(c,d,b)}},topics_ptr:this.active_group.topics,contacts_ptr:this.active_group.contacts})}},update__self:function(){var a=this,b=this.skin;this.logo.className="logo";this.caption.style.cssText="position:absolute;left:32px;top:8px;text-align:center;";this.info_wrapper.style.cssText="position:absolute;left:5px;overflow:hidden;top:"+this.skin.info.top+"px;width:193px;height:"+this.skin.info.height+"px;padding:"+this.skin.info.pad+"px;";this.icon_frame.className=this.icon.className="main_icon";this.icon_frame.style.cssText=this.icon.style.cssText="position:absolute;left:1px;top:1px;";this.icon_file_pub=new user_file_pub({parent:this.icon_frame,req_command:"/im/group_set_logo",extra_parms:{dnid:global_sid,dgid:im.account.uid,dtid:0},caption:im.lang.logo_hint,success_handle:function(c,d){if(c=="load"){a.self_profile.logo.icon=d;a.update_group_icon(d)}},failed_handle:function(){a.icon.src=im.icon_src(a.uid,a.uid)},onsubmit:function(){a.icon.src=a.skin.icon.loading},width:40,height:40,pad:0});this.icon_file_pub.update();this.nick_wrapper.style.cssText="position:absolute;left:54px;top:2px;overflow:hidden;height:"+this.skin.nick.height+"px;width:"+this.skin.nick.width+"px;";this.menu.className="menu";this.menu.style.cssText="position:absolute;top:2px;right:4px;overflow:hidden;text-align:center;width:"+(b.menu.width-b.menu.pad*2)+"px;height:"+(b.menu.height-b.menu.pad*2)+"px;";this.bulletin_wrapper.style.cssText="position:absolute;left:54px;bottom:2px;overflow:hidden;height:"+this.skin.bulletin.height+"px;width:"+this.skin.bulletin.width+"px;";if(!this.already_install){this.head.appendChild(this.install_bar=document.createElement("a"));this.install_bar.className="install";this.install_bar.target="_blank";this.install_bar.style.cssText="position:absolute;left:5px;bottom:0px;cursor:pointer;text-decoration:none;color:white;";this.install_bar.onmousedown=function(c){a.install_bar.style.backgroundImage="url(/images/install_press.jpg)"};this.install_bar.onmouseup=function(c){a.install_bar.style.backgroundImage=""};this.install_bar.innerHTML=im.lang.plz_install_plugin;this.install_bar.title=im.lang.install_plugin_hint;this.install_bar.href=media_plug.prototype.types.install.codebase}},destroy:function(){var b,a;this.living=false;this.send_msg("group_status_notify_ex",{status:im.status.TS_OFFLINE},function(){});this.self__status_notify.unsubscribe(im.change_status_publisher);this.self__status_notify.unsubscribe(im.group_add_publisher);for(b in this.groups){a=this.groups[b];if((undefined!=a)&&(null!=a)){this.destroy_group(a)}}if(this.menu){remove_self(this.menu);this.menu=null}if(this.sign_bar){this.sign_bar.parentNode.removeChild(this.sign_bar);this.sign_bar=null}if(this.group_menu){this.group_menu.destroy();this.group_menu=null}if(this.set_btn){this.set_btn.destroy();this.set_btn=null}if(this.service_btn){this.service_btn.destroy();this.service_btn=null}if(this.share_btn){this.share_btn.destroy();this.share_btn=null}if(this.find_btn){this.find_btn.destroy();this.find_btn=null}if(this.hot_btn){this.hot_btn.destroy();this.hot_btn=null}if(this.new_grp_btn){this.new_grp_btn.destroy();this.new_grp_btn=null}if(this.user_setting){this.user_setting.destroy();this.user_setting=null}if(this.share_box){this.share_box.destroy();this.share_box=null}if(this.find_panel){this.find_panel.destroy();this.find_panel=null;im.find_panel=null}if(this.hot_panel){this.hot_panel.destroy();this.hot_panel=null;im.hot_panel=null}this.body.innerHTML="";this.body=null;if(this.logo){this.logo.parentNode.removeChild(this.logo);delete this.logo}if(this.window_box){this.window_box.destroy();this.window_box=null}if(this.icon_file_pub){this.icon_file_pub.destroy()}},get_self_profile:function(){var a=local_storage.get("user_status"),b=this;if(a){im.change_status(parseInt(a))}else{im.account.status=im.status.TS_ONLINE}this.send_msg("group_status_notify_ex",{status:im.account.status},function(c,d){});this.send_msg("group_get",{gids:[b.uid],flag:im.group_mask.MASK_ALL,flag_ex:im.group_mask.MASK_EX_ALL},function(c,d){if(d.result===0){if(b.living){im.on_group_get_ack(c,d);b.on_self_profile(c,d);im.login_publisher.deliver()}}else{alert(b.lang.session_invalid_hint);b.account.clear_storage();b.account.create_sign_in()}})},on_self_profile:function(b,e){var d,a=im.groups[this.uid],c=this;if(null==a){if("cancel"==b){return}this.account.clear_storage();this.account.create_sign_in()}else{this.self_profile=a;this.nick=a.logo.nick;this.bulletin=a.logo.bulletin||"";this.edit_bulletin=new edit_input({parent:this.bulletin_wrapper,text:this.bulletin,skin:{width:this.skin.bulletin.width,height:this.skin.bulletin.height},hint:this.lang.bulletin_hint,onblur:function(f){return c.bulletin_onblur(f)}});this.edit_nick=new edit_input({parent:this.nick_wrapper,text:this.nick,skin:{width:this.skin.nick.width,height:this.skin.nick.height,bold:true},hint:"",onblur:function(f){return c.nick_onblur(f)}});if(null==this.self_group){this.self_group=this.create_group(a);this.group_menu.add_item(null,{caption:im.lang.online,icon:this.skin.icon.online,callback:function(){c.send_msg("group_status_notify_ex",{status:im.status.TS_ONLINE},function(){});im.change_status(im.status.TS_ONLINE)}});this.group_menu.add_item(null,{caption:im.lang.leave,icon:this.skin.icon.leave,callback:function(){c.send_msg("group_status_notify_ex",{status:im.status.TS_LEAVE},function(){});im.change_status(im.status.TS_LEAVE)}});this.group_menu.add_item(null,{caption:im.lang.busy,icon:this.skin.icon.busy,callback:function(){c.send_msg("group_status_notify_ex",{status:im.status.TS_BUSY},function(){});im.change_status(im.status.TS_BUSY)}});this.group_menu.add_item(null,{caption:im.lang.hide,icon:this.skin.icon.hide,callback:function(){c.send_msg("group_status_notify_ex",{status:im.status.TS_HIDE},function(){});im.change_status(im.status.TS_HIDE)}});this.group_menu.add_item(null,{caption:"-"});this.group_menu.add_item(null,{caption:this.lang.change_user,callback:function(){rpc.cancel();im.clear();im.session.create_sign_in()}});this.group_menu.add_item(null,{caption:this.lang.logout,callback:function(){rpc.cancel();im.clear();im.session.sign_out()}})}}},update:function(){if(this.window_box){this.window_box.update()}if(this.contacts){this.contacts.update()}if(this.topics){this.topics.update()}},on_menu:function(d){switch(d.type){case"mouseover":this.menu.style.backgroundImage=this.skin.menu.img;break;case"mouseout":this.menu.style.backgroundImage="";break;case"click":var a=this.menu,c=0,b=a.offsetHeight;for(;a;a=a.offsetParent){c+=a.offsetLeft;b+=a.offsetTop}this.group_menu.show(null,c,b);break}},create_group:function(c){var d=this,f=c.logo,b=im.icon_src(this.uid,this.uid,im.status.TS_ONLINE),e={profile:c},a;this.body.appendChild(e.panel=document.createElement("div"));e.panel.style.cssText="position:absolute;left:0px;top:0px;width:"+this.body.style.width+";height:"+this.body.style.height;e.panel.innerHTML="&nbsp;";e.contacts=new contacts({parent:e.panel,gid:c.gid,uid:this.uid,self_profile:this.self_profile,send_msg:function(l,m,g){if(d.living){d.send_msg(l,m,g)}},on_cmd:function(l,g){d.on_contact_cmd(e,l,g)}});e.topics=new topics({profile:c,contacts:e.contacts,uid:this.uid,self_profile:this.self_profile,account:this.account,skin:{content:{bg:"#fff"}},send_msg:function(l,m,g){if(d&&d.send_msg&&d.living){d.send_msg(l,m,g)}},on_cmd:function(l,g){d.on_contact_cmd(e,l,g)}});e.panel.style.display="none";this.groups[c.gid]=e;++this.group_counts;if(null==this.active_group){this.set_group_active(e)}if(im.args.ga&&(a=(im.args.ga-0))){e.contacts.group_add(a,"","",function(){e.topics.open_friend_topic(a)})}this.on_hot_btn();return e},destroy_group:function(a){if(this.active_group==a){delete this.active_group}a.contacts.destroy();delete a.contacts;a.topics.destroy();delete a.topics;a.panel.innerHTML="";a.panel.parentNode.removeChild(a.panel);delete a.panel;for(var b in a){if(a[b]){delete a[b]}}},set_group_active:function(c){if(this.active_group!=c){var b=c.profile,a=im.icon_src(this.uid,this.uid,im.status.TS_ONLINE);if(this.active_group){this.active_group.style.display="none"}this.icon.src=im.icon_src(this.uid,this.uid,im.status.TS_ONLINE);this.self_status_notify();this.active_group=c;c.panel.style.display="block"}},update_group_icon:function(a){var c=this,b=im.icon_src(this.uid,this.uid,im.status.TS_ONLINE);this.icon.src=b},on_contact_cmd:function(c,b,a){if(typeof(a)=="object"){switch(b){case"chat":c.topics.open_friend_topic(a.gid);break;case"add":c.contacts.group_add(a.gid,null,null);break;case"del":c.contacts.group_del(a.gid);break;case"set_tags":c.contacts.group_set_tags(a.gid,a);break;case"view_detail":c.contacts.group_view_detail(a.gid,a);break}}else{switch(b){case"chat":c.topics.on_topic_event({type:"click"},a);break}}},chat_to_cs:function(c,a){var d=this,b;if(this.uid){this.groups[this.uid].topics.open_friend_topic(c)}else{this.account.anony_sign_in();b=function(){d.groups[d.uid].topics.open_friend_topic(c);b.unsubscribe(im.login_publisher)};b.subscribe(im.login_publisher)}},self_status_notify:function(){this.menu.innerHTML="<img src='"+this.skin.icon.arrow_down+"' style='position:relative;bottom:-0.4em;'/><img src='"+im.status_icon(im.account.status)+"' style='position:relative;bottom:-0.2em;'/>"+im.status_text(im.account.status)},bulletin_onblur:function(b){var a=this;if(this.bulletin==b){return b}if(b.length>140){b=b.substring(0,30)}this.self_profile.logo.bulletin=b;this.send_msg("group_set",{gid:this.self_profile.gid,info:{logo:this.self_profile.logo}},function(c,d){if(d.result===0){a.bulletin=b;im.group_add(a.self_profile)}});return b},nick_onblur:function(b){var a=this;if(b==""){b=im.lang.user+this.self_profile.gid}if(this.nick==b){return b}if(b.length>15){b=b.substring(0,14)}this.self_profile.logo.nick=b;this.send_msg("group_set",{gid:this.self_profile.gid,info:{logo:this.self_profile.logo}},function(c,d){if(d.result===0){a.nick=b;im.group_add(a.self_profile)}});return b},send_msg:function(b,e,a){var d=this,c="",f=("im_get"!=b);e.nid=this.account?this.account.generate_nid():"";if(f&&(1==(++this.loading_counts))){this.logo.className="loading"}rpc.call({srv:(c+"/"),to:"im",type:b,data:e,on_ack:function(g){if(f&&d.logo&&(0==(--d.loading_counts))){d.logo.className="logo"}if(!d.living){return}if("object"==typeof(g)){a(g.type,g.data)}else{if("cancel"!=g){a(g,g)}}}})}};im_box.prototype.lang=lang_get(im_box.prototype.langs);function account(a){this.create(a)}account.prototype={magic:"account",storage_flag:1,str:{term_id:"terminalid",global_str:"global",cookie_str:"im_storage_info"},langs:{cn:{user:"用户名",user_input:"请输入用户名",user_legal:"请输入合法用户名(长度为4-18以字母开头的字符串，其他各位可以是括字母、数字、'_'、'.'、'@'",user_exist:"用户名已存在",pwd:"密码",pwd_input:"请输入密码",pwd_ag:"确认密码",pwd_ag_input:"请再次输入密码",pwd_ag_fail:"两次输入的密码不一致",user_or_pwd_fail:"用户名或密码错误",email:"电子邮件",email_fail:"无效的邮件地址",email_input:"请输入邮件地址",sign_in:"登录",sign_in_part1:"已有帐号",sign_in_anony:"匿名登录",sign_up:"注册",create_new_account:"注册新用户",sign_uping:"正在注册，请稍候……",sign_out:"退出",sign_ining:"正在登录，请稍候...",commit:"注册新用户",connecting:"正在连接服务器中....",system_fail:"系统故障",tips1:"匿名登录：无需输入用户名密码",login_status:"登录状态",save_session:"记住会话状态",auto_login:"自动登录"},en:{user:"user name",user_input:"please input user name",user_legal:"please input user name(length 4-18,prefix must be letter,others permitted, including,letter,numbers、'_'、'.'、'@'",user_exist:"user name is alread existing",pwd:"password",pwd_input:"please enter password",pwd_ag:"please confirm",pwd_ag_input:"input password again",pwd_ag_fail:"wrong password ",user_or_pwd_fail:"incorrect user name or password ",email:"E-mail address",email_fail:"invalid E-mail",email_input:"please input Email address",sign_in:"sign in",sign_in_part1:"",sign_in_anony:"anonymity log in",sign_up:"sign up",create_new_account:"sign up",sign_uping:"sign up，please wait…… ",sign_out:"quit",sign_ining:"Loginning，please wait...",commit:"sign up new user",connecting:"connecting with server....",system_fail:"system issue",tips1:"anonymity, no id and password needed",login_status:"login status",save_session:"save session",auto_login:"auto login"}},get_default_skin:function(){return{top:70,right:100,width:274,height:308,head:{height:62},txt:{width:160,bg:"url(/images/input-bg.gif)"},pwd:{width:106},pad:8,top_pad:30}},create:function(d){var b=this,c=d||{},a;this.living=true;this.bs=hack.get_border_space();this.ps=hack.get_padding_space();this.text_bs=hack.get_text_border_space();this.text_ps=hack.get_text_padding_space();this.skin=obj_merge(this.get_default_skin(),c.skin||{});this.parent=c.parent||document.body;this.on_login_handle=c.on_login_handle;this.winbox=new window_box({is_hide:c.is_hide||false,skin:{close:false,width:this.skin.width,height:this.skin.height,right:this.skin.right,top:this.skin.top,head:{height:this.skin.head.height}}});this.head=this.winbox.get_head();this.body=this.winbox.get_body();this.head.appendChild(this.logo=document.createElement("div"));this.head.style.cssText+="line-height:"+this.skin.head.height+"px;";this.logo.className=$.ie6?"sign_logo_ie6":"sign_logo";this.logo.style.cssText="position:absolute;top:"+((this.skin.head.height-this.logo.clientHeight)/2)+"px;left:"+((this.skin.width-this.logo.clientWidth)/2)+"px;";this.init_nick_flag=0;im.account.status=im.status.TS_ONLINE;this.auto_login=true;this.save_session=true;this.records_user={};this.local_storage_flag=this.storage_flag;this.read_local_storage();if(c.token){if(a=this.get_user_info(c.token.uid)){this.decode_user(a);this.on_update_sign_state()}else{this.username="";this.secret_key=dh.gen_private();this.pub_key=dh.gen_public(b.secret_key);this.send_msg("acs_login",{username:"",password:"",terminal_id:this.terminalid,dh_flag:1,bnum_prime:dh.prime,root_num:dh.g,token:c.token,key_a2b:b.pub_key},function(e,f){b.on_sign_in_ack(e,f)})}}},destroy:function(){if(this.im_box){this.im_box.destroy()}if(this.user_select_list){this.user_select_list.destroy()}if(this.cookie_data){this.cookie_data=null}if(this.winbox){this.winbox.destroy()}this.records_user=null;this.users=null;this.username=null;this.sharekey=null;this.sid=null;this.cur_user=null;global_str=""},start_login:function(){this.on_update_sign_state()},newguid:function(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c;if((b==8)||(b==12)||(b==16)||(b==20)){a+="-"}}return a},get_terminal_str:function(){var b=this.str.term_id;var a;a=local_storage.get(b);return a},set_terminal_str:function(a){var b=this.str.term_id;local_storage.set(b,a)},get_user_info:function(uid){var key_str,data_str;key_str="u_"+uid;data_str=local_storage.get(key_str);if(undefined==data_str||0==data_str.length){return null}return eval("("+data_str+")")},set_user_info:function(b,c){var a,d="";a="u_"+b;if(c){d=codec.obj_2_str(c)}local_storage.set(a,d)},get_user_list:function(){var global_str=this.str.global_str;var data_str;data_str=local_storage.get(global_str);if(undefined==data_str||0==data_str.length){return null}return eval("("+data_str+")")},set_user_list:function(b){var a,c;a=this.str.global_str;c=codec.obj_2_str(b);local_storage.set(a,c)},read_local_storage:function(){var me=this;this.username="";this.uid=0;this.sid="";this.sharekey="";this.cur_cseq=0;this.lim_cseq=100;global_sid="";if(this.storage_flag){this.terminalid=this.get_terminal_str();if(null==this.terminalid||""==this.terminalid){this.terminalid=this.newguid();this.set_terminal_str(this.terminalid);if(null==(temp=this.get_terminal_str())){this.local_storage_flag=0}else{this.users={items:{},anony_uid:0,auto_login_uid:0};this.set_user_list(this.users)}}else{this.local_storage_flag=1;this.users=this.get_user_list();if(null==this.users){this.users={items:{},anony_uid:0,auto_login_uid:0};this.set_user_list(this.users);return}var n,tmp_uid,info;for(n in this.users.items){if(null==n){continue}if(this.users.anony_uid==(tmp_uid=this.users.items[n])){continue}if(null==this.records_user[tmp_uid]){info=this.get_user_info(tmp_uid);if(null==info){continue}this.records_user[tmp_uid]=info}}if(this.uid=this.users.auto_login_uid){var tmp_auto_user=this.records_user[this.uid];if(tmp_auto_user==undefined||tmp_auto_user==null){this.users.auto_login_uid=0}else{this.auto_login=true}this.decode_user(tmp_auto_user)}}}if(0==this.local_storage_flag||0==this.storage_flag){var im_save,new_tid;this.cookie_data=new cookie_ex(this.str.cookie_str);im_save=this.cookie_data.value;new_tid=this.newguid();if(im_save==""){this.save_cookie_str(new_tid);this.terminalid=new_tid;return}else{var start,end=im_save.length,k=0,c,default_user_str;start=0;for(c=im_save.charAt(k);(","!=c)&&(" "!=c)&&("\t"!=c)&&("\r"!=c)&&("\n"!=c);c=im_save.charAt(k)){if((++k)>=end){break}}this.terminalid=im_save.substring(start,k);start=k+1;default_user_str=im_save.substring(start,end);this.decode_user(eval("("+default_user_str+")"))}}},decode_user:function(a){if(a==undefined||a==null){return}this.cur_user=a;this.sid=this.cur_user.sid;global_sid=this.sid;this.uid=this.cur_user.uid;this.username=this.cur_user.username;this.share_key=this.cur_user.share_key;this.cur_cseq=this.cur_user.cseq;this.lim_cseq=this.cur_cseq+100;this.cur_user.cseq=this.lim_cseq;this.save_user_info(this.cur_user,this.uid,null)},save_cookie_str:function(b,c){var a;if(undefined==c||null==c){c={username:"",sid:"",cseq:0,uid:0,share_key:""}}a=b+","+codec.obj_2_str(c);this.cookie_data.value=a;this.cookie_data.store(30,"/")},clear_storage:function(){if(this.local_storage_flag){this.terminalid=this.get_terminal_str();local_storage.clear();this.set_terminal_str(this.terminalid);this.read_local_storage();this.records_user={}}else{this.save_cookie_str(this.terminalid)}},send_msg:function(b,c,a){rpc.call({srv:"/",to:"accounts",type:b,data:c,on_ack:function(d){if("object"==typeof(d)){a(d.type,d.data)}else{if("cancel"!=d){a(d,d)}}}})},save_user_info:function(d,c,a){var b=d.uid;var f=d.username;var e;if(this.local_storage_flag){e=this.get_user_list();if(null==b||null==f||null==e){return}if(""==f){f="guest_"+b}else{f="reguser_"+b}if(c){e.auto_login_uid=c}if(a){e.anony_uid=a}e.items[f]=b;this.users=e;this.set_user_list(e);this.set_user_info(b,d)}else{if(c){this.save_cookie_str(this.terminalid,d)}}},del_user_info:function(a){var c;var b;if(this.local_storage_flag){c=this.get_user_info(a);b=this.get_user_list();if(null==c||null==b){return}delete b.items[c.username];if(b.anony_uid==a){b.anony_uid=0}if(b.auto_login_uid==a){b.auto_login_uid=0}this.set_user_list(b);this.set_user_info(a,null)}else{this.save_cookie_str(this.terminalid)}},generate_nid:function(){var b;var a=this.cur_cseq;this.cur_cseq=this.cur_cseq+1;b=this.sid+md5_ex.hex(this.share_key+a)+a;if(a>=this.lim_cseq){this.cur_user=this.get_user_info(this.uid);this.lim_cseq=this.cur_user.cseq+100;this.cur_user.cseq=this.lim_cseq;this.set_user_info(this.uid,this.cur_user)}return b},user_validate:function(b){var a=/^[a-zA-Z]{1}([a-zA-Z0-9]|[._]){3,17}$/;if(!a.exec(b)){return false}return true},email_validate:function(b){var a=/^\s*([a-zA-Z0-9_-]+(\.\w+)*@(\w+\.)+\w{2,3})\s*$/;if(!a.exec(b)){return false}return true},create_sign_in:function(){var d=this,g=this.skin,c="im_menu_sign_in",f,b,e;if(this.im_box){this.im_box.destroy();delete this.im_box}this.username="";this.sid="";global_sid="";this.share_key="";this.uid=0;this.winbox.show();this.body.innerHTML='<table style="position:absolute;left:0px;top:0px;overflow:hidden;width:'+this.body.clientWidth+"px;height:"+this.body.clientHeight+'px;"><tr><td style="font-size:14px;width:50px;" align="right"><b>'+im.lang.account+'：</b></td><td><input class="sign_input" type="text" style="font-size:14px;width:'+this.skin.txt.width+'px;" id="'+c+'_user"/></td></tr><tr><td></td><td class="sign_error" id="'+c+'_user_info"></td></tr><tr><td style="font-size:14px;" align="right"><b>'+this.lang.pwd+'：</b></td><td><input class="sign_input" type="password" style="width:'+this.skin.txt.width+'px;" id="'+c+'_pass"/></td></tr><tr><td></td><td class="sign_error" id="'+c+'_pass_info"></td></tr><tr><td></td><td class="sign_error" id="'+c+'_commit_info">&nbsp;</td></tr><tr><td style="font-size:14px;" align="right"><b>'+im.lang.status+'：</b></td><td><select id="login_status" onchange="im.account.status=im.status[this.options[this.selectedIndex].value];"><option value="TS_ONLINE">'+im.lang.online+'</option><option value="TS_BUSY">'+im.lang.busy+'</option><option value="TS_LEAVE">'+im.lang.leave+'</option><option value="TS_HIDE">'+im.lang.hide+'</option></select></td></tr><tr><td></td><td><input type="checkbox" id="eid_sign_session" '+(this.save_session?"checked":"")+'><label for="eid_sign_session">&nbsp;'+this.lang.save_session+'</label></input></td></tr><tr><td></td><td><input type= "checkbox" id= "eid_sign_auto" '+(d.auto_login?"checked":"")+'><label for="eid_sign_auto">&nbsp;'+this.lang.auto_login+'</label></input><br></td></tr><tr><td></td><td><button class="sign_btn" id="'+c+'_commit">'+this.lang.sign_in+'</button>&nbsp;&nbsp;<button class="sign_btn" id="'+c+'_anony">'+im.lang.anony_sign+'</button></td></tr><tr><td></td><td><span style="color:#00c;cursor:pointer;text-decoration:underline;" id="'+c+'_regist" >'+this.lang.create_new_account+'</span></td></tr><tr><td></td><td style="font-size:12px;"><br><br><br></td></tr></table><div id="eid_sign_hint"></div>';this.obj_login_user=$("#"+c+"_user");this.obj_login_pass=$("#"+c+"_pass");this.obj_login_commit=$("#"+c+"_commit");this.obj_login_anony=$("#"+c+"_anony");this.obj_login_reg=$("#"+c+"_regist");this.obj_login_hint=$("#eid_sign_hint");this.obj_sign_session=$("#eid_sign_session");this.obj_login_auto=$("#eid_sign_auto");var l=$("#login_status");l.onchange=function(){im.account.status=im.status[l.options[l.selectedIndex].value];local_storage.set("user_status",im.account.status+"")};var a;if(a=local_storage.get("user_status")){switch((im.account.status=parseInt(a))){case im.status.TS_ONLINE:l.selectedIndex=0;break;case im.status.TS_BUSY:l.selectedIndex=1;break;case im.status.TS_LEAVE:l.selectedIndex=2;break;case im.status.TS_HIDE:l.selectedIndex=3;break}}for(f=0,e=0,b=this.obj_login_user;b!=this.body;b=b.offsetParent){f+=b.offsetLeft;e+=b.offsetTop}this.obj_login_hint.style.cssText="border:1px solid #999;border-top:none;position:absolute;display:none;font-size:12px;top:"+(e+this.obj_login_user.offsetHeight)+"px;left:"+f+"px;width:"+this.obj_login_user.clientWidth+"px;"+hack.css_box_shadow(8,"#6699cc");this.obj_login_commit.onclick=function(){var m=0;d.obj_login_user_info=document.getElementById(c+"_user_info");d.obj_login_pass_info=document.getElementById(c+"_pass_info");d.obj_login_commit_info=document.getElementById(c+"_commit_info");d.obj_login_user_info.innerHTML="";d.obj_login_pass_info.innerHTML="";d.obj_login_commit_info.innerHTML="";if(!d.obj_login_user.value){d.obj_login_user_info.innerHTML=d.lang.user_input;return}if(!d.obj_login_pass.value){d.obj_login_pass_info.innerHTML=d.lang.pwd_input;return}d.username=d.obj_login_user.value;d.pwd=d.obj_login_pass.value;d.obj_login_commit_info.innerHTML=d.lang.sign_ining;d.send_msg("acs_random",{user:d.username},function(n,o){d.on_random_ack(n,o)})};this.obj_login_anony.onclick=function(){d.body.innerHTML="";d.anony_sign_in();return};this.obj_login_commit.onmousedown=function(){d.obj_login_commit.style.backgroundImage="url(/images/button-bg-press.gif)"};this.obj_login_commit.onmouseout=this.obj_login_commit.onmouseup=function(){d.obj_login_commit.style.backgroundImage=""};this.obj_login_anony.onmousedown=function(){d.obj_login_anony.style.backgroundImage="url(/images/button-bg-press.gif)"};this.obj_login_anony.onmouseout=this.obj_login_commit.onmouseup=function(){d.obj_login_anony.style.backgroundImage=""};if(this.user_select_list){this.user_select_list.destroy()}this.user_select_list=new user_select_list({parent:this,input:this.obj_login_user,hint:d.obj_login_hint,on_select_login:function(n,m){d.on_select_login(n,m)},on_del_user_records:function(m){d.on_del_user_records(m)},skin:{width:this.obj_login_user.clientWidth}});if(this.obj_sign_session){this.obj_sign_session.onclick=function(){d.save_session=d.obj_sign_session.checked}}if(this.obj_login_auto){this.obj_login_auto.onclick=function(){if(d.obj_login_auto.checked==true){d.auto_login=true;d.save_session="true";d.obj_sign_session.checked=true}else{d.auto_login=false}}}if(this.obj_login_user){if(!im.global_used_by_cs){}}if(this.obj_login_reg){this.obj_login_reg.onclick=function(){d.body.innerHTML="";d.create_sign_up()}}if(this.obj_login_pass){this.obj_login_pass.onkeypress=function(n){var m=n||window.event;if((m.charCode||m.keyCode)==13){d.obj_login_commit.onclick();m.returnValue=false}}}},anony_sign_in:function(){var b=this;var a=0;if(0==this.local_storage_flag||null==this.users||0==this.users.anony_uid){a=1}else{this.cur_user=this.get_user_info(this.users.anony_uid);if(this.cur_user.sid.length==0||this.cur_user.share_key.length==0){a=1}}if(1==a){this.uid=0;this.username="";this.pwd="";this.secret_key=dh.gen_private();this.pub_key=dh.gen_public(this.secret_key);this.send_msg("acs_login",{username:"",password:"",terminal_id:b.terminalid,dh_flag:1,bnum_prime:dh.prime,root_num:dh.g,key_a2b:b.pub_key},function(c,d){b.on_sign_in_ack(c,d)})}else{this.uid=this.cur_user.uid;this.sid=this.cur_user.sid;global_sid=this.sid;this.username=this.cur_user.username;this.share_key=this.cur_user.share_key;this.cur_cseq=this.cur_user.cseq;this.lim_cseq=this.cur_cseq+100;this.cur_user.cseq=this.lim_cseq;this.save_user_info(this.cur_user,null,null);this.on_update_sign_state()}},on_random_ack:function(b,e){var c=this;if("object"==typeof(e)&&(e.result==0)){this.secret_key=dh.gen_private();this.pub_key=dh.gen_public(this.secret_key);var d=md5_ex.hex(this.pwd);var a=md5_ex.hex(d+e.random);this.send_msg("acs_login",{username:this.username,password:a,terminal_id:this.terminalid,bnum_prime:dh.prime,dh_flag:1,root_num:dh.g,key_a2b:this.pub_key},function(f,g){c.on_sign_in_ack(f,g)})}else{this.obj_login_commit_info.innerHTML=this.lang.user_or_pwd_fail}},on_sign_in_ack:function(a,c){var b=this;if(("object"==typeof(c))&&(c.result===0)){this.share_key=dh.gen_shared_secret(this.secret_key,c.key_b2a);this.secret_key=null;this.cur_cseq=c.cseq;this.lim_cseq=c.cseq+100;this.uid=c.uid;this.sid=c.sid;global_sid=this.sid;this.cur_user={username:this.username,sid:c.sid,cseq:this.lim_cseq,uid:c.uid,share_key:this.share_key};this.records_user[this.uid]=this.cur_user;if(this.save_session){if(this.username.length){this.save_user_info(this.cur_user,b.auto_login?this.uid:null,null)}else{this.save_user_info(this.cur_user,null,this.uid)}}this.on_update_sign_state()}else{if(this.obj_login_commit_info){this.obj_login_commit_info.innerHTML=this.lang.user_or_pwd_fail}}},create_sign_up:function(e){var c=this,b,d=this.skin,a="im_menu_regist";if(this.im_box){this.im_box.destroy();delete this.im_box}if(!e){im.account.uid=0}global_sid="";this.winbox.show();this.body.innerHTML='<table style="position:absolute;overflow:hidden;border:none;left:0px;top:0px;width:'+this.body.clientWidth+"px;height:"+this.body.clientHeight+'px;"><tr><td style="font-size:14px;width:70px;" align="right"><b>'+this.lang.user+'：</b></td><td><input class="sign_input" type="text" id="'+a+'_user" style="width:'+this.skin.txt.width+'px;"/></td></tr><tr><td></td><td class="sign_error" id="'+a+'_user_info"></td></tr><tr><td align="right"><b>'+this.lang.pwd+'：</b></td><td><input class="sign_input" type="password" id="'+a+'_pass" style="width:'+this.skin.txt.width+'px;"/></td></tr><tr><td></td><td class="sign_error" id="'+a+'_pass_info"></td></tr><tr><td align="right"><b>'+this.lang.pwd_ag+'：</b></td><td><input class="sign_input" type="password" id="'+a+'_pass2" style="width:'+this.skin.txt.width+'px;"/></td></tr><tr><td></td><td class="sign_error" id="'+a+'_pass2_info"></td></tr><tr><td></td><td class="sign_error" id="'+a+'_commit_info">&nbsp;</td></tr><tr><td></td><td valign="top"><input type="button" class="sign_btn" id="'+a+'_commit" value="'+this.lang.sign_up+'"/>&nbsp;&nbsp;&nbsp;<span style="color:#00c;cursor:pointer;text-decoration:underline;" id="'+a+'_signin" >'+this.lang.sign_in+this.lang.sign_in_part1+"</span><br>&nbsp;<br>&nbsp;<br></td></tr></table>";this.obj_reg_user=document.getElementById(a+"_user");this.obj_reg_signin=document.getElementById(a+"_signin");this.obj_reg_pass=document.getElementById(a+"_pass");this.obj_reg_pass2=document.getElementById(a+"_pass2");this.obj_reg_commit=document.getElementById(a+"_commit");this.obj_reg_user.focus();this.obj_reg_signin.onclick=function(){c.body.innerHTML="";c.create_sign_in()};this.obj_reg_commit.style.cssText=obj2csstxt(this.skin.button);this.obj_reg_commit.onclick=function(){c.obj_reg_user_info=document.getElementById(a+"_user_info");c.obj_reg_pass_info=document.getElementById(a+"_pass_info");c.obj_reg_pass2_info=document.getElementById(a+"_pass2_info");c.obj_reg_commit_info=document.getElementById(a+"_commit_info");c.obj_reg_user_info.innerHTML="";c.obj_reg_pass_info.innerHTML="";c.obj_reg_pass2_info.innerHTML="";c.obj_reg_commit_info.innerHTML="";var f=0;if(!c.obj_reg_user.value){c.obj_reg_user_info.innerHTML=c.lang.user_input;f=1}else{if(c.user_validate(c.obj_reg_user.value)==false){c.obj_reg_user_info.innerHTML=c.lang.user_legal;f=1}}if(!c.obj_reg_pass.value){c.obj_reg_pass_info.innerHTML=c.lang.pwd_input;f=1}if(!c.obj_reg_pass2.value){c.obj_reg_pass2_info.innerHTML=c.lang.pwd_ag_input;f=1}if(c.obj_reg_pass.value&&c.obj_reg_pass2.value&&c.obj_reg_pass2.value!=c.obj_reg_pass.value){c.obj_reg_pass2_info.innerHTML=c.lang.pwd_ag_fail;f=1}if(f){return}c.obj_reg_user.value=c.obj_reg_user.value.toLowerCase();c.obj_reg_commit_info.innerHTML=c.lang.sign_uping;c.send_msg("acs_check_user",{user:c.obj_reg_user.value},function(g,l){c.on_check_user_ack(g,l,e)})};this.obj_reg_commit.onmousedown=function(){c.obj_login_commit.style.backgroundImage="url(/images/button-bg-press.png)"};this.obj_reg_commit.onmouseup=function(){c.obj_login_commit.style.backgroundImage=""};this.obj_reg_pass2.onkeypress=function(g){var f=g||window.event;if((f.which|f.keyCode)==13){c.obj_reg_commit.onclick();f.returnValue=false}}},on_check_user_ack:function(a,d,c){var b=this;if("object"==typeof(d)){if(d.result){this.obj_reg_user_info.innerHTML=this.lang.user_exist;this.obj_reg_commit_info.innerHTML="";return}this.username=this.obj_reg_user.value;this.pwd=this.obj_reg_pass.value;this.send_msg("acs_reg",{nid:c?this.generate_nid():"",username:this.username,password:md5_ex.hex(this.pwd),uid:im.account.uid,email:"",vid:""},function(e,f){if((0==b.on_regist_ack(e,f))&&c){b.del_user_info(b.users.anony_uid)}})}},on_regist_ack:function(a,c){var b=this;if(("object"==typeof(c))&&(c.result==0)){this.uid=c.uid;this.init_nick_flag=1;this.send_msg("acs_random",{user:this.username},function(d,e){b.on_random_ack(d,e)});return 0}else{this.obj_reg_commit_info.innerHTML=this.lang.system_fail;return -1}},sign_out:function(a){var b=this;this.im_box.destroy();delete this.im_box;if(this.users.anony_uid&&(im.account.uid==this.users.anony_uid)){this.username="";this.sid="";global_sid="";this.share_key="";this.uid=0;this.create_sign_in()}else{this.send_msg("acs_logout",{nid:this.generate_nid()},function(c,d){b.on_sign_out_ack(c,d)})}},on_sign_out_ack:function(b,c){var a=this.records_user[this.uid];a.share_key="";a.sid="";a.cseq=0;this.save_user_info(a,(this.auto_login?0:null),null);this.records_user[this.uid]=a;this.create_sign_in()},on_select_login:function(d,b){var c=this;var a;if(undefined==b||0==b||null==(a=this.records_user[b])||""==a.sid||""==a.share_key){this.username=d;return}this.cur_user=a;this.sid=this.cur_user.sid;global_sid=this.sid;this.uid=this.cur_user.uid;this.username=this.cur_user.username;this.share_key=this.cur_user.share_key;this.cur_cseq=this.cur_user.cseq;this.lim_cseq=this.cur_cseq+100;this.cur_user.cseq=this.lim_cseq;this.save_user_info(this.cur_user,c.auto_login?this.uid:null,null);this.on_update_sign_state()},on_del_user_records:function(a){var c=this;var b=a.uid;delete c.records_user[b];c.del_user_info(b)},on_update_sign_state:function(){var a=this;this.body.innerHTML="";if(this.uid&&this.sid&&this.share_key){if(this.on_login_handle){this.on_login_handle({account:this,uid:this.uid})}else{this.im_box=new im_box({parent:this,sid:this.sid,user:this.username,uid:this.uid,init_nick_flag:this.init_nick_flag});this.winbox.hide()}}else{if(im.args.type){this.anony_sign_in()}else{this.create_sign_in()}}}};account.prototype.lang=lang_get(account.prototype.langs);function user_select_list(a){this.create(a)}user_select_list.prototype={magic:"user select list",langs:{cn:{default_text:"",del_cell_title:"删除会话信息",already_login:"直接登录"},en:{default_text:"",del_cell_title:"delete session",already_login:"sign in"}},get_default_skin:function(){return{bg:"#cef url(images/menu-bg.gif)",border:"0px solid #69c",summery_background:"#e0e0ff",selected_row_background:"#9cf url(images/menu-item-bg.gif)",selected_row_border:"0px solid #88d",del_row_background:"#FFE153",row_background:["",""],row_border:["0px solid #fff","0px solid #f0f0ff"],cell_width:24,logo_css:{width:24,height:24}}},create:function(b){var a=this;this.parent=b.parent;this.input=b.input;this.hint_div=b.hint;this.skin=obj_merge(this.get_default_skin(),b.skin||{});this.select_user_handle=b.on_select_login;this.del_user_handle=b.on_del_user_records;this.table=document.createElement("table");if(this.input.attachEvent){this.input.attachEvent("onkeydown",function(c){a.on_key_event(c)});this.input.attachEvent("onfocus",function(c){a.on_focus(c)});this.input.attachEvent("onblur",function(c){a.on_blur(c)});this.input.attachEvent("onpropertychange",function(c){a.on_input_change(c)})}else{this.input.addEventListener("keydown",function(c){a.on_key_event(c)},false);this.input.addEventListener("focus",function(c){a.on_focus(c)},false);this.input.addEventListener("blur",function(c){a.on_blur(c)},false);this.input.addEventListener("input",function(c){a.on_input_change()},false)}this.table.cellSpacing="0";this.hint_div.appendChild(this.table);this.table.style.cssText="width:"+(this.skin.width)+"px;background:"+this.skin.bg+";";this.input.input_asst=this;this.row_counts=0;this.select_index=-1;this.is_focus=true;this.default_text=a.lang.default_text},destroy:function(){if(this.table&&this.table.parentNode){this.table.parentNode.removeChild(this.table)}this.table=null;this.select_user_handle=null;this.del_user_handle=null},on_focus:function(a){if(this.default_text==this.input.value){this.input.value=""}this.is_focus=true;this.show_list(this.parent.records_user)},on_blur:function(b){var a=this;a.is_focus=false;if(!a.is_mouse_over_item){a.hide_hints();if(""==a.input.value){a.input.value=a.default_text}}},on_key_event:function(g){var f=this;if(f.table&&f.input){var b=-1;var d=0;switch(g.keyCode?g.keyCode:g.which){case 40:b=((0<=f.select_index)&&((f.row_counts-1)>f.select_index))?(f.select_index+1):0;break;case 38:b=(0<f.select_index)?(f.select_index-1):(f.row_counts-1);break;case 33:b=0;break;case 34:b=f.table.rows.length-2;break;case 13:f.hide_hints();if(f.input.value.length){var l=f.input.value;var c=0;if(f.select_index>=0){var a=f.table.rows[f.select_index].session;l=a.username;c=a.uid}f.select_user_handle(l,c)}return}f.is_inputting=(0>b);if(true==f.is_inputting){return}if(f.table.rows&&f.table.rows.length&&(0<=b)&&(b!=f.select_index)){f.select_row(b);f.set_hint_text(f.table.rows[b].session.username);f.is_inputting=false}}},on_input_change:function(){var a=this;if(true==a.is_inputting){a.show_list(a.parent.records_user,a.input.value)}},set_hint_text:function(b){var c=this;var a=c.input.value.lastIndexOf(c.hint_word);if((null!=c.key_prefix)&&(""!=c.key_prefix)&&(0==a)&&((0<=b.indexOf(" "))||(0<=b.indexOf("\t")))){b='"'+b+'"'}c.input.value=(0>a)?b:(c.input.value.substr(0,a)+b);c.hint_word=b},get_text:function(){var a=this;return((a.default_text==a.input.value)?"":a.input.value)},show_list:function(d,p){var f=this;if(f.table){for(e=f.table.rows.length;e>0;f.table.deleteRow(--e)){}f.select_index=-1;f.row_counts=0;f.hide_hints();if((null!=d)&&("object"==typeof(d))){var e,c,q,o,b,a=d;for(e in d){if(undefined==e||null==e){continue}c=d[e];if(0==c.username.length||((null!=p)&&""!=p&&(0>c.username.indexOf(p)))){continue}b="cursor:default;background:"+f.skin.row_background[f.row_counts%2]+";border-top:"+f.skin.row_border[f.row_counts%2]+";border-bottom:"+f.skin.row_border[f.row_counts%2]+";";f.row_counts=f.row_counts+1;var g="/im/group_get_logo/-dgid-"+c.uid+"-dcontact_gid-"+c.uid+"-dlogo_id-0-duser_state-2.png";var n="<img src='"+g+"' style='border:none;width:"+f.skin.logo_css.width+"px;height:"+f.skin.logo_css.height+"px;'/>";var m=c.sid.length?("<span style='float:right;display:block;'>"+f.lang.already_login+"</span>"):"";var l="<div title='"+c.username+"'><span style='float:left;'>"+((c.username.length>7)?(c.username.substring(0,7)+"..."):c.username)+"</span>"+m+"</div>";q=f.table.insertRow(-1);q.session=c;(o=q.insertCell(-1)).innerHTML=n;o.style.width=""+f.skin.cell_width+"px";q.insertCell(-1).innerHTML=l;(o=q.insertCell(-1)).innerHTML="<span style='float:right;display:none;font:10px biondi,Arial Black,Bodoni MT Black;'>&nbsp;X&nbsp;</span>";o.style.width=""+f.skin.cell_width+"px";o.title=f.lang.del_cell_title;if(o.attachEvent){o.attachEvent("onclick",function(t){var s=t.target||t.srcElement;var r;while(s&&(null==s.rowIndex)){s=s.parentNode}r=f.table.rows[s.rowIndex].session;f.del_user_handle(r);f.select_index=-1;f.row_counts=f.row_counts-1;f.table.deleteRow(s.rowIndex)});o.attachEvent("onmouseover",function(s){var r=s.target||s.srcElement;r.style.background=f.skin.del_row_background});o.attachEvent("onmouseout",function(s){var r=s.target||s.srcElement;r.style.background=0})}else{o.addEventListener("click",function(t){var s=t.target||t.srcElement;var r;while(s&&(null==s.rowIndex)){s=s.parentNode}r=f.table.rows[s.rowIndex].session;f.del_user_handle(r);f.select_index=-1;f.row_counts=f.row_counts-1;f.table.deleteRow(s.rowIndex)},false);o.addEventListener("mouseover",function(s){var r=s.target||s.srcElement;r.style.background=f.skin.del_row_background},false);o.addEventListener("mouseout",function(s){var r=s.target||s.srcElement;r.style.background=0},false)}q.style.cssText=b;if(q.attachEvent){q.attachEvent("onclick",function(r){f.on_row_click(r,r.srcElement)});q.attachEvent("onmouseover",function(r){f.on_row_mouseover(r,r.srcElement)});q.attachEvent("onmouseout",function(r){f.on_row_mouseout(r,r.srcElement)})}else{q.addEventListener("click",function(r){f.on_row_click(r,r.target)},false);q.addEventListener("mouseover",function(r){f.on_row_mouseover(r,r.target)},false);q.addEventListener("mouseout",function(r){f.on_row_mouseout(r,r.target)},false)}}f.show_hints()}}},on_del_cell_click:function(c){var b=c.target||c.srcElement;var a;while(b&&(null==b.rowIndex)){b=b.parentNode}a=me.table.rows[b.rowIndex].session;me.select_index=-1;me.row_counts=me.row_counts-1;me.del_user_handle(a);me.table.deleteRow(b.rowIndex)},on_row_mouseout:function(c,a){var b=this;b.is_mouse_over_item=false;b.unselect_row()},on_row_mouseover:function(g,d){var f=this;while(d&&(null==d.rowIndex)){d=d.parentNode}if(d){f.is_mouse_over_item=true;row_index=d.rowIndex;if((null!=row_index)&&f.table&&f.input&&f.table.rows){var c,a,b=(row_index>=f.row_counts)?-1:row_index;if((0<=b)&&(f.select_index!=b)){f.select_row(b)}}}},on_row_click:function(d,b){var c=this;while(b&&(null==b.rowIndex)){b=b.parentNode}if(b){if(c.select_index<0){return}var a=c.table.rows[b.rowIndex].session;c.set_hint_text(a.username);c.is_mouse_over_item=false;c.hide_hints();if(c.input.value.length){c.select_user_handle(a.username,a.uid)}}},unselect_row:function(a){var b=this,c;if(0<=b.select_index){c=b.table.rows[b.select_index];for(i=0;i<c.cells.length;++i){(cell=c.cells[i]).style.background=b.skin.row_background[b.select_index%2]}cell.firstChild.style.display="none"}b.select_index=-1},select_row:function(a){var b=this,c;if(0<=b.select_index){c=b.table.rows[b.select_index];for(i=0;i<c.cells.length;++i){(cell=c.cells[i]).style.background=b.skin.row_background[b.select_index%2]}cell.firstChild.style.display="none"}c=b.table.rows[a];for(i=0;i<c.cells.length;++i){(cell=c.cells[i]).style.background=b.skin.selected_row_background}cell.firstChild.style.display="";b.select_index=a},show_hints:function(){var b=this,a,d,c;if(b.table&&b.is_focus&&(0<b.table.rows.length)){b.hint_div.style.display=""}},hide_hints:function(){var a=this;a.hint_div.style.display="none"}};user_select_list.prototype.lang=lang_get(user_select_list.prototype.langs);function user_setting(a){this.create(a)}user_setting.prototype={magic:"user_setting",langs:{cn:{box_caption:"设置",cancel:"取消",confirm:"确认",general_set:"基本资料",check_set:"验证设置",pwd_mod:"修改密码",plugin_set:"插件",plugin_install:"安装",plugin_update:"更新",logo_hint:"点击更新头像",nick:"昵称",sex:"性别",user_url:"用户链接",male:"男",female:"女",security:"保密",bulletin:"签名",upload_head:"上传头像",uplaod_head_succeed:"上传头像成功",nick_cannot_empty:"昵称不能为空",set_profile_succeed:"修改资料成功",set_profile_failed:"修改资料失败",add_friend_setting:"好友添加请求设置",allow_all_directly:"通过所有请求",refuse_all_directly:"拒绝所有请求",confirm_by_myself:"需要本人手动确认",answer_my_question:"需要对方回答我的问题",topic_invite_setting:"话题邀请设置",modify_invite_setting_failed:"修改验证设置失败",modify_invite_setting_succeed:"修改验证设置成功",old_pwd:"旧密码&nbsp;&nbsp;&nbsp;&nbsp;:",new_pwd:"新密码&nbsp;&nbsp;&nbsp;&nbsp;:",confirm_new_pwd:"重复新密码:",missing_password:"输入密码不能为空，请重试",confirm_password_not_same:"两次输入新密码不一致,请重试",modify_password_succeed:"修改密码成功",modify_password_failed:"修改密码失败",install_plugin_info:"安装视频加速器，获得更高质量的视频",install_plugin_hint:"要激活最新视频加速器，您需要重启浏览器",home:"家乡",birthday:"生日",select_year:"选择年",year:"年",month:"月",day:"日",question:"问题",answer:"答案"},en:{box_caption:"config",cancel:"cancel",confirm:"confirm",general_set:"profile",check_set:"privacy",pwd_mod:"password",plugin_set:"plugin",plugin_install:"install",plugin_update:"update",logo_hint:"update image",nick:"nick",sex:"sex",user_url:"user url",male:"male",female:"female",security:"security",bulletin:"mood",upload_head:"upload",uplaod_head_succeed:"image uploaded successfully",nick_cannot_empty:"nickname can't be null",set_profile_succeed:"modification success",set_profile_failed:"modification failure ",add_friend_setting:"setting of adding friend",allow_all_directly:"pass all requests",refuse_all_directly:"deny all requests",confirm_by_myself:"confirmation required",answer_my_question:"feedback required",topic_invite_setting:"setting of topic request ",modify_invite_setting_failed:"modification of check setting failure",modify_invite_setting_succeed:"modification of check setting success",old_pwd:"old password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:",new_pwd:"new password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:",confirm_new_pwd:"re-enter password:",missing_password:"password can't be null,please try again",confirm_password_not_same:"different password,please try again",modify_password_succeed:"password changed",modify_password_failed:"failed change password ",install_plugin_info:"upgrade plugin to get high quality video ",install_plugin_hint:"please restart your browser when activate the latest video engine",home:"home",birthday:"birthday",select_year:"select year",year:"Y",month:"M",day:"D",question:"question",answer:"answer&nbsp;&nbsp;"}},province:["北京","上海","天津","重庆","黑龙江","吉林","辽宁","山东","山西","陕西","河北","河南","湖北","湖南","海南","江苏","江西","广东","广西","云南","贵州","四川","内蒙古","宁夏","甘肃","青海","西藏","新疆","安徽","浙江","福建","台湾","香港","澳门"],get_default_skin:function(){return{box:{box_width:550,box_height:420,box_left:400,box_top:100,body:{shadow:true},setting_item:{font:{size:"12px"},bg:"#cef",width:100,padding:2,item:{height:28,padding:2,bg:{over:"#69c"}}},setting_info:{font:{size:"12px"},bg:"#fff",padding:2,line_height:18}},button:{width:"80px",height:"26px","vertical-align":"middle","font-size":"12px","line-height":"26px",cursor:"pointer",border:"0px solid #999",background:"url(images/button-bg.gif)",background_focus:"url(images/button-bg-focus.gif)"},txt:{border:{color:"#999",size:1},pad:4,height:24,max_height:100,bg:"#fff url(images/input-bg.gif)",font:"12px 宋体",width:180},icon:{loading:"/images/loading.gif"}}},create:function(d){var c=this;this.skin=this.get_default_skin();this.parent=d.parent||document.body;this.uid=d.gid;this.profile=d.profile;this.send_msg=d.send_msg;this.update_group_icon=d.update_group_icon;this.text_bs=hack.get_text_border_space();this.text_ps=hack.get_text_padding_space();this.province_map={};for(var b=0,a=this.province.length;b<a;b++){this.province_map[this.province[b]]=b}this.setting_box=new window_box({on_status:function(e){c.on_status(e)},caption:this.lang.box_caption,skin:{width:this.skin.box.box_width,height:this.skin.box.box_height,left:this.skin.box.box_left,top:this.skin.box.box_top,body:{shadow:false}}});this.body=this.setting_box.get_body();this.tablist=new tabs({parent:this.body,skin:{vertical:true,pad:0,xcaption:{bg:"#cef"},head_shadow:{size:0},content:{bg:"#fff"}}});this.general_set_tab=this.tablist.create_tab({name:"general_set",caption:this.lang.general_set,on_cmd:function(e,f){if(f=="active"){c.on_mod_base_info(e,c.profile)}}});this.check_set_tab=this.tablist.create_tab({name:"check_set",caption:this.lang.check_set,on_cmd:function(e,f){if(f=="active"){c.on_mod_check_setting(e)}}});if(this.profile.gid>0){this.pwd_mod_tab=this.tablist.create_tab({name:"pwd_mod",caption:this.lang.pwd_mod,on_cmd:function(e,f){if(f=="active"){c.on_change_pwd(e)}}})}},destroy:function(){if(this.tablist){this.tablist.destroy();this.tablist=null}if(this.setting_box){this.setting_box.destroy();this.setting_box=null}},show:function(){this.setting_box.show()},hide:function(){this.setting_box.hide()},on_mod_base_info:function(d,g){var L=this,B=this.skin,v=(B.txt.height-(2*B.txt.border.size*this.text_bs)-(2*B.txt.pad*this.text_ps)),q=(B.txt.width-(2*B.txt.border.size*this.text_bs)-(2*B.txt.pad*this.text_ps));var s=d.content,l=g.logo;var M=s.clientHeight,n=s.clientWidth;var G=im.icon_src(g.gid,g.gid,im.status.TS_ONLINE);var m="border: "+B.txt.border.size+"px solid "+B.txt.border.color+";background:"+B.txt.bg+";padding:"+B.txt.pad+"px;";var f="<br/><div style='position:relative;float:left;width:65%;'><div style='position:relative;margin-left:10px;float:left;line-height:32px;'><table style='font:"+B.txt.font+"'><tr><td>"+this.lang.nick+":</td><td><input type='text' id='user_nick' style='"+m+"width:"+q+"px;height:"+v+"px;' value='"+(l?l.nick:"")+"' /></td></tr><tr><td>"+this.lang.bulletin+":</td><td><textarea id='user_bulletin' style='"+m+"width:"+q+"px;height:48px;resize:none;-moz-resize:none;overflow-x:none;overflow-y:auto;' rows='2' maxlength='50'>"+(l?l.bulletin:"")+"</textarea></td></tr><tr><td></td></tr>"+((this.profile.gid>0)?'<tr><td><label for="us_male">'+this.lang.sex+':</label></td><td><label for="us_male"><input id="us_male" type="radio"/>'+this.lang.male+'</label><label for="us_female"><input id="us_female" type="radio"/>'+this.lang.female+'</label></td></tr><tr><td></td></tr><tr><td><label for="us_province">'+this.lang.home+':</label></td><td><select id="us_province" /></td></tr><tr><td></td></tr><tr><td><label for="us_year">'+this.lang.birthday+':</label></td><td><label for="us_year"><select id="us_year" title="'+this.lang.select_year+'"></select>'+this.lang.year+'&nbsp;</label><label for="us_month"><select id="us_month"></select>'+this.lang.month+'&nbsp;</label><label for="us_day"><select id="us_day"></select>'+this.lang.day+"&nbsp;</label></td></tr>":"")+"</table><span id='base_set_res' style='color:red'></span></div></div><div style='position:relative;float:left;width:30%;'><div style='position:relative;float:left;right:10px;'><img id='user_logo' style='width:120px;height:120px;' src='"+im.icon_src(this.profile.gid,this.profile.gid)+"'/><div id='change_avatar' align='center' style='position:relative;top:10px;left:20px;width:80px;height:24px;cursor:pointer;'><button class='sign_btn'>"+this.lang.upload_head+"</button></div></div></div><div style='float:right;position:relative;top:120px;right:40px;'><button id='base_set_confirm' class='sign_btn'>"+this.lang.confirm+"</button>&nbsp;<button id='base_set_cancel' class='sign_btn'>"+this.lang.cancel+"</button></div>";s.innerHTML=f;var b=$("#base_set_confirm"),H=$("#base_set_cancel"),F=$("#change_avatar"),r=$("#user_logo"),A=$("#us_male"),I=$("#us_female"),e=$("#us_province"),z=$("#us_year"),a=$("#us_month"),o=$("#us_day"),K=g.detail,p,u;if(this.profile.gid>0){A.onclick=function(){I.checked=false};I.onclick=function(){A.checked=false};inner_html="";for(var D=0,E=this.province.length;D<E;D++){u=document.createElement("option");u.innerHTML=this.province[D];e.appendChild(u)}for(var D=1900;D<=2010;D++){u=document.createElement("option");u.value=D;u.innerHTML=D;z.appendChild(u)}for(var D=1;D<=12;D++){u=document.createElement("option");u.value=D;u.innerHTML=D;a.appendChild(u)}for(var D=1;D<=31;D++){u=document.createElement("option");u.value=D;u.innerHTML=D;o.appendChild(u)}if(K&&K.section&&(p=K.section[0])){var c,x=p.fields,t,J,C;for(var D=0,E=x.length;D<E;D++){switch(x[D].name){case"province":e.selectedIndex=this.province_map[x[D].value];break;case"birthday":var y=x[D].value.split("/");t=y[0]-0;J=y[1]-0;C=y[2]-0;z.selectedIndex=t-1900;a.selectedIndex=J-1;o.selectedIndex=C-1;break;case"sex":if(x[D].value=="male"){A.checked=true}else{I.checked=true}break}}}if(!A.checked&&!I.checked){A.checked=true}}this.avatar_frm=new user_file_pub({parent:F,req_command:"/im/group_set_logo",extra_parms:{dnid:global_sid,dgid:this.profile.gid,dtid:0},caption:this.lang.logo_hint,success_handle:function(O,P){if(O=="load"){var N=$("#base_set_res");N.innerHTML=L.lang.uplaod_head_succeed;if(null==L.profile.logo){L.profile.logo={}}L.profile.logo.icon=P;r.src=im.icon_src(L.profile.gid,L.profile.gid,im.status.TS_ONLINE);if(L.update_group_icon){L.update_group_icon(P)}}},failed_handle:function(){r.src=im.icon_src(L.profile.gid,L.profile.gid)},onsubmit:function(){r.src=L.skin.icon.loading},width:80,height:24,pad:0});this.avatar_frm.update();b.onclick=function(){var O=$("#user_nick"),Q=$("#user_bulletin"),P=$("#base_set_res"),N={};if(undefined==O||""==O.value){alert(L.lang.nick_cannot_empty);return}if(null==L.profile.logo){L.profile.logo={}}if((L.profile.logo.nick!=O.value)||(L.profile.logo.bulletin!=Q.value)){L.profile.logo.nick=O.value;L.profile.logo.bulletin=Q.value;N.logo=L.profile.logo}else{if(L.profile.gid<0){return}}if(L.profile.gid>0){N.detail={section:[{name:"group_basic",fields:[{name:"province",value:e.options[e.selectedIndex].value},{name:"sex",value:(A.checked?"male":"female")},{name:"birthday",value:(z.options[z.selectedIndex].value+"/"+a.options[a.selectedIndex].value+"/"+o.options[o.selectedIndex].value)}]}]}}L.send_msg("group_set",{gid:L.profile.gid,info:N},function(R,S){if(("group_set_ack"!=R)||S.result){if("cancel"==R){return}P.innerHTML=L.lang.set_profile_failed;return}P.innerHTML=L.lang.set_profile_succeed});im.group_add(L.profile)};H.onclick=function(){L.setting_box.hide()}},on_mod_check_setting:function(a){var b=this;this.send_msg("group_get_conf",{gid:this.profile.gid},function(c,d){b.on_mod_check_setting_ack(a,c,d)})},on_mod_check_setting_ack:function(g,r,f){var q=this;if(f.result){alert("group_get_conf_ack() failed");return 0}var o=f.gconf||{},e=o.flag_setting||1,c,l,s,b,a,m;var t="<br/><div style='margin-left:10px'>"+this.lang.add_friend_setting+"<form id='fnd_form' >&nbsp;&nbsp;<input type='radio' id='us_check_1'  name='friend_setting' value='1'>"+this.lang.allow_all_directly+"<br>&nbsp;&nbsp;<input type='radio' id='us_check_2' name='friend_setting' value='2'>"+this.lang.refuse_all_directly+"<br>&nbsp;&nbsp;<input type='radio' id='us_check_3' name='friend_setting' value='3'>"+this.lang.confirm_by_myself+"<br>&nbsp;&nbsp;<input type='radio' id='us_check_4' name='friend_setting' value='4'>"+this.lang.answer_my_question+"<ul><li id='us4_li1' style='color:gray;'>"+this.lang.question+" : <input id='us_question' type='text' class='sign_input' disabled='true'/></li><li id='us4_li2' style='color:gray;'>"+this.lang.answer+" : <input id='us_answer' type='text' class='sign_input' disabled='true'/></li></ul></form><br><span id='set_res' style='color:red'></span></div><br><div style='float:right;position:relative;right:40px;'><button id='valid_set_confirm' class='sign_btn'>"+this.lang.confirm+"</button>&nbsp;<button id='valid_set_cancel' class='sign_btn'>"+this.lang.cancel+"</button></div>";g.content.innerHTML=t;$("#us_check_"+e).checked="checked";c=$("#us_check_4");l=$("#us_question");s=$("#us_answer");b=$("#us4_li1");a=$("#us4_li2");for(m=1;m<=3;m++){$("#us_check_"+m).onclick=function(){b.style.color="gray";a.style.color="gray";l.disabled=true;s.disabled=true}}c.onclick=function(){b.style.color="";a.style.color="";l.disabled=false;s.disabled=false};if(e==4){l.value=o.info?o.info[0].question:"";s.value=o.info?o.info[0].answer:"";c.click()}var p=$("#valid_set_confirm");var d=$("#valid_set_cancel");p.onclick=function(){var n=$("#fnd_form"),x=$("#set_res"),v,y=0,u={};for(v=0;v<n.length;v++){if(n[v].checked){y=n[v].value}}if(0==y){return}u.gid=q.profile.gid;u.gconf={flag_setting:y,info:[]};if(4==y){u.gconf.info[0]={question:l.value,answer:s.value}}q.send_msg("group_set_conf",u,function(z,A){if(A.result){if("cancel"==z){return}x.innerHTML=q.lang.modify_invite_setting_failed;return}x.innerHTML=q.lang.modify_invite_setting_succeed})};d.onclick=function(){q.setting_box.hide()}},on_change_pwd:function(b){var e=this,l=this.skin,c=(l.txt.height-(2*l.txt.border.size*this.text_bs)-(2*l.txt.pad*this.text_ps)),m=(l.txt.width-(2*l.txt.border.size*this.text_bs)-(2*l.txt.pad*this.text_ps));var d="border: "+l.txt.border.size+"px solid "+l.txt.border.color+";background:"+l.txt.bg+";padding:"+l.txt.pad+"px;width:"+m+"px;";+"height:"+c+"px;";var g="<br/><div style='margin-left:10px;line-height:32px;'>"+this.lang.old_pwd+"&nbsp;<input type='password' style='"+d+"' id='old_pwd' /><br>"+this.lang.new_pwd+"&nbsp;<input type='password' style='"+d+"' id='new_pwd' /><br>"+this.lang.confirm_new_pwd+"&nbsp;<input type='password' style='"+d+"' id='re_new_pwd' /><br><span id='set_res_pwd' style='color:red'></span></div><br><div style='float:right;position:relative;right:40px;'><button id='change_pwd_comfirm' class='sign_btn'>"+this.lang.confirm+"</button>&nbsp;<button id='change_pwd_cancel' class='sign_btn'>"+this.lang.cancel+"</button></div>";b.content.innerHTML=g;var f=$("#change_pwd_comfirm");var a=$("#change_pwd_cancel");f.onclick=function(){var n=$("#old_pwd");var r=$("#new_pwd");var q=$("#re_new_pwd");var p=$("#set_res_pwd");var o=e.uid;if(!n.value||!r.value||!q.value){p.innerHTML=e.lang.missing_password;return}if(q.value!=r.value){p.innerHTML=e.lang.confirm_password_not_same;return}e.parent.account.send_msg("acs_chpwd",{nid:global_sid,uid:o,old_pwd:md5_ex.hex(n.value),new_pwd:md5_ex.hex(r.value)},function(s,t){n.value=r.value=q.value="";if(("acs_chpwd_ack"!=s)||(0!=t.result)){if("cancel"==s){return}p.innerHTML=e.lang.modify_password_failed;return}p.innerHTML=e.lang.modify_password_succeed})};a.onclick=function(){e.setting_box.hide()}},on_status:function(a){if(a=="close"){this.hide()}}};user_setting.prototype.lang=lang_get(user_setting.prototype.langs);function user_pop_menu(a){this.create(a)}user_pop_menu.prototype={magic:"user_pop_menu",get_default_skin:function(){return{profile:{width:200,height:160}}},create:function(b){var a=this;this.parent=b.parent;this.gid=b.gid;this.skin=this.get_default_skin();if(b.on_cmd){this.on_cmd=b.on_cmd}this.popmenu_panel=document.createElement("div");this.popmenu_panel.onmouseover=function(c){a.on_profile_event(c||window.event)};this.popmenu_panel.onmouseout=function(c){a.on_profile_event(c||window.event)};this.popmenu_panel.style.cssText="position:absolute;width:"+this.skin.profile.width+"px;height:"+this.skin.profile.height+"px;"+hack.css_box_shadow(8,"#6699cc");this.popmenu={show_timer:null,hide_timer:null,menu:null,profile:null,ref_counts:0,tmp_profile:null}},destroy:function(){if(this.popmenu.show_timer){clearTimeout(this.popmenu.show_timer);this.popmenu.show_timer=null}if(this.popmenu.hide_timer){clearTimeout(this.popmenu.hide_timer);this.popmenu.hide_timer=null}if(this.popmenu.menu){this.popmenu.menu.destroy();this.popmenu.menu=null}this.popmenu.profile=null;this.popmenu.tmp_profile=null;this.popmenu.ref_counts=0;this.popmenu=null;if(this.popmenu_panel){this.popmenu_panel.onmouseover=null;this.popmenu_panel.onmouseout=null;if(this.popmenu_panel.parentNode){this.popmenu_panel.parentNode.removeChild(this.popmenu_panel)}this.popmenu_panel=null}},try_hide_popmenu:function(){var a=this;if(a.popmenu.hide_timer){clearTimeout(a.popmenu.hide_timer);a.popmenu.hide_timer=null}a.popmenu.hide_timer=setTimeout(function(){a.popmenu.hide_timer=null;if(0>=a.popmenu.ref_counts){a.popmenu.profile=null;if(a.popmenu.menu){a.popmenu.menu.destroy();a.popmenu.menu=null}a.popmenu_panel.style.display="none";if(a.popmenu_panel.parentNode){a.popmenu_panel.parentNode.removeChild(a.popmenu_panel)}}},500)},on_profile_event:function(a){this.popmenu.ref_counts+=(("mouseout"==a.type)?-1:1);if("mouseout"==a.type){this.try_hide_popmenu()}},on_event:function(d,b){var c=this,a=d.srcElement?d.srcElement:d.target;if(b.gid==this.gid){return}switch(d.type){case"mouseover":if(c.popmenu.tmp_profile!=b){if(c.popmenu.show_timer){clearTimeout(c.popmenu.show_timer);c.popmenu.show_timer=null}c.popmenu.tmp_profile=b}if(c.popmenu.profile==b){++c.popmenu.ref_counts}if(null==c.popmenu.show_timer){c.popmenu.show_timer=setTimeout(function(){if(c.popmenu.tmp_profile==b){var g,f,m=0,l=0,e=0;c.popmenu.show_timer=null;for(g=a;g;g=g.parentNode){if("DIV"==g.tagName){e=g.offsetWidth;for(;g;g=g.offsetParent){l+=(g.offsetTop-g.scrollTop);m+=g.offsetLeft}break}}if((m==0)&&(0==l)){return}if(undefined!=global_z_index){c.popmenu_panel.style.zIndex=global_z_index}document.body.appendChild(c.popmenu_panel);c.popmenu_panel.style.display="";c.popmenu_panel.style.top=l+"px";c.popmenu_panel.style.left=((m>c.popmenu_panel.offsetWidth)?(m-c.popmenu_panel.offsetWidth):(m+e))+"px";if(c.popmenu.menu){c.popmenu.menu.destroy();c.popmenu.menu=null}c.popmenu.ref_counts=1;c.popmenu.profile=b;c.popmenu.menu=new user_menu({parent:c.popmenu_panel,gid:c.gid,profile:b,on_cmd:function(o,n){c.on_profile_cmd(o,n)}})}},500)}break;case"mouseout":case"click":c.popmenu.tmp_profile=null;if(c.popmenu.profile==b){--c.popmenu.ref_counts;c.try_hide_popmenu()}if("click"==d.type){c.on_profile_cmd("chat",b)}break}},on_profile_cmd:function(b,a){this.popmenu_panel.style.display="none";if(this.popmenu_panel.parentNode){this.popmenu_panel.parentNode.removeChild(this.popmenu_panel)}if(this.on_cmd){this.on_cmd(b,a)}}};function user_menu(a){this.create(a)}user_menu.prototype={magic:"user_menu",langs:{cn:{send_msg:"发送消息",add_as_friend:"加为好友",set_tag:"设置标签",del_friend:"删除好友",del_member:"删除成员",quit_group:"退出小组",view_detail:"详细资料",bulletin:"签名",user:"用户"},en:{send_msg:"send message",add_as_friend:"add as friend",set_tag:"tag",del_friend:"delete friend",del_member:"delete",quit_group:"quit",view_detail:"profile",bulletin:"mood",user:"user"}},get_default_skin:function(){return{font:{size:"12px",family:"宋体"},bd:{size:1,color:"#369"},bg:"#9cf url(images/menu-bg.gif)",padding:2,control:{font:{size:"12px"},bg:"#9cf url(images/menu-bg.gif)",width:70,padding:2,item:{height:26,padding:2,bg:{over:"#69c url(images/menu-item-bg.gif)"}}},summary:{font:{size:"12px"},bg:"#fff",padding:2,line_height:18,nick:{font:{}},bulletin:{font:{}}},icon:{topics:"/images/topics.gif"}}},create:function(b){var a=this;if("object"!=typeof(b)||b.parent==null||b.on_cmd==null||b.gid==null){alert("New user_menu failed with invalid input param");return}if(typeof(b.parent)=="object"){this.parent=b.parent}else{if((this.parent=document.getElementById(b.parent))==null){alert("New account failed: parent("+b.parent+") does not existed");return}}this.gid=b.gid;this.profile=b.profile;if(typeof(this.profile)!="object"){this.tid=this.profile}if(b.on_cmd){this.on_cmd=b.on_cmd}this.skin=this.get_default_skin();if(b.skin){obj_merge(this.skin,b.skin)}this.draw_menu()},destroy:function(){var b=this;if(this.menu){this.menu.parentNode.removeChild(this.menu)}for(var a in b){if(b[a]){b[a]=null}}},draw_menu:function(){if(this.menu==null){this.bs=hack.get_border_space();this.menu=document.createElement("div");this.parent.appendChild(this.menu)}this.menu._width=this.parent.clientWidth-(this.skin.bd.size+this.skin.padding)*2*this.bs;this.menu._height=this.parent.clientHeight-(this.skin.bd.size+this.skin.padding)*2*this.bs;this.menu._content_width=this.parent.clientWidth-(this.skin.bd.size+this.skin.padding)*2;this.menu._content_height=this.parent.clientHeight-(this.skin.bd.size+this.skin.padding)*2;this.menu.style.cssText="width:"+this.menu._width+"px;height:"+this.menu._height+"px;overflow:hidden;border:"+this.skin.bd.size+"px solid "+this.skin.bd.color+";padding:"+this.skin.padding+"px;background:"+this.skin.bg+";"+(this.skin.font.size?("font-size:"+this.skin.font.size+";"):"")+(this.skin.font.family?("font-family:"+this.skin.font.family+";"):"")+"-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5px;"+hack.css_box_shadow(8,"#6699cc");this.draw_control();this.draw_summary();if(this.clear==null){this.clear=document.createElement("div");this.menu.appendChild(this.clear);this.clear.style.cssText="clear:both;"}},draw_control:function(){var a;if(this.control==null){this.control=document.createElement("div");this.menu.appendChild(this.control);this.control_items=[]}this.control._offset_width=(this.skin.control.width>1)?this.skin.control.width:this.menu._content_width*this.skin.control.width;this.control._width=this.control._offset_width-this.skin.control.padding*2*this.bs;this.control._height=this.menu._content_height-this.skin.control.padding*2*this.bs;this.control._content_width=this.control._offset_width-this.skin.control.padding*2;this.control._content_height=this.menu._content_height-this.skin.control.padding*2;this.control._item_width=this.control._content_width-this.skin.control.item.padding*2;this.control._item_height=this.skin.control.item.height-this.skin.control.item.padding*2;this.control.style.cssText="width:"+this.control._width+"px;height:"+this.control._height+"px;overflow:hidden;white-space:nowrap;padding:"+this.skin.control.padding+"px;background:"+this.skin.control.bg+(this.skin.control.font.size?(";font-size:"+this.skin.control.font.size):"")+";float:left;";if(this.tid){if(this.tid===1){return}a=8}else{a=this.profile.role?this.profile.role.type:5}switch(a){case im.role.MEMBER:this.add_control_item({cmd:"chat",caption:this.lang.send_msg});if(this.profile.is_owner){this.add_control_item({cmd:"del",caption:this.lang.del_member})}this.add_control_item({cmd:"view_detail",caption:this.lang.view_detail});break;case im.role.FRIEND:this.add_control_item({cmd:"set_tags",caption:this.lang.set_tag});if(this.profile.gid>0){this.add_control_item({cmd:"del",caption:this.lang.del_friend})}else{if((this.profile.gid<0)&&(this.profile.permission.owner_gid!=im.account.uid)){this.add_control_item({cmd:"del",caption:this.lang.quit_group})}}this.add_control_item({cmd:"view_detail",caption:this.lang.view_detail});break;case im.role.GUEST:this.add_control_item({cmd:"chat",caption:this.lang.send_msg});this.add_control_item({cmd:"add",caption:this.lang.add_as_friend});this.add_control_item({cmd:"view_detail",caption:this.lang.view_detail});break;case im.role.STRANGER:this.add_control_item({cmd:"chat",caption:this.lang.send_msg});this.add_control_item({cmd:"add",caption:this.lang.add_as_friend});break;case im.role.BLACK:this.add_control_item({cmd:"chat",caption:this.lang.send_msg});this.add_control_item({cmd:"add",caption:this.lang.add_as_friend});break;default:this.add_control_item({cmd:"chat",caption:this.lang.send_msg});break}},draw_summary:function(){var e=this,f,a,d,c,g="";if(this.summary==null){this.summary=document.createElement("div");this.menu.appendChild(this.summary)}this.summary._width=this.menu._content_width-this.control.clientWidth-this.skin.control.padding*2*this.bs;this.summary._height=this.menu._content_height-this.skin.summary.padding*2*this.bs;this.summary._content_width=this.menu._content_width-this.control.clientWidth-this.skin.summary.padding*2;this.summary._content_height=this.menu._content_height-this.skin.summary.padding*2;this.summary.style.cssText="width:"+this.summary._width+"px;height:"+this.summary._height+"px;line-height:"+this.skin.summary.line_height+"px;overflow:hidden;padding:"+this.skin.summary.padding+"px;background:"+this.skin.summary.bg+(this.skin.summary.font.size?(";font-size:"+this.skin.summary.font.size):"")+";float:left;";f=this.profile.logo;a=(f&&f.nick)?f.nick:(this.lang.user+this.profile.gid);d=im.icon_src(this.profile.gid,this.profile.gid);c=(f&&f.bulletin)?f.bulletin:"";if(this.tid){if(this.tid===1){a=im.lang.system_topic}else{a=im.lang.temp_session}d=this.skin.icon.topics}g+='<div style="width:'+this.summary._content_width+'px;text-align:center;"><img style="width:'+this.summary._content_width+'px;visibility:hidden"></div>';g+='<div style="width:'+this.summary._content_width+"px;text-align:center;"+(this.skin.summary.nick.font.size?(";font-size:"+this.skin.summary.nick.font.size):"")+'">'+a;+((this.profile.tag&&this.profile.tag.data)?("("+this.profile.tag.data+")"):"")+"</div>";g+='<div style="width:'+this.summary._content_width+"px;text-align:left;"+(this.skin.summary.bulletin.font.size?(";font-size:"+this.skin.summary.bulletin.font.size):"")+'" title="'+this.lang.bulletin+":"+c+'">'+c+"</div>";this.summary.innerHTML=g;var b=this.summary.getElementsByTagName("img")[0];if(b){b.onload=function(){if(e.summary){var l=new Image();l.src=b.src;if(l.width<e.summary._content_width){b.style.width=l.width+"px"}b.style.visibility="inherit"}};b.src=d}},add_control_item:function(c){var b=this;var a=document.createElement("div");this.control.appendChild(a);a.style.cssText="cursor:pointer;width:"+this.control._item_width+"px;height:"+this.control._item_height+"px;line-height:"+this.control._item_height+"px;overflow:hidden;padding:"+this.skin.control.item.padding+"px;";a.innerHTML=c.caption;a.onmouseover=function(d){a.style.background=b.skin.control.item.bg.over};a.onmouseout=function(d){a.style.background=""};a.onclick=function(d){if(b.on_cmd){b.on_cmd(c.cmd,b.profile,b.tid)}}}};user_menu.prototype.lang=lang_get(user_menu.prototype.langs);function cs_banner(a){this.create(a)}cs_banner.prototype={get_default_skin:function(){return{font:{size:"15px"},bd:{size:1,color:"#699"},bg:"#add",padding:4}},create:function(b){var a=this;if("object"!=typeof(b)||b.parent==null){alert("New cs_banner failed with invalid input param");return}if(typeof(b.parent)=="object"){this.parent=b.parent}else{if((this.parent=document.getElementById(b.parent))==null){alert("New account failed: parent("+b.parent+") does not existed");return}}this.skin=this.get_default_skin();if(b.skin){obj_merge(this.skin,b.skin)}},destroy:function(){var b=this;for(var a in b){if(b[a]){delete b[a]}}}};var g_about_win;function about(){if(null==g_about_win){lang=about.prototype.lang;g_about_win=new window_box({skin:{width:480,height:360,top:100},on_status:function(a){if(("close"==a)&&g_about_win){g_about_win.destroy();g_about_win=null}}});g_about_win.get_caption().innerHTML="<span style='color:white'>"+lang.about+"<span>";g_about_win.get_body().innerHTML="<div style='color:white;display:block;position:relative;left:0px;padding:8px;overflow:hidden;line-height:1.5em;'>"+lang.h1+"<hr/>"+lang.c1.replace(/\n/g,"<br/>")+"</p><p>"+lang.h2+"<hr/>"+lang.c2.replace(/\n/g,"<br/>")+"<p>"+lang.h3+lang.c3.replace(/\n/g,"<br/>")+"<br/><span style='float:right'>"+lang.from+"</span><span style='float:clear'/></p></div>"}}about.prototype={langs:{cn:{about:"关于hehe,hi!",h1:"HeHe,Hi!",c1:'&nbsp;&nbsp;人们见面时,一个轻声的微笑："呵呵"，然后伴随一句：“嗨！”的问候，那便是"hehe,hi！"。\nhehehi.com就是来自于这个见面礼！\n\n',h2:"使命",c2:"&nbsp;&nbsp;致力于提供人性化的贴身视频沟通服务。\n\n",h3:"",c3:"&nbsp;&nbsp;不论您在计算机前，还是携带3G手机的旅途中，hehehi.com均可为您提供贴身的视讯服务。\n\n",from:"来自迈岭科技"},en:{about:"About hehe,hi!",h1:"HeHe,Hi!",c1:'&nbsp;&nbsp;when people meet someone,a softly smile: "hehe" and then with one sentence: "Hi!" Greetings, that is, "hehe, hi!".。\nhehehi.com is a gift from this！\n\n',h2:"Mission",c2:"&nbsp;&nbsp;Committed to providing humane personal video communication services.\n\n",h3:"",c3:"&nbsp;&nbsp;Whether you're in front of the computer or 3G mobile phone to carry the road, hehehi.com can provide you with personal video communication services.\n\n",from:"From Mining Technology"}}};about.prototype.lang=lang_get(about.prototype.langs);function video_link(){var g=codec.uri_2_obj(location.search||"");if(!g||((!g.from||!g.to)&&(!g.play))){alert("missing param.");return}var n=codec.str_2_uri_param(g.from||""),o=codec.str_2_uri_param(g.to||""),e=codec.str_2_uri_param(g.play||""),d=((window.location.protocol=="http:")?window.location.hostname:"127.0.0.1"),l,m,p=function(q){switch(q.type){case"close":alert(q.type);if(q.chl){if(q.chl==l){b.chl_destroy(l);l=null}else{if(q.chl==m){b.chl_destroy(m);m=null}}}break}},f,b=new media_plug({parent:$("#main"),on_event:p}),a=0,c=setInterval(function(){if((f=(b.status==b.plug_status.running))||(b.status==b.plug_status.closed)||(100<=a)){if(c){clearInterval(c)}if(f){if(""!=e){l=b.chl_create({type:"play",url:d+"/"+e})}else{l=b.chl_create({type:"play",url:d+"/"+n+"_"+o});m=b.chl_create({type:"publish",url:d+"/"+o+"_"+n})}}else{alert("init plugin failed.");b.destroy();b=null}}a+=((b.status==b.plug_status.initting)?1:0)},50)}function video_call(a){this.create(a||{})}video_call.prototype={langs:{cn:{ext_display:"显示侧边栏",ext_hide:"隐藏侧边栏",send_hint:"◆发送：ENTER或CTRL+ENTER\r\n◆换行：SHIFT+ENTER",stop:"停止",play:"播放",play_stop:"停止播放",play_you_video:"正在观看你的视频",play_:"正在观看",_video:"的视频",play_you_video_stop:"关闭了你的视频",publish:"发布",publish_stop:"关闭",video:"视频",upload:"上传文件",group_add_0:"对方同意你的邀请，和您成为了好友！",group_add_1:"已经加您为好友！",group_add_2:"想加你为好友！",accept:"接受",denial:"拒绝",user_add_the_topic:"参与者",user:"用户",share:"分享",topic_share:"分享此会话",video_share:"分享此视频",file_dialog_cap:"文件上传",cancel:"取消",confirm:"确认",err_camera_not_install:"对不起，你还没有安装摄像头",err_camera_busy:"摄像头正被别的程序使用",err_camera:"对不起，你的摄像头可能没有安装或被别的程序占用",err_video_start:"视频启动失败，请稍候再试",cam_select:"摄像头选择",mic_select:"麦克风选择",cam:"摄像头",mic:"麦克风",io_error:"网络出现故障",me:"我",drm_error:"数字视频授权无法通过",unknown_msg_type:"unknown message type",newest_msg:"(最新消息)",media_msg:"视频消息",msg:"消息",th_prevfix:"第",th_postfix:"条",share_hint:"点此按钮，邀请用户加入讨论组",need_pull:"未拉取",pulling:"拉取中...",peer_refuse_hint:"添加失败，对方拒绝所有好友邀请",need_peer_confirm_hint:"需要对方确认，已向对方发送请求",need_answer_question_hint:"用户需要回答问题，问题为空, 返回",already_friend_hint:"你们已经是好友",group_add_ack_failed_hint:"添加好友失败",become_friend:"成为好友",add_:"想加",_friend:"为好友",topic_invite:"邀请你进入讨论组",file_uploaded:"已上传文件",size:"大小",input_hint:"在此输入消息，按【回车】键发送",sent_at:"发表于",calling:"正在呼叫",accept:"接受",refuse:"拒绝",cancel:"取消",you:"您"},en:{ext_display:"display extension ",ext_hide:"hide extension",send_hint:"◆send：ENTER或CTRL+ENTER\r\n◆line wrap：SHIFT+ENTER",stop:"stop",play:" play",play_stop:"shut down",play_you_video:" is watching your video",play_:"play ",_video:"'s video",play_you_video_stop:" shut down your video",publish:" publish",publish_stop:"stop publishing",video:"video",share_hint:"click [share] button, invite user join topic",upload:"upload",group_add_0:"agree to add you as friend",group_add_1:"already in buddy list",group_add_2:"invite you to be a friend",share:"share",topic_share:"topic share",video_share:"video share",accept:"accept",denial:"deny",user_add_the_topic:"participator",user:"user",file_dialog_cap:"file upload",cancel:"cancel",confirm:"confirm",err_camera_not_install:"I'm sorry, your webcam can't be finded",err_camera_busy:"your webcam is now occupied",err_camera:"I'm sorry that your webcam can't be installed or occupied",err_video_start:"failed to open your video, please try it later",cam_select:"webcam option",mic_select:"mic option",cam:"webcam",mic:"mic",io_error:"networking issue",me:"I",drm_error:"failed to pass through with authorized digital video",unknown_msg_type:"unknown message type",newest_msg:"the latest message",media_msg:"video message",msg:"message",th_prevfix:"",th_postfix:"th ",need_pull:"waiting for extracting",pulling:"extracting...",peer_refuse_hint:"add failed,denied by your friend",need_peer_confirm_hint:"sent message out, waiting for confirmation",need_answer_question_hint:"feedback is needed,when result is null then return",already_friend_hint:"already in buddy list",group_add_ack_failed_hint:"failure of adding friends",become_friend:"adding friend success",add_:"want to add ",_friend:"as friend",topic_invite:"invite you join topic",file_uploaded:"finished upload",size:"size",input_hint:"input message here, press [ENTER] key to send",sent_at:" sent at ",calling:" is calling ",accept:"Accept",refuse:"Refuse",cancel:"Cancel",you:"you"}},create:function(b){var a=this;this.media_server=((window.location.protocol=="http:")?window.location.hostname:"127.0.0.1");this.living=true;this.account=b.account;this.gid=b.from.gid;this.nick=b.from.nick;this.is_called=(b.caller!=this.gid);this.to_gid=b.to.gid;this.to_nick=b.to.nick;this.videos={};this.send_msg("group_get",{gid:this.gid,flag:im.group_mask.MASK_STATE,flag_ex:im.group_mask.MASK_EX_GID},function(c,f){try{a.dyn_gmid=f.group.state.cur_dyn_gmid}catch(d){a.dyn_gmid=0}a.send_im_get(200)});this.send_msg("topic_link_open",{gid:this.gid,gids:[this.to_gid]},function(c,d){if(d.result===0){a.on_topic_link_open_ack(c,d)}})},destroy:function(){this.living=false;this.hide_call_panel();if(this.pub_timer){clearInterval(this.pub_timer);delete this.pub_tiemr}if(this.plug){this.plug.destroy();delete this.plug}},send_im_get:function(b){var a=this;setTimeout(function(){if(a.living){a.send_msg("im_get",{groups:[{gid:a.gid,dyn_gmids:{start:a.dyn_gmid+1}}]},function(c,d){if(a.living){a.on_ds_records(c,d,true)}})}},b)},on_topic_link_open_ack:function(a,c){var b=this;this.link_id=c.link_id;if(c.tid){this.tid=c.tid;this.send_msg("topic_get",{gid:this.gid,tid:[c.tid]},function(d,e){b.on_topic_get_ack(d,e)});this.show_call_panel()}else{this.send_msg("topic_open",{gid:this.gid,link_id:this.link_id},function(d,e){b.on_topic_open_ack(d,e)})}},on_topic_open_ack:function(a,c){var b=this;if(c.result!==0){alert("topic_open失败");return}this.send_msg("group_add",{gid:this.gid,gid_add:this.to_gid},function(){});this.tid=c.tid;this.send_msg("topic_get",{gid:this.gid,tid:[c.tid]},function(d,e){b.on_topic_get_ack(d,e)});this.show_call_panel()},hide_call_panel:function(){if(this.call_hint_panel){this.call_hint_panel.innerHTML="";this.call_hint_panel.parentNode.removeChild(this.call_hint_panel);delete this.call_hint_panel}},show_call_panel:function(){var b=this,c,a,d=["",""];$("#main").appendChild(this.call_hint_panel=document.createElement("div"));this.call_hint_panel.style.cssText="position:absolute;top:30%;left:0;width:100%;height:70%;";d[this.is_called?1:0]=(this.nick+"( "+this.lang.you+")");d[this.is_called?0:1]=this.to_nick;this.call_hint_panel.innerHTML="<center><span style='font-size:18px;color:#fff;'>"+d[0]+this.lang.calling+d[1]+"...</span><br/><br/><button style='font-size:18px;border:none;color:#fff;background:#333;width:210px;height:32px;line-height:32px;cursor:pointer;'>"+(b.is_called?this.lang.refuse:this.lang.cancel)+"</button>"+(b.is_called?("&nbsp;&nbsp;<button style='font-size:18px;border:none;color:#fff;background:#333;width:210px;height:32px;line-height:32px;cursor:pointer;'>"+this.lang.accept+"</button>"):"")+"</center>";hint=this.call_hint_panel.getElementsByTagName("span")[0];a=this.call_hint_panel.getElementsByTagName("button");if(0<a.length){a[0].onmouseover=function(){this.style.background="#666"};a[0].onmouseout=function(){this.style.background="#333"};a[0].onclick=function(){b.hide_call_panel();if(b.is_called){b.send_msg("cmd_pub",{gid:b.gid,tid:b.tid,flag:1,content:{type:"call",params:[{name:"sub_type",value:"refuse"}]}},function(e,f){})}else{}}}if(b.is_called&&(1<a.length)){a[1].onmouseover=function(){this.style.background="#666"};a[1].onmouseout=function(){this.style.background="#333"};a[1].onclick=function(){b.hide_call_panel();b.send_msg("cmd_pub",{gid:b.gid,tid:b.tid,flag:1,content:{type:"call",params:[{name:"sub_type",value:"accept"}]}},function(e,f){});setTimeout(function(){if(b.living){b.publish_start()}},100)}}for(i=0;i<a.length;++i){}sound_play("/voice/audio.wav","/voice/audio.swf")},on_topic_get_ack:function(d,e){if(e.result===0){var c=e.info[0].videos;if(undefined==c){return}var a={};a.is_new=true;a.head={};a.content={};a.head.from={};for(var b=0;b<c.length;b++){if(this.videos[c[b].stream_id]){continue}a.head.from.gid=c[b].gid;a.content.flag=1;a.content.stream_id=c[b].stream_id;a.content.type="rtmp";a.head.date=c[b].date;this.on_imsg("im_media",a)}}},on_ds_records:function(m,a,d){var l=this,n=100;if(a.result!==0){if("cancel"==m){return}n=10000}else{var f,o,g,e,c,b=a.records;for(f=0,is_dyn_msg=false;f<b.length;++f,is_dyn_msg=false){g=b[f];if(g&&g.type&&(0==g.type.indexOf("im_"))&&(e=g.data)){o=e.head;c=o.tid;if(o.tmid==0){is_dyn_msg=true;if(o.gmid>this.dyn_gmid){this.dyn_gmid=o.gmid}}this.on_imsg(g.type,e)}}}this.send_im_get(n)},plug_on_event:function(a){switch(a.type){case"close":alert(a.type);if(a.chl){if(a.chl==this.chl_play){plug.chl_destroy(this.chl_play);this.chl_play=null}else{if(a.chl==this.chl_publish){plug.chl_destroy(this.chl_publish);this.chl_publish=null}}}break}},publish_start:function(){var d=this,c=codec.uri_2_obj(location.search||""),b,e=0,a=this.plug;if(null==a){this.plug=(a=new media_plug({parent:$("#main"),on_event:function(f){return d.plug_on_event(f)}}))}if(this.pub_timer){clearInterval(this.pub_timer)}this.pub_timer=setInterval(function(){if((b=(a.status==a.plug_status.running))||(a.status==a.plug_status.closed)||(100<=e)){if(d.pub_timer){clearInterval(d.pub_timer);delete d.pub_timer}if(b){if(null==d.chl_publish){var f=d.gid+"_"+d.gid+"_"+d.tid+"?dtype=rtmp&dnid="+d.account.generate_nid()+"&dgid="+codec.str_2_uri_param(""+d.gid)+"&dtid="+codec.str_2_uri_param(""+d.tid);d.chl_publish=d.plug.chl_create({type:"publish",url:d.media_server+"/live/"+f})}}else{alert("init plugin failed.");d.plug.destroy();d.plug=null}}e+=(a.status==a.plug_status.initting)},100)},video_add:function(a){var b={stream_id:a.content.stream_id,active:false,try_times:0,gid:a.head.from.gid,nick:this.to_nick};this.videos[b.stream_id]=b;this.video_play(b)},video_del:function(a){if(a.active){this.video_stop(a);a.url_try_index=0}delete this.videos[a.stream_id];for(var b in a){if(a[b]){delete a[b]}}},video_play:function(b){var a=this;if(null==this.plug){this.plug=new media_plug({parent:$("#main"),on_event:function(c){return a.plug_on_event(c)}})}++this.video_active_counts;b.active=true;if(b.play_timer){clearInterval(b.play_timer)}b.play_timer=setInterval(function(){a.video_play_start(b)},100)},video_play_start:function(b){var a=(this.plug.status==this.plug.plug_status.running);if(a||(this.plug.status==this.plug.plug_status.closed)||(b.try_times>=this.try_times)){b.try_times=0;clearInterval(b.play_timer);delete b.play_timer;if(a){var c=b.stream_id+"?dtype=rtmp&dnid="+this.account.generate_nid()+"&dgid="+codec.str_2_uri_param(""+this.gid)+"&dtid="+codec.str_2_uri_param(""+this.tid);b.url=this.media_server+"/live/"+c;b.chl=this.plug.chl_create({type:"play",url:b.url,refer:b})}else{this.video_stop(b);b.url_try_index=0}}b.try_times+=(this.plug.status==this.plug.plug_status.initting)?1:0},video_stop:function(a){if(a.play_timer){clearInterval(a.play_timer);delete a.play_timer}a.active=false;if(a.chl){this.plug.chl_destroy(a.chl);delete a.chl}--this.video_active_counts},on_im_cmd:function(b){if(b.head.from.gid!=this.gid){var e,a=b.content.params,d=(b.content.deoced_params={}),c=0;for(;c<a.length;++c){e=a[c];d[e.name]=e.value}if("call"==b.content.type){this.hide_call_panel();switch(d.sub_type){case"accept":this.publish_start();break;case"refuse":alert("be refused");break}}}},on_im_media:function(b){var f,a,c=b.head;if(b.content.flag==2){if(c.from.gid==this.gid){return}f=(b.content.type?this.lang.play_:this.lang.play_stop)+this.nick+this.lang._video;if(this.plug){this.plug.text_out(this.to_nick+" : "+f)}}else{if(c.from.gid==this.gid){return}var e=b.content.stream_id,d=this.videos[e];this.hide_call_panel();if(""==b.content.type){if(d){this.video_del(d)}}else{if((undefined==d)||(null==d)){this.video_add(b)}}}},on_imsg:function(b,a){switch(b){case"im_cmd":this.on_im_cmd(a);break;case"im_media":this.on_im_media(a);break}},send_msg:function(b,e,a){var d=this,c="";e.nid=this.account?this.account.generate_nid():"";rpc.call({srv:(c+"/"),to:"im",type:b,data:e,on_ack:function(f){if(!d.living){return}if("object"==typeof(f)){a(f.type,f.data)}else{if("cancel"!=f){a(f,f)}}}})}};video_call.prototype.lang=lang_get(video_call.prototype.langs);